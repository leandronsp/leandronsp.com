<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Construindo um web server em Assembly x86, parte IV, um assembly modesto - Leandro Proen√ßa</title>
  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">

  <!-- Google Fonts - Nunito for name, Caveat for bio -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800&family=Caveat:wght@500;700&display=swap" rel="stylesheet">

  <!-- SEO Meta Tags -->
  <meta name="description" content="Uma vez que temos [uma compreens√£o](https://leandronsp.com/articles/construindo-um-web-server-em-assembly-x86-parte-iii-codigo-de-maquina-bgk) sobre sistema bin√°">
  <meta name="author" content="Leandro Proen√ßa">
  <link rel="canonical" href="https://leandronsp.com/articles/construindo-um-web-server-em-assembly-x86-parte-iv-um-assembly-modesto-oif.html">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://leandronsp.com/articles/construindo-um-web-server-em-assembly-x86-parte-iv-um-assembly-modesto-oif.html">
  <meta property="og:title" content="Construindo um web server em Assembly x86, parte IV, um assembly modesto">
  <meta property="og:description" content="Uma vez que temos [uma compreens√£o](https://leandronsp.com/articles/construindo-um-web-server-em-assembly-x86-parte-iii-codigo-de-maquina-bgk) sobre sistema bin√°">
  <meta property="og:site_name" content="Leandro Proen√ßa">
  <meta property="article:published_time" content="2024-05-13T11:33:03Z">
  <meta property="article:tag" content="computerscience">
      <meta property="article:tag" content="braziliandevs">
      <meta property="article:tag" content="assembly">

  <!-- JSON-LD Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "Construindo um web server em Assembly x86, parte IV, um assembly modesto",
    "datePublished": "2024-05-13T11:33:03Z",
    "author": {
      "@type": "Person",
      "name": "Leandro Proen√ßa"
    },
    "description": "Uma vez que temos [uma compreens√£o](https://leandronsp.com/articles/construindo-um-web-server-em-assembly-x86-parte-iii-codigo-de-maquina-bgk) sobre sistema bin√°",
        "keywords": "computerscience, braziliandevs, assembly"
  }
  </script>

  <link rel="preload" href="/assets/css/app.css" as="style">
  <script>
    // Prevent FOUC (Flash of Unstyled Content) by setting theme before CSS loads
    (function() {
      const theme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <link rel="stylesheet" href="/assets/css/app.css">
  <style>
    /* Force scrollbar to always be visible to prevent layout shift */
    html {
      overflow-y: scroll;
    }

    /* Softer dark theme colors */
    [data-theme="dark"] {
      --base-100: #2a2f3a;
      --base-200: #232831;
      --base-300: #1e222a;
      --base-content: #e8eaed;
    }
    [data-theme="dark"] .article-card {
      background-color: transparent;
      border-color: #3d4454;
    }
    [data-theme="dark"] .article-card:hover {
      border-color: #4a5568;
    }
    /* Keep pinned article with background for prominence in dark theme - lighter pastel */
    [data-theme="dark"] .pinned-article {
      background-color: #3a4050 !important;
    }
    [data-theme="dark"] .prose {
      color: #e8eaed;
    }
    [data-theme="dark"] .prose h1,
    [data-theme="dark"] .prose h2,
    [data-theme="dark"] .prose h3,
    [data-theme="dark"] .prose h4 {
      color: #f0f2f5;
    }
    [data-theme="dark"] .prose a {
      color: #8fb4ff;
    }
    [data-theme="dark"] .prose code {
      background-color: #3d4454;
      color: #f0f2f5;
    }
    [data-theme="dark"] .prose pre {
      background-color: #1e222a;
      border: 1px solid #3d4454;
    }
    [data-theme="dark"] input {
      background-color: #2f3542;
      border-color: #3d4454;
      color: #e8eaed;
    }
    [data-theme="dark"] input::placeholder {
      color: #9ca3af;
    }
    /* Language switcher dark theme styling */
    [data-theme="dark"] .lang-switcher-bg {
      background-color: rgba(59, 130, 246, 0.15) !important;
      border-color: rgba(59, 130, 246, 0.3) !important;
    }
    /* Blog name styling */
    .blog-name {
      font-family: 'Nunito', sans-serif;
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    /* Intro text styling */
    .intro-text {
      font-family: 'Caveat', cursive;
      font-weight: 600;
      color: #6b7280; /* Darker pastel gray for light theme */
    }
    [data-theme="dark"] .intro-text {
      color: #d4d4d8; /* Lighter pastel gray for dark theme */
    }
    /* Article card styling */
    article {
      background-color: transparent;
      border: none;
      border-radius: 0.5rem;
      padding: 2rem;
    }
    [data-theme="dark"] article {
      background-color: transparent;
    }
    /* Article images styling - consistent sizing */
    .prose img {
      max-width: 800px;
      width: 100%;
      height: auto;
      display: block;
      margin-left: auto;
      margin-right: auto;
      border-radius: 0.5rem;
    }
  </style>
</head>
<body class="min-h-screen bg-base-100">
  <!-- Fixed Header -->
  <header class="sticky top-0 z-50 bg-base-100 border-b border-base-300 shadow-sm">
    <div class="container mx-auto px-4 sm:px-6 py-4 max-w-6xl">
      <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-2 lg:gap-4 mb-4">
        <!-- Left side: Name + Intro text -->
        <div class="flex flex-col lg:flex-row lg:items-center lg:gap-6 flex-1">
          <h1 class="blog-name text-2xl sm:text-3xl font-bold text-base-content flex-shrink-0">Leandro Proen√ßa</h1>
          <p class="intro-text text-xl lg:text-2xl leading-tight">
            Software Developer 15+ years programming and counting.<br>
            See my guides at
            <a href="https://web101.leandronsp.com" target="_blank" rel="noopener noreferrer" class="underline decoration-2 hover:opacity-80 transition-opacity cursor-pointer">web101</a>,
            <a href="https://concorrencia101.leandronsp.com" target="_blank" rel="noopener noreferrer" class="underline decoration-2 hover:opacity-80 transition-opacity cursor-pointer">concorrencia101</a>,
            <a href="https://aws101.leandronsp.com" target="_blank" rel="noopener noreferrer" class="underline decoration-2 hover:opacity-80 transition-opacity cursor-pointer">aws101</a>
          </p>
        </div>

        <!-- Right side: Social icons -->
        <div class="flex items-center gap-3 flex-shrink-0">
          <a href="https://linkedin.com/in/leandronsp" target="_blank" rel="noopener noreferrer" class="text-base-content/60 hover:text-primary transition-colors" title="LinkedIn">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
          </a>
          <a href="https://github.com/leandronsp" target="_blank" rel="noopener noreferrer" class="text-base-content/60 hover:text-primary transition-colors" title="GitHub">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/></svg>
          </a>
          <button id="theme-toggle" class="text-base-content/60 hover:text-primary transition-colors" title="Toggle theme">
            <svg xmlns="http://www.w3.org/2000/svg" class="sun-icon h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
            <svg xmlns="http://www.w3.org/2000/svg" class="moon-icon h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
          </button>
        </div>
      </div>

      <!-- Search Bar + Language Switcher -->
      <div class="flex gap-4 items-center">
        <!-- Search -->
        <div class="hidden md:block relative flex-1 max-w-2xl">
          <input
            type="text"
            id="search-input"
            placeholder="Search articles..."
            class="w-full h-12 pl-12 pr-4 text-base bg-base-200 border-2 border-base-300 rounded-full transition-all focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
            autocomplete="off"
          />
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-4 top-1/2 -translate-y-1/2 text-base-content/40" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>

          <!-- Search Results Dropdown -->
          <div id="search-results" class="hidden absolute top-full mt-2 w-full bg-base-100 border-2 border-base-300 rounded-2xl shadow-2xl max-h-[500px] overflow-y-auto z-50 p-3">
            <!-- Results will be inserted here by JavaScript -->
          </div>
        </div>

        <!-- Language Switcher -->
        <div class="lang-switcher-bg flex gap-0 bg-blue-50/80 border border-blue-100 rounded-full p-1 ml-auto shadow-sm">
          <button class="lang-filter-btn px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-primary text-white" data-lang="all" onclick="window.blogFilters.setLanguage('all')">All</button>
          <button class="lang-filter-btn px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-white/60 text-base-content" data-lang="pt" onclick="window.blogFilters.setLanguage('pt')">üáßüá∑ PT</button>
          <button class="lang-filter-btn px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-white/60 text-base-content" data-lang="en" onclick="window.blogFilters.setLanguage('en')">üá∫üá∏ EN</button>
        </div>
        <script>
          // Apply language state immediately (sync, no event listener)
          (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlLang = urlParams.get('lang');
            const savedLang = localStorage.getItem('blog-filter-lang') || 'all';
            const currentLang = urlLang || savedLang;

            const buttons = document.querySelectorAll('.lang-filter-btn');
            buttons.forEach(function(btn) {
              const lang = btn.getAttribute('data-lang');
              if (lang === currentLang) {
                btn.className = 'lang-filter-btn px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-primary text-white';
              } else {
                btn.className = 'lang-filter-btn px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-white/60 text-base-content';
              }
            });
          })();
        </script>
      </div>
    </div>

    <!-- Tags Navigation -->
    <div class="border-t border-base-300 bg-base-200/50">
      <div class="container mx-auto px-4 sm:px-6 max-w-6xl">
        <div class="py-3">
          <div class="flex flex-wrap gap-2 items-center">
            <div id="tags-pills" class="flex flex-wrap gap-2 items-center">
              <button class="tag-pill px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-primary text-white" data-tag="all" onclick="window.blogFilters.clearTag()">All</button>
              <button class="tag-pill px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-base-200 text-base-content" data-tag="ruby" onclick="window.blogFilters.setTag('ruby')">Ruby</button>
              <button class="tag-pill px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-base-200 text-base-content" data-tag="rust" onclick="window.blogFilters.setTag('rust')">Rust</button>
              <button class="tag-pill px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-base-200 text-base-content" data-tag="haskell" onclick="window.blogFilters.setTag('haskell')">Haskell</button>
              <button class="tag-pill px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-base-200 text-base-content" data-tag="assembly" onclick="window.blogFilters.setTag('assembly')">Assembly</button>
              <button class="tag-pill px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-base-200 text-base-content" data-tag="bash" onclick="window.blogFilters.setTag('bash')">Bash</button>
              <button class="tag-pill px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-base-200 text-base-content" data-tag="postgres" onclick="window.blogFilters.setTag('postgres')">Postgres</button>
              <button class="tag-pill px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-base-200 text-base-content" data-tag="kubernetes" onclick="window.blogFilters.setTag('kubernetes')">Kubernetes</button>
            </div>
          </div>
        </div>
      </div>
      <script>
        // Apply tag state and pinned visibility immediately (sync, no event listener)
        (function() {
          const urlParams = new URLSearchParams(window.location.search);
          const urlTag = urlParams.get('tag');
          const savedTag = localStorage.getItem('blog-filter-tag');
          const currentTag = urlTag || savedTag || null;

          // Update tag buttons
          const buttons = document.querySelectorAll('.tag-pill');
          buttons.forEach(function(btn) {
            const tag = btn.getAttribute('data-tag');
            const isActive = (tag === 'all' && !currentTag) || (tag === currentTag);
            if (isActive) {
              btn.className = 'tag-pill px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-primary text-white';
            } else {
              btn.className = 'tag-pill px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-base-200 text-base-content';
            }
          });
        })();
      </script>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 sm:px-6 py-8 max-w-6xl">
    <article class="bg-base-100">
      <!-- Back link -->
      <a href="/" onclick="event.preventDefault(); history.back();" class="inline-flex items-center gap-2 text-lg font-medium transition-colors text-base-content/70 hover:text-primary cursor-pointer mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back
      </a>

      <h1 class="text-5xl font-bold leading-tight mb-6">Construindo um web server em Assembly x86, parte IV, um assembly modesto</h1>

      <div class="flex flex-wrap items-center gap-3 mb-8 text-base text-base-content/85">
        <div class="flex items-center gap-1.5">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
          <span>Published 13 May 2024</span>
        </div>

        <div class="flex items-center gap-1.5">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
  </svg>
  <div class="flex gap-2 flex-wrap">
    <span class="inline-flex items-center px-3 py-1 text-sm border border-base-content/25 rounded-full">computerscience</span><span class="inline-flex items-center px-3 py-1 text-sm border border-base-content/25 rounded-full">braziliandevs</span><span class="inline-flex items-center px-3 py-1 text-sm border border-base-content/25 rounded-full">assembly</span>
  </div>
</div>

      </div>

      <div class="prose prose-lg max-w-none">
        <p>Uma vez que temos <a href="https://leandronsp.com/articles/construindo-um-web-server-em-assembly-x86-parte-iii-codigo-de-maquina-bgk">uma compreens√£o</a> sobre sistema bin√°rio, hexadecimal, ASCII e c√≥digo de m√°quina, chegou o grande momento de entrarmos no assunto principal desta saga: <strong>assembly</strong>.</p>
<p>Vamos iniciar transportando o ‚ÄúHello, World‚Äù feito em c√≥digo de m√°quina para assembly x86 e, posteriormente, abordar um exemplo de programa que recebe argumento da linha de comando.</p>
<p>Ao longo deste artigo vamos aprender a base de conceitos como r√≥tulos, segmentos de mem√≥ria, <em>muito gdb</em>, layout de mem√≥ria, <strong>muita stack</strong>, procedures (subrotinas, ou <em>fun√ß√µes</em>), loops, condicionais, flags, tipos de registradores e etc</p>
<p>Aperte os cintos, pois este ser√° um artigo bem extenso. Sugiro ao leitor, - que tem interesse em aprender na pr√°tica com esta saga -, que tenha o ambiente preparado e que execute cada exemplo seguindo os passos aqui descritos.</p>
<p>Sem mais delongas, vamos ao que importa.</p>
<hr />
<h2><a href="#agenda" aria-hidden="true" class="anchor" id="agenda"></a>Agenda</h2>
<ul>
<li><a href="#humanizar-%C3%A9-preciso">Humanizar √© preciso</a>
<ul>
<li><a href="#mnemonics">Mnemonics</a></li>
</ul>
</li>
<li><a href="#assemblers">Assemblers</a></li>
<li><a href="#nosso-primeiro-programa">Nosso primeiro programa</a>
<ul>
<li><a href="#a-chamada-de-sistema-exit">A chamada de sistema exit</a></li>
<li><a href="#arquivos-objeto">Arquivos Objeto</a></li>
<li><a href="#linker">Linker</a></li>
</ul>
</li>
<li><a href="#depurando-o-programa">Depurando o programa</a>
<ul>
<li><a href="#o-utilit%C3%A1rio-size">O utilit√°rio size</a></li>
<li><a href="#debugging-com-gdb">Debugging com gdb</a></li>
<li><a href="#rastreando-execu%C3%A7%C3%A3o-com-strace">Rastreando execu√ß√£o com strace</a></li>
</ul>
</li>
<li><a href="#evoluindo-nosso-primeiro-programa">Evoluindo nosso primeiro programa<br />
</a>
<ul>
<li><a href="#alocando-bytes-para-hello-world">Alocando bytes para ‚ÄúHello, World‚Äù</a></li>
<li><a href="#adicionando-a-chamada-de-sistema-write">Adicionando a chamada de sistema write</a></li>
<li><a href="#layout-de-mem%C3%B3ria">Layout de mem√≥ria</a></li>
<li><a href="#definindo-constantes">Definindo constantes</a></li>
</ul>
</li>
<li><a href="#um-programa-mais-sofisticado">Um programa mais sofisticado</a>
<ul>
<li><a href="#definindo-labels">Definindo labels</a></li>
<li><a href="#desvio-de-fluxo-com-jump">Desvio de fluxo com jump</a></li>
<li><a href="#desvio-de-fluxo-com-call">Desvio de fluxo com call</a></li>
<li><a href="#brincando-com-pilhas">Brincando com pilhas</a></li>
<li><a href="#calculando-tamanho-dinamicamente-com-loop">Calculando tamanho dinamicamente com loop</a></li>
<li><a href="#rflags">RFLAGS</a></li>
<li><a href="#botando-mais-pilha-no-neg%C3%B3cio">Botando mais pilha no neg√≥cio</a></li>
<li><a href="#depurando-o-programa-final-com-strace">Depurando o programa final com strace</a></li>
</ul>
</li>
<li><a href="#falando-um-pouco-de-registradores">Falando um pouco de registradores</a>
<ul>
<li><a href="#prop%C3%B3sito-dos-registradores">Prop√≥sito dos registradores</a></li>
<li><a href="#registradores-de-prop%C3%B3sito-geral">Registradores de prop√≥sito geral</a></li>
<li><a href="#registradores-especiais">Registradores especiais</a></li>
<li><a href="#precisamos-sempre-utilizar-todos-os-64-bits">Precisamos sempre utilizar todos os 64 bits?</a></li>
</ul>
</li>
<li><a href="#uma-side-note-sobre-stack-frames">Uma side note sobre stack frames</a></li>
<li><a href="#conclus%C3%A3o">Conclus√£o</a></li>
<li><a href="#refer%C3%AAncias">Refer√™ncias</a></li>
</ul>
<hr />
<blockquote>
<p>Antes de iniciar, quero novamente deixar uma men√ß√£o especial ao excelente <a href="https://www.youtube.com/watch?v=Ej6U-qk0bdE&amp;list=PLXoSGejyuQGohd0arC7jRBqVdQqf5GqKJ">curso gratuito de Assembly x86</a> do <a href="https://www.youtube.com/@debxp">Blau Ara√∫jo</a>. √â importante refor√ßar o quanto este material dele √© necess√°rio e foi crucial para que eu pudesse fundamentar diversos conceitos explorados ao longo desta saga</p>
</blockquote>
<h2><a href="#humanizar-√©-preciso" aria-hidden="true" class="anchor" id="humanizar-√©-preciso"></a>Humanizar √© preciso</h2>
<p>Como vimos no artigo anterior, CPU s√≥ entende c√≥digo de m√°quina:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">48 65 6C 6C 6F 2C 20 57 6F 72 6C 64 0A  ; Hello, World
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">BF 01 00 00 00     ; RDI ‚¨ÖÔ∏è 1
</div><div class="line" data-line="4">48 BE 00 10 40     ; RSI ‚¨ÖÔ∏è 0x401000
</div><div class="line" data-line="5">BA 0D 00 00 00     ; RDX ‚¨ÖÔ∏è 13
</div><div class="line" data-line="6">B8 01 00 00 00     ; RAX ‚¨ÖÔ∏è 1
</div><div class="line" data-line="7">0F 05              ; SYSCALL
</div><div class="line" data-line="8">BF 00 00 00 00     ; RDI ‚¨ÖÔ∏è 0
</div><div class="line" data-line="9">B8 3C 00 00 00     ; RAX ‚¨ÖÔ∏è 60
</div><div class="line" data-line="10">0F 05              ; SYSCALL
</div></code></pre>
<p>Entretanto, para uma pessoa desenvolvedora manter um programa em c√≥digo de m√°quina, √© preciso ter muita paci√™ncia e aten√ß√£o ao detalhe, pelo que tamb√©m manter programas assim √© muito propenso a bugs.</p>
<p>Precisamos de alguma forma, representar cada instru√ß√£o em c√≥digo de m√°quina em uma linguagem mais ‚Äúhuman-friendly‚Äù.</p>
<h3><a href="#mnemonics" aria-hidden="true" class="anchor" id="mnemonics"></a>Mnemonics</h3>
<p>√â a√≠ que entram os <strong>mnemonics</strong>, que s√£o uma forma textual de representar informa√ß√µes visando facilitar a memoriza√ß√£o para o c√©rebro humano.</p>
<p>Ao inv√©s de trabalharmos com <code>BF 01 00 00 00</code>, podemos trocar por <code>MOV RDI, 1</code>, que significa:</p>
<blockquote>
<p>estou movendo o valor imediato 1 para o registrador RDI</p>
</blockquote>
<p>E assim vamos <em>montando</em> instru√ß√£o por instru√ß√£o, tal e qual far√≠amos com c√≥digo de m√°quina, mas utilizando uma <em>linguagem</em> de f√°cil memoriza√ß√£o.</p>
<p>Mas a CPU n√£o entende essa ‚Äúlinguagem‚Äù. Temos de construir um <em>programa</em> que faz a <em>tradu√ß√£o</em> de mnemonics para <em>c√≥digo de m√°quina</em>, ou seja, de <code>MOV RSI, 1</code> para <code>BF 01 00 00 00</code>.</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/m7zzy20fad71wg461cpt.png" alt="assembly" /></p>
<p>Estamos falando de <em>montadores</em>, ou simplesmente <strong>assemblers</strong>.</p>
<hr />
<h2><a href="#assemblers" aria-hidden="true" class="anchor" id="assemblers"></a>Assemblers</h2>
<p>Ao longo do tempo, foram desenvolvidos diversos assemblers para diferentes arquiteturas.</p>
<p>Para arquitetura x86, h√° diversos assemblers j√° constru√≠dos, GNU Assembler (as), NASM, FASM, pra mencionar alguns.</p>
<p>Assemblers para esta arquitetura em espec√≠fico podem seguir 2 tipos de sintaxe que s√£o predominantes:</p>
<ul>
<li>AT&T, desenvolvida pela AT&T corporation</li>
<li>Intel, desenvolvida pela Intel</li>
</ul>
<p>Nesta saga, vamos focar no Assembler <strong>NASM</strong> para arquitetura X86 64-bits (x64), com <em>sintaxe Intel</em> e rodando em sistema GNU/Linux, como j√° mencionamos algumas vezes em artigos anteriores.</p>
<ul>
<li>Arquitetura x86_64 (x64)</li>
<li>Sistema Operacional GNU/Linux (Ubuntu)</li>
<li>Assembler NASM 2.16.01</li>
<li>GNU ld 2.38 (ligador, ou linker)</li>
<li>Debugger GNU gdb 12.1</li>
<li>strace 5.16 (tracing de syscalls)</li>
</ul>
<p>Uma vez que definimos as ferramentas utilizadas, vamos seguir traduzindo o ‚ÄúHello, World‚Äù para asm x86 enquanto entendemos o uso de cada uma delas.</p>
<blockquote>
<p>A partir de agora, quando me referir a Assembly ou simplesmente ‚Äúasm‚Äù, leia-se <em>Assembly x86_64</em></p>
</blockquote>
<hr />
<h2><a href="#nosso-primeiro-programa" aria-hidden="true" class="anchor" id="nosso-primeiro-programa"></a>Nosso primeiro programa</h2>
<p>Em Assembly, todo programa deve ter um ponto de entrada, tamb√©m chamado de <strong>entry point</strong>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">_start:
</div><div class="line" data-line="4">	; c√≥digo do programa vai aqui
</div></code></pre>
<p>E a primeira coisa que nosso programa vai fazer √© sair:</p>
<blockquote>
<p>kkkkkkkkkk</p>
</blockquote>
<h3><a href="#a-chamada-de-sistema-exit" aria-hidden="true" class="anchor" id="a-chamada-de-sistema-exit"></a>A chamada de sistema exit</h3>
<p>Brincadeiras √† parte, a chamada de sistema que precisamos executar √© a <code>exit</code>, definida da seguinte forma no <code>glibc</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-c" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #e5c07b;">void</span> <span style="color: #61afef;">_exit</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">int</span> <span style="color: #e06c75;">status</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<p>Com isto, temos de seguir a l√≥gica para montar as instru√ß√µes tal como fizemos com os opcodes, que seguindo  <a href="https://x64.syscall.sh/">a mesma tabela de syscalls</a>, √©:</p>
<ul>
<li>nome da syscall vai em RAX</li>
<li>primeiro argumento (o status de erro) vai em RDI</li>
</ul>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">_start:
</div><div class="line" data-line="4">	mov rdi, 0   ; error status
</div><div class="line" data-line="5">	mov rax, 60  ; nome da syscall: SYS_exit
</div><div class="line" data-line="6">	syscall       
</div></code></pre>
<p>Este programa simplesmente faz aquilo que mencionamos no artigo anterior: <em>que todo programa deve terminar</em>.</p>
<ul>
<li><code>mov rdi, 0</code> move o valor imediato 1 para o registrador RDI; vai representar o error code da syscall <strong>exit</strong>: 0 para t√©rmino sem erros</li>
<li><code>mov rax, 60</code> move o valor imediato 60 para o registrador RAX; vai representar o nome da syscall em si, <strong>exit</strong></li>
<li><code>syscall</code> faz a chamada de sistema da syscall <strong>exit</strong>, definida em RAX</li>
</ul>
<p>Para que o programa seja compilado, precisamos primeiro fazer a ‚Äúmontagem‚Äù das instru√ß√µes com NASM:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">nasm</span> <span style="color: #e06c75;">-f</span> <span style="color: #e06c75;">elf64</span> <span style="color: #e06c75;">hello.asm</span> <span style="color: #e06c75;">-o</span> <span style="color: #e06c75;">hello.o</span>
</div></code></pre>
<ul>
<li><code>-f elf64</code>: arquitetura de destino, x64</li>
<li><code>hello.asm</code> input, ou seja, o arquivo que cont√©m o c√≥digo fonte</li>
<li><code>-o hello.o</code>: define sa√≠da para o arquivo <code>hello.o</code></li>
</ul>
<blockquote>
<p>Mas o qu√™ √© este arquivo <code>hello.o</code>?</p>
</blockquote>
<h3><a href="#arquivos-objeto" aria-hidden="true" class="anchor" id="arquivos-objeto"></a>Arquivos objeto</h3>
<p>Arquivo objeto (<strong>Object File</strong>) √© um arquivo que cont√©m c√≥digo de m√°quina gerado por um assembler ou compilador.</p>
<p>Por√©m este arquivo ainda n√£o √© um <em>execut√°vel</em> final, porque podemos querer combinar com outros arquivos objeto e bibliotecas nativas do SO.</p>
<p>A partir deste arquivo, que geralmente tem a extens√£o <code>.o</code>, podemos utilizar outro programa para ‚Äúligar‚Äù com outros arquivos, se necess√°rio, no intuito de gerar um arquivo com c√≥digo de m√°quina final e execut√°vel.</p>
<p>Este programa se chama <strong>linker</strong>, pelo que utilizaremos a vers√£o padr√£o do <code>ld</code> que vem com o GNU no nosso sistema operacional GNU/Linux.</p>
<h3><a href="#linker" aria-hidden="true" class="anchor" id="linker"></a>Linker</h3>
<p><em>Linker</em> √© o programa respons√°vel por, a partir de um ou mais arquivos objeto, gerar um arquivo final execut√°vel com o c√≥digo de m√°quina.</p>
<p>Como j√° geramos anteriormente o arquivo objeto <code>hello.o</code> utilizando o assembler NASM, podemos concluir o processo de compila√ß√£o do nosso programa fonte asm x86 com <code>ld</code></p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">ld</span> <span style="color: #e06c75;">hello.o</span> <span style="color: #e06c75;">-o</span> <span style="color: #e06c75;">hello</span>
</div></code></pre>
<p>E agora, vamos rodar o bin√°rio final execut√°vel <code>hello</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1">$ <span style="color: #61afef;">./hello</span>
</div><div class="line" data-line="2"><span style="color: #e5c07b;">echo</span> <span style="color: #abb2bf;">$</span><span style="color: #d19a66;">?</span>
</div><div class="line" data-line="3"><span style="color: #d19a66;">0</span>
</div></code></pre>
<p><em>Hurray!</em> Nosso primeiro programa em Assembly conclu√≠do com sucesso!</p>
<p>Contudo, vamos lembrar de um ponto importante que vimos na parte II da saga: que o <em>programa e seus dados ficam na mem√≥ria</em>. Queremos entender <strong>o que est√° acontecendo na mem√≥ria</strong> com este simples programa.</p>
<hr />
<h2><a href="#depurando-o-programa" aria-hidden="true" class="anchor" id="depurando-o-programa"></a>Depurando o programa</h2>
<p>Uma das etapas mais importantes, sen√£o a mais  importante, em desenvolvimento de software, √© a <em>depura√ß√£o</em> (ou debugging, em ingl√™s).</p>
<p>Depurar √© o ato de conseguir interceptar a execu√ß√£o do programa, analisar o estado, alterar o estado, adicionar pontos de parada (breakpoints) entre outras t√©cnicas.</p>
<p>O processo de depura√ß√£o tamb√©m consiste em analisar a sa√≠da do programa como um todo, seu tamanho e trace de chamadas no sistema operacional.</p>
<h3><a href="#o-utilit√°rio-size" aria-hidden="true" class="anchor" id="o-utilit√°rio-size"></a>O utilit√°rio size</h3>
<p>Vamos iniciar o processo de depura√ß√£o do nosso programa analisando o tamanho, com o utilit√°rio GNU <em>size</em>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">size</span> <span style="color: #e06c75;">hello</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">   <span style="color: #61afef;">text</span>    <span style="color: #e06c75;">data</span>     <span style="color: #e06c75;">bss</span>     <span style="color: #e06c75;">dec</span>     <span style="color: #e06c75;">hex</span> <span style="color: #e06c75;">filename</span>
</div><div class="line" data-line="4">     <span style="color: #d19a66;">12</span>       <span style="color: #d19a66;">0</span>       <span style="color: #d19a66;">0</span>      <span style="color: #d19a66;">12</span>       <span style="color: #e06c75;">c</span> <span style="color: #e06c75;">hello</span>
</div></code></pre>
<blockquote>
<p>Mas o qu√™ significa ‚Äútext, data, bss, etc‚Äù?</p>
</blockquote>
<p>Cada programa no sistema operacional √© dividido em <em>se√ß√µes</em>, que representam alguma caracter√≠stica para o sistema operacional.</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/lv9edus1e9nxw4b24cxq.png" alt="layout de mem√≥ria" /></p>
<p><strong>text</strong><br />
Esta se√ß√£o cont√©m todo o c√≥digo fonte do programa, e assim o SO sabe que precisa buscar esta se√ß√£o na mem√≥ria principal</p>
<p><strong>data</strong><br />
Se√ß√£o de dados inicializados na mem√≥ria</p>
<p><strong>bss</strong><br />
Se√ß√£o de dados n√£o-inicializados na mem√≥ria</p>
<p>O comando <strong>size</strong> traz justamente o tamanho (em bytes) de cada se√ß√£o.</p>
<blockquote>
<p><code>dec</code> e <code>hex</code> n√£o s√£o se√ß√µes, s√£o apenas a representa√ß√£o do valor total (em bytes) tanto em decimal quanto hexadecimal</p>
</blockquote>
<ul>
<li><code>text</code>: esta se√ß√£o cont√©m todo o c√≥digo fonte do nosso programa, tamb√©m chamado de ‚Äútexto‚Äù</li>
<li><code>data</code>: se√ß√£o de dados inicializados, logo a seguir neste artigos entramos em detalhe</li>
<li><code>bss</code>: se√ß√£o de dados n√£o-inicializados, logo a seguir tamb√©m falaremos deste</li>
<li><code>dec</code>: o tamanho total em decimal</li>
<li><code>hex</code>: o tamanho total em hexadecimal</li>
</ul>
<p>Nosso programa por enquanto s√≥ tem a se√ß√£o text, que √© exatamente todo o c√≥digo a partir do r√≥tulo <code>_start</code>.</p>
<blockquote>
<p>Nossa, Leandro, nosso programa tem apenas 12 bytes?</p>
</blockquote>
<p>Aparentemente sim. Vamos confirmar:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">ls</span> <span style="color: #e06c75;">-lh</span> <span style="color: #e06c75;">hello</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #61afef;">......</span> <span style="color: #e06c75;">4.6K</span> <span style="color: #e06c75;">...</span> <span style="color: #e06c75;">hello</span>
</div></code></pre>
<blockquote>
<p>Como assim o arquivo tem 4,6Kb? O programa n√£o ocupa 12 bytes apenas?</p>
</blockquote>
<p>Bom, isto ocorre por causa dos headers que s√£o adicionados pelo linker, que cont√©m informa√ß√£o relevante para que o sistema operacional possa admitir a execu√ß√£o do arquivo.</p>
<p>Vamos novamente utilizar o comando <code>size</code> mas desta vez:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">size</span> <span style="color: #e06c75;">--format</span> <span style="color: #e06c75;">sysv</span> <span style="color: #e06c75;">--radix</span> <span style="color: #d19a66;">16</span> <span style="color: #e06c75;">hello</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #61afef;">hello</span>  <span style="color: #e06c75;">:</span>
</div><div class="line" data-line="4"><span style="color: #61afef;">section</span>   <span style="color: #e06c75;">size</span>       <span style="color: #e06c75;">addr</span>
</div><div class="line" data-line="5"><span style="color: #61afef;">.text</span>    <span style="color: #e06c75;">0xc</span>   <span style="color: #d19a66;">0x401000</span>
</div><div class="line" data-line="6"><span style="color: #61afef;">Total</span>    <span style="color: #e06c75;">0xc</span>
</div></code></pre>
<p>A op√ß√£o <code>--format</code> indica o formato <code>sysv</code> que traz tamb√©m os s√≠mbolos. E a op√ß√£o <code>--radix 16</code> permite visualizar o tamanho de cada se√ß√£o em hexadecimal.</p>
<p>Na se√ß√£o size, <code>0xc</code> representa o n√∫mero 12 em decimal. Nada de novo aqui. Mas se repararmos na coluna <code>addr</code>, temos um valor hexadecimal para a se√ß√£o text (0x401000).</p>
<p>J√° vimos isto no artigo anterior, que <code>0x401000</code> se referia ao endere√ßo em hexadecimal de mem√≥ria virtual que indica o in√≠cio do programa, lembra?</p>
<p>Hora de confirmar isto com uma an√°lise mais profunda na depura√ß√£o, chegou o momento de utilizarmos GNU <em>gdb</em>.</p>
<h3><a href="#debugging-com-gdb" aria-hidden="true" class="anchor" id="debugging-com-gdb"></a>Debugging com GDB</h3>
<p>GDB √© um depurador (<em>debugger</em> em ingl√™s) que permite ver o que est√° acontecendo dentro de um programa <em>em execu√ß√£o</em>.</p>
<p>Com um depurador, podemos analisar as informa√ß√µes est√°ticas contidas no bin√°rio do programa, estabelecer <em>breakpoints</em> (pontos de parada) em qualquer parte do c√≥digo, executar e analisar mudan√ßas de estado do programa durante sua execu√ß√£o.</p>
<p>Para habilitar o programa com <code>gdb</code>, precisamos montar o programa com a op√ß√£o <code>-g</code>, que exporta s√≠mbolos necess√°rios para depura√ß√£o:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">nasm</span> <span style="color: #e06c75;">-g</span> <span style="color: #e06c75;">-f</span> <span style="color: #e06c75;">elf64</span> <span style="color: #e06c75;">hello.asm</span> <span style="color: #e06c75;">-o</span> <span style="color: #e06c75;">hello.o</span>
</div><div class="line" data-line="2"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">ld</span> <span style="color: #e06c75;">hello.o</span> <span style="color: #e06c75;">-o</span> <span style="color: #e06c75;">hello</span>
</div></code></pre>
<p>Podemos verificar os s√≠mbolos exportados no bin√°rio com o comando size novamente:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">size</span> <span style="color: #e06c75;">--format</span> <span style="color: #e06c75;">sysv</span> <span style="color: #e06c75;">--radix</span> <span style="color: #d19a66;">16</span> <span style="color: #e06c75;">hello</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #61afef;">hello</span>  <span style="color: #e06c75;">:</span>
</div><div class="line" data-line="4"><span style="color: #61afef;">section</span>           <span style="color: #e06c75;">size</span>       <span style="color: #e06c75;">addr</span>
</div><div class="line" data-line="5"><span style="color: #61afef;">.text</span>              <span style="color: #e06c75;">0xc</span>   <span style="color: #d19a66;">0x401000</span>
</div><div class="line" data-line="6"><span style="color: #61afef;">.debug_aranges</span>    <span style="color: #d19a66;">0x30</span>        <span style="color: #d19a66;">0x0</span>
</div><div class="line" data-line="7"><span style="color: #61afef;">.debug_info</span>       <span style="color: #d19a66;">0x75</span>        <span style="color: #d19a66;">0x0</span>
</div><div class="line" data-line="8"><span style="color: #61afef;">.debug_abbrev</span>     <span style="color: #e06c75;">0x1d</span>        <span style="color: #d19a66;">0x0</span>
</div><div class="line" data-line="9"><span style="color: #61afef;">.debug_line</span>       <span style="color: #e06c75;">0x3d</span>        <span style="color: #d19a66;">0x0</span>
</div><div class="line" data-line="10"><span style="color: #61afef;">Total</span>            <span style="color: #e06c75;">0x10b</span>
</div><div class="line" data-line="11">
</div><div class="line" data-line="12"><span style="color: #7f848e;">##############</span>
</div><div class="line" data-line="13">
</div><div class="line" data-line="14"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">ls</span> <span style="color: #e06c75;">-lh</span> <span style="color: #e06c75;">hello</span>
</div><div class="line" data-line="15"><span style="color: #61afef;">......</span> <span style="color: #e06c75;">5.1K</span> <span style="color: #e06c75;">...</span> <span style="color: #e06c75;">hello</span>
</div></code></pre>
<p>Como demonstrado acima, o bin√°rio agora cont√©m se√ß√µes adicionais de ‚Äúdebug‚Äù que ser√£o utilizadas pelo <em>gdb</em>, e consequentemente o tamanho do programa teve um acr√©scimo de <del>500MB</del> 512 bytes!</p>
<p>Sem mais delongas, vamos entrar no <code>gdb</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">gdb</span> <span style="color: #e06c75;">--quiet</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span>
</div></code></pre>
<p>E agora, dentro do shell gdb, podemos utilizar diversos comandos de depura√ß√£o. O comando <code>help</code> traz a lista de <em>classes de comandos</em> dispon√≠veis:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #e5c07b;">help</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #61afef;">...</span>
</div><div class="line" data-line="4"><span style="color: #61afef;">aliases</span> <span style="color: #e06c75;">--</span> <span style="color: #e06c75;">User-defined</span> <span style="color: #e06c75;">aliases</span> <span style="color: #e06c75;">of</span> <span style="color: #e06c75;">other</span> <span style="color: #e06c75;">commands.</span>
</div><div class="line" data-line="5"><span style="color: #61afef;">breakpoints</span> <span style="color: #e06c75;">--</span> <span style="color: #e06c75;">Making</span> <span style="color: #e06c75;">program</span> <span style="color: #e06c75;">stop</span> <span style="color: #e06c75;">at</span> <span style="color: #e06c75;">certain</span> <span style="color: #e06c75;">points.</span>
</div><div class="line" data-line="6"><span style="color: #61afef;">data</span> <span style="color: #e06c75;">--</span> <span style="color: #e06c75;">Examining</span> <span style="color: #e06c75;">data.</span>
</div><div class="line" data-line="7"><span style="color: #61afef;">files</span> <span style="color: #e06c75;">--</span> <span style="color: #e06c75;">Specifying</span> <span style="color: #e06c75;">and</span> <span style="color: #e06c75;">examining</span> <span style="color: #e06c75;">files.</span>
</div><div class="line" data-line="8"><span style="color: #61afef;">internals</span> <span style="color: #e06c75;">--</span> <span style="color: #e06c75;">Maintenance</span> <span style="color: #e06c75;">commands.</span>
</div><div class="line" data-line="9"><span style="color: #61afef;">obscure</span> <span style="color: #e06c75;">--</span> <span style="color: #e06c75;">Obscure</span> <span style="color: #e06c75;">features.</span>
</div><div class="line" data-line="10"><span style="color: #61afef;">running</span> <span style="color: #e06c75;">--</span> <span style="color: #e06c75;">Running</span> <span style="color: #e06c75;">the</span> <span style="color: #e06c75;">program.</span>
</div><div class="line" data-line="11"><span style="color: #61afef;">stack</span> <span style="color: #e06c75;">--</span> <span style="color: #e06c75;">Examining</span> <span style="color: #e06c75;">the</span> <span style="color: #e06c75;">stack.</span>
</div><div class="line" data-line="12"><span style="color: #61afef;">status</span> <span style="color: #e06c75;">--</span> <span style="color: #e06c75;">Status</span> <span style="color: #e06c75;">inquiries.</span>
</div><div class="line" data-line="13"><span style="color: #61afef;">support</span> <span style="color: #e06c75;">--</span> <span style="color: #e06c75;">Support</span> <span style="color: #e06c75;">facilities.</span>
</div><div class="line" data-line="14"><span style="color: #61afef;">text-user-interface</span> <span style="color: #e06c75;">--</span> <span style="color: #e06c75;">TUI</span> <span style="color: #e06c75;">is</span> <span style="color: #e06c75;">the</span> <span style="color: #e06c75;">GDB</span> <span style="color: #e06c75;">text</span> <span style="color: #e06c75;">based</span> <span style="color: #e06c75;">interface.</span>
</div><div class="line" data-line="15"><span style="color: #61afef;">tracepoints</span> <span style="color: #e06c75;">--</span> <span style="color: #e06c75;">Tracing</span> <span style="color: #e06c75;">of</span> <span style="color: #e06c75;">program</span> <span style="color: #e06c75;">execution</span> <span style="color: #e06c75;">without</span> <span style="color: #e06c75;">stopping</span> <span style="color: #e06c75;">the</span> <span style="color: #e06c75;">program.</span>
</div><div class="line" data-line="16"><span style="color: #61afef;">user-defined</span> <span style="color: #e06c75;">--</span> <span style="color: #e06c75;">User-defined</span> <span style="color: #e06c75;">commands.</span>
</div><div class="line" data-line="17"><span style="color: #61afef;">...</span>
</div></code></pre>
<blockquote>
<p>Para o escopo deste artigo vamos utilizar apenas alguns comandos para depura√ß√£o, mas a lista de comandos dispon√≠veis √© <a href="https://visualgdb.com/gdbreference/commands/">gigante</a>. Deixo o desafio ao leitor para se aventurar com o <code>help</code> do gdb e brincar de depurar qualquer bin√°rio execut√°vel</p>
</blockquote>
<p>Como queremos depurar o bin√°rio <em>hello</em>, podemos carregar os s√≠mbolos utilizando o comando <code>file</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">file</span> <span style="color: #e06c75;">hello</span>
</div><div class="line" data-line="2"><span style="color: #61afef;">Reading</span> <span style="color: #e06c75;">symbols</span> <span style="color: #e06c75;">from</span> <span style="color: #e06c75;">hello...</span>
</div><div class="line" data-line="3"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span>
</div></code></pre>
<p>O comando <code>info files</code> traz alguns insights:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">info</span> <span style="color: #e06c75;">files</span>
</div><div class="line" data-line="2"><span style="color: #61afef;">Symbols</span> <span style="color: #e06c75;">from</span> <span style="color: #98c379;">&quot;/code/asm-x64/hello&quot;</span><span style="color: #e06c75;">.</span>
</div><div class="line" data-line="3"><span style="color: #61afef;">Local</span> <span style="color: #e06c75;">exec</span> <span style="color: #e06c75;">file:</span>
</div><div class="line" data-line="4">        `/code/asm-x64/hello&#39;, file type elf64-x86-64.
</div><div class="line" data-line="5">        Entry point: 0x401000
</div><div class="line" data-line="6">        0x0000000000401000 - 0x000000000040100c is .text
</div><div class="line" data-line="7">(gdb)
</div></code></pre>
<p>Que interessante! O entry point do programa come√ßa justamente em <code>0x401000</code>, que √© o que est√° definido na se√ß√£o <code>.text</code>.</p>
<p>Para visualizar o c√≥digo fonte do programa, utilizamos o comando <code>list</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">list</span>
</div><div class="line" data-line="2"><span style="color: #d19a66;">1</span>       <span style="color: #e06c75;">global</span> <span style="color: #e06c75;">_start</span>
</div><div class="line" data-line="3"><span style="color: #d19a66;">2</span>
</div><div class="line" data-line="4"><span style="color: #d19a66;">3</span>       <span style="color: #e06c75;">_start:</span>
</div><div class="line" data-line="5"><span style="color: #d19a66;">4</span>               <span style="color: #e06c75;">mov</span> <span style="color: #e06c75;">rdi,</span> <span style="color: #d19a66;">0</span>   <span style="color: #abb2bf;">;</span> <span style="color: #61afef;">error</span> <span style="color: #e06c75;">code</span>
</div><div class="line" data-line="6"><span style="color: #d19a66;">5</span>               <span style="color: #e06c75;">mov</span> <span style="color: #e06c75;">rax,</span> <span style="color: #d19a66;">60</span>  <span style="color: #abb2bf;">;</span> <span style="color: #61afef;">SYS_exit</span>
</div><div class="line" data-line="7"><span style="color: #d19a66;">6</span>               <span style="color: #e06c75;">syscall</span>
</div><div class="line" data-line="8"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span>
</div></code></pre>
<blockquote>
<p>Lembrando que o programa ainda n√£o est√° em execu√ß√£o, estamos apenas analisando o bin√°rio execut√°vel com o gdb</p>
</blockquote>
<p>Com o comando <code>x</code>, de <em>examine</em>, podemos examinar o r√≥tulo <code>_start</code> que √© o ponto de entrada do programa:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">_start</span>
</div><div class="line" data-line="2"><span style="color: #d19a66;">0x401000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">_start</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>      <span style="color: #61afef;">0x000000bf</span>
</div><div class="line" data-line="3"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span>
</div></code></pre>
<p>Se quisermos executar o programa, podemos faz√™-lo com o comando <code>run</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">run</span>
</div><div class="line" data-line="2"><span style="color: #61afef;">Starting</span> <span style="color: #e06c75;">program:</span> <span style="color: #e06c75;">/code/asm-x64/hello</span>
</div><div class="line" data-line="3"><span style="color: #c678dd;">[</span><span style="color: #61afef;">Inferior</span> <span style="color: #d19a66;">1</span> <span style="color: #c678dd;">(</span><span style="color: #61afef;">process</span> <span style="color: #d19a66;">7991</span><span style="color: #c678dd;">)</span> exited normally<span style="color: #c678dd;">]</span>
</div><div class="line" data-line="4"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span>
</div></code></pre>
<p>Entretanto, podemos definir breakpoints antes de executar, assim temos controle do estado do programa <strong>em execu√ß√£o</strong>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Aqui, definimos um ponto de parada no r√≥tulo _start_</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #e5c07b;">break</span> <span style="color: #e06c75;">_start</span>
</div><div class="line" data-line="3"><span style="color: #61afef;">Breakpoint</span> <span style="color: #d19a66;">1</span> <span style="color: #e06c75;">at</span> <span style="color: #e06c75;">0x401000:</span> <span style="color: #e06c75;">file</span> <span style="color: #e06c75;">hello.asm,</span> <span style="color: #e06c75;">line</span> <span style="color: #e06c75;">4.</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #7f848e;"># Info sobre breakpoints</span>
</div><div class="line" data-line="6"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">info</span> <span style="color: #e06c75;">breakpoints</span>
</div><div class="line" data-line="7"><span style="color: #61afef;">Num</span>     <span style="color: #e06c75;">Type</span>           <span style="color: #e06c75;">Disp</span> <span style="color: #e06c75;">Enb</span> <span style="color: #e06c75;">Address</span>            <span style="color: #e06c75;">What</span>
</div><div class="line" data-line="8"><span style="color: #d19a66;">1</span>       <span style="color: #e06c75;">breakpoint</span>     <span style="color: #e06c75;">keep</span> <span style="color: #e06c75;">y</span>   <span style="color: #d19a66;">0x0000000000401000</span> <span style="color: #e06c75;">hello.asm:4</span>
</div><div class="line" data-line="9"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span>
</div></code></pre>
<p>Agora sim, vamos executar:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">run</span>
</div><div class="line" data-line="2"><span style="color: #61afef;">Starting</span> <span style="color: #e06c75;">program:</span> <span style="color: #e06c75;">/code/asm-x64/hello</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #61afef;">Breakpoint</span> <span style="color: #e06c75;">1,</span> <span style="color: #e06c75;">_start</span> <span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span> <span style="color: #e06c75;">at</span> <span style="color: #e06c75;">hello.asm:4</span>
</div><div class="line" data-line="5"><span style="color: #d19a66;">4</span>               <span style="color: #e06c75;">mov</span> <span style="color: #e06c75;">rdi,</span> <span style="color: #d19a66;">0</span>   <span style="color: #abb2bf;">;</span> <span style="color: #61afef;">error</span> <span style="color: #e06c75;">code</span>
</div><div class="line" data-line="6"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span>
</div></code></pre>
<p>O programa est√° parado na linha 4 como solicitado. Esta linha no c√≥digo <strong>n√£o foi avaliada</strong>, pelo que podemos analisar e alterar o estado do programa:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Neste momento o valor no registrador RDI est√° 0 (default)</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">info</span> <span style="color: #e06c75;">register</span> <span style="color: #e06c75;">rdi</span>
</div><div class="line" data-line="3"><span style="color: #61afef;">rdi</span>            <span style="color: #d19a66;">0x0</span>                 <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #7f848e;"># Mudamos o valor do registrador para 42</span>
</div><div class="line" data-line="6"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #e5c07b;">set</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rdi</span> <span style="color: #e06c75;">=</span> <span style="color: #d19a66;">42</span>
</div><div class="line" data-line="7">
</div><div class="line" data-line="8"><span style="color: #7f848e;"># Agora verificamos que foi modificado diretamente do GDB</span>
</div><div class="line" data-line="9"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">info</span> <span style="color: #e06c75;">register</span> <span style="color: #e06c75;">rdi</span>
</div><div class="line" data-line="10"><span style="color: #61afef;">rdi</span>            <span style="color: #e06c75;">0x2a</span>                <span style="color: #d19a66;">42</span>
</div><div class="line" data-line="11"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span>
</div></code></pre>
<p>Para avaliar a linha atual, utilizamos o comando <code>next</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">next</span>
</div><div class="line" data-line="2"><span style="color: #d19a66;">5</span>               <span style="color: #e06c75;">mov</span> <span style="color: #e06c75;">rax,</span> <span style="color: #d19a66;">60</span>  <span style="color: #abb2bf;">;</span> <span style="color: #61afef;">SYS_exit</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #7f848e;"># E podemos agora verificar que o valor de RDI foi modificado para 0, </span>
</div><div class="line" data-line="5"><span style="color: #7f848e;"># conforme descrito no programa</span>
</div><div class="line" data-line="6"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">info</span> <span style="color: #e06c75;">register</span> <span style="color: #e06c75;">rdi</span>
</div><div class="line" data-line="7"><span style="color: #61afef;">rdi</span>            <span style="color: #d19a66;">0x0</span>                 <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="8"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span>
</div></code></pre>
<p>Poder√≠amos continuar indo linha a linha com <code>next</code>, ou ent√£o continuar a execu√ß√£o do programa com <code>continue</code> que p√°ra no pr√≥ximo ponto de parada ou executa todas as instru√ß√µes que faltam at√© terminar o programa.</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Inicia execu√ß√£o e p√°ra no primeiro breakpoint definido</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">run</span>
</div><div class="line" data-line="3"><span style="color: #61afef;">Starting</span> <span style="color: #e06c75;">program:</span> <span style="color: #e06c75;">/Users/leandronsp/Documents/code/asm-x64/hello</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #61afef;">Breakpoint</span> <span style="color: #e06c75;">1,</span> <span style="color: #e06c75;">_start</span> <span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span> <span style="color: #e06c75;">at</span> <span style="color: #e06c75;">hello.asm:4</span>
</div><div class="line" data-line="6"><span style="color: #d19a66;">4</span>               <span style="color: #e06c75;">mov</span> <span style="color: #e06c75;">rdi,</span> <span style="color: #d19a66;">0</span>   <span style="color: #abb2bf;">;</span> <span style="color: #61afef;">error</span> <span style="color: #e06c75;">code</span>
</div><div class="line" data-line="7">
</div><div class="line" data-line="8"><span style="color: #7f848e;"># Continua execu√ß√£o. Neste caso termina o programa pois</span>
</div><div class="line" data-line="9"><span style="color: #7f848e;"># n√£o h√° mais breakpoints a partir deste ponto</span>
</div><div class="line" data-line="10"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #e5c07b;">continue</span>
</div><div class="line" data-line="11"><span style="color: #61afef;">Continuing.</span>
</div><div class="line" data-line="12"><span style="color: #c678dd;">[</span><span style="color: #61afef;">Inferior</span> <span style="color: #d19a66;">1</span> <span style="color: #c678dd;">(</span><span style="color: #61afef;">process</span> <span style="color: #d19a66;">8000</span><span style="color: #c678dd;">)</span> exited normally<span style="color: #c678dd;">]</span>
</div><div class="line" data-line="13"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span>
</div></code></pre>
<p>Pronto, terminamos a demonstra√ß√£o do primeiro programa com <code>gdb</code>. Para sair, utilizamos o comando <code>exit</code>.</p>
<h3><a href="#rastreando-execu√ß√£o-com-strace" aria-hidden="true" class="anchor" id="rastreando-execu√ß√£o-com-strace"></a>Rastreando execu√ß√£o com strace</h3>
<p>O utilit√°rio <code>strace</code> permite rastrear todas as chamadas de sistema e sinais que um programa faz. √â bastante √∫til quando queremos saber o que pode ter acontecido com determinada <em>syscall</em>, quais par√¢metros foram enviados e o que a syscall retornou.</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">strace</span> <span style="color: #e06c75;">./hello</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #61afef;">execve</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;./hello&quot;</span><span style="color: #98c379;">,</span> <span style="color: #e06c75;">[</span><span style="color: #98c379;">&quot;./hello&quot;</span><span style="color: #e06c75;">]</span><span style="color: #e06c75;">,</span> <span style="color: #e06c75;">0x7ffc504b5710</span> <span style="color: #e06c75;">/*</span> <span style="color: #d19a66;">24</span> <span style="color: #e06c75;">vars</span> <span style="color: #e06c75;">*/</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="4"><span style="color: #e5c07b;">exit</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">0</span><span style="color: #c678dd;">)</span>                                 <span style="color: #56b6c2;">=</span> ?
</div><div class="line" data-line="5">+++ <span style="color: #61afef;">exited</span> <span style="color: #e06c75;">with</span> <span style="color: #d19a66;">0</span> <span style="color: #e06c75;">+++</span>
</div></code></pre>
<p>Vamos entender a sa√≠da do <strong>strace</strong> por partes.</p>
<p><em><em>execve(‚Äú./hello‚Äù, [‚Äú./hello‚Äù], 0x7ffc504b5710 /</em> 24 vars <em>/) = 0:</em></em></p>
<ul>
<li><code>execve</code> √© uma chamada do Linux que executa um determinado programa</li>
<li><code>./hello</code> √© o caminho para o programa que ser√° executado</li>
<li><code>[&quot;./hello&quot;]</code> √© a lista de argumentos passados para o programa. Como s√≥ h√° o nome do programa (que entra na lista <em>ARGV</em>), indica que este programa n√£o recebe argumentos extras na linha de comando</li>
<li><code>0x7ffc504b5710</code> √© o endere√ßo de mem√≥ria onde as vari√°veis de ambiente do processo em execu√ß√£o est√£o armazenadas</li>
<li><code>/* 24 vars */</code> indica que h√° 24 vari√°veis de ambiente definidas no shell atual</li>
<li><code>=0</code> √© o resultado da chamada <code>execve</code>, o que significa que foi bem-sucedido e executado com sucesso</li>
</ul>
<p><strong>exit(0) = ?:</strong></p>
<ul>
<li><code>exit</code> √© a chamada de sistema (syscall) feita no sistema operacional, e geralmente √© definida no <code>libc</code>, sendo no caso de sistema GNU, <code>glibc</code>. Foi o valor <em>60</em> passado para o registrador RAX, lembra?</li>
<li><code>(0)</code> √© o par√¢metro passado para a fun√ß√£o, que neste caso foi o que determinamos no registrador RDI, indicando que nosso programa em execu√ß√£o vai terminar <em>sem erros</em></li>
<li><code>= ?</code> indica que o resultado da chamada de sistema n√£o √© conhecido, ou seja n√£o houve um retorno <em>expl√≠cito</em> de valor da chamada de sistema</li>
</ul>
<p><strong>+++ exited with 0 +++:</strong></p>
<ul>
<li><code>+++</code> sinaliza o in√≠cio de uma mensagem de sa√≠da do strace</li>
<li><code>exited with 0</code> indica que o programa terminou sem erros</li>
<li><code>+++</code> sinaliza o fim da mensagem de sa√≠da</li>
</ul>
<p>Uma vez que entendemos como depurar nosso programa, podemos evolui-lo para imprimir a mensagem ‚ÄúHello, World‚Äù na sa√≠da do terminal.</p>
<hr />
<h2><a href="#evoluindo-nosso-primeiro-programa" aria-hidden="true" class="anchor" id="evoluindo-nosso-primeiro-programa"></a>Evoluindo nosso primeiro programa</h2>
<p>Vamos agora evoluir o programa anterior para que possamos imprimir a mensagem ‚ÄúHello, World‚Äù na sa√≠da padr√£o <code>STDOUT</code>.</p>
<p>Para isto, conforme vimos na parte III da saga, ‚ÄúC√≥digo de M√°quina‚Äù, vamos por partes.</p>
<h3><a href="#alocando-bytes-para-hello-world" aria-hidden="true" class="anchor" id="alocando-bytes-para-hello-world"></a>Alocando bytes para ‚ÄúHello, World‚Äù</h3>
<p>Precisamos primeiro definir os bytes de cada caracter da string em <em>hexadecimal</em> de acordo com a tabela ASCII, que resulta em <code>48 65 6C 6C 6F 2C 20 57 6F 72 6C 64 0A</code>.</p>
<blockquote>
<p>0x48 para ‚ÄúH‚Äù, 0x65 para ‚Äúe‚Äù, 0x6C para ‚Äúl‚Äù e assim por diante‚Ä¶</p>
</blockquote>
<p>Portanto, se quisermos evoluir o primeiro programa que cont√©m apenas a syscall <code>exit</code>, podemos come√ßar por definir a string utilizando a diretiva <code>db</code> que significa <em>define byte</em>, utilizando o endere√ßo do primeiro byte em um r√≥tulo que iremos chamar de <em>msg</em>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">msg: db 0x48, 0x65, 0x6C, 0x6C, 0x6F, \
</div><div class="line" data-line="4">		0x2C, 0x20, 0x57, 0x6F, 0x72, \
</div><div class="line" data-line="5">		0x6C, 0x64, 0xA
</div><div class="line" data-line="6">
</div><div class="line" data-line="7">_start:
</div><div class="line" data-line="8">	mov rdi, 0   ; error code
</div><div class="line" data-line="9">	mov rax, 60  ; SYS_exit
</div><div class="line" data-line="10">	syscall       
</div></code></pre>
<p>Antes de sair adicionando mais c√≥digo, vamos utilizar o <code>gdb</code> para analisar o que esta mudan√ßa provoca na mem√≥ria:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Examinar o que h√° no r√≥tulo msg</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">msg</span>
</div><div class="line" data-line="3"><span style="color: #d19a66;">0x401000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">msg</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span> <span style="color: #61afef;">0x6c6c6548</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #7f848e;"># Examinar o que h√° no r√≥tulo _start</span>
</div><div class="line" data-line="6"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">_start</span>
</div><div class="line" data-line="7"><span style="color: #61afef;">0x40100d</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">_start</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>      <span style="color: #61afef;">0x000000bf</span>
</div><div class="line" data-line="8"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span>
</div></code></pre>
<p>Ora ora, o que temos aqui?</p>
<ul>
<li><code>msg</code> aponta para o endere√ßo <code>0x401000</code> que era o endere√ßo usado pelo <code>_start</code> no nosso programa anterior</li>
<li>e agora <code>_start</code> aponta para outro endere√ßo, <code>0x40100d</code> que est√° <strong>13 bytes</strong> (‚Äúd‚Äù em hexa) acima de <code>msg</code>, exatamente os 13 bytes da string ‚ÄúHello, World‚Äù adicionado com quebra de linha!!!!!1</li>
</ul>
<blockquote>
<p>Superb! Mas o que significa o valor <code>0x6c6c6548</code>?</p>
</blockquote>
<p>Se analisarmos com calma, d√° pra perceber que se trata dos caracteres da string em ASCII segundo o que foi definido no programa. Mas eles est√£o <em>invertidos</em>, lembra de endianness que foi explicado no artigo anterior?</p>
<p>Ent√£o, esta arquitetura segue o padr√£o little-endian, onde os bytes s√£o armazenados na ordem inversa, do menos relevante (expoentes menores da base 2) para o mais relevante (expoentes maiores).</p>
<p>Voltando ao gdb, podemos confirmar que todos os bytes da string est√£o alocados trabalhando com ponteiros de 4 em 4 bytes:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">msg</span>
</div><div class="line" data-line="2"><span style="color: #d19a66;">0x401000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">msg</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span> <span style="color: #61afef;">0x6c6c6548</span> <span style="color: #abb2bf;">;</span> <span style="color: #61afef;">Hell</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">msg+4</span>
</div><div class="line" data-line="5"><span style="color: #61afef;">0x401004:</span>       <span style="color: #e06c75;">0x57202c6f</span> <span style="color: #abb2bf;">;</span> <span style="color: #61afef;">o,</span> <span style="color: #e06c75;">W</span>
</div><div class="line" data-line="6">
</div><div class="line" data-line="7"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">msg+8</span>
</div><div class="line" data-line="8"><span style="color: #61afef;">0x401008:</span>       <span style="color: #e06c75;">0x646c726f</span> <span style="color: #abb2bf;">;</span> <span style="color: #61afef;">orld</span>
</div></code></pre>
<p>Ou ent√£o, o comando <code>x</code> permite passar uma quantidade junto com o formato de apresenta√ß√£o, por exemplo queremos que traga os primeiros <em>13 hexabytes</em> a partir do ponteiro <strong>msg</strong>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x/13xb</span> <span style="color: #e06c75;">msg</span>
</div><div class="line" data-line="2"><span style="color: #d19a66;">0x401000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">msg</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span> <span style="color: #d19a66;">0x48</span>    <span style="color: #d19a66;">0x65</span>    <span style="color: #61afef;">0x6c</span>    <span style="color: #61afef;">0x6c</span>    <span style="color: #61afef;">0x6f</span>    <span style="color: #61afef;">0x2c</span>    <span style="color: #d19a66;">0x20</span>    <span style="color: #d19a66;">0x57</span>
</div><div class="line" data-line="3"><span style="color: #61afef;">0x401008:</span>       <span style="color: #e06c75;">0x6f</span>    <span style="color: #d19a66;">0x72</span>    <span style="color: #e06c75;">0x6c</span>    <span style="color: #d19a66;">0x64</span>    <span style="color: #e06c75;">0x0a</span>
</div></code></pre>
<p>Exatamente os hexadecimais da string ‚ÄúHello, World‚Äù com quebra de linha!</p>
<p>Mas em Assembly, n√£o precisamos definir os bytes de uma string em hexadecimal. Podemos utilizar os <em>quotes literais</em>, assim o programa fica menos verboso e o assembler faz o processo de traduzir o caracter para o hexadecimal da tabela ASCII:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">msg: db &quot;Hello, World&quot;, 0xA
</div></code></pre>
<blockquote>
<p>N√£o conseguimos representar a quebra de linha dentro de quotes literais, ent√£o vamos manter esta com 0xA</p>
</blockquote>
<h3><a href="#adicionando-a-chamada-de-sistema-write" aria-hidden="true" class="anchor" id="adicionando-a-chamada-de-sistema-write"></a>Adicionando a chamada de sistema write</h3>
<p>Como j√° sabemos, o programa precisa utilizar a syscall <code>write</code> para escrever na sa√≠da, que est√° definida da seguinte forma no <code>glibc</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-c" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #e5c07b;">ssize_t</span> <span style="color: #61afef;">write</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">int</span> <span style="color: #e06c75;">fd</span><span style="color: #abb2bf;">,</span> <span style="color: #c678dd;">const</span> <span style="color: #e5c07b;">void</span> <span style="color: #e06c75;"><span style="color: #e06c75;">buf</span><span style="color: #c678dd;">[</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">count</span><span style="color: #c678dd;">]</span></span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">size_t</span> <span style="color: #e06c75;">count</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<ul>
<li>nome da syscall vai em RAX</li>
<li>primeiro argumento (file descriptor, no caso o <em>STDOUT</em>) vai em RDI</li>
<li>segundo argumento (ponteiro para o in√≠cio do buffer) vai em RSI</li>
<li>terceiro argumento (quantidade de bytes a serem escritos) vai em RDX</li>
</ul>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">msg: db &quot;Hello, World&quot;, 0xA
</div><div class="line" data-line="4">_start:
</div><div class="line" data-line="5">	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</div><div class="line" data-line="6">	; Chamada de sistema
</div><div class="line" data-line="7">	; glibc -&gt; ssize_t write(int fd, 
</div><div class="line" data-line="8">							 const void buf[.count], 
</div><div class="line" data-line="9">							 size_t count)
</div><div class="line" data-line="10">	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</div><div class="line" data-line="11">	mov rdi, 1   ; STDOUT
</div><div class="line" data-line="12">	mov rsi, msg ; ponteiro para o in√≠cio da string
</div><div class="line" data-line="13">	mov rdx, 13  ; quantidade de bytes a serem escritos
</div><div class="line" data-line="14">	mov rax, 1   ; nome da syscall: SYS_write
</div><div class="line" data-line="15">	syscall      ; chamada de sistema
</div><div class="line" data-line="16">
</div><div class="line" data-line="17">	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</div><div class="line" data-line="18">	; Chamada de sistema
</div><div class="line" data-line="19">	; glibc -&gt; void _exit(int status)
</div><div class="line" data-line="20">	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
</div><div class="line" data-line="21">	mov rdi, 0   ; erro de sa√≠da
</div><div class="line" data-line="22">	mov rax, 60  ; nome da syscall: SYS_exit
</div><div class="line" data-line="23">	syscall           
</div></code></pre>
<p>Ao compilar o programa com <code>nasm + ld</code>, seguindo a mesma l√≥gica do primeiro programa, temos de fato a sa√≠da t√£o desejada:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">$ ./hello
</div><div class="line" data-line="2">Hello, World
</div></code></pre>
<p><em>Yay! que dia maravilhoso!</em></p>
<p>Vamos ver como fica o trace disso tudo agora?</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">strace</span> <span style="color: #e06c75;">./hello</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #61afef;">execve</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;./hello&quot;</span><span style="color: #98c379;">,</span> <span style="color: #e06c75;">[</span><span style="color: #98c379;">&quot;./hello&quot;</span><span style="color: #e06c75;">]</span><span style="color: #e06c75;">,</span> <span style="color: #e06c75;">0x7fff139437f0</span> <span style="color: #e06c75;">/*</span> <span style="color: #d19a66;">24</span> <span style="color: #e06c75;">vars</span> <span style="color: #e06c75;">*/</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="4"><span style="color: #61afef;">write</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">1,</span> <span style="color: #98c379;">&quot;Hello, World\n&quot;</span><span style="color: #e06c75;">,</span> <span style="color: #e06c75;">13Hello,</span> <span style="color: #e06c75;">World</span>
</div><div class="line" data-line="5"><span style="color: #c678dd;">)</span>          <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">13</span>
</div><div class="line" data-line="6"><span style="color: #e5c07b;">exit</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">0</span><span style="color: #c678dd;">)</span>                                 <span style="color: #56b6c2;">=</span> ?
</div><div class="line" data-line="7">+++ <span style="color: #61afef;">exited</span> <span style="color: #e06c75;">with</span> <span style="color: #d19a66;">0</span> <span style="color: #e06c75;">+++</span>
</div></code></pre>
<p>Wow, podemos ver que, agora, o programa executa primeiro a syscall <code>write</code>, que retorna o valor <code>13</code>, que √© quantidade de bytes escritos <em>com sucesso</em>; e a seguir executa a syscall <code>exit</code>, tamb√©m com sucesso, indicando que nosso programa imprime a string na sa√≠da e termina sem erros.</p>
<p>Como ficou o tamanho do programa agora?</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">size</span> <span style="color: #e06c75;">hello</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">   <span style="color: #61afef;">text</span>    <span style="color: #e06c75;">data</span>     <span style="color: #e06c75;">bss</span>     <span style="color: #e06c75;">dec</span>     <span style="color: #e06c75;">hex</span> <span style="color: #e06c75;">filename</span>
</div><div class="line" data-line="4">     <span style="color: #d19a66;">52</span>       <span style="color: #d19a66;">0</span>       <span style="color: #d19a66;">0</span>      <span style="color: #d19a66;">52</span>      <span style="color: #d19a66;">34</span> <span style="color: #e06c75;">hello</span>
</div></code></pre>
<p>Hmm, parece que a se√ß√£o <code>text</code> aumentou de tamanho, que √© a adi√ß√£o da string ‚ÄúHello, World‚Äù e das instru√ß√µes para a syscall <code>write</code>. Mas por enquanto √© a √∫nica se√ß√£o existente:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">size</span> <span style="color: #e06c75;">--format</span> <span style="color: #e06c75;">sysv</span> <span style="color: #e06c75;">--radix</span> <span style="color: #d19a66;">16</span> <span style="color: #e06c75;">hello</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #61afef;">hello</span>  <span style="color: #e06c75;">:</span>
</div><div class="line" data-line="4"><span style="color: #61afef;">section</span>           <span style="color: #e06c75;">size</span>       <span style="color: #e06c75;">addr</span>
</div><div class="line" data-line="5"><span style="color: #61afef;">.text</span>             <span style="color: #d19a66;">0x34</span>   <span style="color: #d19a66;">0x401000</span>
</div><div class="line" data-line="6"><span style="color: #c678dd;">(</span><span style="color: #61afef;">omitindo</span> <span style="color: #e06c75;">se√ß√µes</span> <span style="color: #e06c75;">de</span> <span style="color: #e06c75;">debug</span><span style="color: #c678dd;">)</span>
</div><div class="line" data-line="7"><span style="color: #61afef;">Total</span>            <span style="color: #d19a66;">0x139</span>
</div><div class="line" data-line="8">
</div></code></pre>
<p>Podemos ver que a string definida no r√≥tulo <code>msg</code>, que come√ßa no endere√ßo <code>0x401000</code> est√° contida na se√ß√£o <code>.text</code>.</p>
<blockquote>
<p>Isto √© um problema?</p>
</blockquote>
<p>Mais ou menos:</p>
<ol>
<li>O r√≥tulo <code>msg</code> , que √© um ‚Äúdado‚Äù, contendo a string, est√° definido num endere√ßo de mem√≥ria <strong>anterior</strong>, ou seja, em endere√ßo de mem√≥ria mais baixo em dire√ß√£o a 0</li>
<li>O r√≥tulo <code>_start</code>, que √© o in√≠cio do programa, est√° definido num endere√ßo <strong>posterior</strong>, ou seja, em endere√ßo de mem√≥ria mais alto com rela√ß√£o √† string</li>
</ol>
<p>No sistema operacional, todo programa √© encapsulado em um processo tal como vimos no artigo anterior. E sendo um processo, √© submetido a um ‚Äúlayout‚Äù que deve seguir algumas regras.</p>
<h3><a href="#layout-de-mem√≥ria" aria-hidden="true" class="anchor" id="layout-de-mem√≥ria"></a>Layout de mem√≥ria</h3>
<p>Fazendo paralelo com a sa√≠da do comando <code>size</code>, a mem√≥ria do programa segue um layout, que basicamente cont√©m as seguintes se√ß√µes, ou <em>segmentos</em> de mem√≥ria:</p>
<ul>
<li>text</li>
<li>data</li>
<li>bss</li>
</ul>
<p>J√° falamos disto anteriormente neste artigo, mas basicamente na se√ß√£o <code>text</code> fica todo o c√≥digo, instru√ß√µes do programa.</p>
<p>Na se√ß√£o <code>data</code>, ficam dados inicializados (aqui deveria estar a nossa string). E na se√ß√£o <code>bss</code> v√£o os dados n√£o-inicializados, mas j√° com uma √°rea pr√©-alocada na mem√≥ria.</p>
<p>Em termos de <strong>espa√ßo virtual de mem√≥ria</strong> do programa, a se√ß√£o <code>text</code> deve ficar nos endere√ßos de mem√≥ria mais baixos, pr√≥ximos ao entry point <code>0x401000</code>.</p>
<p>Com isto, o programa deve crescer a partir da se√ß√£o <code>text</code> em dire√ß√£o a <code>data</code> e <code>bss</code>, dos menores endere√ßos de mem√≥ria para os maiores (da esquerda pra direita):</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #61afef;">text</span> <span style="color: #e06c75;">-</span><span style="color: #56b6c2;">&gt;</span> <span style="color: #61afef;">data</span> <span style="color: #61afef;">-</span><span style="color: #56b6c2;">&gt;</span> <span style="color: #61afef;">bss</span>
</div></code></pre>
<p>Ou ent√£o, analisando numa imagem em vertical, de baixo pra cima:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/yy0iqqbaz3ox378srcw6.png" alt="layout de memoria 2" /></p>
<p>Existem mais se√ß√µes no layout mas vamos adicion√°-las √† medida que avan√ßamos no artigo. Por agora, como nosso programa est√° tratando dados (<code>msg</code>) como <code>text</code>, devemos colocar na se√ß√£o correta, que √© <code>data</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">; segmento de dados (endere√ßos mais altos)
</div><div class="line" data-line="4">section .data
</div><div class="line" data-line="5">msg: db &quot;Hello, World&quot;, 0xA
</div><div class="line" data-line="6">
</div><div class="line" data-line="7">; segmento de texto (endere√ßos mais baixos)
</div><div class="line" data-line="8">section .text
</div><div class="line" data-line="9">_start:
</div><div class="line" data-line="10">	mov rdi, 1   ; STDOUT
</div><div class="line" data-line="11">	mov rsi, msg ; ponteiro para o in√≠cio da string
</div><div class="line" data-line="12">	mov rdx, 13  ; quantidade de bytes a serem escritos
</div><div class="line" data-line="13">	mov rax, 1   ; nome da syscall: SYS_write
</div><div class="line" data-line="14">	syscall      ; chamada de sistema
</div><div class="line" data-line="15">
</div><div class="line" data-line="16">	mov rdi, 0   ; erro de sa√≠da
</div><div class="line" data-line="17">	mov rax, 60  ; nome da syscall: SYS_exit
</div><div class="line" data-line="18">	syscall  
</div></code></pre>
<p>Com <code>gdb</code>, podemos conferir que agora estamos obedecendo o layout de mem√≥ria estabelecido para o programa:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">_start</span>
</div><div class="line" data-line="2"><span style="color: #d19a66;">0x401000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">_start</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>      <span style="color: #61afef;">0x000000bf</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">msg</span>
</div><div class="line" data-line="5"><span style="color: #d19a66;">0x402000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">msg</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span> <span style="color: #61afef;">0x6c6c6548</span>
</div><div class="line" data-line="6"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span>
</div></code></pre>
<blockquote>
<p>Note que para acessar <code>msg</code> no segmento de dados, precisamos examinar atrav√©s da <em>refer√™ncia</em>, com o operador <code>&amp;</code></p>
</blockquote>
<h3><a href="#definindo-constantes" aria-hidden="true" class="anchor" id="definindo-constantes"></a>Definindo constantes</h3>
<p>Em Assembly podemos definir constantes que podem ser reutilizadas em diversas partes do programa, evitando assim alguma redund√¢ncia com repeti√ß√£o de c√≥digo e valores.</p>
<p>A diretiva <code>%define</code> permite definir valores constantes tanto para string quanto n√∫meros:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">%define SYS_write 1
</div><div class="line" data-line="4">%define SYS_exit 60
</div><div class="line" data-line="5">%define EXIT_STATUS 1
</div><div class="line" data-line="6">%define STDOUT 1
</div><div class="line" data-line="7">%define NEWLINE 0xA
</div><div class="line" data-line="8">
</div><div class="line" data-line="9">section .data
</div><div class="line" data-line="10">msg: db &quot;Hello, World&quot;, NEWLINE
</div><div class="line" data-line="11">
</div><div class="line" data-line="12">section .text
</div><div class="line" data-line="13">_start:
</div><div class="line" data-line="14">	mov rdi, STDOUT
</div><div class="line" data-line="15">	mov rsi, msg 
</div><div class="line" data-line="16">	mov rdx, 13
</div><div class="line" data-line="17">	mov rax, SYS_write
</div><div class="line" data-line="18">	syscall      
</div><div class="line" data-line="19">
</div><div class="line" data-line="20">	mov rdi, EXIT_STATUS
</div><div class="line" data-line="21">	mov rax, SYS_exit
</div><div class="line" data-line="22">	syscall  
</div></code></pre>
<p>Podemos tamb√©m definir uma constante baseada em uma express√£o aritm√©tica. Por exemplo, ao inv√©s de deixarmos o tamanho em bytes com valor fixo <em>13</em>, podemos fazer que isto seja calculado com base em aritm√©tica de ponteiros na mem√≥ria com a diretiva <code>equ</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">...
</div><div class="line" data-line="2">section .data
</div><div class="line" data-line="3">msg: db &quot;Hello, World&quot;, NEWLINE
</div><div class="line" data-line="4">msgLen: equ $ - msg
</div><div class="line" data-line="5">...
</div></code></pre>
<p>O operador <code>$</code> tem o ponteiro de mem√≥ria para o √∫ltimo byte no programa, no caso o <code>NEWLINE</code> definido na linha anterior. Ao subtrair do ponteiro <code>msg</code> com a express√£o <code>$ - msg</code>, temos o tamanho em bytes calculado e desta forma n√£o precisa ser um valor fixo em RDX:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">%define SYS_write 1
</div><div class="line" data-line="4">%define SYS_exit 60
</div><div class="line" data-line="5">%define EXIT_STATUS 1
</div><div class="line" data-line="6">%define STDOUT 1
</div><div class="line" data-line="7">%define NEWLINE 0xA
</div><div class="line" data-line="8">
</div><div class="line" data-line="9">section .data
</div><div class="line" data-line="10">msg: db &quot;Hello, World&quot;, NEWLINE
</div><div class="line" data-line="11">msgLen: equ $ - msg
</div><div class="line" data-line="12">
</div><div class="line" data-line="13">section .text
</div><div class="line" data-line="14">_start:
</div><div class="line" data-line="15">	mov rdi, STDOUT
</div><div class="line" data-line="16">	mov rsi, msg 
</div><div class="line" data-line="17">	mov rdx, msgLen
</div><div class="line" data-line="18">	mov rax, SYS_write
</div><div class="line" data-line="19">	syscall      
</div><div class="line" data-line="20">
</div><div class="line" data-line="21">	mov rdi, EXIT_STATUS
</div><div class="line" data-line="22">	mov rax, SYS_exit
</div><div class="line" data-line="23">	syscall  
</div></code></pre>
<p><em>Wonderful! Nosso programa agora t√° muito mais elegante!</em></p>
<p>Ufa, parece que terminamos o nosso primeiro programa e este por si s√≥ j√° foi uma jornada longa. Mas tenha um pouco mais de paci√™ncia, <strong>vem comigo</strong>, pois chegou o momento de escrevermos um programa um pouco mais sofisticado.</p>
<p>Hora de explorar mais funcionalidades no Assembly e entrar no mundo da <em>stack</em>.</p>
<hr />
<h2><a href="#um-programa-mais-sofisticado" aria-hidden="true" class="anchor" id="um-programa-mais-sofisticado"></a>Um programa mais sofisticado</h2>
<p>Vamos come√ßar por um programa simples e evoluindo conforme depuramos e entendemos a mem√≥ria. Ao fim, o programa deve ser capaz de receber um nome atrav√©s dos argumentos da linha de comando e imprimir ‚ÄúHi, <code>&lt;nome&gt;</code>‚Äù.</p>
<p>Desejado:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1">$ <span style="color: #61afef;">./greeting</span> <span style="color: #e06c75;">Leandro</span>
</div><div class="line" data-line="2"><span style="color: #61afef;">Hi,</span> <span style="color: #e06c75;">Leandro</span>
</div></code></pre>
<h3><a href="#definindo-labels" aria-hidden="true" class="anchor" id="definindo-labels"></a>Definindo labels</h3>
<p>J√° sabemos que o programa precisa imprimir ‚ÄúHi, ‚Äú alguma coisa. Ent√£o as instru√ß√µes pra syscall <code>write</code> s√£o necess√°rias, e j√° fazendo uso de constantes:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">%define SYS_write 1
</div><div class="line" data-line="4">%define SYS_exit 60
</div><div class="line" data-line="5">%define STDOUT 1
</div><div class="line" data-line="6">
</div><div class="line" data-line="7">section .data
</div><div class="line" data-line="8">greet: db &quot;Hi&quot;, 0xA
</div><div class="line" data-line="9">
</div><div class="line" data-line="10">section .text
</div><div class="line" data-line="11">_start:
</div><div class="line" data-line="12">	mov rdi, STDOUT
</div><div class="line" data-line="13">	mov rsi, greet
</div><div class="line" data-line="14">	mov rdx, 3
</div><div class="line" data-line="15">	mov rax, SYS_write
</div><div class="line" data-line="16">	syscall
</div><div class="line" data-line="17">	
</div><div class="line" data-line="18">	mov rdi, 0
</div><div class="line" data-line="19">	mov rax, SYS_exit
</div><div class="line" data-line="20">	syscall
</div></code></pre>
<p>Este programa imprime ‚ÄúHi‚Äù apenas. Mas podemos melhorar a organiza√ß√£o separando em blocos com algum valor <em>sem√¢ntico</em>:</p>
<ul>
<li>separar o bloco de <code>exit</code></li>
<li>separar o bloco de <code>write</code></li>
</ul>
<p>Assembly emprega o conceito de <strong>labels</strong>, que s√£o r√≥tulos, mas que podem ser definidas em qualquer parte do c√≥digo. Utilizando o caracter <em>ponto</em> (<code>.</code>), o programa fica bem mais expressivo:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">%define SYS_write 1
</div><div class="line" data-line="4">%define SYS_exit 60
</div><div class="line" data-line="5">%define STDOUT 1
</div><div class="line" data-line="6">
</div><div class="line" data-line="7">section .data
</div><div class="line" data-line="8">greet: db &quot;Hi&quot;, 0xA
</div><div class="line" data-line="9">
</div><div class="line" data-line="10">section .text
</div><div class="line" data-line="11">_start:
</div><div class="line" data-line="12">.print:
</div><div class="line" data-line="13">	mov rdi, STDOUT
</div><div class="line" data-line="14">	mov rsi, greet
</div><div class="line" data-line="15">	mov rdx, 3
</div><div class="line" data-line="16">	mov rax, SYS_write
</div><div class="line" data-line="17">	syscall
</div><div class="line" data-line="18">.exit:
</div><div class="line" data-line="19">	mov rdi, 0
</div><div class="line" data-line="20">	mov rax, SYS_exit
</div><div class="line" data-line="21">	syscall
</div></code></pre>
<p>Assim como qualquer r√≥tulo, o programa vai executando top-down. O que fizemos aqui foi apenas colocar r√≥tulos em determinadas partes do programa, mas sem <em>alterar seu fluxo de execu√ß√£o</em>.</p>
<h3><a href="#desvio-de-fluxo-com-jump" aria-hidden="true" class="anchor" id="desvio-de-fluxo-com-jump"></a>Desvio de fluxo com jump</h3>
<p>Se quisermos alterar o fluxo de execu√ß√£o, podemos utilizar a instru√ß√£o <code>JMP</code> que altera o fluxo do programa para outro ponto, continuando <em>a partir desde novo ponto</em>.</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">%define SYS_write 1
</div><div class="line" data-line="4">%define SYS_exit 60
</div><div class="line" data-line="5">%define STDOUT 1
</div><div class="line" data-line="6">
</div><div class="line" data-line="7">section .data
</div><div class="line" data-line="8">greet: db &quot;Hi&quot;, 0xA
</div><div class="line" data-line="9">
</div><div class="line" data-line="10">section .text
</div><div class="line" data-line="11">_start:
</div><div class="line" data-line="12">	; Faz o jump para a label .print, sem passar por .exit
</div><div class="line" data-line="13">	jmp .print
</div><div class="line" data-line="14">.exit:
</div><div class="line" data-line="15">	mov rdi, 0
</div><div class="line" data-line="16">	mov rax, SYS_exit
</div><div class="line" data-line="17">	syscall
</div><div class="line" data-line="18">.print:
</div><div class="line" data-line="19">	mov rdi, STDOUT
</div><div class="line" data-line="20">	mov rsi, greet
</div><div class="line" data-line="21">	mov rdx, 3
</div><div class="line" data-line="22">	mov rax, SYS_write
</div><div class="line" data-line="23">	syscall
</div><div class="line" data-line="24">	
</div><div class="line" data-line="25">	; Faz o jump para a label .exit, caso contr√°rio o programa n√£o terminaria
</div><div class="line" data-line="26">	; da forma adequada (todo programa deve terminar)
</div><div class="line" data-line="27">	jmp .exit
</div></code></pre>
<p>Este foi um exemplo bastante simples com jump e desvio de fluxo. Mas √© poss√≠vel tamb√©m desviar o fluxo, executar a l√≥gica do novo fluxo, e <em>retornar</em> ao ponto anterior.</p>
<p>Entretanto, para que isto funcione, vamos imaginar uma poss√≠vel solu√ß√£o:</p>
<ul>
<li>definir algum registrador ‚Äúespecial‚Äù que guarda sempre o ponteiro da pr√≥xima instru√ß√£o</li>
<li>antes de desviar o fluxo, guardar o endere√ßo de mem√≥ria da pr√≥xima instru√ß√£o do programa em alguma <em>estrutura de dados</em> para que possa ser resgatado quando a l√≥gica do desvio terminar</li>
</ul>
<p>Sim, estamos falando do desvio com <code>call</code>, <code>ret</code>, registradores e pilha.</p>
<h3><a href="#desvio-de-fluxo-com-call" aria-hidden="true" class="anchor" id="desvio-de-fluxo-com-call"></a>Desvio de fluxo com call</h3>
<p>Tendo o exemplo anterior, ao inv√©s de fazer <code>jmp</code>, vamos utilizar a instru√ß√£o <code>call</code> que faz o desvio para outra rotina:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">call .print  ; &lt;------ chamada da rotina
</div></code></pre>
<p>Al√©m disso, a √∫ltima linha da rotina <code>.print</code> deve ‚Äúretornar‚Äù o fluxo desviado para o ponto anterior.</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">.print:
</div><div class="line" data-line="2">	mov rdi, STDOUT
</div><div class="line" data-line="3">	mov rsi, greet
</div><div class="line" data-line="4">	mov rdx, 3
</div><div class="line" data-line="5">	mov rax, SYS_write
</div><div class="line" data-line="6">	syscall
</div><div class="line" data-line="7">	ret  ; &lt;------ retorno da rotina
</div></code></pre>
<p>Antes de analisarmos com <code>gdb</code> passo a passo, precisamos entender um aspecto importante dos programas no sistema operacional.</p>
<p>Quando um programa √© executado, ele √© definido em uma estrutura chamada <strong>processo</strong> (j√° falamos disto no artigo anterior). Todo processo carrega o layout de mem√≥ria definido no bin√°rio do programa, conforme vimos anteriormente:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">text -&gt; data -&gt; bss
</div></code></pre>
<p>Nos endere√ßos mais <em>altos</em> da mem√≥ria virtual do processo (programa em execu√ß√£o), o sistema operacional tamb√©m define uma outra estrutura de dados, chamada <strong>stack</strong>, que tem um formato de pilha (LIFO, Last In, First Out).</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">text -&gt; data -&gt; bss ---------&gt; &lt;-------- stack
</div></code></pre>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/z7lyluh9a4hqkzl3yo7s.png" alt="layout de mem√≥ria com stack" /></p>
<p>A stack fica nos endere√ßos mais altos e carrega informa√ß√µes como argumentos do programa, lista de vari√°veis de ambiente definidas no <em>shell</em>, argumentos para fun√ß√µes entre qualquer informa√ß√£o pertinente para o programa. Stack sempre cresce <em>para baixo</em> em dire√ß√£o aos endere√ßos menores.</p>
<p><strong>rsp</strong><br />
Em um programa Assembly x86, √© preciso armazenar o ponteiro atual do topo da stack, e esta informa√ß√£o fica no registrador RSP, ou <em>stack pointer</em>.</p>
<p><strong>rip</strong><br />
J√° o ponteiro da instru√ß√£o atual fica no registrador RIP, ou <em>instruction pointer</em>.</p>
<p>Com estes dois registradores conseguimos demonstrar o uso de call e ret para desvio de fluxo. Voltando ao programa:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">%define SYS_write 1
</div><div class="line" data-line="4">%define SYS_exit 60
</div><div class="line" data-line="5">%define STDOUT 1
</div><div class="line" data-line="6">
</div><div class="line" data-line="7">section .data
</div><div class="line" data-line="8">greet: db &quot;Hi&quot;, 0xA
</div><div class="line" data-line="9">
</div><div class="line" data-line="10">section .text
</div><div class="line" data-line="11">_start:
</div><div class="line" data-line="12">	call .print     ; &lt;--------- desvio do fluxo
</div><div class="line" data-line="13">	
</div><div class="line" data-line="14">	; aqui neste ponto, j√° continua a execu√ß√£o normal em dire√ß√£o ao exit
</div><div class="line" data-line="15">	; para terminar o programa
</div><div class="line" data-line="16">.exit:
</div><div class="line" data-line="17">	mov rdi, 0
</div><div class="line" data-line="18">	mov rax, SYS_exit
</div><div class="line" data-line="19">	syscall
</div><div class="line" data-line="20">.print:
</div><div class="line" data-line="21">	mov rdi, STDOUT
</div><div class="line" data-line="22">	mov rsi, greet
</div><div class="line" data-line="23">	mov rdx, 3
</div><div class="line" data-line="24">	mov rax, SYS_write
</div><div class="line" data-line="25">	syscall
</div><div class="line" data-line="26">	ret            ; &lt;---------- retorno ao ponto anterior
</div></code></pre>
<p>E agora demonstrando com <code>gdb</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">gdb</span> <span style="color: #e06c75;">greeting</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #7f848e;"># Breakpoint em _start, in√≠cio do programa</span>
</div><div class="line" data-line="4"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #e5c07b;">break</span> <span style="color: #e06c75;">_start_</span>
</div><div class="line" data-line="5"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">run</span>
</div><div class="line" data-line="6">
</div><div class="line" data-line="7"><span style="color: #7f848e;"># RIP apontando para 0x401000 (_start), o entry point do programa</span>
</div><div class="line" data-line="8"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">info</span> <span style="color: #e06c75;">register</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rip</span>
</div><div class="line" data-line="9"><span style="color: #61afef;">rip</span>            <span style="color: #d19a66;">0x401000</span>            <span style="color: #d19a66;">0x401000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">_start</span><span style="color: #56b6c2;">&gt;</span>
</div><div class="line" data-line="10">
</div><div class="line" data-line="11"><span style="color: #7f848e;"># RSP apontando para um endere√ßo de mem√≥ria</span>
</div><div class="line" data-line="12"><span style="color: #7f848e;"># Se formos examinar com x $rsp, temos</span>
</div><div class="line" data-line="13"><span style="color: #7f848e;"># 0x7fffffffe450: 0x00000001, que √© a quantidade de argumentos</span>
</div><div class="line" data-line="14"><span style="color: #7f848e;"># passados, no caso 1 representa apenas o nome do programa, ou seja</span>
</div><div class="line" data-line="15"><span style="color: #7f848e;"># n√£o h√° argumentos na linha de comando</span>
</div><div class="line" data-line="16"><span style="color: #c678dd;">(</span>gdb) i r <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsp</span>
</div><div class="line" data-line="17"><span style="color: #61afef;">rsp</span>            <span style="color: #e06c75;">0x7fffffffe450</span>      <span style="color: #e06c75;">0x7fffffffe450</span>
</div></code></pre>
<p>At√© aqui okay, agora vamos andar um <code>step</code> para que o desvio de <code>call</code> seja avaliado e analisar o RIP:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">step</span>
</div><div class="line" data-line="2"><span style="color: #d19a66;">18</span>              <span style="color: #e06c75;">mov</span> <span style="color: #e06c75;">rdi,</span> <span style="color: #e06c75;">STDOUT</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #7f848e;"># O RIP andou conforme esperado</span>
</div><div class="line" data-line="5"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rip</span>
</div><div class="line" data-line="6"><span style="color: #61afef;">rip</span>            <span style="color: #d19a66;">0x401011</span>            <span style="color: #d19a66;">0x401011</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">_start.print</span><span style="color: #56b6c2;">&gt;</span>
</div><div class="line" data-line="7">
</div><div class="line" data-line="8"><span style="color: #7f848e;"># RIP apontando para 0x000001bf, que √© BF 01 00 00 </span>
</div><div class="line" data-line="9"><span style="color: #7f848e;"># Lembra? √© o opcode pra MOV RDI, 1</span>
</div><div class="line" data-line="10"><span style="color: #7f848e;"># Exatamente onde paramos</span>
</div><div class="line" data-line="11"><span style="color: #c678dd;">(</span>gdb) x <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rip</span>
</div><div class="line" data-line="12"><span style="color: #d19a66;">0x401011</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">_start.print</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>        <span style="color: #61afef;">0x000001bf</span>
</div></code></pre>
<p>E a stack (RSP) como ficou?</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># A pilha andou alguns bytes (no caso foi feito um &quot;push&quot;, o que a fez crescer para endere√ßos de mem√≥rias menores)</span>
</div><div class="line" data-line="2"><span style="color: #7f848e;"># Lembra? Pilha &quot;cresce pra baixo&quot; na mem√≥ria</span>
</div><div class="line" data-line="3"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">rsp</span>
</div><div class="line" data-line="4"><span style="color: #61afef;">rsp</span>            <span style="color: #e06c75;">0x7fffffffe448</span>      <span style="color: #e06c75;">0x7fffffffe448</span>
</div><div class="line" data-line="5">
</div><div class="line" data-line="6"><span style="color: #7f848e;"># Opaaa, o que temos aqui? 0x00401005</span>
</div><div class="line" data-line="7"><span style="color: #7f848e;"># √â alguma pista...</span>
</div><div class="line" data-line="8"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsp</span>
</div><div class="line" data-line="9"><span style="color: #61afef;">0x7fffffffe448:</span> <span style="color: #d19a66;">0x00401005</span>
</div><div class="line" data-line="10">
</div><div class="line" data-line="11"><span style="color: #7f848e;"># Examinando o ponteiro do in√≠cio do programa...</span>
</div><div class="line" data-line="12"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">_start</span>
</div><div class="line" data-line="13"><span style="color: #d19a66;">0x401000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">_start</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>      <span style="color: #61afef;">0x00000ce8</span>
</div><div class="line" data-line="14">
</div><div class="line" data-line="15"><span style="color: #7f848e;"># Se andarmos alguns bytes, </span>
</div><div class="line" data-line="16"><span style="color: #7f848e;"># temos exatamente o endere√ßo da label .exit, 0x401005</span>
</div><div class="line" data-line="17"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">_start</span> <span style="color: #e06c75;">+</span> <span style="color: #d19a66;">5</span>
</div><div class="line" data-line="18"><span style="color: #d19a66;">0x401005</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">_start.exit</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span> <span style="color: #61afef;">0x000000bf</span>
</div></code></pre>
<p>Se voc√™ prestou aten√ß√£o nos coment√°rios do snippet acima‚Ä¶</p>
<blockquote>
<p>√â muito importante prestar aten√ß√£o em todos os coment√°rios, se n√£o estiver fazendo isso, volte o artigo do in√≠cio e tente acompanhar <em>no terminal</em>, √© extremamente importante para entender os conceitos</p>
</blockquote>
<p>‚Ä¶se prestarmos a devida aten√ß√£o, este √© o endere√ßo que t√° no topo da pilha agora, que foi adicionado pela instru√ß√£o <code>call</code>.</p>
<blockquote>
<p>Ok Leandro, mas como fazemos ent√£o para voltar ao ponto anterior?</p>
</blockquote>
<p>Calma, jovem. Estamos parados no in√≠cio da rotina <code>.print</code>. Vamos continuar a depura√ß√£o com <code>gdb</code> at√© parar em <code>ret</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">next</span>
</div><div class="line" data-line="2"><span style="color: #d19a66;">19</span>              <span style="color: #e06c75;">mov</span> <span style="color: #e06c75;">rsi,</span> <span style="color: #e06c75;">greet</span>
</div><div class="line" data-line="3"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">next</span>
</div><div class="line" data-line="4"><span style="color: #d19a66;">20</span>              <span style="color: #e06c75;">mov</span> <span style="color: #e06c75;">rdx,</span> <span style="color: #d19a66;">3</span>
</div><div class="line" data-line="5"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">next</span>
</div><div class="line" data-line="6"><span style="color: #d19a66;">21</span>              <span style="color: #e06c75;">mov</span> <span style="color: #e06c75;">rax,</span> <span style="color: #e06c75;">SYS_write</span>
</div><div class="line" data-line="7"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">next</span>
</div><div class="line" data-line="8"><span style="color: #d19a66;">22</span>              <span style="color: #e06c75;">syscall</span>
</div><div class="line" data-line="9"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">next</span>
</div><div class="line" data-line="10"><span style="color: #61afef;">Hi</span>
</div><div class="line" data-line="11"><span style="color: #61afef;">_start.print</span> <span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span> <span style="color: #e06c75;">at</span> <span style="color: #e06c75;">greeting.asm:23</span>
</div><div class="line" data-line="12"><span style="color: #d19a66;">23</span>              <span style="color: #e06c75;">ret</span>
</div><div class="line" data-line="13"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span>
</div></code></pre>
<p>Nice, antes de avaliar a instru√ß√£o <code>ret</code>, podemos ver que RIP andou mas RSP continua na mesma, com o endere√ßo da pr√≥xima instru√ß√£o antes do desvio:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># RIP aponta para a instru√ß√£o da linha &quot;ret&quot;</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rip</span>
</div><div class="line" data-line="3"><span style="color: #61afef;">0x40102c</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">_start.print+27</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>     <span style="color: #61afef;">0x000000c3</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #7f848e;"># RSP aponta para o endere√ßo de mem√≥ria que est√° a instru√ß√£o .exit, que</span>
</div><div class="line" data-line="6"><span style="color: #7f848e;"># vem a seguir ao desvio feito com &quot;call&quot; l√° em cima</span>
</div><div class="line" data-line="7"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsp</span>
</div><div class="line" data-line="8"><span style="color: #61afef;">0x7fffffffe448:</span> <span style="color: #d19a66;">0x00401005</span>
</div></code></pre>
<p>Vamos andar com <code>ret</code> e‚Ä¶.</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># RIP agora aponta para 0x401005, que √© a instru√ß√£o .exit</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rip</span>
</div><div class="line" data-line="3"><span style="color: #d19a66;">0x401005</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">_start.exit</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span> <span style="color: #61afef;">0x000000bf</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #7f848e;"># Foi feito &quot;pop&quot; em RSP e agora este aponta para o topo da pilha</span>
</div><div class="line" data-line="6"><span style="color: #7f848e;"># com o valor exato quando estava no in√≠cio do programa</span>
</div><div class="line" data-line="7"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsp</span>
</div><div class="line" data-line="8"><span style="color: #61afef;">0x7fffffffe450:</span> <span style="color: #d19a66;">0x00000001</span>
</div><div class="line" data-line="9"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span>
</div></code></pre>
<p><em>OMG!! Acabamos de demonstrar manipula√ß√£o de registradores e pilhas</em>.</p>
<h3><a href="#brincando-com-pilhas" aria-hidden="true" class="anchor" id="brincando-com-pilhas"></a>Brincando com pilhas</h3>
<p><em>Pilhas √© divertido.</em></p>
<blockquote>
<p>Mas prefiro filas, gosto de tratar as coisas de modo ordenado. Quem chega primeiro precisa ser atendido primeiro kkkkkkkk</p>
</blockquote>
<p>Mas com pilhas n√£o √© assim. Quem entra por √∫ltimo sai primeiro.</p>
<p>Com base nisto, como podemos manipular a stack do programa? Vamos alterar um pouco o c√≥digo adicionando o ponteiro de <code>greet</code> na stack:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">%define SYS_write 1
</div><div class="line" data-line="4">%define SYS_exit 60
</div><div class="line" data-line="5">%define STDOUT 1
</div><div class="line" data-line="6">
</div><div class="line" data-line="7">section .data
</div><div class="line" data-line="8">greet: db &quot;Hi&quot;, 0xA
</div><div class="line" data-line="9">
</div><div class="line" data-line="10">section .text
</div><div class="line" data-line="11">_start:
</div><div class="line" data-line="12">	push greet    ; &lt;----- adiciona o ponteiro de greet na stack
</div><div class="line" data-line="13">	call .print
</div><div class="line" data-line="14">.exit:
</div><div class="line" data-line="15">	mov rdi, 0
</div><div class="line" data-line="16">	mov rax, SYS_exit
</div><div class="line" data-line="17">	syscall
</div><div class="line" data-line="18">.print:
</div><div class="line" data-line="19">	mov rdi, STDOUT
</div><div class="line" data-line="20">	mov rsi, greet
</div><div class="line" data-line="21">	mov rdx, 3
</div><div class="line" data-line="22">	mov rax, SYS_write
</div><div class="line" data-line="23">	syscall
</div><div class="line" data-line="24">	ret
</div></code></pre>
<p>No <code>gdb</code>, vamos colocar um breakpoint na linha da chamada <code>call</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Breakpoint na linha 13</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">b</span> <span style="color: #d19a66;">13</span>
</div><div class="line" data-line="3"><span style="color: #61afef;">Breakpoint</span> <span style="color: #d19a66;">1</span> <span style="color: #e06c75;">at</span> <span style="color: #e06c75;">0x401005:</span> <span style="color: #e06c75;">file</span> <span style="color: #e06c75;">greeting.asm,</span> <span style="color: #e06c75;">line</span> <span style="color: #e06c75;">13.</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #7f848e;"># Run</span>
</div><div class="line" data-line="6"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">r</span>
</div><div class="line" data-line="7">
</div><div class="line" data-line="8"><span style="color: #7f848e;"># Examinando o topo da pilha</span>
</div><div class="line" data-line="9"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsp</span>
</div><div class="line" data-line="10"><span style="color: #61afef;">0x7fffffffe448:</span> <span style="color: #d19a66;">0x00402000</span>
</div><div class="line" data-line="11">
</div><div class="line" data-line="12"><span style="color: #7f848e;"># Examinando o endere√ßo de mem√≥ria que t√° no topo da pilha</span>
</div><div class="line" data-line="13"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #d19a66;">0x00402000</span>
</div><div class="line" data-line="14"><span style="color: #d19a66;">0x402000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">greet</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>       <span style="color: #61afef;">0x2c0a6948</span>
</div></code></pre>
<p><em>Cool</em>, temos <code>0x48 0x69 0x0A</code> (little-endian), exatamente a string ‚ÄúHi‚Äù seguida de uma quebra de linha. Com esta rica informa√ß√£o, ao inv√©s da rotina <code>.print</code> passar pro registrador RSI o ponteiro de <code>greet</code>, porque n√£o passar o ponteiro do topo da pilha?</p>
<p>Algo nessa linha:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">; ao inv√©s disso (atual)
</div><div class="line" data-line="2">mov rsi, greet
</div><div class="line" data-line="3">
</div><div class="line" data-line="4">; que tal mover o ponteiro que t√° em rsp (topo da pilha) para rsi
</div><div class="line" data-line="5">mov rsi, rsp
</div></code></pre>
<p>Por enquanto, seguramos esta ideia no bolso. Ainda no <code>gdb</code>, vamos continuar analisando a pilha depois de entrar na rotina:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">step</span>
</div><div class="line" data-line="2"><span style="color: #61afef;">_start.print</span> <span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span> <span style="color: #e06c75;">at</span> <span style="color: #e06c75;">greeting.asm:19</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #7f848e;"># Agora o topo da pilha foi modificado, &quot;call&quot; colocou o endere√ßo de </span>
</div><div class="line" data-line="5"><span style="color: #7f848e;"># mem√≥ria da pr√≥xima instru√ß√£o quando voltar do &quot;ret&quot;</span>
</div><div class="line" data-line="6"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsp</span>
</div><div class="line" data-line="7"><span style="color: #61afef;">0x7fffffffe440:</span> <span style="color: #e06c75;">0x0040100a</span>
</div><div class="line" data-line="8">
</div><div class="line" data-line="9"><span style="color: #7f848e;"># O endere√ßo de mem√≥ria aponta justamente pra pr√≥xima instru√ß√£o quando voltar do &quot;ret&quot;, no caso a instru√ß√£o que t√° na label .exit do programa</span>
</div><div class="line" data-line="10"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">0x0040100a</span>
</div><div class="line" data-line="11"><span style="color: #61afef;">0x40100a</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">_start.exit</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span> <span style="color: #61afef;">0x000000bf</span>
</div></code></pre>
<p>Mas agora o topo da pilha estraga nossa ideia de fazer <code>mov rsi, rsp</code>, mas podemos fazer aritm√©tica com ponteiros e mover o conte√∫do resultante, e √© muito f√°cil:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Topo da pilha apontando pra instru√ß√£o guardada pelo &quot;call&quot;</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsp</span>
</div><div class="line" data-line="3"><span style="color: #61afef;">0x7fffffffe440:</span> <span style="color: #e06c75;">0x0040100a</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #7f848e;"># Topo da pilha + 8 bytes apontando pro endere√ßo onde t√° a string &quot;Hi&quot;</span>
</div><div class="line" data-line="6"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsp</span><span style="color: #e06c75;">+8</span>
</div><div class="line" data-line="7"><span style="color: #61afef;">0x7fffffffe448:</span> <span style="color: #d19a66;">0x00402000</span>
</div></code></pre>
<blockquote>
<p>Nesta arquitetura, a pilha, assim como os registradores, armazenam por padr√£o at√© 8 bytes por cada informa√ß√£o</p>
</blockquote>
<p>Ent√£o teoricamente, tudo o que precisamos √© <code>mov rsi, [rsp + 8]</code></p>
<blockquote>
<p>Note que √© preciso usar <code>[rsp + 8]</code>, com square brackets √© uma forma de fazermos aritm√©tica de ponteiros e acessar o valor resultante da opera√ß√£o na mem√≥ria, no caso o endere√ßo apontando para a string ‚ÄúHi‚Äù</p>
</blockquote>
<p>Para finalizar este primeiro exemplo, √© muito importante fazermos ‚Äúpop‚Äù da pilha. Todo <code>push</code> deve ter um <code>pop</code>, caso contr√°rio podemos gastar a pilha desnecessariamente e talvez chegar a um stack overflow se exagerarmos bastante.</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">%define SYS_write 1
</div><div class="line" data-line="4">%define SYS_exit 60
</div><div class="line" data-line="5">%define STDOUT 1
</div><div class="line" data-line="6">
</div><div class="line" data-line="7">section .data
</div><div class="line" data-line="8">greet: db &quot;Hi&quot;, 0xA
</div><div class="line" data-line="9">
</div><div class="line" data-line="10">section .text
</div><div class="line" data-line="11">_start:
</div><div class="line" data-line="12">	push greet             ; &lt;----- push na pilha
</div><div class="line" data-line="13">	call .print
</div><div class="line" data-line="14">	pop rbp                ; &lt;----- pop da pilha, jogando o valor em rbp
</div><div class="line" data-line="15">	                       ; note que rbp √© outro registrador de prop√≥sito geral,
</div><div class="line" data-line="16">	                       ; mas que √© utilizado para manter a base da pilha
</div><div class="line" data-line="17">.exit:
</div><div class="line" data-line="18">	mov rdi, 0
</div><div class="line" data-line="19">	mov rax, SYS_exit
</div><div class="line" data-line="20">	syscall
</div><div class="line" data-line="21">.print:
</div><div class="line" data-line="22">	mov rdi, STDOUT
</div><div class="line" data-line="23">	mov rsi, [rsp + 8]     ; &lt;----- 8 bytes depois do topo da pilha est√° o
</div><div class="line" data-line="24">	                       ; endere√ßo de mem√≥ria da string
</div><div class="line" data-line="25">	mov rdx, 3
</div><div class="line" data-line="26">	mov rax, SYS_write
</div><div class="line" data-line="27">	syscall
</div><div class="line" data-line="28">	ret
</div></code></pre>
<p>Podemos reparar 2 coisas:</p>
<ul>
<li>A rotina <code>.print</code> est√° ficando bastante gen√©rica, ou seja ela n√£o sabe o que est√° na pilha, simplesmente move para o registrador RSI e faz a syscall <code>write</code></li>
<li>A rotina  <code>.print</code> ainda usa o tamanho em bytes como valor fixo, no caso 3 bytes. Deveria ser din√¢mico tamb√©m se quisermos fazer com que esta rotina seja bem gen√©rica</li>
</ul>
<p>Colocamos o tamanho tamb√©m na pilha? <em>Nah</em>, seria mais interessante ainda se calcul√°ssemos dinamicamente o que vem da pilha. Para fazer este c√°lculo, ter√≠amos que ‚Äúiterar‚Äù, em forma de <em>loop</em>, por cada byte que queremos imprimir, incrementar em um registrador e utilizar isto na syscall.</p>
<p>Vamos entrar no mundo dos <strong>loops</strong> e <strong>condicionais</strong>.</p>
<h3><a href="#calculando-tamanho-dinamicamente-com-loop" aria-hidden="true" class="anchor" id="calculando-tamanho-dinamicamente-com-loop"></a>Calculando tamanho dinamicamente com loop</h3>
<p>Combinando labels e jumps, podemos criar um <em>loop</em> em assembly, como neste pequeno exemplo a seguir:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">; Um loop infinito sem condi√ß√£o de parada
</div><div class="line" data-line="2">; N√£o fa√ßam isso
</div><div class="line" data-line="3">
</div><div class="line" data-line="4">global _start
</div><div class="line" data-line="5">
</div><div class="line" data-line="6">_start:
</div><div class="line" data-line="7">.loop
</div><div class="line" data-line="8">	jmp .loop
</div></code></pre>
<p>Entretanto para adicionarmos uma <em>condi√ß√£o de parada</em> do loop, √© necess√°rio utilizar uma instru√ß√£o de <strong>compara√ß√£o</strong> e outra que <strong>muda algum estado</strong>.</p>
<p>No nosso exemplo, vamos introduzir um <em>loop</em> que calcula o tamanho da string <em>antes de fazer a syscall</em>. Entendendo a necessidade:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">; Pseudo-code
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">.print:
</div><div class="line" data-line="4">	mov rdi, STDOUT
</div><div class="line" data-line="5">	mov rsi, [rsp + 8]   ; string em RSI     
</div><div class="line" data-line="6">	                       
</div><div class="line" data-line="7">	mov rdx, ?           ; &lt;--- aqui devemos introduzir um loop que vai
</div><div class="line" data-line="8">	                     ; modificando o valor de RDX, lendo byte a byte
</div><div class="line" data-line="9">	                     ; o conte√∫do da string
</div><div class="line" data-line="10">	mov rax, SYS_write
</div><div class="line" data-line="11">	syscall
</div><div class="line" data-line="12">	ret
</div></code></pre>
<p>Para resolver isto, podemos criar uma <strong>label</strong> chamada <code>.calculate_size</code> que cont√©m um <code>jmp</code> para ela mesma:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">.print:
</div><div class="line" data-line="2">	mov rsi, [rsp + 8]       ; string em RSI 
</div><div class="line" data-line="3">	mov rdx, 0               ; RDX come√ßa em 0
</div><div class="line" data-line="4">.calculate_size:             ; label
</div><div class="line" data-line="5">	jmp .calculate_size      ; jmp &quot;recursivo&quot;
</div><div class="line" data-line="6">.done:
</div><div class="line" data-line="7">	mov rdi, STDOUT
</div><div class="line" data-line="8">	mov rax, SYS_write
</div><div class="line" data-line="9">	syscall
</div><div class="line" data-line="10">	ret
</div></code></pre>
<p>Ao rodarmos o programa, <em>obviamente</em> ca√≠mos em loop infinito. Precisamos definir uma condi√ß√£o de parada, que consiste em:</p>
<ul>
<li>mudar o estado de alguma vari√°vel condicional</li>
<li>desviar o fluxo para outra <em>label</em> quando a condi√ß√£o for verdadeira</li>
</ul>
<p>Em Assembly, podemos fazer a mudan√ßa de estado utilizando a instru√ß√£o <code>inc</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">.print:
</div><div class="line" data-line="2">	mov rsi, [rsp + 8]     
</div><div class="line" data-line="3">	mov rdx, 0             ; RDX (contador) come√ßa em 0
</div><div class="line" data-line="4">.calculate_size:
</div><div class="line" data-line="5">	inc rdx                ; incrementa o valor que est√° em RDX (linha 23)
</div><div class="line" data-line="6">	jmp .calculate_size
</div><div class="line" data-line="7">.done:
</div><div class="line" data-line="8">	mov rdi, STDOUT
</div><div class="line" data-line="9">	mov rax, SYS_write
</div><div class="line" data-line="10">	syscall
</div><div class="line" data-line="11">	ret
</div></code></pre>
<p>Com gdb, verificamos que o valor de RDX est√° sempre sendo incrementado:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Adicionar breakpoint na linha 23 (&lt;&lt;inc rdx&gt;&gt;)</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #e5c07b;">break</span> <span style="color: #d19a66;">23</span>
</div><div class="line" data-line="3"><span style="color: #61afef;">Breakpoint</span> <span style="color: #d19a66;">1</span> <span style="color: #e06c75;">at</span> <span style="color: #e06c75;">0x401021:</span> <span style="color: #e06c75;">file</span> <span style="color: #e06c75;">live.asm,</span> <span style="color: #e06c75;">line</span> <span style="color: #e06c75;">23.</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #7f848e;"># Executar o programa, que vai no primeiro breakpoint</span>
</div><div class="line" data-line="6"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">run</span>
</div><div class="line" data-line="7"><span style="color: #61afef;">Breakpoint</span> <span style="color: #e06c75;">1,</span> <span style="color: #e06c75;">_start.calculate_size</span> <span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span> <span style="color: #e06c75;">at</span> <span style="color: #e06c75;">live.asm:23</span>
</div><div class="line" data-line="8"><span style="color: #d19a66;">23</span>              <span style="color: #e06c75;">inc</span> <span style="color: #e06c75;">rdx</span>
</div><div class="line" data-line="9">
</div><div class="line" data-line="10"><span style="color: #7f848e;"># Continuar execu√ß√£o at√© o pr√≥ximo breakpoint ou fim do programa.</span>
</div><div class="line" data-line="11"><span style="color: #7f848e;"># Mas como estamos em loop, o programa vai parar de novo nesta linha</span>
</div><div class="line" data-line="12"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #e5c07b;">continue</span>
</div><div class="line" data-line="13">
</div><div class="line" data-line="14"><span style="color: #7f848e;"># Atalho para &quot;info register rdx&quot;</span>
</div><div class="line" data-line="15"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">rdx</span>
</div><div class="line" data-line="16"><span style="color: #61afef;">rdx</span>            <span style="color: #d19a66;">0x1</span>                 <span style="color: #d19a66;">1</span>
</div><div class="line" data-line="17">
</div><div class="line" data-line="18"><span style="color: #7f848e;"># Pr√≥xima itera√ß√£o...</span>
</div><div class="line" data-line="19"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #e5c07b;">continue</span>
</div><div class="line" data-line="20"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">rdx</span>
</div><div class="line" data-line="21"><span style="color: #61afef;">rdx</span>            <span style="color: #d19a66;">0x2</span>                 <span style="color: #d19a66;">2</span>
</div><div class="line" data-line="22">
</div><div class="line" data-line="23"><span style="color: #7f848e;"># E assim infinitamente pois n√£o temos ainda a segunda premissa da condi√ß√£o de parada, que √© a condicional</span>
</div><div class="line" data-line="24"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #e5c07b;">continue</span>
</div><div class="line" data-line="25"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">rdx</span>
</div><div class="line" data-line="26"><span style="color: #61afef;">rdx</span>            <span style="color: #d19a66;">0x19</span>                <span style="color: #d19a66;">25</span>
</div></code></pre>
<p>Como podemos elaborar esta condicional, uma vez que o valor em RDX pode ser infinito, logo ter <em>todas as possibilidades</em>?</p>
<p>Uma ideia √© irmos <strong>consumindo</strong> byte a byte da string at√© chegar a <em>zero</em>. Para isto, podemos definir o fim da string com <code>0x0</code> e fazer <em>aritm√©tica bin√°ria</em> na pr√≥pria string, consumindo os bytes at√© chegar a <code>0x0</code>!</p>
<p>Eis o exemplo com um pseudo-c√≥digo:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">; &quot;Hi&quot;, 0 
</div><div class="line" data-line="2">; que em hexabyte fica 0x49, 0x69, 0x00
</div><div class="line" data-line="3">
</div><div class="line" data-line="4">INCREMENT
</div><div class="line" data-line="5">0x69 0x00   ; consumiu o byte mais √† esquerda 0x49
</div><div class="line" data-line="6">
</div><div class="line" data-line="7">INCREMENT   ; consumiu o byte mais √† esquerda 0x69
</div><div class="line" data-line="8">0x00 0x...
</div></code></pre>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/3v83k677xw88fg49dn86.png" alt="increment em endere√ßo de mem√≥ria" /></p>
<blockquote>
<p>Nossa Leandro, que fant√°stico! Podemos ent√£o fazer <code>inc</code> em um registrador que cont√©m a string, nesse caso o pr√≥prio RSI?</p>
</blockquote>
<p><em>Isso mesmo!</em></p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">.....
</div><div class="line" data-line="2">section .data
</div><div class="line" data-line="3">greet: db &quot;Hi&quot;, 0xA, 0      ; &lt;--- adicionamos o &quot;zero&quot; para identificar o 
</div><div class="line" data-line="4">                            ; fim da string
</div><div class="line" data-line="5">
</div><div class="line" data-line="6">.....
</div><div class="line" data-line="7">
</div><div class="line" data-line="8">.print:
</div><div class="line" data-line="9">	mov rsi, [rsp + 8]     
</div><div class="line" data-line="10">	mov rdx, 0
</div><div class="line" data-line="11">.calculate_size:
</div><div class="line" data-line="12">	inc rdx                 ; incrementa o valor inteiro em RDX (contador)
</div><div class="line" data-line="13">	inc rsi                 ; &lt;--- al√©m de incrementar o RDX, incrementamos
</div><div class="line" data-line="14">	                        ; tamb√©m o RSI, que cont√©m o endere√ßo de
</div><div class="line" data-line="15">	                        ; mem√≥ria para a string. Aritm√©tica em hexabytes
</div><div class="line" data-line="16">	                        ; vai fazer o efeito de &quot;consumir os bytes at√© zero
</div><div class="line" data-line="17">	jmp .calculate_size
</div><div class="line" data-line="18">.done:
</div><div class="line" data-line="19">	mov rdi, STDOUT
</div><div class="line" data-line="20">	mov rax, SYS_write
</div><div class="line" data-line="21">	syscall
</div><div class="line" data-line="22">	ret
</div><div class="line" data-line="23">
</div></code></pre>
<p>Agora, com <code>gdb</code>, vamos verificar o que est√° acontecendo com nosso programa:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Breakpoint na linha &lt;jmp .calculate_size&gt;</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #e5c07b;">break</span> <span style="color: #d19a66;">25</span>
</div><div class="line" data-line="3"><span style="color: #61afef;">Breakpoint</span> <span style="color: #d19a66;">1</span> <span style="color: #e06c75;">at</span> <span style="color: #e06c75;">0x401027:</span> <span style="color: #e06c75;">file</span> <span style="color: #e06c75;">live.asm,</span> <span style="color: #e06c75;">line</span> <span style="color: #e06c75;">25.</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">run</span>
</div><div class="line" data-line="6">
</div><div class="line" data-line="7"><span style="color: #7f848e;"># Cool, o contador RDX foi incrementado</span>
</div><div class="line" data-line="8"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">rdx</span>
</div><div class="line" data-line="9"><span style="color: #61afef;">rdx</span>            <span style="color: #d19a66;">0x1</span>                 <span style="color: #d19a66;">1</span>
</div><div class="line" data-line="10">
</div><div class="line" data-line="11"><span style="color: #7f848e;"># Em RSI, temos outro endere√ßo de mem√≥ria.</span>
</div><div class="line" data-line="12"><span style="color: #7f848e;"># Anteriormente era o in√≠cio da string, 0x402000, mas agora est√°</span>
</div><div class="line" data-line="13"><span style="color: #7f848e;"># apontando para 0x402001</span>
</div><div class="line" data-line="14"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">rsi</span>
</div><div class="line" data-line="15"><span style="color: #61afef;">rsi</span>            <span style="color: #d19a66;">0x402001</span>            <span style="color: #d19a66;">4202497</span>
</div><div class="line" data-line="16">
</div><div class="line" data-line="17"><span style="color: #7f848e;"># Wow! Temos os bytes da string &quot;i&quot;, seguido de &quot;\n&quot;, e depois o 0x00</span>
</div><div class="line" data-line="18"><span style="color: #7f848e;"># Parece que o inc RSI funcionou como esper√°vamos?</span>
</div><div class="line" data-line="19"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span><span style="color: #61afef;">x</span> <span style="color: #e06c75;">/4xb</span> <span style="color: #d19a66;">0x402001</span>
</div><div class="line" data-line="20"><span style="color: #61afef;">0x402001:</span>       <span style="color: #d19a66;">0x69</span>    <span style="color: #e06c75;">0x0a</span>    <span style="color: #d19a66;">0x00</span>    <span style="color: #e06c75;">0x2c</span>
</div><div class="line" data-line="21">
</div><div class="line" data-line="22"><span style="color: #7f848e;"># A vida continua...</span>
</div><div class="line" data-line="23"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #e5c07b;">continue</span>
</div><div class="line" data-line="24">
</div><div class="line" data-line="25"><span style="color: #7f848e;"># Caminho mais curto</span>
</div><div class="line" data-line="26"><span style="color: #7f848e;"># E parece que RSI andou mais ainda, agora apontando para o byte &quot;\n&quot;</span>
</div><div class="line" data-line="27"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsi</span>
</div><div class="line" data-line="28"><span style="color: #61afef;">0x402002:</span>       <span style="color: #e06c75;">0x0a</span>
</div><div class="line" data-line="29">
</div><div class="line" data-line="30"><span style="color: #7f848e;"># A vida continua...</span>
</div><div class="line" data-line="31"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #e5c07b;">continue</span>
</div><div class="line" data-line="32">
</div><div class="line" data-line="33"><span style="color: #7f848e;"># O nosso grande momento! Agora RSI aponta para 0x00</span>
</div><div class="line" data-line="34"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsi</span>
</div><div class="line" data-line="35"><span style="color: #61afef;">0x402003:</span>       <span style="color: #d19a66;">0x00</span>
</div></code></pre>
<p>Tudo o que precisamos fazer, neste momento, √© comparar <strong>o valor que est√° em RSI</strong> com <em>zero</em>. Se chegou a zero, significa que podemos <em>parar o loop</em>. Vamos verificar o que est√° no contador RDX (esperamos que seja 3):</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">rdx</span>
</div><div class="line" data-line="2"><span style="color: #61afef;">rdx</span>            <span style="color: #d19a66;">0x3</span>                 <span style="color: #d19a66;">3</span>
</div></code></pre>
<p><em>Yay! Que grande momento!</em></p>
<p>Mas como verificar em Assembly se chegou ou n√£o no valor? Existe ‚ÄúIF‚Äù e ‚ÄúELSE‚Äù em Assembly?</p>
<blockquote>
<p>Hell no!</p>
</blockquote>
<p>N√£o. N√£o tem ‚ÄúIF‚Äù e ‚ÄúELSE‚Äù em Assembly.</p>
<p>Uma poss√≠vel solu√ß√£o seria:</p>
<ul>
<li>utilizar uma instru√ß√£o que compare o valor de um registrador ou em algum endere√ßo de mem√≥ria com <strong>qualquer outro valor</strong></li>
<li>esta instru√ß√£o iria guardar o resultado da compara√ß√£o em outro registrador ‚Äúespecial‚Äù</li>
<li>utilizar outra instru√ß√£o para fazer <em>desvio do fluxo</em> de acordo com o valor que estive neste registrador especial</li>
</ul>
<p>Sim, √© a√≠ que entramos no tal do registrador <strong>RFLAGS</strong>.</p>
<h3><a href="#rflags" aria-hidden="true" class="anchor" id="rflags"></a>RFLAGS</h3>
<p>O registrador de <em>flags</em> √© um registrador de status que mant√©m sempre o estado atual da CPU, neste caso estamos referindo a uma CPU x86_64, pelo que chamamos este registrador de <strong>RFLAGS</strong>.</p>
<p>Este registrador guarda <em>opcodes condicionais</em>, que s√£o resultado de diversas opera√ß√µes l√≥gicas e aritm√©ticas que afetam o estado da CPU.</p>
<p>Voltando ao nosso exemplo, podemos comparar o registrador RSI com o valor 0, e ent√£o verificar o que est√° acontecendo com o registrador <code>eflags</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">.print:
</div><div class="line" data-line="2">	mov rsi, [rsp + 8]     
</div><div class="line" data-line="3">	mov rdx, 0
</div><div class="line" data-line="4">.calculate_size:
</div><div class="line" data-line="5">	inc rdx
</div><div class="line" data-line="6">	inc rsi
</div><div class="line" data-line="7">	cmp byte [rsi], 0x00   ; &lt;-- aqui comparamos (em byte) o valor que est√°
</div><div class="line" data-line="8">	                       ; em RSI com o byte 0x00
</div><div class="line" data-line="9">	jmp .calculate_size
</div><div class="line" data-line="10">.done:
</div><div class="line" data-line="11">	mov rdi, STDOUT
</div><div class="line" data-line="12">	mov rax, SYS_write
</div><div class="line" data-line="13">	syscall
</div><div class="line" data-line="14">	ret
</div></code></pre>
<p>E com isto podemos conferir com <code>gdb</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Breakpoint na linha &lt;cmp byte [rsi], 0x00&gt;</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #e5c07b;">break</span> <span style="color: #d19a66;">25</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">run</span>
</div><div class="line" data-line="5">
</div><div class="line" data-line="6"><span style="color: #7f848e;"># O que temos no primeiro byte de RSI? &quot;i&quot;, pois o &quot;H&quot; j√° foi</span>
</div><div class="line" data-line="7"><span style="color: #7f848e;"># consumido no &lt;inc rsi&gt;</span>
</div><div class="line" data-line="8"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">/1xb</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsi</span>
</div><div class="line" data-line="9"><span style="color: #61afef;">0x402002:</span>       <span style="color: #d19a66;">0x69</span>
</div><div class="line" data-line="10">
</div><div class="line" data-line="11"><span style="color: #7f848e;"># E no eflags?</span>
</div><div class="line" data-line="12"><span style="color: #7f848e;"># Nossa, temos o IF que est√°vamos precisando!!!!!11</span>
</div><div class="line" data-line="13"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">eflags</span>
</div><div class="line" data-line="14"><span style="color: #61afef;">eflags</span>         <span style="color: #d19a66;">0x202</span>               <span style="color: #e06c75;">[</span> <span style="color: #e06c75;">IF</span> <span style="color: #e06c75;">]</span>
</div></code></pre>
<blockquote>
<p>Calma jovem, <code>IF</code> n√£o √© o que voc√™ est√° pensando!</p>
</blockquote>
<p><code>IF</code> √© uma flag chamada <em>interrupt flag</em>, que est√° sempre presente no programa em execu√ß√£o. Ela determina se o programa pode ou n√£o sofrer interrup√ß√µes de hardware. No nosso caso, est√° sempre habilitada por padr√£o, e √© por este motivo que podemos fazer chamadas de sistema (syscalls).</p>
<p>Continuando no gdb‚Ä¶</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #e5c07b;">continue</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #7f848e;"># O que temos em RSI? &quot;\n&quot;</span>
</div><div class="line" data-line="4"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">/1xb</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsi</span>
</div><div class="line" data-line="5"><span style="color: #61afef;">0x402002:</span>       <span style="color: #e06c75;">0x0a</span>
</div><div class="line" data-line="6">
</div><div class="line" data-line="7"><span style="color: #7f848e;"># Executar a instru√ß√£o &lt;cmp byte [rsi], 0x00&gt;</span>
</div><div class="line" data-line="8"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">next</span>
</div><div class="line" data-line="9">
</div><div class="line" data-line="10"><span style="color: #7f848e;"># Ok, segunda itera√ß√£o continua na mesma, sem flags adicionais</span>
</div><div class="line" data-line="11"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">eflags</span>
</div><div class="line" data-line="12"><span style="color: #61afef;">eflags</span>         <span style="color: #d19a66;">0x202</span>               <span style="color: #e06c75;">[</span> <span style="color: #e06c75;">IF</span> <span style="color: #e06c75;">]</span>
</div><div class="line" data-line="13">
</div><div class="line" data-line="14"><span style="color: #7f848e;">######## Pr√≥xima itera√ß√£o ##########</span>
</div><div class="line" data-line="15">
</div><div class="line" data-line="16"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #e5c07b;">continue</span>
</div><div class="line" data-line="17">
</div><div class="line" data-line="18"><span style="color: #7f848e;"># O que temos em RSI? 0x00, cool.</span>
</div><div class="line" data-line="19"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">/1xb</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsi</span>
</div><div class="line" data-line="20"><span style="color: #61afef;">0x402003:</span>       <span style="color: #d19a66;">0x00</span>
</div><div class="line" data-line="21">
</div><div class="line" data-line="22"><span style="color: #7f848e;"># Executar a instru√ß√£o &lt;cmp byte [rsi], 0x00&gt;</span>
</div><div class="line" data-line="23"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">next</span>
</div><div class="line" data-line="24">
</div><div class="line" data-line="25"><span style="color: #7f848e;"># Outras flags foram adicionadas ao estado: PF e ZF</span>
</div><div class="line" data-line="26"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">eflags</span>
</div><div class="line" data-line="27"><span style="color: #61afef;">eflags</span>         <span style="color: #d19a66;">0x246</span>               <span style="color: #e06c75;">[</span> <span style="color: #e06c75;">PF</span> <span style="color: #e06c75;">ZF</span> <span style="color: #e06c75;">IF</span> <span style="color: #e06c75;">]</span>
</div></code></pre>
<p><code>PF</code> √© a <em>parity flag</em>, que √© adicionada quando uma opera√ß√£o aritm√©tica em qualquer registrador resulta em paridade √≠mpar.</p>
<blockquote>
<p>N√£o √© do escopo deste artigo entrar em detalhes sobre PF, sugiro a leitura <a href="https://en.wikipedia.org/wiki/Parity_flag">sobre o assunto</a></p>
</blockquote>
<p>J√° a <code>ZF</code> √© chamada <strong>zero flag</strong>, adicionada quando uma opera√ß√£o aritm√©tica resulta em zero, que √© exatamente o que estamos buscando aqui.</p>
<p>Agora o que precisamos √© desviar o fluxo (lembra do <code>jmp</code>) quando a <em>flag zero est√° presente</em>. Para isto, temos a disposi√ß√£o diversas instru√ß√µes de jump baseadas em flags:</p>
<ul>
<li>jz (jump if zero)</li>
<li>jnz(jump if not zero)</li>
<li>je (jump if equal)</li>
<li>jne (jump if not equal)</li>
</ul>
<blockquote>
<p>Isto pra mencionar apenas algumas, existem muitas outras que podem ser consultadas <a href="https://en.wikibooks.org/wiki/X86_Assembly/Control_Flow">aqui</a></p>
</blockquote>
<p>Com isto, a instru√ß√£o que precisamos √© a <code>jz</code>, que verifica se a flag <code>ZF</code> est√° presente:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">.print:
</div><div class="line" data-line="2">	mov rsi, [rsp + 8]     
</div><div class="line" data-line="3">	mov rdx, 0
</div><div class="line" data-line="4">.calculate_size:
</div><div class="line" data-line="5">	inc rdx
</div><div class="line" data-line="6">	inc rsi
</div><div class="line" data-line="7">	cmp byte [rsi], 0x00     ; &lt;--- compara RSI com 0x00. Adiciona a flag ZF                                  ; quando chegar a zero
</div><div class="line" data-line="8">	jz .done                 ; &lt;--- desvia fluxo para a label &quot;.done&quot; caso a
</div><div class="line" data-line="9">	                         ; flag ZF esteja presente
</div><div class="line" data-line="10">	jmp .calculate_size
</div><div class="line" data-line="11">.done:
</div><div class="line" data-line="12">	mov rdi, STDOUT
</div><div class="line" data-line="13">	mov rax, SYS_write
</div><div class="line" data-line="14">	syscall
</div><div class="line" data-line="15">	ret
</div></code></pre>
<p>Com <code>gdb</code>, colocamos o breakpoint na linha <code>mov rdi, STDOUT</code> que √© depois do loop. Caso o programa fique parado nesta linha, significa que o loop foi conclu√≠do com sucesso e os bytes da string devidamente calculados:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Breakpoint na linha &lt;mov rdi, STDOUT&gt;</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #e5c07b;">break</span> <span style="color: #d19a66;">29</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">run</span>
</div><div class="line" data-line="5">
</div><div class="line" data-line="6"><span style="color: #7f848e;"># Olha o que temos aqui</span>
</div><div class="line" data-line="7"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">rdx</span> <span style="color: #e06c75;">rsi</span>
</div><div class="line" data-line="8"><span style="color: #61afef;">rdx</span>            <span style="color: #d19a66;">0x3</span>                 <span style="color: #d19a66;">3</span>
</div><div class="line" data-line="9"><span style="color: #61afef;">rsi</span>            <span style="color: #d19a66;">0x402003</span>            <span style="color: #d19a66;">4202499</span>
</div><div class="line" data-line="10">
</div><div class="line" data-line="11"><span style="color: #7f848e;"># E se formos examinar a string (com x/s) em RSI, temos isto:</span>
</div><div class="line" data-line="12"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">x/s</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsi</span>
</div><div class="line" data-line="13"><span style="color: #61afef;">0x402003:</span>       <span style="color: #98c379;">&quot;&quot;</span>
</div></code></pre>
<ul>
<li>Em RDX, temos o contador, que est√° em 3, que √© a quantidade de bytes que ser√° passada como terceiro argumento da syscall write. Okay, aqui ficou tudo certo.</li>
<li>Em RSI, temos <code>0x402003</code>, e o valor est√° vazio, ou <code>0x00</code>. Isto √© um problema</li>
</ul>
<p>O problema reside no fato de que RSI precisa ter o ponteiro para a string em si, e as opera√ß√µes de <code>inc rsi</code> <strong>modificaram o registrador</strong>, pelo que n√£o queremos que isto aconte√ßa.</p>
<p>Podemos ent√£o inicialmente mover o valor que est√° em RSI para outro registrador tempor√°rio, que pode ser um daqueles registradores de <em>rascunho</em>, chamados de <em>draft registers</em>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">.print:
</div><div class="line" data-line="2">	mov rsi, [rsp + 8]     
</div><div class="line" data-line="3">	mov r9, rsi          ; aqui preservamos RSI, movendo o valor para R9
</div><div class="line" data-line="4">	mov rdx, 0
</div><div class="line" data-line="5">.calculate_size:
</div><div class="line" data-line="6">	inc rdx
</div><div class="line" data-line="7">	inc r9               ; incrementar o valor em R9, preservando assim RSI
</div><div class="line" data-line="8">	cmp byte [r9], 0x00  ; comparar 0x00 com R9, e n√£o mais RSI
</div><div class="line" data-line="9">	jz .done
</div><div class="line" data-line="10">	jmp .calculate_size
</div><div class="line" data-line="11">.done:
</div><div class="line" data-line="12">	mov rdi, STDOUT       
</div><div class="line" data-line="13">	mov rax, SYS_write
</div><div class="line" data-line="14">	syscall              ; no momento da syscall, RSI est√° intacto, contendo
</div><div class="line" data-line="15">	                     ; o ponteiro para o endere√ßo de mem√≥ria onde est√°
</div><div class="line" data-line="16">	                     ; localizada a nossa querid√≠ssima string &quot;Hi&quot;
</div><div class="line" data-line="17">	ret
</div></code></pre>
<p>Ap√≥s estas altera√ß√µes, vamos executar o programa completo:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #61afef;">./greeting</span>
</div><div class="line" data-line="2"><span style="color: #61afef;">Hi</span>
</div></code></pre>
<p><em>Que dia maravilhoso!</em> Nosso programa imprime a string ‚ÄúHi‚Äù calculando dinamicamente o tamanho dos bytes da string!</p>
<blockquote>
<p>Entretanto, queremos implementar a proposta inicial, n√£o √©, Leandro? O programa n√£o tem que ler o nome da linha de comando e imprimir ‚ÄúHi, Leandro‚Äù?</p>
</blockquote>
<h3><a href="#botando-mais-pilha-no-neg√≥cio" aria-hidden="true" class="anchor" id="botando-mais-pilha-no-neg√≥cio"></a>Botando mais pilha no neg√≥cio</h3>
<p>Nosso objetivo √© chamar <code>./greeting</code> com argumento e assim o programa deve imprimir <code>Hi, </code> com o argumento enviado:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Objetivo, isto ainda n√£o funciona</span>
</div><div class="line" data-line="2"><span style="color: #61afef;">./greeting</span> <span style="color: #e06c75;">Leandro</span>
</div><div class="line" data-line="3"><span style="color: #61afef;">Hi,</span> <span style="color: #e06c75;">Leandro</span>
</div></code></pre>
<p>Se pensarmos um pouco, podemos inferir que qualquer argumento pode ser armazenado na <em>stack</em> do processo, que √© quando o programa est√° em execu√ß√£o.</p>
<p>Com <code>gdb</code>, podemos confirmar isto:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Breakpoint na primeira linha do programa, depois do _start</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #e5c07b;">break</span> <span style="color: #d19a66;">12</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #7f848e;"># Executa o programa com o argumento &quot;Leandro&quot;</span>
</div><div class="line" data-line="5"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">run</span> <span style="color: #e06c75;">Leandro</span>
</div><div class="line" data-line="6">
</div><div class="line" data-line="7"><span style="color: #7f848e;"># Onde estar√° Leandro? Na pilha? (rsp)</span>
</div><div class="line" data-line="8"><span style="color: #7f848e;">#      -&gt; x de examine</span>
</div><div class="line" data-line="9"><span style="color: #7f848e;">#      -&gt; /8xb os primeiros 8 hexa bytes</span>
</div><div class="line" data-line="10"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">/8xb</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsp</span>
</div><div class="line" data-line="11"><span style="color: #61afef;">0x7fffffffe450:</span> <span style="color: #d19a66;">0x02</span>    <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>
</div></code></pre>
<p>Mas o qu√™ significa esse n√∫mero 2? Vamos examinar a stack e a ordem das informa√ß√µes contidas nela.</p>
<p>Voltando ao <code>gdb</code>, e se lermos os pr√≥ximos 8 bytes na stack?</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">/8xb</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsp</span> <span style="color: #e06c75;">+</span> <span style="color: #d19a66;">8</span>
</div><div class="line" data-line="2"><span style="color: #61afef;">0x7fffffffe458:</span> <span style="color: #e06c75;">0xb1</span>    <span style="color: #e06c75;">0xe6</span>    <span style="color: #e06c75;">0xff</span>    <span style="color: #e06c75;">0xff</span>    <span style="color: #e06c75;">0xff</span>    <span style="color: #e06c75;">0x7f</span>    <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>
</div></code></pre>
<blockquote>
<p>Lembrando que os bytes s√£o escritos na stack em formato little-endian, ou seja est√£o invertidos</p>
</blockquote>
<p>Com isto, temos um hexadecimal <code>0x7fffffffe6b1</code>. Parece um endere√ßo de mem√≥ria, n√£o?</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Examinando o endere√ßo de mem√≥ria no formato de string (/s)</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">/s</span> <span style="color: #e06c75;">0x7fffffffe6b1</span>
</div><div class="line" data-line="3"><span style="color: #61afef;">0x7fffffffe6b1:</span> <span style="color: #98c379;">&quot;/Users/..../code/asm-x64/live&quot;</span>
</div></code></pre>
<p>Wow, temos o primeiro argumento, tamb√©m chamado de <em>ARG0</em> que √© o nome do programa com o caminho absoluto no sistema operacional.</p>
<p>Andando mais 8 bytes‚Ä¶</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Endere√ßo de mem√≥ria...</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">/8xb</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsp</span> <span style="color: #e06c75;">+</span> <span style="color: #d19a66;">16</span>
</div><div class="line" data-line="3"><span style="color: #61afef;">0x7fffffffe460:</span> <span style="color: #e06c75;">0xdf</span>    <span style="color: #e06c75;">0xe6</span>    <span style="color: #e06c75;">0xff</span>    <span style="color: #e06c75;">0xff</span>    <span style="color: #e06c75;">0xff</span>    <span style="color: #e06c75;">0x7f</span>    <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #7f848e;"># Examinando o valor que est√° no endere√ßo</span>
</div><div class="line" data-line="6"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">/s</span> <span style="color: #e06c75;">0x7fffffffe6df</span>
</div><div class="line" data-line="7"><span style="color: #61afef;">0x7fffffffe6df:</span> <span style="color: #98c379;">&quot;Leandro&quot;</span>
</div></code></pre>
<p><em>Yay!</em> Temos o nosso argumento, armazenado na stack. √â o primeiro argumento, tamb√©m chamado de <em>ARG1</em>.</p>
<blockquote>
<p>Se continuarmos andando na stack de 8 em 8 bytes, vamos passar por todos os argumentos (no nosso caso n√£o h√° mais), e a seguir vamos chegar no vetor ambiente, que cont√©m todas as vari√°veis de ambiente contidas no shell que est√° executando o nosso programa</p>
</blockquote>
<p>Com isto, sabemos que o primeiro argumento est√° localizado em <code>rsp + 16</code>:</p>
<ul>
<li><code>rsp</code>: quantidade de argumentos</li>
<li><code>rsp + 8</code>: ARG0, nome do programa</li>
<li><code>rsp + 16</code>: ARG1, primeiro argumento (se existir)</li>
<li><code>rsp + 24</code>: ARG2, segundo argumento (se existir)</li>
<li>e assim sucessivamente‚Ä¶at√© chegar no vetor de vari√°veis de ambiente (vetor ambiente)</li>
</ul>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/zs0kmzgwigotv9drklh9.png" alt="layout de mem√≥ria com stack" /></p>
<p>Sabendo que nossa <em>sub-rotina</em> <code>.print</code> j√° recebe uma string da stack e calcula dinamicamente o tamanho da string que foi passada, podemos passar pro topo da stack o nosso argumento (que por acaso tamb√©m est√° na stack), e em seguida chamada a rotina <code>.print</code> novamente:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">section .data
</div><div class="line" data-line="2">greet: db &quot;Hi, &quot;, 0
</div><div class="line" data-line="3">
</div><div class="line" data-line="4">_start:
</div><div class="line" data-line="5">	push greet      
</div><div class="line" data-line="6">	call .print     
</div><div class="line" data-line="7">	pop rbp     
</div><div class="line" data-line="8">
</div><div class="line" data-line="9">	; aqui fazemos push pro topo da stack o valor que est√° em RSP + 16 (ARG1)
</div><div class="line" data-line="10">	; utilizamos o tipo &quot;qword&quot; que significa &quot;quadword&quot;
</div><div class="line" data-line="11">	push qword [rsp + 16]
</div><div class="line" data-line="12">	call .print
</div><div class="line" data-line="13">	pop rbp
</div><div class="line" data-line="14">...
</div></code></pre>
<p>O qu√™ significa <strong>quadword</strong>? Em assembly podemos definir <em>tipos de bytes</em>, que basicamente s√£o grupos de bytes, podendo ou n√£o caber em um registrador ou stack dependendo da arquitetura da CPU.</p>
<ul>
<li><strong>byte</strong>: especifica 1 byte (8-bit)</li>
<li><strong>word</strong>: 2 bytes (16-bit)</li>
<li><strong>dword</strong>: 4 bytes (32-bit)</li>
<li><strong>qword</strong>: 8 bytes (64-bit)</li>
<li><strong>tbyte</strong>: 10 bytes</li>
</ul>
<p>Na arquitetura x86_64, precisamos especificar que o tipo de byte adicionado na stack, quando n√£o vier de um registrador mas sim de um lugar arbitr√°rio na mem√≥ria ou stack, tem um determinado <em>tamanho</em> em bytes.</p>
<p>Neste caso, estamos utilizando <em>qword</em> que √© justamente 8 bytes (ou 64-bit) que representa a arquitetura em quest√£o.</p>
<p>Precisamos adicionar mais um caracter, que √© o <em>newline</em>, ou <code>\n</code>, no fim da mensagem. Para isto, podemos definir um dado inicializado e chamar a rotina <code>.print</code> , que j√° est√° bem ‚Äúcrescidinha‚Äù, n√£o?</p>
<p>Programa completo, com coment√°rios:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">%define SYS_write 1
</div><div class="line" data-line="4">%define SYS_exit 60
</div><div class="line" data-line="5">%define STDOUT 1
</div><div class="line" data-line="6">
</div><div class="line" data-line="7">section .data
</div><div class="line" data-line="8">greet: db &quot;Hi, &quot;, 0
</div><div class="line" data-line="9">newline: db 0xA, 0
</div><div class="line" data-line="10">
</div><div class="line" data-line="11">section .text
</div><div class="line" data-line="12">_start:
</div><div class="line" data-line="13">	push greet             ; adiciona &quot;Hi, &quot; na stack para print
</div><div class="line" data-line="14">	call .print     
</div><div class="line" data-line="15">	pop rbp         
</div><div class="line" data-line="16">
</div><div class="line" data-line="17">	push qword [rsp + 16]  ; adiciona ARG1 na stack para print
</div><div class="line" data-line="18">	call .print
</div><div class="line" data-line="19">	pop rbp
</div><div class="line" data-line="20">
</div><div class="line" data-line="21">	push newline           ; adiciona newline na stack para print
</div><div class="line" data-line="22">	call .print
</div><div class="line" data-line="23">	pop rbp
</div><div class="line" data-line="24">.exit:                     ; label de t√©rmino do programa
</div><div class="line" data-line="25">	mov rdi, 0
</div><div class="line" data-line="26">	mov rax, SYS_exit
</div><div class="line" data-line="27">	syscall
</div><div class="line" data-line="28">.print:                    ; rotina de print no STDOUT
</div><div class="line" data-line="29">	mov rsi, [rsp + 8]     
</div><div class="line" data-line="30">	mov r9, rsi
</div><div class="line" data-line="31">	mov rdx, 0
</div><div class="line" data-line="32">.calculate_size:           ; loop para calcular tamanho da string
</div><div class="line" data-line="33">	inc rdx
</div><div class="line" data-line="34">	inc r9
</div><div class="line" data-line="35">	cmp byte [r9], 0x00
</div><div class="line" data-line="36">	jz .done
</div><div class="line" data-line="37">	jmp .calculate_size
</div><div class="line" data-line="38">.done:                     ; label para finalizar a rotina print e retornar
</div><div class="line" data-line="39">	mov rdi, STDOUT
</div><div class="line" data-line="40">	mov rax, SYS_write
</div><div class="line" data-line="41">	syscall
</div><div class="line" data-line="42">	ret
</div></code></pre>
<p>Rodamos o programa e:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #61afef;">./greeting</span> <span style="color: #e06c75;">Leandro</span>
</div><div class="line" data-line="2"><span style="color: #61afef;">Hi,</span> <span style="color: #e06c75;">Leandro</span>
</div></code></pre>
<p><em>OMG! Eu n√£o estou acreditando no que estou vendo!!!!!11</em></p>
<h3><a href="#depurando-o-programa-final-com-strace" aria-hidden="true" class="anchor" id="depurando-o-programa-final-com-strace"></a>Depurando o programa final com strace</h3>
<p>Com <em>strace</em>, podemos fazer o trace de syscalls do programa final. Olha que maravilha isto:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">strace</span> <span style="color: #e06c75;">./greeting</span> <span style="color: #e06c75;">Leandro</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #61afef;">execve</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;./greeting&quot;</span><span style="color: #98c379;">,</span> <span style="color: #e06c75;">[</span><span style="color: #98c379;">&quot;./greeting&quot;</span><span style="color: #e06c75;">,</span> <span style="color: #98c379;">&quot;Leandro&quot;</span><span style="color: #e06c75;">]</span><span style="color: #e06c75;">,</span> <span style="color: #e06c75;">0x7ffc30f75368</span> <span style="color: #e06c75;">/*</span> <span style="color: #d19a66;">24</span> <span style="color: #e06c75;">vars</span> <span style="color: #e06c75;">*/</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="4"><span style="color: #61afef;">write</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">1,</span> <span style="color: #98c379;">&quot;Hi, &quot;</span><span style="color: #e06c75;">,</span> <span style="color: #e06c75;">4Hi,</span> <span style="color: #c678dd;">)</span>                     <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">4</span>
</div><div class="line" data-line="5"><span style="color: #61afef;">write</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">1,</span> <span style="color: #98c379;">&quot;Leandro&quot;</span><span style="color: #e06c75;">,</span> <span style="color: #e06c75;">7Leandro</span><span style="color: #c678dd;">)</span>                  <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">7</span>
</div><div class="line" data-line="6"><span style="color: #61afef;">write</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">1,</span> <span style="color: #98c379;">&quot;\n&quot;</span><span style="color: #e06c75;">,</span> <span style="color: #d19a66;">1</span>
</div><div class="line" data-line="7"><span style="color: #c678dd;">)</span>                       <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">1</span>
</div><div class="line" data-line="8"><span style="color: #e5c07b;">exit</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">0</span><span style="color: #c678dd;">)</span>                                 <span style="color: #56b6c2;">=</span> ?
</div><div class="line" data-line="9">+++ <span style="color: #61afef;">exited</span> <span style="color: #e06c75;">with</span> <span style="color: #d19a66;">0</span> <span style="color: #e06c75;">+++</span>
</div></code></pre>
<p>Foram feitas 4 chamadas de sistema, sendo:</p>
<ul>
<li>1 write, ‚ÄúHi, ‚Äú</li>
<li>1 write ‚ÄúLeandro‚Äù</li>
<li>1 write ‚Äú\n‚Äù</li>
<li>1 exit</li>
</ul>
<hr />
<h2><a href="#falando-um-pouco-de-registradores" aria-hidden="true" class="anchor" id="falando-um-pouco-de-registradores"></a>Falando um pouco de registradores</h2>
<p>At√© o momento, vimos durante este artigo a utiliza√ß√£o de alguns registradores que foram muito √∫teis para o desenvolvimento do programa, dentre eles <em>RSI</em>, <em>RAX</em>, <em>RDX</em>, <em>RSP</em>, <em>RIP</em>, <em>RFLAGS</em> e assim por diante.</p>
<p>Mas qual o <strong>prop√≥sito de cada registrador</strong>? Posso usar qualquer registrador para qualquer opera√ß√£o, de forma aleat√≥ria?</p>
<blockquote>
<p>De forma pr√°tica, sim. Mas nem sempre conv√©m.</p>
</blockquote>
<p>Nada impede que o teu programa coloque qualquer valor em um registrador arbitr√°rio. Por exemplo, com <code>gdb</code> vamos alterar alguns registradores e ver como o programa se comporta:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Breakpoint &amp; run</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #e5c07b;">break</span> <span style="color: #d19a66;">13</span>
</div><div class="line" data-line="3"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">run</span> <span style="color: #e06c75;">Leandro</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #7f848e;"># Vamos alterar alguns registradores arbitr√°rios</span>
</div><div class="line" data-line="6"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #e5c07b;">set</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rax</span> <span style="color: #e06c75;">=</span> <span style="color: #d19a66;">42</span>
</div><div class="line" data-line="7"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #e5c07b;">set</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rdx</span> <span style="color: #e06c75;">=</span> <span style="color: #d19a66;">33</span>
</div><div class="line" data-line="8">
</div><div class="line" data-line="9"><span style="color: #7f848e;"># Confirmando que foram modificados</span>
</div><div class="line" data-line="10"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">rax</span> <span style="color: #e06c75;">rdx</span>
</div><div class="line" data-line="11"><span style="color: #61afef;">rax</span>            <span style="color: #e06c75;">0x2a</span>                <span style="color: #d19a66;">42</span>
</div><div class="line" data-line="12"><span style="color: #61afef;">rdx</span>            <span style="color: #d19a66;">0x21</span>                <span style="color: #d19a66;">33</span>
</div><div class="line" data-line="13">
</div><div class="line" data-line="14"><span style="color: #7f848e;"># Continuando...</span>
</div><div class="line" data-line="15"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #e5c07b;">continue</span>
</div><div class="line" data-line="16"><span style="color: #61afef;">Continuing.</span>
</div><div class="line" data-line="17"><span style="color: #61afef;">Hi,</span> <span style="color: #e06c75;">Leandro</span>
</div><div class="line" data-line="18"><span style="color: #c678dd;">[</span><span style="color: #61afef;">Inferior</span> <span style="color: #d19a66;">1</span> <span style="color: #c678dd;">(</span><span style="color: #61afef;">process</span> <span style="color: #d19a66;">19231</span><span style="color: #c678dd;">)</span> exited normally<span style="color: #c678dd;">]</span>
</div></code></pre>
<p>Okay, podemos ver que ter mudado estes registradores para <em>qualquer valor</em> n√£o impactou o programa. No meio do programa, provavelmente eles s√£o sobrescritos novamente e utilizados de acordo com <em>determinada l√≥gica</em>.</p>
<p>Mas e se alterarmos, por exemplo, um registrador como o <code>rip</code>, que √© o <em>ponteiro da pr√≥xima instru√ß√£o</em>?</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Breakpoint &amp; run</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #e5c07b;">break</span> <span style="color: #d19a66;">13</span>
</div><div class="line" data-line="3"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">run</span> <span style="color: #e06c75;">Leandro</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #7f848e;"># Antes de alterar o RIP, podemos ver qual o valor ele carrega,</span>
</div><div class="line" data-line="6"><span style="color: #7f848e;"># que √© o ponteiro da pr√≥xima instru√ß√£o</span>
</div><div class="line" data-line="7"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">rip</span>
</div><div class="line" data-line="8"><span style="color: #61afef;">rip</span>            <span style="color: #d19a66;">0x401000</span>            <span style="color: #d19a66;">0x401000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">_start</span><span style="color: #56b6c2;">&gt;</span>
</div><div class="line" data-line="9">
</div><div class="line" data-line="10"><span style="color: #7f848e;"># Vamos alterar o registrador RIP</span>
</div><div class="line" data-line="11"><span style="color: #c678dd;">(</span>gdb) set <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rip</span> <span style="color: #61afef;">=</span> <span style="color: #d19a66;">42</span>
</div><div class="line" data-line="12">
</div><div class="line" data-line="13"><span style="color: #7f848e;"># Confirmando que foi alterando</span>
</div><div class="line" data-line="14"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">rip</span>
</div><div class="line" data-line="15"><span style="color: #61afef;">rip</span>            <span style="color: #e06c75;">0x2a</span>                <span style="color: #e06c75;">0x2a</span>
</div><div class="line" data-line="16">
</div><div class="line" data-line="17"><span style="color: #7f848e;"># Continuando...</span>
</div><div class="line" data-line="18"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #e5c07b;">continue</span>
</div><div class="line" data-line="19"><span style="color: #61afef;">Continuing.</span>
</div><div class="line" data-line="20"><span style="color: #61afef;">Program</span> <span style="color: #e06c75;">received</span> <span style="color: #e06c75;">signal</span> <span style="color: #e06c75;">SIGSEGV,</span> <span style="color: #e06c75;">Segmentation</span> <span style="color: #e06c75;">fault.</span>
</div><div class="line" data-line="21"><span style="color: #61afef;">0x000000000000002a</span> <span style="color: #e06c75;">in</span> <span style="color: #e06c75;">??</span> <span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span>
</div></code></pre>
<p><em>Ouch!</em> Agora o programa n√£o p√¥de ser finalizado com sucesso. Confirmamos ent√£o que nem sempre conv√©m mudar os registradores sem <em>haver algum crit√©rio</em>.</p>
<h3><a href="#prop√≥sito-dos-registradores" aria-hidden="true" class="anchor" id="prop√≥sito-dos-registradores"></a>Prop√≥sito dos registradores</h3>
<p>Os registradores, e falando especificamente da arquitetura x86, seguem um <strong>prop√≥sito original</strong> para o qual foram designados. Mas tamb√©m podem ser utilizados em conven√ß√µes de <strong>chamadas de sistema</strong> tal como vimos na montagem das syscalls <code>write</code> e <code>exit</code>, e neste caso a utiliza√ß√£o correta importa bastante.</p>
<p>E al√©m disso, alguns registradores cont√©m dados importantes para a execu√ß√£o do programa, tais como o <code>rip</code> e <code>eflags</code>.</p>
<ul>
<li>Prop√≥sito original</li>
<li>Conven√ß√µes de chamadas</li>
<li>Funcionamento cr√≠tico do programa</li>
</ul>
<p>Apesar destas caracter√≠sticas importantes de uso dos registradores, podem haver situa√ß√µes em que utilizar um registrador de prop√≥sito geral √© o que faz mais sentido para o programa. Vamos a seguir destacar alguns registradores e seus <em>prop√≥sitos originais</em>.</p>
<h3><a href="#registradores-de-prop√≥sito-geral" aria-hidden="true" class="anchor" id="registradores-de-prop√≥sito-geral"></a>Registradores de prop√≥sito geral</h3>
<p>Podemos categorizar os registradores de uso geral em 2 partes: manipula√ß√£o de <em>dados diretos</em> ou <em>endere√ßos de mem√≥ria</em>.</p>
<p><strong>Dados</strong><br />
Registradores podem manipular dados, que chamamos de <em>valor imediato</em>, e nesta categoria podemos utilizar RAX, RBX, RCX, RDX e os registradores de rascunho que v√£o de R8 a R15.</p>
<ul>
<li><strong>RAX</strong>: opera√ß√µes aritm√©ticas e armazenamento de resultados; tamb√©m usado para o nome de chamadas de sistema em conven√ß√µes de chamada (syscalls)</li>
<li><strong>RBX</strong>: ponteiro de base, utilizado para o endere√ßo de algumas informa√ß√µes na mem√≥ria</li>
<li><strong>RCX</strong>: geralmente usado como contador, para armazenar a quantidade de vezes que uma instru√ß√£o deve ser executada</li>
<li><strong>RDX</strong>: usado para algumas opera√ß√µes de multiplica√ß√£o e divis√£o, muito utilizado para armazenar o resto de opera√ß√µes</li>
<li><strong>R8 a R15</strong>: registradores de <em>rascunho</em> utilizados para prop√≥sito geral</li>
</ul>
<p><strong>Endere√ßos de mem√≥ria</strong><br />
Registradores tamb√©m permitem manipular endere√ßos de mem√≥ria. Nesta categoria temos RSI, RDI, RBP e RSP.</p>
<ul>
<li><strong>RSI</strong>: utilizado como um ponteiro de origem em opera√ß√µes de transfer√™ncias de dados, frequentemente usado em loops para iterar sobre arrays ou buffers de dados</li>
<li><strong>RDI</strong>: utilizado como ponteiro de destino em opera√ß√µes de transfer√™ncias de dados, frequentemente usado junto com RSI</li>
<li><strong>RBP</strong>: frequentemente usado como ponteiro base em opera√ß√µes de mem√≥ria, para referenciar vari√°veis locais e par√¢metros de fun√ß√£o na stack</li>
<li><strong>RSP</strong>: ponteiro para o topo da pilha (stack) do programa em execu√ß√£o</li>
</ul>
<h3><a href="#registradores-especiais" aria-hidden="true" class="anchor" id="registradores-especiais"></a>Registradores especiais</h3>
<p>Vamos destacar apenas 2 dos registradores considerados ‚Äúespeciais‚Äù:</p>
<ul>
<li><strong>RFLAGS</strong>: utilizado para armazenar o estado da CPU, frequentemente modificado por instru√ß√µes aritm√©ticas e controle de paridade bin√°ria</li>
<li><strong>RIP</strong>: ponteiro de instru√ß√£o, que sempre cont√©m o endere√ßo da pr√≥xima instru√ß√£o a ser executada. Por exemplo, a instru√ß√£o <code>ret</code> busca o endere√ßo do topo da pilha e modifica o <code>rip</code> para que o programa continue a partir daquele ponto</li>
</ul>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/z3ospgiir3a2nv78nm96.png" alt="tipos de registradores" /></p>
<h3><a href="#precisamos-sempre-utilizar-todos-os-64-bits" aria-hidden="true" class="anchor" id="precisamos-sempre-utilizar-todos-os-64-bits"></a>Precisamos sempre utilizar todos os 64 bits?</h3>
<p>Sabemos que registradores nesta arquitetura <strong>ocupam 64 bits de mem√≥ria</strong>. Mas e quando o dado que estamos manipulando n√£o precisa dos 64 bits? Conseguimos otimizar o uso de mem√≥ria?</p>
<blockquote>
<p>A ideia seria algo do tipo ‚Äúpor favor me d√™ uma fatia dos 64 bits, n√£o preciso de tudo‚Äù</p>
</blockquote>
<p>Historicamente, como vimos na parte II desta saga, as CPU‚Äôs x86 n√£o come√ßaram com 64 bits. Evolu√≠ram de 8 bits, para 16, ent√£o 32 at√© chegar em 64 bits.</p>
<p>Para manter compatibilidade, os registradores ‚Äúlegados‚Äù podem ser utilizados na arquitetura x64, e assim quando n√£o houver necessidade de utilizar todos os bits do registrador, podemos utilizar uma <em>fatia menor</em>.</p>
<p>Por exemplo, o registrador RAX de 64-bits tem o seu equivalente de 32-bits que √© o EAX, que <strong>ocupa os 32 bits mais baixos</strong>.</p>
<p>O registrador EAX, por sua vez, tem o equivalente AX de 8-bits. Dentro deste AX, podemos utilizar ainda a parte <strong>maior</strong> que se chama AH ou a parte <strong>menor</strong> que se chama AL.</p>
<blockquote>
<p>O ‚ÄúH‚Äù em AH vem de ‚Äúhigh‚Äù, e consequentemente ‚ÄúL‚Äù de AL significa ‚Äúlow‚Äù. √ìbvio, n√£o? :P</p>
</blockquote>
<p>Sendo assim, h√° situa√ß√µes em que ao inv√©s de:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">mov rax, 7  ; 1 byte mas ocupa 8 bytes (64 bits)
</div></code></pre>
<p>E sabendo que 42 n√£o ocupa 64 bits, podemos mudar para:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">mov eax, 7  ; 1 byte mas ocupa 4 bytes (16 bits)
</div></code></pre>
<p>Ou ent√£o:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">mov ax, 7   ; 1 byte ocupando exatamente 1 byte (8 bits)
</div></code></pre>
<p>Assim o programa final passa a ocupar menos mem√≥ria em sua totalidade.</p>
<p>Seguindo esta l√≥gica, podemos aplicar para todos os registradores, trazendo alguns como exemplo:</p>
<ul>
<li><strong>RAX</strong>: <code>EAX -&gt; AX -&gt; AH -&gt; AL</code></li>
<li><strong>RBX</strong>: <code>EBX -&gt; BX -&gt; BH -&gt; BL</code></li>
<li><strong>RDX</strong>: <code>RDX -&gt; DX -&gt; DH -&gt; DL</code></li>
<li><strong>R8</strong>: <code>R8W -&gt; R8B</code></li>
</ul>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/wtp88ythfnm7yj2rhefw.png" alt="fatias de registradores" /></p>
<p>E assim por diante.</p>
<hr />
<h2><a href="#uma-side-note-sobre-stack-frames" aria-hidden="true" class="anchor" id="uma-side-note-sobre-stack-frames"></a>Uma side note sobre stack frames</h2>
<p>Depois de publicar o artigo, o <a href="https://twitter.com/rodrigogbranco">Rodrigo Gon√ßalves de Branco</a> decidiu dar um <a href="https://docs.google.com/document/d/10xr0Qm6jatko2dRyQYqXuToXp5DShxl6dhmBnPPUAb4/edit">feedback ultra detalhado</a> executando todos os exemplos aqui demonstrados, e um dos insights foi sobre a utiliza√ß√£o de stack frames.</p>
<blockquote>
<p>Foi um trabalho fenomenal, meus agradecimentos ao Rodrigo</p>
</blockquote>
<p>Voltando ao exemplo dos <strong>argumentos na pilha</strong>, dentro da rotina <code>_start</code>, temos a pilha do programa com o seguinte layout:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/uaiuvwiltzhlzj5bxner.png" alt="rsp antes" /></p>
<p>Quando fazemos a chamada:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">...
</div><div class="line" data-line="2">	push greet    ; adiciona &quot;Hi, &quot; na stack para print
</div><div class="line" data-line="3">	call .print     
</div><div class="line" data-line="4">...
</div></code></pre>
<p>Estamos basicamente <em>manipulando a pilha original</em> do programa. O <code>push</code> vai colocar no topo da pilha (RSP) o endere√ßo de <code>greet</code>, como demonstrado a seguir no GDB:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Breakpoint no &lt;push greet&gt;</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #e5c07b;">break</span> <span style="color: #d19a66;">13</span>   
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">run</span>
</div><div class="line" data-line="5"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">next</span>
</div><div class="line" data-line="6">
</div><div class="line" data-line="7"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsp</span>
</div><div class="line" data-line="8"><span style="color: #61afef;">0x7fffffffe448:</span> <span style="color: #d19a66;">0x00402000</span>
</div></code></pre>
<p>Agora a pilha ficou assim:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/3tqkty8gtj5olc876qtd.png" alt="layout com pilha e data" /></p>
<p>Se fizermos <code>step</code> no GDB, podemos ver que o RSP foi modificado novamente, desta vez adicionando o endere√ßo da pr√≥xima instru√ß√£o por conta da chamada <code>call</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">step</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsp</span>
</div><div class="line" data-line="4"><span style="color: #61afef;">0x7fffffffe440:</span> <span style="color: #e06c75;">0x0040100a</span>
</div></code></pre>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7kis57u2auas91bcebog.png" alt="layout com data e text" /></p>
<p><em>Isso √© o que acontece com a pilha em uma simples chamada de rotina com argumentos!</em></p>
<p>Bom, sabendo disso, vemos que o argumento que precisamos est√° em <code>rsp + 8</code>, exatamente como no nosso programa original. <em>So far, so good</em>.</p>
<p>O problema √© que podemos reparar que o RSP √© modificado durante as chamadas de fun√ß√µes no programa. N√£o temos controle sobre isso.</p>
<p>E podem acontecer <em>comportamentos inesperados</em> (bugs?) quando isso ocorre, pelo simples fato de estarmos <strong>apontando dados na pilha</strong> e eles j√° estarem em posi√ß√µes que n√£o esper√°vamos.</p>
<p>Para mitigar este potencial problema, podemos preservar a <strong>base da pilha</strong> em algum registrador sempre no in√≠cio de cada fun√ß√£o, desta forma cada rotina/fun√ß√£o pode ter sua pr√≥pria ‚Äúvers√£o‚Äù da pilha sem correr riscos de apontar para o dado errado.</p>
<p>Esta t√©cnica √© chamada de <strong>stack frame</strong>.</p>
<p>E √© pra isso que usamos o <strong>registrador RBP</strong>! No <em>pr√≥logo</em> de cada rotina, adicionamos o <code>rbp</code> na pilha e em seguida colocamos o ponteiro de <code>rsp</code> dentro do registrador <code>rbp</code>, igualando assim ambos registradores:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">_start:
</div><div class="line" data-line="2">    push rbp
</div><div class="line" data-line="3">    mov rbp, rsp
</div><div class="line" data-line="4">....
</div></code></pre>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/si286ldan8b9swswr9q0.png" alt="rsp e rbp" /></p>
<p>Repare que esta t√©cnica consiste em <em>igualar</em> RSP com RBP, assim pode-se de forma segura manipular o <em>ponteiro em RBP</em>, pois mesmo RSP sendo modificado pelo programa, RBP continua intacto.</p>
<p>Continuando com o programa:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">push rbp
</div><div class="line" data-line="2">mov rbp, rsp
</div><div class="line" data-line="3">....
</div><div class="line" data-line="4">push greet
</div><div class="line" data-line="5">call .print
</div><div class="line" data-line="6">....
</div></code></pre>
<p>Constatamos no GDB que a stack foi alterada, portanto RSP foi modificado para apontar para o endere√ßo da pr√≥xima instru√ß√£o, ao passo que RBP continua apontando pro valor anterior:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># RBP </span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rbp</span>
</div><div class="line" data-line="3"><span style="color: #61afef;">0x7fffffffe448:</span> <span style="color: #d19a66;">0x00000000</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #7f848e;"># RSP aponta para o endere√ßo da pr√≥xima instru√ß√£o </span>
</div><div class="line" data-line="6"><span style="color: #7f848e;"># antes da chamada da rotina</span>
</div><div class="line" data-line="7"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsp</span>
</div><div class="line" data-line="8"><span style="color: #61afef;">0x7fffffffe438:</span> <span style="color: #e06c75;">0x0040100e</span>
</div><div class="line" data-line="9">
</div><div class="line" data-line="10"><span style="color: #7f848e;"># RSP + 8 aponta para o primeiro argumento da rotina</span>
</div><div class="line" data-line="11"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsp</span> <span style="color: #e06c75;">+</span> <span style="color: #d19a66;">8</span>
</div><div class="line" data-line="12"><span style="color: #61afef;">0x7fffffffe440:</span> <span style="color: #d19a66;">0x00402000</span>
</div><div class="line" data-line="13">
</div><div class="line" data-line="14"><span style="color: #7f848e;"># RSP + 16 aponta para o mesmo valor de RBP (base da pilha),</span>
</div><div class="line" data-line="15"><span style="color: #7f848e;"># ou seja, `RBP = RSP + 16` neste caso porque houve um PUSH</span>
</div><div class="line" data-line="16"><span style="color: #7f848e;"># expl√≠cito do argumento e tamb√©m outro push feito pelo CALL</span>
</div><div class="line" data-line="17"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsp</span> <span style="color: #e06c75;">+</span> <span style="color: #d19a66;">16</span>
</div><div class="line" data-line="18"><span style="color: #61afef;">0x7fffffffe448:</span> <span style="color: #d19a66;">0x00000000</span>
</div></code></pre>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/a3fjvaxlpm4g8c41jnl8.png" alt="rbp  = rsp + 16" /></p>
<p>E modificando a rotina <code>.print</code> para tamb√©m ter seu pr√≥prio stack frame, como fica a pilha depois de executar:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">.print:
</div><div class="line" data-line="2">    push rbp
</div><div class="line" data-line="3">    mov rbp, rsp
</div><div class="line" data-line="4">....
</div></code></pre>
<p>Analisando com GDB:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rbp</span>
</div><div class="line" data-line="2"><span style="color: #61afef;">0x7fffffffe430:</span> <span style="color: #e06c75;">0xffffe448</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">rsp</span>
</div><div class="line" data-line="5"><span style="color: #61afef;">0x7fffffffe430:</span> <span style="color: #e06c75;">0xffffe448</span>
</div></code></pre>
<p>RSP e RBP ficaram igualados novamente, dando uma caracter√≠stica de stack frame, preservando a pilha como podemos ver na imagem a seguir:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/oyrhiaqltlra50b8fi2w.png" alt="stack frame" /></p>
<p>Portanto, o argumento da rotina, ao inv√©s de ser <code>rsp + 8</code>, passa a ser <code>rbp + 16</code> por conta da stack frame, ficando da seguinte forma:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">.print:                  
</div><div class="line" data-line="2">	push rbp
</div><div class="line" data-line="3">	mov rbp, rsp
</div><div class="line" data-line="4">
</div><div class="line" data-line="5">	mov rsi, [rbp + 16]     
</div><div class="line" data-line="6">	mov r9, rsi
</div><div class="line" data-line="7">	mov rdx, 0
</div></code></pre>
<p><em>Uma coisa importante</em>: ao final de cada rotina, antes do <em>retorno</em>, devemos fazer <code>pop</code> do topo da pilha para voltar ao estado original antes do <code>push rbp</code> feito no in√≠cio da rotina:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">push rbp
</div><div class="line" data-line="2">mov rbp, rsp
</div><div class="line" data-line="3">....
</div><div class="line" data-line="4">pop rbp
</div><div class="line" data-line="5">ret
</div></code></pre>
<p>Desta forma, ao fazer o <code>pop rbp</code>, o que est√° em RSP √© justamente o endere√ßo de retorno antes da chamada da fun√ß√£o:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/4kbrojascqyspoa4lhjl.png" alt="pop do rbp antes do retorno" /></p>
<p>Ao continuar com o programa, a instru√ß√£o <code>ret</code> (j√° falamos sobre ela anteriormente) faz <em>pop</em> do topo da pilha (RSP) e continua a execu√ß√£o do programa na pr√≥xima instru√ß√£o:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">_start:
</div><div class="line" data-line="2">	push rbp
</div><div class="line" data-line="3">	mov rbp, rsp     ; &lt;--- iguala RSP e RBP
</div><div class="line" data-line="4">
</div><div class="line" data-line="5">	push greet       ; &lt;--- adiciona &lt;greet&gt; na pilha
</div><div class="line" data-line="6">	call .print      ; &lt;--- adiciona ponteiro da pr√≥xima 
</div><div class="line" data-line="7">                         ; instru√ß√£o na pilha
</div><div class="line" data-line="8">	pop rax          ; &lt;--- faz pop de &lt;greet&gt; da pilha      
</div><div class="line" data-line="9">
</div><div class="line" data-line="10">............
</div><div class="line" data-line="11">.print:                 
</div><div class="line" data-line="12">	push rbp         
</div><div class="line" data-line="13">	mov rbp, rsp     ; &lt;--- iguala RSP e RBP
</div><div class="line" data-line="14">
</div><div class="line" data-line="15">	mov rsi, [rbp + 16]     
</div><div class="line" data-line="16">        .............
</div><div class="line" data-line="17">	syscall
</div><div class="line" data-line="18">	pop rbp          ; &lt;--- remove frame RBP da pilha
</div><div class="line" data-line="19">	ret              ; &lt;--- faz pop do pointeiro da 
</div><div class="line" data-line="20">                         ; pr√≥xima instru√ß√£o e atualiza RIP
</div></code></pre>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/nrhswxyhluvlc9yvlyem.png" alt="layout depois do ret" /></p>
<p>Quando o fluxo volta para quem chamou a rotina, a pr√≥xima instru√ß√£o deve ser sempre o <code>pop</code> dos argumentos que entraram na pilha.</p>
<p>Neste caso no exemplo anterior estamos fazendo <em>pop</em> do argumento e descartando o valor em RAX com <code>pop rax</code>, deixando assim a pilha em seu estado anterior √† chamada da rotina:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/uxp5nup5nzqs19hx3nwb.png" alt="final" /></p>
<p>Ao fim do programa (rotina <code>_start</code>), devemos tamb√©m fazer <code>pop rbp</code>, assim a pilha volta ao estado original de quando foi iniciado o programa.</p>
<p>C√≥digo completo:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">%define SYS_write 1
</div><div class="line" data-line="4">%define SYS_exit 60
</div><div class="line" data-line="5">%define STDOUT 1
</div><div class="line" data-line="6">
</div><div class="line" data-line="7">section .data
</div><div class="line" data-line="8">greet: db &quot;Hi, &quot;, 0
</div><div class="line" data-line="9">newline: db 0xA, 0
</div><div class="line" data-line="10">
</div><div class="line" data-line="11">section .text
</div><div class="line" data-line="12">_start:
</div><div class="line" data-line="13">	push rbp               ; &lt;-- cria um stack frame
</div><div class="line" data-line="14">	mov rbp, rsp           ; para preservar a pilha
</div><div class="line" data-line="15">
</div><div class="line" data-line="16">	push greet             ; adiciona &quot;Hi, &quot; na pilha
</div><div class="line" data-line="17">	call .print            ; chama sub-rotina
</div><div class="line" data-line="18">	pop rax                ; remove &quot;Hi, &quot; da pilha
</div><div class="line" data-line="19">
</div><div class="line" data-line="20">	push qword [rbp + 24]  ; adiciona argumento na pilha
</div><div class="line" data-line="21">	call .print            ; chama sub-rotina
</div><div class="line" data-line="22">	pop rax                ; remove argumento da pilhha
</div><div class="line" data-line="23">
</div><div class="line" data-line="24">	push newline           ; adiciona newline na pilha
</div><div class="line" data-line="25">	call .print            ; chama-subrotina
</div><div class="line" data-line="26">	pop rax                ; remove newline da pilha
</div><div class="line" data-line="27">
</div><div class="line" data-line="28">	pop rbp                ; remove RBP da pilha, 
</div><div class="line" data-line="29">                               ; retornando ao estado original
</div><div class="line" data-line="30">.exit:               
</div><div class="line" data-line="31">	mov rdi, 0
</div><div class="line" data-line="32">	mov rax, SYS_exit
</div><div class="line" data-line="33">	syscall                ; termina o programa
</div><div class="line" data-line="34">.print:                   
</div><div class="line" data-line="35">	push rbp               ; &lt;-- cria um stack frame
</div><div class="line" data-line="36">	mov rbp, rsp           ; para preservar a pilha
</div><div class="line" data-line="37">
</div><div class="line" data-line="38">	mov rsi, [rbp + 16]     
</div><div class="line" data-line="39">	mov r9, rsi
</div><div class="line" data-line="40">	mov rdx, 0
</div><div class="line" data-line="41">.calculate_size:               ; loop para calcular tamanho
</div><div class="line" data-line="42">	inc rdx
</div><div class="line" data-line="43">	inc r9
</div><div class="line" data-line="44">	cmp byte [r9], 0x00
</div><div class="line" data-line="45">	jz .done
</div><div class="line" data-line="46">	jmp .calculate_size
</div><div class="line" data-line="47">.done:                     
</div><div class="line" data-line="48">	mov rdi, STDOUT
</div><div class="line" data-line="49">	mov rax, SYS_write
</div><div class="line" data-line="50">	syscall
</div><div class="line" data-line="51">
</div><div class="line" data-line="52">	pop rbp                ; &lt;--- remove RBP da pilha, 
</div><div class="line" data-line="53">                               ; retornando ao estado anterior
</div><div class="line" data-line="54">
</div><div class="line" data-line="55">	ret                    ; &lt;--- retorna fluxo para o
</div><div class="line" data-line="56">                               ; estado anterior
</div></code></pre>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/4zqxli9xe88yxloe21ht.png" alt="voltando ao estado original da pilha" /></p>
<p>√â isto. Esta se√ß√£o foi apenas uma demonstra√ß√£o de como utilizar boas pr√°ticas de manipula√ß√£o da pilha quando utilizamos argumentos em fun√ß√µes, atrav√©s da t√©cnica de <em>criar um frame</em> como <strong>base da pilha</strong> com o registrador RBP.</p>
<hr />
<h2><a href="#conclus√£o" aria-hidden="true" class="anchor" id="conclus√£o"></a>Conclus√£o</h2>
<p>√â isto, pessoal. Esta parte da saga foi bastante densa. Passamos pela cria√ß√£o de um programa simples em Assembly, ao passo em que √≠amos depurando o programa com ferramentas como <em>strace</em>, <em>size</em> e <strong>muito gdb</strong>.</p>
<p>Tamb√©m aprendemos sobre labels, tipos de registradores, desvio de fluxo com jmp, call, ret, <strong>muita stack</strong>, depurando tudo e mais um pouco, loops, FLAGS e aritm√©tica de ponteiro.</p>
<p>Apesar de ter sido muito denso, os t√≥picos aqui abordados servir√£o de base para entendermos o pr√≥ximo artigo que j√° come√ßa pesado com syscalls de rede, para iniciarmos o nosso t√£o esperado web server.</p>
<p>Nos vemos no pr√≥ximo artigo!</p>
<hr />
<h2><a href="#refer√™ncias" aria-hidden="true" class="anchor" id="refer√™ncias"></a>Refer√™ncias</h2>
<sub>
Mnemonics
https://en.wikipedia.org/wiki/Mnemonic
Comparison of Assemblers
https://en.wikipedia.org/wiki/Comparison_of_assemblers
Linker (computing)
https://en.wikipedia.org/wiki/Linker_(computing)
Assembly x86 tutorial
https://www.tutorialspoint.com/assembly_programming/index.htm
Data segment
https://en.wikipedia.org/wiki/Data_segment
FLAGS register
https://en.wikipedia.org/wiki/FLAGS_register
Debugging with GDB
https://ncona.com/2019/12/debugging-assembly-with-gdb/
GDB command reference
https://visualgdb.com/gdbreference/commands/
GDB cheatsheet
https://cs.brown.edu/courses/cs033/docs/guides/gdb.pdf
[V√≠deo] Introdu√ß√£o ao GNU Debugger - Blau Ara√∫jo
https://www.youtube.com/watch?v=t9OKpBKbJ4Q
</sub>
      </div>

      <!-- Back to top -->
      <div class="mt-12 mb-8 text-center">
        <a href="#" onclick="event.preventDefault(); window.scrollTo({ top: 0, behavior: 'smooth' });" class="inline-flex items-center gap-2 text-xl font-medium transition-colors text-base-content/70 hover:text-primary cursor-pointer">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
          </svg>
          Back to top
        </a>
      </div>
    </article>

    <!-- Giscus Comments -->
    <div class="mt-16">
      <div class="border-t border-base-300 pt-8">
        <h2 class="text-2xl font-bold mb-6">Comments</h2>
        <script src="https://giscus.app/client.js"
                data-repo="leandronsp/leandronsp.com"
                data-repo-id="R_kgDOQGG-eQ"
                data-category="Announcements"
                data-category-id="DIC_kwDOQGG-ec4Cw4TN"
                data-mapping="pathname"
                data-strict="0"
                data-reactions-enabled="1"
                data-emit-metadata="0"
                data-input-position="bottom"
                data-theme="preferred_color_scheme"
                data-lang="en"
                crossorigin="anonymous"
                async>
        </script>
      </div>
    </div>

    <!-- Footer -->
    <footer class="mt-16 pt-8 pb-6 border-t border-base-300">
      <div class="text-center text-sm text-base-content/80">
        <p>
          Powered by
          <a
            href="https://github.com/leandronsp/curupira"
            target="_blank"
            rel="noopener noreferrer"
            class="font-semibold text-blue-600 hover:underline"
          >
            Curupira
          </a>
          | Open source blog platform built with Phoenix LiveView
        </p>
        <p class="mt-2 text-xs text-base-content/70">
          Licensed under
          <a
            href="https://github.com/leandronsp/curupira/blob/master/LICENSE"
            target="_blank"
            rel="noopener noreferrer"
            class="text-blue-600 hover:underline"
          >
            AGPL-3.0
          </a>
        </p>
      </div>
    </footer>
  </main>

  <script src="/static-theme.js" defer></script>
  <script src="/static-filters.js" defer></script>
  <script src="/static-search.js" defer></script>
  <script src="/static-giscus.js" defer></script>

  <!-- Lazy load Google Analytics after page is interactive -->
  <script>
    (function() {
      function loadGTM() {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-0Y5RNLZMKN');

        var script = document.createElement('script');
        script.async = true;
        script.src = 'https://www.googletagmanager.com/gtag/js?id=G-0Y5RNLZMKN';
        document.head.appendChild(script);
      }

      // Load after page is idle, or after 2 seconds as fallback
      if ('requestIdleCallback' in window) {
        requestIdleCallback(loadGTM, { timeout: 2000 });
      } else {
        setTimeout(loadGTM, 2000);
      }
    })();
  </script>
</body>
</html>
