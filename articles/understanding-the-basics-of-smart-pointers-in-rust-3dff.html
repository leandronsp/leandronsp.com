<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Understanding the basics of Smart Pointers in Rust - Leandro Proen√ßa</title>
  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">

  <!-- SEO Meta Tags -->
  <meta name="description" content="In today's post we'll delve into the basics of smart pointers in Rust, while we build from scratch a simple linked list - starting from a singly linked list and">
  <meta name="author" content="Leandro Proen√ßa">
  <link rel="canonical" href="https://leandronsp.com/articles/understanding-the-basics-of-smart-pointers-in-rust-3dff.html">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://leandronsp.com/articles/understanding-the-basics-of-smart-pointers-in-rust-3dff.html">
  <meta property="og:title" content="Understanding the basics of Smart Pointers in Rust">
  <meta property="og:description" content="In today's post we'll delve into the basics of smart pointers in Rust, while we build from scratch a simple linked list - starting from a singly linked list and">
  <meta property="og:site_name" content="Leandro Proen√ßa">
  <meta property="article:published_time" content="2023-11-01T04:15:27Z">
  <meta property="article:tag" content="rust">
      <meta property="article:tag" content="datastructures">

  <!-- JSON-LD Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "Understanding the basics of Smart Pointers in Rust",
    "datePublished": "2023-11-01T04:15:27Z",
    "author": {
      "@type": "Person",
      "name": "Leandro Proen√ßa"
    },
    "description": "In today's post we'll delve into the basics of smart pointers in Rust, while we build from scratch a simple linked list - starting from a singly linked list and",
        "keywords": "rust, datastructures"
  }
  </script>

  <link rel="preload" href="/assets/css/app.c82d75ab.css" as="style">
  <script>
    // Prevent FOUC (Flash of Unstyled Content) by setting theme before CSS loads
    (function() {
      const theme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <link rel="stylesheet" href="/assets/css/app.c82d75ab.css">
  <style>
    /* Force scrollbar to always be visible to prevent layout shift */
    html {
      overflow-y: scroll;
    }

    /* Softer dark theme colors */
    [data-theme="dark"] {
      --base-100: #2a2f3a;
      --base-200: #232831;
      --base-300: #1e222a;
      --base-content: #e8eaed;
    }
    [data-theme="dark"] .article-card {
      background-color: transparent;
    }
    /* Keep pinned article with background for prominence in dark theme - lighter pastel */
    [data-theme="dark"] .pinned-article {
      background-color: #3a4050 !important;
    }
    [data-theme="dark"] .prose {
      color: #e8eaed;
    }
    [data-theme="dark"] .prose h1,
    [data-theme="dark"] .prose h2,
    [data-theme="dark"] .prose h3,
    [data-theme="dark"] .prose h4 {
      color: #f0f2f5;
    }
    [data-theme="dark"] .prose a {
      color: #8fb4ff;
    }
    [data-theme="dark"] .prose code {
      background-color: #3d4454;
      color: #f0f2f5;
    }
    [data-theme="dark"] .prose pre {
      background-color: #1e222a;
      border: 1px solid #3d4454;
    }
    [data-theme="dark"] input {
      background-color: #2f3542;
      border-color: #3d4454;
      color: #e8eaed;
    }
    [data-theme="dark"] input::placeholder {
      color: #9ca3af;
    }
    /* Language switcher dark theme styling */
    [data-theme="dark"] .lang-switcher-bg {
      background-color: rgba(59, 130, 246, 0.15) !important;
      border-color: rgba(59, 130, 246, 0.3) !important;
    }
    /* Blog name styling - system font first, Google Font loads async */
    .blog-name {
      font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    /* Intro text styling - system font first, Google Font loads async */
    .intro-text {
      font-family: 'Caveat', 'Bradley Hand', 'Comic Sans MS', cursive;
      font-weight: 600;
      color: #6b7280; /* Darker pastel gray for light theme */
    }
    [data-theme="dark"] .intro-text {
      color: #d4d4d8; /* Lighter pastel gray for dark theme */
    }
    /* Article card styling */
    article {
      background-color: transparent;
      border: none;
      border-radius: 0.5rem;
      padding: 2rem;
    }
    [data-theme="dark"] article {
      background-color: transparent;
    }
    /* Article images styling - consistent sizing */
    .prose img {
      max-width: 800px;
      width: 100%;
      height: auto;
      display: block;
      margin-left: auto;
      margin-right: auto;
      border-radius: 0.5rem;
    }
  </style>
</head>
<body class="min-h-screen bg-base-100">
  <!-- Fixed Header - Article page: focus on reading -->
  <header class="sticky top-0 z-50 bg-base-100 border-b border-base-300 shadow-sm">
    <div class="container mx-auto px-4 sm:px-6 py-4 max-w-6xl">
      <!-- Same structure as homepage, no search/language/tags -->
      <div class="flex flex-col gap-2">
        <!-- Name + Social Icons + Guide Links (icons hidden on small) -->
        <div class="flex items-center gap-3">
          <a href="/" class="blog-name text-2xl sm:text-3xl font-bold text-base-content flex-shrink-0 no-underline cursor-pointer hover:opacity-80 transition-opacity">Leandro Proen√ßa</a>
          <div class="hidden md:flex items-center gap-2">
            <a href="https://linkedin.com/in/leandronsp" target="_blank" rel="noopener noreferrer" class="text-base-content/60 hover:text-primary transition-colors" title="LinkedIn">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
            </a>
            <a href="https://github.com/leandronsp" target="_blank" rel="noopener noreferrer" class="text-base-content/60 hover:text-primary transition-colors" title="GitHub">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/></svg>
            </a>
            <button id="theme-toggle" class="text-base-content/60 hover:text-primary transition-colors" title="Toggle theme">
              <svg xmlns="http://www.w3.org/2000/svg" class="sun-icon h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
              <svg xmlns="http://www.w3.org/2000/svg" class="moon-icon h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>
          </div>
          <!-- Guide Links (medium and up) -->
          <div class="hidden md:flex items-center gap-3 ml-4">
            <a href="https://concorrencia101.leandronsp.com" target="_blank" rel="noopener noreferrer" class="flex items-center gap-1 text-sm font-medium text-base-content/70 hover:text-primary transition-colors" title="Concorr√™ncia 101">
              <span>Concorr√™ncia 101</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </a>
            <a href="https://web101.leandronsp.com" target="_blank" rel="noopener noreferrer" class="flex items-center gap-1 text-sm font-medium text-base-content/70 hover:text-primary transition-colors" title="Web 101">
              <span>Web 101</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </a>
            <a href="https://aws101.leandronsp.com" target="_blank" rel="noopener noreferrer" class="flex items-center gap-1 text-sm font-medium text-base-content/70 hover:text-primary transition-colors" title="AWS 101">
              <span>AWS 101</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </a>
          </div>
        </div>

        <!-- Bio -->
        <p class="intro-text text-xl sm:text-2xl leading-tight">
          Software Developer 15+ years working for companies worldwide
        </p>
      </div>

    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto max-w-6xl">
    <article class="bg-base-100">
      <!-- Back link -->
      <a href="/" onclick="event.preventDefault(); history.back();" class="inline-flex items-center gap-2 text-lg font-medium transition-colors text-base-content/70 hover:text-primary cursor-pointer mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back
      </a>

      <h1 class="text-5xl font-bold leading-tight mb-6">Understanding the basics of Smart Pointers in Rust</h1>

      <div class="flex flex-wrap items-center gap-3 mb-8 text-base text-base-content/85">
        <div class="flex items-center gap-1.5">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
          <span>Published 01 Nov 2023</span>
        </div>

        <div class="flex items-center gap-1.5">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
  </svg>
  <div class="flex gap-2 flex-wrap">
    <span class="inline-flex items-center px-3 py-1 text-sm border border-base-content/25 rounded-full">rust</span><span class="inline-flex items-center px-3 py-1 text-sm border border-base-content/25 rounded-full">datastructures</span>
  </div>
</div>

      </div>

      <div class="prose prose-lg max-w-none">
        <p>In today‚Äôs post we‚Äôll delve into the basics of smart pointers in Rust, while we build from scratch a simple linked list - starting from a singly linked list and then evolving to a doubly one.</p>
<hr />
<h2><a href="#prelude-intro-to-rust" aria-hidden="true" class="anchor" id="prelude-intro-to-rust"></a>Prelude, intro to Rust</h2>
<p>It‚Äôs not intended to be an introduction about Rust. For that, you can follow along <a href="https://dev.to/mfcastellani/series/23318">this blogpost series</a> by <a href="https://dev.to/mfcastellani">@mfcastellani</a>.</p>
<p>Also, you can read <a href="https://www.casadocodigo.com.br/products/livro-rust">his book</a> (pt-BR). Moreover, I have a <a href="https://www.youtube.com/watch?v=6VSgMbFNUuQ">live coding video</a> where I explored the Rust fundamentals by covering an introduction to Rust, data types, functions, ownership, references, structs/enums and error handling.</p>
<p>Another content about Rust I higly recommend is presented on <a href="https://www.youtube.com/watch?v=zWXloY0sslE">this Youtube channel</a> by Bruno Rocha, which creates great videos about Rust as well (pt-BR).</p>
<blockquote>
<p>Please note that this post you are currently reading was written during a <a href="https://www.youtube.com/watch?v=bdZe0LjDUyk">live coding session (pt-BR)</a> where you can follow the process I use to write blogposts in general and how I created this particular one. It‚Äôs a novel format I‚Äôm experimenting with to share content.</p>
</blockquote>
<p>However, if you are looking for introdutory content in english only, the Youtube channel <a href="https://www.youtube.com/@letsgetrusty">Let‚Äôs get Rusty</a> provides great content on Rust from basics to advanced.</p>
<hr />
<p>No more introduction, let‚Äôs embark on this journey of <strong>Smart Pointers in Rust</strong>.</p>
<hr />
<h2><a href="#table-of-contents" aria-hidden="true" class="anchor" id="table-of-contents"></a>Table of Contents</h2>
<ul>
<li><a href="#first-things-first">First things first</a></li>
<li><a href="#a-linked-list-using-rust">A linked list using Rust</a></li>
<li><a href="#box">Meet the Box smart pointer</a></li>
<li><a href="#rc">Shared ownership using Rc</a></li>
<li><a href="#refcell">Interior mutability with RefCell</a></li>
<li><a href="#thinking-about-a-circular-linked-list">Weak references on a circular linked list</a></li>
</ul>
<hr />
<h2><a href="#-first-things-first" aria-hidden="true" class="anchor" id="-first-things-first"></a>üëâ First things first</h2>
<p>Rust employs a mechanism for dealing with memory management where it prevents dangling references, double free error and other problems related to memory management.</p>
<p>This mechanism is called ‚Äúownership‚Äù and through <a href="https://en.wikipedia.org/wiki/Resource_acquisition_is_initialization">RAII</a> (Resource Acquisition Is Initialization), it follows three basic rules:</p>
<ul>
<li>Each value in Rust has a single owner</li>
<li>There are only <em>one</em> owner at a time</li>
<li>When the owner‚Äôs scope is finished, its associated value is dropped and invalidated</li>
</ul>
<p>When we need to transfer ownership, in case the value is in the stack (fixed-sized types), Rust performs a <em>Copy</em>:</p>
<blockquote>
<p>I‚Äôm assuming that all code snippets within this post are being executed inside a <code>fn main() &lbrace;&rbrace;</code> function</p>
</blockquote>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">age</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">20</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">copied_age</span> <span style="color: #56b6c2;">=</span> <span style="color: #e06c75;">age</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #c678dd;">println</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;copied_age: &lbrace;&rbrace;&quot;</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">copied_age</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="5"><span style="color: #c678dd;">println</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;age: &lbrace;&rbrace;&quot;</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">age</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span> <span style="color: #7f848e;">// age is still valid because Rust performs a &quot;Copy&quot; for data in the stack</span>
</div></code></pre>
<p>As for <em>dynamically-sized</em> types, which live in the heap, Rust performs a <em>Move</em>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">name</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">String</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">from</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;John&quot;</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">other_name</span> <span style="color: #56b6c2;">=</span> <span style="color: #e06c75;">name</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #c678dd;">println</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;other_name: &lbrace;&rbrace;&quot;</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">other_name</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="5"><span style="color: #c678dd;">println</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;name: &lbrace;&rbrace;&quot;</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">name</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span> <span style="color: #7f848e;">// name is no loger valid because Rust performs a &quot;Move&quot;</span>
</div><div class="line" data-line="6">
</div><div class="line" data-line="7"><span style="color: #7f848e;">// Error:</span>
</div><div class="line" data-line="8"><span style="color: #7f848e;">// error[E0382]: borrow of moved value: `name`</span>
</div></code></pre>
<p><em>Copy</em> literally copies the data in the stack, while the <em>Move</em> operation transfers ownership, which means that the former owner is no longer the owner and its reference is completely dropped.</p>
<hr />
<h2><a href="#-a-linked-list-using-rust" aria-hidden="true" class="anchor" id="-a-linked-list-using-rust"></a>üëâ A Linked List using Rust</h2>
<p>A linked list is a data structure which represents a collection of nodes where each node points to the next node. This is basically a <strong>singly linked list</strong>.</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/n2et97dstkxf8y265rsv.png" alt="a singly linked list" /></p>
<p>Also, we can build a linked list where each node points to the previous node as well. In this case, such a list is called <strong>doubly linked list</strong>.</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/eq1gutt2osbn8vwiv5ew.png" alt="a doubly linked list" /></p>
<h3><a href="#-a-singly-linked-list" aria-hidden="true" class="anchor" id="-a-singly-linked-list"></a>üîµ A Singly Linked List</h3>
<p>The first version of our linked list will be a singly one. As we evolve to a doubly linked list, we‚Äôll bring Rust concepts about ownership, references and smart pointers.</p>
<p>We start by modeling the Node:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="2">    <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">i32</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="3">    <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Node</span>
</div><div class="line" data-line="4"><span style="color: #c678dd;">&rbrace;</span>
</div></code></pre>
<p>We are bound to situations where the <strong>next</strong> pointer points to ‚Äúnothing‚Äù, or simply a <code>null</code> pointer when the list reaches the end, commonly seen in a variety of programming languages.</p>
<p>But Rust has no <code>null</code> pointers. That said, we can represent the <code>next</code> pointer by using the enum <strong>Option</strong>, which in Rust gives us two possibilities of types:</p>
<ul>
<li>None (the end of the list)</li>
<li>Some(node)</li>
</ul>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="2">    <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">i32</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="3">    <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&gt;</span>
</div><div class="line" data-line="4"><span style="color: #c678dd;">&rbrace;</span>
</div><div class="line" data-line="5">
</div><div class="line" data-line="6"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">head</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="7"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="8"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">next</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<p>The above code is not yet compiling:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #e06c75;">error</span><span style="color: #c678dd;">[</span><span style="color: #e5c07b;">E0072</span><span style="color: #c678dd;">]</span><span style="color: #abb2bf;">:</span> <span style="color: #e06c75;">recursive</span> <span style="color: #c678dd;">type</span> `<span style="color: #e5c07b;">Node</span>` <span style="color: #e06c75;">has</span> <span style="color: #e06c75;">infinite</span> <span style="color: #e06c75;">size</span>
</div><div class="line" data-line="2"> <span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">&gt;</span> <span style="color: #e06c75;">src</span><span style="color: #56b6c2;">/</span><span style="color: #e06c75;">main</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">rs</span><span style="color: #abb2bf;">:</span><span style="color: #d19a66;">2</span><span style="color: #abb2bf;">:</span><span style="color: #d19a66;">5</span>
</div><div class="line" data-line="3">  <span style="color: #56b6c2;">|</span>
</div><div class="line" data-line="4"><span style="color: #d19a66;">2</span> <span style="color: #56b6c2;">|</span>     <span style="color: #e06c75;">struct</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="5">  <span style="color: #56b6c2;">|</span>     <span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span>
</div><div class="line" data-line="6"><span style="color: #d19a66;">3</span> <span style="color: #56b6c2;">|</span>         <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">i32</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="7"><span style="color: #d19a66;">4</span> <span style="color: #56b6c2;">|</span>         <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #56b6c2;">&lt;</span><span style="color: #e5c07b;">Node</span><span style="color: #56b6c2;">&gt;</span>
</div><div class="line" data-line="8">  <span style="color: #c678dd;">|</span>                      <span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span> <span style="color: #e06c75;">recursive</span> <span style="color: #e06c75;">without</span> <span style="color: #e06c75;">indirection</span>
</div><div class="line" data-line="9">  <span style="color: #c678dd;">|</span>
</div><div class="line" data-line="10"><span style="color: #e06c75;">help</span><span style="color: #abb2bf;">:</span> <span style="color: #e06c75;">insert</span> <span style="color: #e06c75;">some</span> <span style="color: #61afef;">indirection</span> <span style="color: #c678dd;">(</span><span style="color: #e06c75;">e</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">g</span><span style="color: #abb2bf;">.</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">a</span> `<span style="color: #d19a66;">Box</span>`<span style="color: #abb2bf;">,</span> `<span style="color: #e5c07b;">Rc</span>`<span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">or</span> `<span style="color: #56b6c2;">&amp;</span>`<span style="color: #c678dd;">)</span> <span style="color: #e06c75;">to</span> <span style="color: #c678dd;">break</span> <span style="color: #e06c75;">the</span> <span style="color: #e06c75;">cycle</span>
</div><div class="line" data-line="11">  <span style="color: #56b6c2;">|</span>
</div><div class="line" data-line="12"><span style="color: #d19a66;">4</span> <span style="color: #56b6c2;">|</span>         <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #56b6c2;">&lt;</span><span style="color: #e5c07b;">Box</span><span style="color: #56b6c2;">&lt;</span><span style="color: #e5c07b;">Node</span><span style="color: #56b6c2;">&gt;&gt;</span>
</div><div class="line" data-line="13">  <span style="color: #56b6c2;">|</span>                      <span style="color: #56b6c2;">+</span><span style="color: #56b6c2;">+</span><span style="color: #56b6c2;">+</span><span style="color: #56b6c2;">+</span>    <span style="color: #56b6c2;">+</span>
</div></code></pre>
<p>The Rust compiler is saying that <em>Node</em> has unknown size at compile-time and as such it can‚Äôt be determined, because the ‚Äúnext‚Äù pointer points to another Node which points to another Node and so on, infinitely.</p>
<p>This is a <strong>recursive type</strong>.</p>
<p>In order to solve this problem, we have to help the Rust compiler to use some abstraction which can allocate data on the heap and determine the size of the Node at compile-time, resolving the recursive type.</p>
<p>Such abstraction is called <strong>Box</strong>, which is a smart pointer in Rust.</p>
<hr />
<h2><a href="#-box" aria-hidden="true" class="anchor" id="-box"></a>üëâ Box</h2>
<p>By using Box, we want to allocate the data on the heap.</p>
<p>Also, Box has a known size at compile-time. Being a pointer, the <em>size of the Box is the pointer size</em>, which makes it a good fit for recursive types.</p>
<p>The following code compiles sucessfully:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">#</span><span style="color: #c678dd;">[</span><span style="color: #61afef;">derive</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Debug</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">PartialEq</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">]</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="3">    <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">i32</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="4">    <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Box</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span>
</div><div class="line" data-line="5"><span style="color: #c678dd;">&rbrace;</span>
</div><div class="line" data-line="6">
</div><div class="line" data-line="7"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">head</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="8">
</div><div class="line" data-line="9"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="10"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">next</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<p>What if we add one more node, called ‚Äútail‚Äù?</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">tail</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">2</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">head</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">tail</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<p>As always (the Rust compilers always wins), it won‚Äôt compile:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span> <span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span> <span style="color: #e06c75;">expected</span> `<span style="color: #e5c07b;">Box</span><span style="color: #56b6c2;">&lt;</span><span style="color: #e5c07b;">Node</span><span style="color: #56b6c2;">&gt;</span>`<span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">found</span> `<span style="color: #e5c07b;">Node</span>`
</div></code></pre>
<p>We have to wrap the tail in a <em>Box</em>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="2">    <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">i32</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="3">    <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Box</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span>
</div><div class="line" data-line="4"><span style="color: #c678dd;">&rbrace;</span>
</div><div class="line" data-line="5">
</div><div class="line" data-line="6"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">tail</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Box</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="7"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">head</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">tail</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="8">
</div><div class="line" data-line="9"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="10"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">next</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">unwrap</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<ul>
<li>We wrap the tail box in an Option (Some)</li>
<li>The <em>head.next</em> points to an <strong>Option</strong>. Because it‚Äôs the enum Option, we have to call <code>unwrap</code> to fetch the underlying value</li>
</ul>
<p>Let‚Äôs go further in the example and implement a <strong>doubly linked list</strong>, by specifying the <em>prev</em> attribute on the Node struct.</p>
<h3><a href="#-a-doubly-linked-list" aria-hidden="true" class="anchor" id="-a-doubly-linked-list"></a>üîµ A Doubly Linked List</h3>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="2">    <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">i32</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="3">    <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Box</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="4">    <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Box</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="5"><span style="color: #c678dd;">&rbrace;</span>
</div><div class="line" data-line="6">
</div><div class="line" data-line="7"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">tail</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Box</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="8"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">head</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">tail</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<ul>
<li>the <code>head.prev</code> points to <code>None</code></li>
<li>the <code>tail.prev</code> points to <code>None</code> (at this moment‚Ä¶)</li>
</ul>
<p>In order to change the <code>tail.prev</code>, we have to mutate its underlying value, from <code>None</code> to <code>Some(head)</code>. May we change the source code:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">let</span> <span style="color: #c678dd;">mut</span> <span style="color: #e06c75;">tail</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Box</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">head</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Box</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">tail</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">prev</span> <span style="color: #56b6c2;">=</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">head</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span> <span style="color: #7f848e;">// mutating the tail.prev</span>
</div></code></pre>
<p>And‚Ä¶</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #e06c75;">error</span><span style="color: #c678dd;">[</span><span style="color: #e5c07b;">E0382</span><span style="color: #c678dd;">]</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">use</span> <span style="color: #e06c75;">of</span> <span style="color: #e06c75;">moved</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> `<span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">next</span>`
</div><div class="line" data-line="2">  <span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">&gt;</span> <span style="color: #e06c75;">src</span><span style="color: #56b6c2;">/</span><span style="color: #e06c75;">main</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">rs</span><span style="color: #abb2bf;">:</span><span style="color: #d19a66;">14</span><span style="color: #abb2bf;">:</span><span style="color: #d19a66;">15</span>
</div><div class="line" data-line="3">   <span style="color: #56b6c2;">|</span>
</div><div class="line" data-line="4"><span style="color: #d19a66;">9</span>  <span style="color: #56b6c2;">|</span> <span style="color: #e06c75;">let</span> <span style="color: #e06c75;">head</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Box</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">tail</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="5">   <span style="color: #c678dd;">|</span>     <span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span> <span style="color: #c678dd;">move</span> <span style="color: #e06c75;">occurs</span> <span style="color: #e06c75;">because</span> `<span style="color: #e06c75;">head</span>` <span style="color: #e06c75;">has</span> <span style="color: #e06c75;">type</span> `<span style="color: #e5c07b;">Box</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&gt;</span>`<span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">which</span> <span style="color: #e06c75;">does</span> <span style="color: #e06c75;">not</span> <span style="color: #e06c75;">implement</span> <span style="color: #e06c75;">the</span> `<span style="color: #e5c07b;">Copy</span>` <span style="color: #c678dd;">trait</span>
</div><div class="line" data-line="6"><span style="color: #d19a66;">10</span> <span style="color: #c678dd;">|</span>
</div><div class="line" data-line="7"><span style="color: #d19a66;">11</span> <span style="color: #56b6c2;">|</span> <span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">prev</span> <span style="color: #56b6c2;">=</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">head</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="8">   <span style="color: #c678dd;">|</span>                  <span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span> <span style="color: #e06c75;">value</span> <span style="color: #e06c75;">moved</span> <span style="color: #e06c75;"><span style="color: #e06c75;">here</span></span>
</div><div class="line" data-line="9"><span style="color: #e06c75;"><span style="color: #c678dd;">...</span></span>
</div><div class="line" data-line="10"><span style="color: #e06c75;"><span style="color: #d19a66;">14</span></span> <span style="color: #c678dd;">|</span> <span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">next</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">unwrap</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="11">   <span style="color: #56b6c2;">|</span>               <span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span> <span style="color: #e06c75;">value</span> <span style="color: #e06c75;">used</span> <span style="color: #e06c75;">here</span> <span style="color: #e06c75;">after</span> <span style="color: #c678dd;">move</span>
</div></code></pre>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/znv09sx9a23qp53f4p3k.gif" alt="a very very explosion" /></p>
<p><em>Welcome to the ownership saga in Rust!</em></p>
<p>Let‚Äôs clarify some points here:</p>
<p>First, a Box has <strong>single ownership</strong>, meaning that each value holds one owner at a time. Here, in this line:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">head</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Box</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">tail</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span> <span style="color: #7f848e;">// value was moved here</span>
</div></code></pre>
<p><code>Tail</code> has been <em>moved</em>, that‚Äôs why we cannot use it later, due to ownership rules.</p>
<p>To fix that, we can make use of the method <code>clone</code> implemented in the Box, which will perform a deep copy (clone) of the value in the heap:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">head</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Box</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #61afef;">clone</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">prev</span> <span style="color: #56b6c2;">=</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">head</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<p>Additionally, in the following line, <code>tail.prev</code> takes ownership of the value of <code>head</code>, so the value was moved to the new owner:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">prev</span> <span style="color: #56b6c2;">=</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">head</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span> <span style="color: #7f848e;">// value as moved here</span>
</div></code></pre>
<p>Now the solution is calling <code>clone</code> as we did in the <code>tail</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">prev</span> <span style="color: #56b6c2;">=</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #61afef;">clone</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<p>Here‚Äôs the current solution for a doubly linked list using Box:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">#</span><span style="color: #c678dd;">[</span><span style="color: #61afef;">derive</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Clone</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">]</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="3">    <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">i32</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="4">    <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Box</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="5">    <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Box</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="6"><span style="color: #c678dd;">&rbrace;</span>
</div><div class="line" data-line="7">
</div><div class="line" data-line="8"><span style="color: #c678dd;">let</span> <span style="color: #c678dd;">mut</span> <span style="color: #e06c75;">tail</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Box</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="9"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">head</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Box</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #61afef;">clone</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="10">
</div><div class="line" data-line="11"><span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">prev</span> <span style="color: #56b6c2;">=</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #61afef;">clone</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="12">
</div><div class="line" data-line="13"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="14"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="15"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">next</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">unwrap</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="16"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">unwrap</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<p>By using Box, we‚Äôve solved the problem but we may end up wasting memory, as demonstrated in the following picture:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/aj2tz2i7kcpq0cdjzmjb.png" alt="box wasting memory on linked list" /></p>
<p>At this point in time, we have the following abstraction model about ownership, which is single and shares no value in the heap (Box):</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/6fkmdx1czv6jlulzwqtj.png" alt="box single ownership" /></p>
<p>We have to find a way to overcome the single ownership problem. What about <em>not taking ownership at all</em>, by using <strong>References</strong> instead?</p>
<h3><a href="#-references--lifetimes" aria-hidden="true" class="anchor" id="-references--lifetimes"></a>üîµ References & Lifetimes</h3>
<p>References in Rust do not take ownership, as they allow to work with the reference of the data which is allocated in the heap.</p>
<p>This way, references can be ‚Äúborrowed‚Äù without taking ownership, and as such they are bound to a mechanism called <strong>borrow checker</strong>.</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">name</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">String</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">from</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;John&quot;</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span> <span style="color: #7f848e;">// value in the heap. name is the owner</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">other_name</span> <span style="color: #56b6c2;">=</span> <span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">name</span><span style="color: #abb2bf;">;</span> <span style="color: #7f848e;">// not a move. other_name has a reference to the value in the heap. name is still the owner</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #c678dd;">println</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;other_name: &lbrace;&rbrace;&quot;</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">other_name</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="5"><span style="color: #c678dd;">println</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;name: &lbrace;&rbrace;&quot;</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">name</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<p>The above code compiles successfully. The borrow checker ensures that the reference is pointing to some valid value in the heap, thus not ‚Äúmoving‚Äù the ownership.</p>
<p>Let‚Äôs change the code to use References instead of Box:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="2">    <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">i32</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="3">    <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&gt;</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="4"><span style="color: #c678dd;">&rbrace;</span>
</div><div class="line" data-line="5">
</div><div class="line" data-line="6"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">tail</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="7"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">head</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">tail</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<ul>
<li>The <code>next</code> is an enum Option which wraps a <em>reference to another Node</em></li>
<li>The <code>head.next</code> is now using <code>Some(&amp;tail)</code> which is a reference to the tail (other node), instead of a Box which takes ownership</li>
</ul>
<p>But this code won‚Äôt compile yet:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #e06c75;">error</span><span style="color: #c678dd;">[</span><span style="color: #e5c07b;">E0106</span><span style="color: #c678dd;">]</span><span style="color: #abb2bf;">:</span> <span style="color: #e06c75;">missing</span> lifetime <span style="color: #e06c75;">specifier</span>
</div><div class="line" data-line="2"> <span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">&gt;</span> <span style="color: #e06c75;">src</span><span style="color: #56b6c2;">/</span><span style="color: #e06c75;">main</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">rs</span><span style="color: #abb2bf;">:</span><span style="color: #d19a66;">4</span><span style="color: #abb2bf;">:</span><span style="color: #d19a66;">18</span>
</div><div class="line" data-line="3">  <span style="color: #56b6c2;">|</span>
</div><div class="line" data-line="4"><span style="color: #d19a66;">4</span> <span style="color: #56b6c2;">|</span>     <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #56b6c2;">&lt;</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e5c07b;">Node</span><span style="color: #56b6c2;">&gt;</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="5">  <span style="color: #c678dd;">|</span>                  <span style="color: #56b6c2;">^</span> <span style="color: #e06c75;">expected</span> <span style="color: #e06c75;">named</span> <span style="color: #e06c75;">lifetime</span> <span style="color: #e06c75;">parameter</span>
</div><div class="line" data-line="6">  <span style="color: #c678dd;">|</span>
</div><div class="line" data-line="7"><span style="color: #e06c75;">help</span><span style="color: #abb2bf;">:</span> <span style="color: #e06c75;">consider</span> <span style="color: #e06c75;">introducing</span> <span style="color: #e06c75;">a</span> <span style="color: #e06c75;">named</span> <span style="color: #e06c75;">lifetime</span> <span style="color: #e06c75;">parameter</span>
</div><div class="line" data-line="8">  <span style="color: #56b6c2;">|</span>
</div><div class="line" data-line="9"><span style="color: #d19a66;">2</span> ~ <span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">Node</span><span style="color: #56b6c2;">&lt;</span><span style="color: #c678dd;">&#39;</span><span style="color: #c678dd;">a</span><span style="color: #56b6c2;">&gt;</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="10"><span style="color: #d19a66;">3</span> <span style="color: #56b6c2;">|</span>     <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">i32</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="11"><span style="color: #d19a66;">4</span> ~     <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #56b6c2;">&lt;</span><span style="color: #56b6c2;">&amp;</span><span style="color: #c678dd;">&#39;</span><span style="color: #c678dd;">a</span> <span style="color: #e5c07b;">Node</span><span style="color: #56b6c2;">&gt;</span><span style="color: #abb2bf;">,</span>
</div></code></pre>
<p>Each reference has an implicit lifetime in the Rust compiler. In our example of a linked list, the compiler can‚Äôt determine the lifetime of the <code>next</code> pointer because it points to another Node which could have a different lifetime.</p>
<p>Because the borrow checker prevents dangling references by using lifetimes, we have to help the compiler by annotating lifetimes in the struct definition:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #c678dd;">&#39;</span><span style="color: #c678dd;">a</span><span style="color: #c678dd;">&gt;</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="2">    <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">i32</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="3">    <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #56b6c2;">&amp;</span><span style="color: #c678dd;">&#39;</span><span style="color: #c678dd;">a</span> <span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #c678dd;">&#39;</span><span style="color: #c678dd;">a</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="4"><span style="color: #c678dd;">&rbrace;</span>
</div><div class="line" data-line="5">
</div><div class="line" data-line="6"><span style="color: #7f848e;">// or, using generics</span>
</div><div class="line" data-line="7">
</div><div class="line" data-line="8"><span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #c678dd;">&#39;</span><span style="color: #c678dd;">a</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="9">    <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">T</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="10">    <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #56b6c2;">&amp;</span><span style="color: #c678dd;">&#39;</span><span style="color: #c678dd;">a</span> <span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #c678dd;">&#39;</span><span style="color: #c678dd;">a</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="11"><span style="color: #c678dd;">&rbrace;</span>
</div></code></pre>
<p><em>It‚Äôs quite verbose, I know.</em> üò¨</p>
<p>Now the version of a singly linked list using references:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">#</span><span style="color: #c678dd;">[</span><span style="color: #61afef;">derive</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Debug</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">PartialEq</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">]</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #c678dd;">&#39;</span><span style="color: #c678dd;">a</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="3">    <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">T</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="4">    <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #56b6c2;">&amp;</span><span style="color: #c678dd;">&#39;</span><span style="color: #c678dd;">a</span> <span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #c678dd;">&#39;</span><span style="color: #c678dd;">a</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="5"><span style="color: #c678dd;">&rbrace;</span>
</div><div class="line" data-line="6">
</div><div class="line" data-line="7"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">tail</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="8"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">head</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">tail</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="9">
</div><div class="line" data-line="10"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="11"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">next</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">unwrap</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="12"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">next</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<ul>
<li>The <code>Node</code> and its <code>next</code> (reference) node has a lifetime <code>'a</code></li>
<li>we can use tail/head even after they been applied to the repective nodes, because we took no ownership</li>
</ul>
<p>But a singly linked list is not enough. We want a doubly one:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">#</span><span style="color: #c678dd;">[</span><span style="color: #61afef;">derive</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Debug</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">PartialEq</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">]</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #c678dd;">&#39;</span><span style="color: #c678dd;">a</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="3">    <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">T</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="4">    <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #56b6c2;">&amp;</span><span style="color: #c678dd;">&#39;</span><span style="color: #c678dd;">a</span> <span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #c678dd;">&#39;</span><span style="color: #c678dd;">a</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="5">    <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #56b6c2;">&amp;</span><span style="color: #c678dd;">&#39;</span><span style="color: #c678dd;">a</span> <span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #c678dd;">&#39;</span><span style="color: #c678dd;">a</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="6"><span style="color: #c678dd;">&rbrace;</span>
</div><div class="line" data-line="7">
</div><div class="line" data-line="8"><span style="color: #c678dd;">let</span> <span style="color: #c678dd;">mut</span> <span style="color: #e06c75;">tail</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="9"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">head</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">tail</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="10">
</div><div class="line" data-line="11"><span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">prev</span> <span style="color: #56b6c2;">=</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">head</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="12">
</div><div class="line" data-line="13"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="14"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">next</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">unwrap</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="15"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">next</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<p>We run the code and‚Ä¶</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #e06c75;">error</span><span style="color: #c678dd;">[</span><span style="color: #e5c07b;">E0506</span><span style="color: #c678dd;">]</span><span style="color: #abb2bf;">:</span> <span style="color: #e06c75;">cannot</span> <span style="color: #e06c75;">assign</span> <span style="color: #e06c75;">to</span> `<span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">prev</span>` <span style="color: #e06c75;">because</span> <span style="color: #e06c75;">it</span> <span style="color: #e06c75;">is</span> <span style="color: #e06c75;">borrowed</span>
</div><div class="line" data-line="2">  <span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">&gt;</span> <span style="color: #e06c75;">src</span><span style="color: #56b6c2;">/</span><span style="color: #e06c75;">main</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">rs</span><span style="color: #abb2bf;">:</span><span style="color: #d19a66;">12</span><span style="color: #abb2bf;">:</span><span style="color: #d19a66;">1</span>
</div><div class="line" data-line="3">   <span style="color: #56b6c2;">|</span>
</div><div class="line" data-line="4"><span style="color: #d19a66;">10</span> <span style="color: #56b6c2;">|</span> <span style="color: #e06c75;">let</span> <span style="color: #e06c75;">head</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">tail</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="5">   <span style="color: #c678dd;">|</span>                                                    <span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span> `<span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">prev</span>` <span style="color: #e06c75;">is</span> <span style="color: #e06c75;">borrowed</span> <span style="color: #e06c75;">here</span>
</div><div class="line" data-line="6"><span style="color: #d19a66;">11</span> <span style="color: #c678dd;">|</span>
</div><div class="line" data-line="7"><span style="color: #d19a66;">12</span> <span style="color: #56b6c2;">|</span> <span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">prev</span> <span style="color: #56b6c2;">=</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">head</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="8">   <span style="color: #c678dd;">|</span> <span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span> `<span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">prev</span>` <span style="color: #e06c75;">is</span> <span style="color: #e06c75;">assigned</span> <span style="color: #e06c75;">to</span> <span style="color: #e06c75;">here</span> <span style="color: #e06c75;">but</span> <span style="color: #e06c75;">it</span> <span style="color: #e06c75;">was</span> <span style="color: #e06c75;">already</span> <span style="color: #e06c75;">borrowed</span>
</div><div class="line" data-line="9"><span style="color: #d19a66;">13</span> <span style="color: #c678dd;">|</span>
</div><div class="line" data-line="10"><span style="color: #d19a66;">14</span> <span style="color: #56b6c2;">|</span> <span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="11">   <span style="color: #56b6c2;">|</span> <span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span> <span style="color: #e06c75;">borrow</span> <span style="color: #e06c75;">later</span> <span style="color: #e06c75;">used</span> <span style="color: #e06c75;">here</span>
</div></code></pre>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/khry9qxk07s1com4hsik.gif" alt="yet another explosion" /></p>
<p><em>What happened here?</em></p>
<p>The <strong>borrow checker</strong> checks at compile-time that we can have only <em>one mutable reference</em> at a time in the same scope.</p>
<p>Our example has a scenario where the <code>tail.prev</code> is <strong>mutable</strong> and is already borrowed to the <code>head</code>.</p>
<p>That‚Äôs why we simply <em>can‚Äôt implement a doubly linked list</em> in Rust using references (AFAIK).</p>
<p>Then we should go back to ownership. But what about having a ‚Äúshared ownership‚Äù instead of a ‚Äúsingle ownership‚Äù like in the Box example?</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/p2l5w1f09rr5oyx3bsk0.png" alt="ideal scenario for shared ownerhsip" /></p>
<p>Enter <em>Rc</em>.</p>
<hr />
<h2><a href="#-rc" aria-hidden="true" class="anchor" id="-rc"></a>üëâ Rc</h2>
<p>Rc stands for <strong>reference counting</strong>, which performs heap allocation, like a Box.</p>
<p>But unlike Box, it enables <em>shared ownership</em>, where one or more owners point to the same value in the heap. Each time an owner <em>comes to the party</em>, it increments the counter. When the owner goes out of scope, it decrements the counter.</p>
<p>Only when all owners are dropped, then the Rc is entirely dropped as well freeing the underlying data from the heap.</p>
<p>Rc brings one caveat: <strong>the reference must be immutable</strong>. Otherwise, it would lead to double-free errors.</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">use</span> <span style="color: #e5c07b;">std</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">rc</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">name</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">String</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">from</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;John&quot;</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #e06c75;">strong_count</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">name</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="5">
</div><div class="line" data-line="6"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">cloned_name</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">clone</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">name</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="7">
</div><div class="line" data-line="8"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #e06c75;">strong_count</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">name</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="9"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;John&quot;</span><span style="color: #abb2bf;">,</span> <span style="color: #56b6c2;">*</span><span style="color: #e06c75;">cloned_name</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span> <span style="color: #7f848e;">// Dereference</span>
</div><div class="line" data-line="10"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;John&quot;</span><span style="color: #abb2bf;">,</span> <span style="color: #56b6c2;">*</span><span style="color: #e06c75;">name</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span> <span style="color: #7f848e;">// Dereference</span>
</div></code></pre>
<p>Each time an <code>Rc</code> is called <code>data.clone()</code> or by using <code>Rc::clone(&amp;data)</code>, the data is not being copied on the heap (deep copy). Only the reference is copied and the strong count of references is incremented.</p>
<p>The original owner is still valid after <em>cloning</em> multiple Rc references.</p>
<p>Let‚Äôs implement the singly linked list using Rc instead of references or Box:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">use</span> <span style="color: #e5c07b;">std</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">rc</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="4">    <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">T</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="5">    <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Rc</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span>
</div><div class="line" data-line="6"><span style="color: #c678dd;">&rbrace;</span>
</div></code></pre>
<p>Cool, now let‚Äôs add some data to our linked list:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">tail</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">head</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">tail</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="5"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">next</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">clone</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">unwrap</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<p>It simply works! <em>How cool is that?</em></p>
<p>Time to evolve to a doubly linked list using Rc:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">use</span> <span style="color: #e5c07b;">std</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">rc</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="4">    <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">T</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="5">    <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Rc</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="6">    <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Rc</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="7"><span style="color: #c678dd;">&rbrace;</span>
</div><div class="line" data-line="8">
</div><div class="line" data-line="9"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">tail</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="10"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">head</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">clone</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">tail</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="11">
</div><div class="line" data-line="12"><span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">prev</span> <span style="color: #56b6c2;">=</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">clone</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">head</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="13">
</div><div class="line" data-line="14"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="15"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">next</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">clone</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">unwrap</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<p>Instead of deep copy like in Box, the Rc smart pointer only increments the reference counter. Check <code>Rc::clone(&amp;head)</code> and <code>Rc::clone(&amp;tail)</code>.</p>
<p>But it won‚Äôt compile:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #e06c75;">error</span><span style="color: #c678dd;">[</span><span style="color: #e5c07b;">E0594</span><span style="color: #c678dd;">]</span><span style="color: #abb2bf;">:</span> <span style="color: #e06c75;">cannot</span> <span style="color: #e06c75;">assign</span> <span style="color: #e06c75;">to</span> <span style="color: #e06c75;">data</span> <span style="color: #c678dd;">in</span> <span style="color: #e06c75;">an</span> `<span style="color: #e5c07b;">Rc</span>`
</div><div class="line" data-line="2">  <span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">-</span><span style="color: #56b6c2;">&gt;</span> <span style="color: #e06c75;">src</span><span style="color: #56b6c2;">/</span><span style="color: #e06c75;">main</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">rs</span><span style="color: #abb2bf;">:</span><span style="color: #d19a66;">24</span><span style="color: #abb2bf;">:</span><span style="color: #d19a66;">5</span>
</div><div class="line" data-line="3">   <span style="color: #56b6c2;">|</span>
</div><div class="line" data-line="4"><span style="color: #d19a66;">24</span> <span style="color: #56b6c2;">|</span>     <span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">prev</span> <span style="color: #56b6c2;">=</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">clone</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">head</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="5">   <span style="color: #56b6c2;">|</span>     <span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span><span style="color: #56b6c2;">^</span> <span style="color: #e06c75;">cannot</span> <span style="color: #e06c75;">assign</span>
</div></code></pre>
<p><em>Cannot assign data in an Rc!</em></p>
<p>Even if we used <code>let mut tail = ...</code>, Rc is now allowed to mutate because <strong>all references in Rc are immutable</strong>.</p>
<p>How about <em>mutating the underlying data</em> even if the reference is immutable? We could achieve that by using ‚Äúunsafe Rust‚Äù, where <strong>some checks could be done at runtime instead of compile-time.</strong></p>
<p>Even better, what about Rust providing an abstraction which uses unsafe capabilities under the hood but wrapping in a safe API?</p>
<p>Yes, <em>we are talking about RefCell</em>.</p>
<hr />
<h2><a href="#-refcell" aria-hidden="true" class="anchor" id="-refcell"></a>üëâ RefCell</h2>
<p><strong>RefCell</strong> is an smart pointer which provides a safe API to mutate underlying data (on the heap) but through immutable references.</p>
<p>This approach is called <strong>interior mutability</strong>.</p>
<p>The borrow checker won‚Äôt perform checks, but Rust will check them at runtime. In case we cause a problem regarding mutable data, the program will crash and stop (<code>panic!</code>).</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">use</span> <span style="color: #e5c07b;">std</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">cell</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">RefCell</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">name</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">RefCell</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">String</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">from</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;John&quot;</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="4"><span style="color: #e06c75;">name</span><span style="color: #abb2bf;">.</span><span style="color: #61afef;">borrow_mut</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #61afef;">push_str</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot; Doe&quot;</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="5">
</div><div class="line" data-line="6"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;John Doe&quot;</span><span style="color: #abb2bf;">,</span> <span style="color: #56b6c2;">*</span><span style="color: #e06c75;">name</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">borrow</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<ul>
<li>RefCell wraps a String in the heap</li>
<li>The reference is immutable</li>
<li>Through <code>borrow_mut</code>, we get <code>RefMut&lt;T&gt;</code> to mutate the underlying data</li>
<li>Through <code>borrow</code>, we get a <code>Ref&lt;T&gt;</code> to read the underlying data</li>
</ul>
<p>In a RefCell, we can have multiple borrows for reading or <strong>only one borrow mutable</strong> for writing.</p>
<p>With that in place, time to implement our doubly linked list using Rc + RefCell:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1">    <span style="color: #c678dd;">use</span> <span style="color: #e5c07b;">std</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">rc</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="2">    <span style="color: #c678dd;">use</span> <span style="color: #e5c07b;">std</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">cell</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">RefCell</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4">    <span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="5">        <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">T</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="6">        <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Rc</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">RefCell</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="7">        <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Rc</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">RefCell</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="8">    <span style="color: #c678dd;">&rbrace;</span>
</div><div class="line" data-line="9">
</div><div class="line" data-line="10">    <span style="color: #c678dd;">let</span> <span style="color: #e06c75;">tail</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">RefCell</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="11">    <span style="color: #c678dd;">let</span> <span style="color: #e06c75;">head</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">RefCell</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">clone</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">tail</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="12">
</div><div class="line" data-line="13">    <span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #61afef;">borrow_mut</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">prev</span> <span style="color: #56b6c2;">=</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">clone</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">head</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="14">
</div><div class="line" data-line="15">    <span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">borrow</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="16">    <span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">borrow</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">next</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">clone</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">unwrap</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">borrow</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="17">    <span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">borrow</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">clone</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">unwrap</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">borrow</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<p>Our Node model now is composed of a value and a <code>next</code> pointer which basically is:</p>
<ul>
<li>an enum Option</li>
<li>which wraps an Rc (shared ownership)</li>
<li>which wraps an RefCell (for interior mutability)</li>
<li>which points to other Node</li>
<li>and so on and on and on‚Ä¶</li>
</ul>
<p>With RefCell, every time we have to write, we use <code>borrow_mut</code>, and every time we have to read, we use <code>borrow</code>.</p>
<p><em>How wonderful is that?</em></p>
<hr />
<h2><a href="#-thinking-about-a-circular-linked-list" aria-hidden="true" class="anchor" id="-thinking-about-a-circular-linked-list"></a>üëâ Thinking about a circular linked list</h2>
<p>In order to make our linked list to be circular, we have to make <code>tail.next</code> point to the <code>head</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">use</span> <span style="color: #e5c07b;">std</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">rc</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">use</span> <span style="color: #e5c07b;">std</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">cell</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">RefCell</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="5">    <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">T</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="6">    <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Rc</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">RefCell</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="7">    <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Rc</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">RefCell</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="8"><span style="color: #c678dd;">&rbrace;</span>
</div><div class="line" data-line="9">
</div><div class="line" data-line="10"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">tail</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">RefCell</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="11"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">head</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">RefCell</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">clone</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">tail</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="12">
</div><div class="line" data-line="13"><span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #61afef;">borrow_mut</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">prev</span> <span style="color: #56b6c2;">=</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">clone</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">head</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="14"><span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #61afef;">borrow_mut</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">next</span> <span style="color: #56b6c2;">=</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">clone</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">head</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="15">
</div><div class="line" data-line="16"><span style="color: #56b6c2;">..</span><span style="color: #56b6c2;">..</span>
</div><div class="line" data-line="17"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">borrow</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">next</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">clone</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">unwrap</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">borrow</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<p>What‚Äôs the challenges of a circular linked list using Rc?</p>
<h3><a href="#-strong-references-may-never-reach-zero" aria-hidden="true" class="anchor" id="-strong-references-may-never-reach-zero"></a>üîµ Strong references may never reach zero</h3>
<p>Remember that the Rc underlying data is dropped and invalidated when the <code>Rc::strong_count</code> reaches zero.</p>
<p>But in a circular linked list, for instance, we may have a <strong>cyclic reference</strong>, which in turn will never make the <code>strong_count</code> to reach zero, <strong>leading to memory leaks</strong>.</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/8z6cj08ae1c2788j1uva.png" alt="cyclic references" /></p>
<p>In such a scenario, the <code>tail.next</code> is a ‚Äúweak‚Äù reference. Rust provides a way for <code>Rc</code> to have a different counter, called <code>weak_count</code>.</p>
<p>Thus, the weak counter will not be used for deciding when Rust should drop the value from the heap.</p>
<p>For solving this problem, Rc brings a method called <code>downgrade</code>, which <strong>does not involve ownership at all</strong> and transforms a strong reference into a weak one.</p>
<p>This smart pointer is called <strong>Weak</strong> and it‚Äôs a weak reference in an <em>Rc</em>.</p>
<p>Let‚Äôs see a basic usage of downgrading or upgrading references in an Rc (see below in the comments):</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">use</span> <span style="color: #e5c07b;">std</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">rc</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #7f848e;">// Just a strong reference</span>
</div><div class="line" data-line="4"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">name</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">String</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">from</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;John&quot;</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="5"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #e06c75;">strong_count</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">name</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="6">
</div><div class="line" data-line="7"><span style="color: #7f848e;">// Cloning Rc is a strong reference</span>
</div><div class="line" data-line="8"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">_other_name</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">clone</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">name</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="9"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #e06c75;">strong_count</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">name</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="10"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">0</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #e06c75;">weak_count</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">name</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="11">
</div><div class="line" data-line="12"><span style="color: #7f848e;">// Downgrade makes it a weak reference</span>
</div><div class="line" data-line="13"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">weak_name</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">downgrade</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">name</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="14"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #e06c75;">strong_count</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">name</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="15"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #e06c75;">weak_count</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">name</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="16">
</div><div class="line" data-line="17"><span style="color: #7f848e;">// Upgrade makes it a strong reference again</span>
</div><div class="line" data-line="18"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">upgraded_name</span> <span style="color: #56b6c2;">=</span> <span style="color: #e06c75;">weak_name</span><span style="color: #abb2bf;">.</span><span style="color: #61afef;">upgrade</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #61afef;">unwrap</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="19"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">3</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #e06c75;">strong_count</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">name</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="20"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #e06c75;">weak_count</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">name</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="21"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;John&quot;</span><span style="color: #abb2bf;">,</span> <span style="color: #56b6c2;">*</span><span style="color: #e06c75;">upgraded_name</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<p>In a linked list, the <code>prev</code> should be the ‚Äúweak‚Äù reference because starting from the head, the Rc has already strong references that make the entire linked list through the <code>next</code> pointers.</p>
<p>Now, let‚Äôs explore the final solution of this entire blogpost, using <code>Rc</code> for <strong>shared ownership</strong>, <code>RefCell</code> for <strong>interior mutability</strong> and <code>Rc::Weak</code> for preventing cyclic references in a linked list:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-rust" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">use</span> <span style="color: #e5c07b;">std</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">rc</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">use</span> <span style="color: #e5c07b;">std</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">cell</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">RefCell</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="3"><span style="color: #c678dd;">use</span> <span style="color: #e5c07b;">std</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">rc</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">Weak</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="6">    <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">T</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="7">    <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Rc</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">RefCell</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="8">    <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #e5c07b;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Weak</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">RefCell</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">Node</span><span style="color: #c678dd;">&lt;</span><span style="color: #e5c07b;">T</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #c678dd;">&gt;</span><span style="color: #abb2bf;">,</span>
</div><div class="line" data-line="9"><span style="color: #c678dd;">&rbrace;</span>
</div><div class="line" data-line="10">
</div><div class="line" data-line="11"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">tail</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">RefCell</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="12"><span style="color: #c678dd;">let</span> <span style="color: #e06c75;">head</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">RefCell</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">new</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Node</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">None</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">next</span><span style="color: #abb2bf;">:</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">clone</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">tail</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="13">
</div><div class="line" data-line="14"><span style="color: #7f848e;">// Weak reference (no ownership)</span>
</div><div class="line" data-line="15"><span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #61afef;">borrow_mut</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">prev</span> <span style="color: #56b6c2;">=</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">downgrade</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">head</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="16">
</div><div class="line" data-line="17"><span style="color: #7f848e;">// Strong reference (shared ownership)</span>
</div><div class="line" data-line="18"><span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #61afef;">borrow_mut</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">next</span> <span style="color: #56b6c2;">=</span> <span style="color: #c678dd;">Some</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">Rc</span><span style="color: #abb2bf;">::</span><span style="color: #61afef;">clone</span><span style="color: #c678dd;">(</span><span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">head</span><span style="color: #c678dd;">)</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="19">
</div><div class="line" data-line="20"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">borrow</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="21"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">2</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">head</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">borrow</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">next</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">clone</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">unwrap</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">borrow</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="22"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">borrow</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">prev</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">clone</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">unwrap</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">upgrade</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">unwrap</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">borrow</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="23"><span style="color: #c678dd;">assert_eq</span><span style="color: #61afef;">!</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">tail</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">borrow</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">next</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">clone</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">unwrap</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">borrow</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">value</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div></code></pre>
<hr />
<h2><a href="#wrapping-up" aria-hidden="true" class="anchor" id="wrapping-up"></a>Wrapping Up</h2>
<p>In this very post we demonstrated the fundamentals smart pointers in Rust and the problems they solve about memory management.</p>
<p>This post was written during a <a href="https://www.youtube.com/watch?v=bdZe0LjDUyk">live coding</a> while building a doubly linked list by explaining fundamental concepts of ownership, references, borrowing and smart pointers.</p>
<p>I hope you had fun while learning a bit more about the <em>Rust ownership mental model</em> as I did.</p>
<p><strong>Cheers!</strong></p>
<hr />
<h2><a href="#references" aria-hidden="true" class="anchor" id="references"></a>References</h2>
<p><a href="https://doc.rust-lang.org/book/">https://doc.rust-lang.org/book/</a></p>
<p><a href="https://en.wikipedia.org/wiki/Smart_pointer">https://en.wikipedia.org/wiki/Smart_pointer</a></p>
<p><a href="https://ricardomartins.cc/2016/06/08/interior-mutability">https://ricardomartins.cc/2016/06/08/interior-mutability</a></p>
<p><a href="https://www.youtube.com/watch?v=6VSgMbFNUuQ">https://www.youtube.com/watch?v=6VSgMbFNUuQ</a></p>
      </div>

      <!-- Back to top -->
      <div class="mt-12 mb-8 text-center">
        <a href="#" onclick="event.preventDefault(); window.scrollTo({ top: 0, behavior: 'smooth' });" class="inline-flex items-center gap-2 text-xl font-medium transition-colors text-base-content/70 hover:text-primary cursor-pointer">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
          </svg>
          Back to top
        </a>
      </div>
    </article>

    <!-- Giscus Comments -->
    <div class="mt-16">
      <div class="border-t border-base-300 pt-8">
        <h2 class="text-2xl font-bold mb-6">Comments</h2>
        <script src="https://giscus.app/client.js"
                data-repo="leandronsp/leandronsp.com"
                data-repo-id="R_kgDOQGG-eQ"
                data-category="Announcements"
                data-category-id="DIC_kwDOQGG-ec4Cw4TN"
                data-mapping="pathname"
                data-strict="0"
                data-reactions-enabled="1"
                data-emit-metadata="0"
                data-input-position="bottom"
                data-theme="preferred_color_scheme"
                data-lang="en"
                crossorigin="anonymous"
                async>
        </script>
      </div>
    </div>

    <!-- Footer -->
    <footer class="mt-16 pt-8 pb-6 border-t border-base-300">
      <div class="text-center text-sm text-base-content/80">
        <p>
          Powered by
          <a
            href="https://github.com/leandronsp/curupira"
            target="_blank"
            rel="noopener noreferrer"
            class="font-semibold text-blue-600 hover:underline"
          >
            Curupira
          </a>
          | Open source blog platform built with Phoenix LiveView
        </p>
        <p class="mt-2 text-xs text-base-content/70">
          Licensed under
          <a
            href="https://github.com/leandronsp/curupira/blob/master/LICENSE"
            target="_blank"
            rel="noopener noreferrer"
            class="text-blue-600 hover:underline"
          >
            AGPL-3.0
          </a>
        </p>
      </div>
    </footer>
  </main>

  <script src="/static-theme.js" defer></script>
  <script src="/static-filters.js" defer></script>
  <script src="/static-search.js" defer></script>
  <script src="/static-giscus.js" defer></script>

  <!-- Lazy load Google Analytics after page is fully interactive -->
  <script>
    (function() {
      function loadGTM() {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-0Y5RNLZMKN');

        var script = document.createElement('script');
        script.async = true;
        script.src = 'https://www.googletagmanager.com/gtag/js?id=G-0Y5RNLZMKN';
        document.head.appendChild(script);
      }

      // Load after page is idle, or after 5 seconds as fallback
      if ('requestIdleCallback' in window) {
        requestIdleCallback(loadGTM, { timeout: 5000 });
      } else {
        setTimeout(loadGTM, 5000);
      }
    })();
  </script>
</body>
</html>
