<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arrays in x86 Assembly - Leandro Proença</title>
  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">

  <!-- SEO Meta Tags -->
  <meta name="description" content="_Originally posted in [Portuguese](https://leandronsp.com/articles/arrays-em-assembly-x86-55hb)_

Recently I wrote [a 6-article series](https://leandronsp.com/ar">
  <meta name="author" content="Leandro Proença">
  <link rel="canonical" href="https://leandronsp.com/articles/arrays-in-x86-assembly.html">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://leandronsp.com/articles/arrays-in-x86-assembly.html">
  <meta property="og:title" content="Arrays in x86 Assembly">
  <meta property="og:description" content="_Originally posted in [Portuguese](https://leandronsp.com/articles/arrays-em-assembly-x86-55hb)_

Recently I wrote [a 6-article series](https://leandronsp.com/ar">
  <meta property="og:site_name" content="Leandro Proença">
  <meta property="article:published_time" content="2025-10-22T21:09:03Z">
  <meta property="article:tag" content="assembly">

  <!-- JSON-LD Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "Arrays in x86 Assembly",
    "datePublished": "2025-10-22T21:09:03Z",
    "author": {
      "@type": "Person",
      "name": "Leandro Proença"
    },
    "description": "_Originally posted in [Portuguese](https://leandronsp.com/articles/arrays-em-assembly-x86-55hb)_

Recently I wrote [a 6-article series](https://leandronsp.com/ar",
        "keywords": "assembly"
  }
  </script>

  <link rel="preload" href="/assets/css/app.cf141171.css" as="style">
  <script>
    // Prevent FOUC (Flash of Unstyled Content) by setting theme before CSS loads
    (function() {
      const theme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <link rel="stylesheet" href="/assets/css/app.cf141171.css">
  <style>
    /* Force scrollbar to always be visible to prevent layout shift */
    html {
      overflow-y: scroll;
    }

    /* Softer dark theme colors */
    [data-theme="dark"] {
      --base-100: #2a2f3a;
      --base-200: #232831;
      --base-300: #1e222a;
      --base-content: #e8eaed;
    }
    [data-theme="dark"] .article-card {
      background-color: transparent;
    }
    /* Keep pinned article with background for prominence in dark theme - lighter pastel */
    [data-theme="dark"] .pinned-article {
      background-color: #3a4050 !important;
    }
    [data-theme="dark"] .prose {
      color: #e8eaed;
    }
    [data-theme="dark"] .prose h1,
    [data-theme="dark"] .prose h2,
    [data-theme="dark"] .prose h3,
    [data-theme="dark"] .prose h4 {
      color: #f0f2f5;
    }
    [data-theme="dark"] .prose a {
      color: #8fb4ff;
    }
    [data-theme="dark"] .prose code {
      background-color: #3d4454;
      color: #f0f2f5;
    }
    [data-theme="dark"] .prose pre {
      background-color: #1e222a;
      border: 1px solid #3d4454;
    }
    [data-theme="dark"] input {
      background-color: #2f3542;
      border-color: #3d4454;
      color: #e8eaed;
    }
    [data-theme="dark"] input::placeholder {
      color: #9ca3af;
    }
    /* Language switcher dark theme styling */
    [data-theme="dark"] .lang-switcher-bg {
      background-color: rgba(59, 130, 246, 0.15) !important;
      border-color: rgba(59, 130, 246, 0.3) !important;
    }
    /* Blog name styling - system font first, Google Font loads async */
    .blog-name {
      font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    /* Intro text styling - system font first, Google Font loads async */
    .intro-text {
      font-family: 'Caveat', 'Bradley Hand', 'Comic Sans MS', cursive;
      font-weight: 600;
      color: #6b7280; /* Darker pastel gray for light theme */
    }
    [data-theme="dark"] .intro-text {
      color: #d4d4d8; /* Lighter pastel gray for dark theme */
    }
    /* Article card styling */
    article {
      background-color: transparent;
      border: none;
      border-radius: 0.5rem;
      padding: 2rem;
    }
    [data-theme="dark"] article {
      background-color: transparent;
    }
    /* Article images styling - consistent sizing */
    .prose img {
      max-width: 800px;
      width: 100%;
      height: auto;
      display: block;
      margin-left: auto;
      margin-right: auto;
      border-radius: 0.5rem;
    }
  </style>
</head>
<body class="min-h-screen bg-base-100">
  <!-- Fixed Header - Article page: focus on reading -->
  <header class="sticky top-0 z-50 bg-base-100 border-b border-base-300 shadow-sm">
    <div class="container mx-auto px-4 sm:px-6 py-4 max-w-6xl">
      <!-- Same structure as homepage, no search/language/tags -->
      <div class="flex flex-col gap-2">
        <!-- Name + Social Icons + Guide Links (all screens) -->
        <div class="flex items-center gap-3">
          <a href="/" class="blog-name text-2xl sm:text-3xl font-bold text-base-content flex-shrink-0 no-underline cursor-pointer hover:opacity-80 transition-opacity">Leandro Proença</a>
          <div class="flex items-center gap-2">
            <a href="https://linkedin.com/in/leandronsp" target="_blank" rel="noopener noreferrer" class="text-base-content/60 hover:text-primary transition-colors" title="LinkedIn">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
            </a>
            <a href="https://github.com/leandronsp" target="_blank" rel="noopener noreferrer" class="text-base-content/60 hover:text-primary transition-colors" title="GitHub">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/></svg>
            </a>
            <button id="theme-toggle" class="text-base-content/60 hover:text-primary transition-colors" title="Toggle theme">
              <svg xmlns="http://www.w3.org/2000/svg" class="sun-icon h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
              <svg xmlns="http://www.w3.org/2000/svg" class="moon-icon h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>
          </div>
          <!-- Guide Links (medium and up) -->
          <div class="hidden md:flex items-center gap-3 ml-4">
            <a href="https://concorrencia101.leandronsp.com" target="_blank" rel="noopener noreferrer" class="flex items-center gap-1 text-sm font-medium text-base-content/70 hover:text-primary transition-colors" title="Concorrência 101">
              <span>Concorrência 101</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </a>
            <a href="https://web101.leandronsp.com" target="_blank" rel="noopener noreferrer" class="flex items-center gap-1 text-sm font-medium text-base-content/70 hover:text-primary transition-colors" title="Web 101">
              <span>Web 101</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </a>
            <a href="https://aws101.leandronsp.com" target="_blank" rel="noopener noreferrer" class="flex items-center gap-1 text-sm font-medium text-base-content/70 hover:text-primary transition-colors" title="AWS 101">
              <span>AWS 101</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </a>
          </div>
        </div>

        <!-- Bio -->
        <p class="intro-text text-xl sm:text-2xl leading-tight">
          Software Developer 15+ years working for companies worldwide
        </p>
      </div>

    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto max-w-6xl">
    <article class="bg-base-100">
      <!-- Back link (goes to home if no history) -->
      <a href="/" onclick="if (window.history.length > 1) { event.preventDefault(); history.back(); }" class="inline-flex items-center gap-2 text-lg font-medium transition-colors text-base-content/70 hover:text-primary cursor-pointer mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back
      </a>

      <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold leading-tight mb-6">Arrays in x86 Assembly</h1>

      <div class="flex flex-wrap items-center gap-3 mb-8 text-base text-base-content/85">
        <div class="flex items-center gap-1.5">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
          <span>Published 22 Oct 2025</span>
        </div>

        <div class="flex items-center gap-1.5">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
  </svg>
  <div class="flex gap-2 flex-wrap">
    <span class="inline-flex items-center px-3 py-1 text-sm border border-base-content/25 rounded-full">assembly</span>
  </div>
</div>

      </div>

      <div class="prose prose-lg max-w-none">
        <p><em>Originally posted in <a href="https://leandronsp.com/articles/arrays-em-assembly-x86-55hb">Portuguese</a></em></p>
<p>Recently I wrote <a href="https://leandronsp.com/articles/construindo-um-web-server-em-assembly-x86-parte-i-introducao-14p5">a 6-article series</a> about x86 Assembly (written in Portuguese, but I’m planning to translate the guide to English soon), covering fundamental concepts of computer architecture and low-level programming while building a minimalist multi-threaded web server.</p>
<p>During the process, I left some important concepts aside for later articles, because if I had tackled them during the series, it would have been even longer than it already was. However, these are concepts that can be addressed separately, like the queues implemented in the thread pool.</p>
<p>And when we talk about queues, <strong>it’s inevitable to address arrays</strong> and how they’re organized in computer memory.</p>
<p>In this article, we’ll cover fundamental concepts like memory manipulation, registers, and heap memory while implementing arrays.</p>
<blockquote>
<p>I’m assuming you’re already familiar with x86 Assembly and the GDB tool. If not, I strongly recommend reading my series.</p>
</blockquote>
<hr />
<h2><a href="#agenda" aria-hidden="true" class="anchor" id="agenda"></a>Agenda</h2>
<ul>
<li><a href="#arrays-dont-exist">Arrays don’t exist</a></li>
<li><a href="#strings-dont-exist-either">Strings don’t exist either</a></li>
<li><a href="#the-simplest-array-in-the-universe">The simplest array in the universe</a></li>
<li><a href="#using-an-array-with-uninitialized-data">Using an array with uninitialized data</a>
<ul>
<li><a href="#index-to-the-rescue">Index to the rescue</a></li>
<li><a href="#hitting-the-array-limit">Hitting the array limit</a></li>
</ul>
</li>
<li><a href="#heap-heap-hooray">Heap, heap, hooray!</a>
<ul>
<li><a href="#dynamic-memory-allocation-with-brk">Dynamic memory allocation with brk</a></li>
<li><a href="#pointers-pointers-everywhere">Pointers, pointers everywhere</a></li>
<li><a href="#resize-with-brk">Resize with brk</a></li>
</ul>
</li>
<li><a href="#the-final-program">The final program</a></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#references">References</a></li>
</ul>
<hr />
<h2><a href="#arrays-dont-exist" aria-hidden="true" class="anchor" id="arrays-dont-exist"></a>Arrays don’t exist</h2>
<p><em>Arrays don’t exist.</em> Simple as that.</p>
<p>As we saw <a href="https://leandronsp.com/articles/construindo-um-web-server-em-assembly-x86-parte-iv-um-assembly-modesto-oif">in part IV</a> of the series, memory is organized contiguously, where information is allocated one after another.</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/u90q0z4ka96nccs1syef.png" alt="contiguous memory" /></p>
<p>Suppose we want to declare the following sequence of information:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">1, 2, &#39;H&#39;, 0
</div></code></pre>
<blockquote>
<p>I know, I know, the types are mixed, but that doesn’t matter right now. They all fit in 1 byte</p>
</blockquote>
<p>In x86 assembly (let’s call it asm for the rest of the article), we can declare this information in the data section like this:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">section .data
</div><div class="line" data-line="2">stuff: db 0x1, 0x2, 0x48, 0x0
</div></code></pre>
<blockquote>
<p>Remember that the character ‘H’ in the ASCII table represents 0x48 in hexadecimal</p>
</blockquote>
<p>Using <code>gdb</code> for debugging, we can confirm that this hexadecimal sequence at the <code>stuff</code> label is stored as follows:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Reading the first hexbyte in stuff</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x/1xb</span> <span style="color: #c678dd;">(</span><span style="color: #61afef;">void*</span><span style="color: #c678dd;">)</span> <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">stuff</span>
</div><div class="line" data-line="3"><span style="color: #d19a66;">0x402000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">stuff</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>       <span style="color: #d19a66;">0x01</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #7f848e;"># Reading the second hexbyte in stuff</span>
</div><div class="line" data-line="6"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">x/1xb</span> <span style="color: #c678dd;">(</span><span style="color: #61afef;">void*</span><span style="color: #c678dd;">)</span> <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">stuff+1</span>
</div><div class="line" data-line="7"><span style="color: #61afef;">0x402001:</span>       <span style="color: #d19a66;">0x02</span>
</div><div class="line" data-line="8">
</div><div class="line" data-line="9"><span style="color: #7f848e;"># Reading the third hexbyte in stuff</span>
</div><div class="line" data-line="10"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">x/1xb</span> <span style="color: #c678dd;">(</span><span style="color: #61afef;">void*</span><span style="color: #c678dd;">)</span> <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">stuff+2</span>
</div><div class="line" data-line="11"><span style="color: #61afef;">0x402002:</span>       <span style="color: #d19a66;">0x48</span>
</div></code></pre>
<p>We can also represent the hexadecimal <code>0x48</code> in string format using <code>x/s</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x/s</span> <span style="color: #c678dd;">(</span><span style="color: #61afef;">void*</span><span style="color: #c678dd;">)</span> <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">stuff+2</span>
</div><div class="line" data-line="2"><span style="color: #61afef;">0x402002:</span>       <span style="color: #98c379;">&quot;H&quot;</span>
</div></code></pre>
<p><em>It’s all hexadecimal!</em></p>
<p>With this, if we want to represent the string “Hello”, according to the ASCII table, it could look like this:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">section .data
</div><div class="line" data-line="2">msg: db 0x48, 0x65, 0x6C, 0x6C, 0x6F, 0x0
</div></code></pre>
<p>In gdb, let’s check the string representation of the <code>msg</code> label:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x/s <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">msg</span>
</div><div class="line" data-line="2"><span style="color: #d19a66;">0x402000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">msg</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span> <span style="color: #98c379;">&quot;Hello&quot;</span>
</div></code></pre>
<p>In asm, it’s possible to declare the string with direct ASCII table representation:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">section .data
</div><div class="line" data-line="2">msg: db &quot;Hello&quot;, 0x0
</div><div class="line" data-line="3">
</div><div class="line" data-line="4">; same as
</div><div class="line" data-line="5">; msg: db 0x48, 0x65, 0x6C, 0x6C, 0x6F, 0x0
</div></code></pre>
<hr />
<h2><a href="#strings-dont-exist-either" aria-hidden="true" class="anchor" id="strings-dont-exist-either"></a>Strings don’t exist either</h2>
<p>In other words, it’s all hexadecimal in memory. An array, like a string, is simply a contiguous sequence of data <strong>with the same size</strong> in memory.</p>
<p>The difference is that a string is a “special array” that has data representing ASCII table characters (note that both need to delimit a “final” byte to represent the end of the string or array):</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/dw5cjo8fvoh7rvp8t2l3.png" alt="string and array" /></p>
<h2><a href="#the-simplest-array-possible" aria-hidden="true" class="anchor" id="the-simplest-array-possible"></a>The simplest array possible</h2>
<p>Below we have the implementation of a very simple array in asm, which we’ll explore step by step in subsequent sections:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">%define SYS_exit 60
</div><div class="line" data-line="4">%define EXIT_SUCCESS 0
</div><div class="line" data-line="5">
</div><div class="line" data-line="6">section .data
</div><div class="line" data-line="7">array: db 1, 2, 3, 0
</div><div class="line" data-line="8">
</div><div class="line" data-line="9">section .text
</div><div class="line" data-line="10">_start:
</div><div class="line" data-line="11">	mov al, [array]        ; array[0]
</div><div class="line" data-line="12">	mov bl, [array + 1]    ; array[1]
</div><div class="line" data-line="13">	mov cl, [array + 2]    ; array[2]
</div><div class="line" data-line="14">	mov sil, [array + 3]   ; array[3]
</div><div class="line" data-line="15">.exit:
</div><div class="line" data-line="16">	mov rdi, EXIT_SUCCESS
</div><div class="line" data-line="17">	mov rax, SYS_exit
</div><div class="line" data-line="18">	syscall
</div></code></pre>
<p>In the initialized data section <code>.data</code>, we declare an array with 3 elements of 1 byte each (integers from 1 to 3), using the number 0 as the array terminator:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">section .data
</div><div class="line" data-line="2">array: db 1, 2, 3, 0
</div></code></pre>
<p>Next, in the <code>.text</code> section, which is where the program’s source code goes, we can access array elements using pointer arithmetic, storing the result in registers:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">section .text
</div><div class="line" data-line="2">_start:
</div><div class="line" data-line="3">mov al, [array]        ; array[0]
</div></code></pre>
<p>In the code above, we’re accessing the value contained at memory address <code>0x402000</code> and storing the result in a register (AL) that has a size of 1 byte, meaning only the first byte of the array will be stored in the register.</p>
<p>Let’s check with gdb:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># The array is stored at address 0x402000</span>
</div><div class="line" data-line="2"><span style="color: #7f848e;"># and contains the hex value 0x00 0x03 0x02 0x01,</span>
</div><div class="line" data-line="3"><span style="color: #7f848e;"># remembering that this architecture uses little-endian format</span>
</div><div class="line" data-line="4"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">array</span>
</div><div class="line" data-line="5"><span style="color: #d19a66;">0x402000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">array</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>       <span style="color: #d19a66;">0x00030201</span>
</div><div class="line" data-line="6">
</div><div class="line" data-line="7"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">b</span> <span style="color: #d19a66;">13</span>
</div><div class="line" data-line="8"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">run</span>
</div><div class="line" data-line="9"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">next</span>
</div><div class="line" data-line="10">
</div><div class="line" data-line="11"><span style="color: #7f848e;"># In register AL we have the first element of the array</span>
</div><div class="line" data-line="12"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">al</span>
</div><div class="line" data-line="13"><span style="color: #61afef;">al</span>             <span style="color: #d19a66;">0x1</span>                 <span style="color: #d19a66;">1</span>
</div><div class="line" data-line="14">
</div><div class="line" data-line="15"><span style="color: #7f848e;"># It&#39;s the same as accessing the first hexbyte contained at address</span>
</div><div class="line" data-line="16"><span style="color: #7f848e;"># 0x402000</span>
</div><div class="line" data-line="17"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">x/1xb</span> <span style="color: #d19a66;">0x402000</span>
</div><div class="line" data-line="18"><span style="color: #d19a66;">0x402000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">array</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>       <span style="color: #d19a66;">0x01</span>
</div><div class="line" data-line="19">
</div></code></pre>
<blockquote>
<p>Remember that the AL register represents the lower 8-bits within the spectrum of the RAX register which encompasses a total of 64-bits in the x86_64 architecture</p>
</blockquote>
<p>To access the other array elements, just do pointer arithmetic and store in other 1-byte registers:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">mov al, [array]        ; array[0] =&gt; 1
</div><div class="line" data-line="2">mov bl, [array + 1]    ; array[1] =&gt; 2
</div><div class="line" data-line="3">mov cl, [array + 2]    ; array[2] =&gt; 3
</div><div class="line" data-line="4">mov sil, [array + 3]   ; array[3] =&gt; 0 (array ends here)
</div></code></pre>
<hr />
<h2><a href="#using-an-array-with-uninitialized-data" aria-hidden="true" class="anchor" id="using-an-array-with-uninitialized-data"></a>Using an array with uninitialized data</h2>
<p>So far, we’re declaring the array in the <code>.data</code> section where data is initialized. But we can make the program more “dynamic” by declaring the array in the section of <strong>uninitialized</strong> data, which is <code>.bss</code>.</p>
<p>Keeping compatibility with the previous example, let’s declare a 4-byte array using the <code>resb</code> directive which means “reserve byte”, where the first 3 bytes are reserved to store array elements and the last byte representing 0x0 which is the array terminator.</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">section .bss
</div><div class="line" data-line="2">array: resb 4 ; 3 bytes + 1 terminator byte
</div></code></pre>
<p>In gdb, we can see that the array is initialized with all values at zero, indicating that the array is empty but has 4 bytes reserved:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">array</span>
</div><div class="line" data-line="2"><span style="color: #d19a66;">0x402004</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">array</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>       <span style="color: #d19a66;">0x00000000</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x/4xb <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">array</span>
</div><div class="line" data-line="5"><span style="color: #d19a66;">0x402004</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">array</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>       <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>
</div></code></pre>
<p>To add elements to the array, we also need to use pointer arithmetic, just like we did in the previous example to access an array with pre-initialized data.</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">; Move value 1 to the first byte of the memory address at array
</div><div class="line" data-line="2">mov byte [array], 1  ; array[0] = 1
</div></code></pre>
<p>With gdb we confirm that at address 0x402000 where the array is, byte 1 was added:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">array</span>
</div><div class="line" data-line="2"><span style="color: #d19a66;">0x402000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">array</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>       <span style="color: #d19a66;">0x00000001</span>
</div></code></pre>
<p>And if we want to add value 2 to the next byte of the array?</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">mov byte [array + 1], 2
</div></code></pre>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">array</span>
</div><div class="line" data-line="2"><span style="color: #d19a66;">0x402000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">array</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>       <span style="color: #d19a66;">0x00000201</span>
</div></code></pre>
<p>Notice that what changes is the array “index”. At the initial position of the array, it’s like the index is zero, and at the subsequent position, we use index 1, which can be incremented until the array terminator.</p>
<p>It would be very complicated to keep manipulating a hard-coded index. We need a <em>pointer</em> to represent this index.</p>
<h3><a href="#index-to-the-rescue" aria-hidden="true" class="anchor" id="index-to-the-rescue"></a>Index to the rescue</h3>
<p>Assuming the array pointer starts with <em>zero</em>, which is the memory address where the array is, we can declare it in the initialized data section <code>.data</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #61afef;">section</span> <span style="color: #e06c75;">.bss</span>
</div><div class="line" data-line="2"><span style="color: #61afef;">array:</span> <span style="color: #e06c75;">resb</span> <span style="color: #d19a66;">4</span> <span style="color: #abb2bf;">;</span> <span style="color: #d19a66;">3</span> <span style="color: #e06c75;">bytes</span> <span style="color: #e06c75;">+</span> <span style="color: #d19a66;">1</span> <span style="color: #e06c75;">terminator</span> <span style="color: #e06c75;">byte</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #61afef;">section</span> <span style="color: #e06c75;">.data</span>
</div><div class="line" data-line="5"><span style="color: #61afef;">pointer:</span> <span style="color: #e06c75;">db</span> <span style="color: #d19a66;">0</span>
</div></code></pre>
<p>So, we could add the first element like this, right?</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">mov byte [array + pointer], 1   ; array + 0
</div></code></pre>
<p>When running the program, we get this error:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">src/live.asm:14: error: invalid effective address: multiple base segments
</div></code></pre>
<p><strong>This error indicates that we’re trying to do pointer manipulation from multiple memory segments</strong>, in this case array and pointer.</p>
<p>To solve this, we need to do pointer manipulation with immediate values (which was the previous case with hard-coded numbers) or with registers:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">; append(1)
</div><div class="line" data-line="2">mov al, byte [pointer]
</div><div class="line" data-line="3">mov byte [array + rax], 1   ; array + 0
</div></code></pre>
<ul>
<li>the first instruction moves the first byte contained at the <code>pointer</code> address and stores it in register AL</li>
<li>the second instruction moves immediate value 1 (array element) to the array’s memory address. Since RAX (64-bit version of AL) has value <code>0x0</code> representing the pointer, we’re inserting at the first byte of the array</li>
</ul>
<p>And to store the second element in the array?</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">; append(2)
</div><div class="line" data-line="2">mov al, byte [pointer]
</div><div class="line" data-line="3">mov byte [array + rax], 2
</div></code></pre>
<p>In gdb, let’s check what’s happening:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">array</span>
</div><div class="line" data-line="2"><span style="color: #d19a66;">0x402004</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">array</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>       <span style="color: #d19a66;">0x00000002</span>
</div></code></pre>
<p><em>Uh, oh…</em> This way we’re overwriting the previous value. We actually want the pointer to “move”, that is, it needs to be incremented by one byte so that <code>append(2)</code> results in 2 elements in the array.</p>
<p>With the <code>INC</code> instruction we can solve this problem:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">mov al, byte [pointer]      ; pointer -&gt; 0
</div><div class="line" data-line="2">mov byte [array + rax], 1   ; array + 0
</div><div class="line" data-line="3">inc byte [pointer]          ; pointer -&gt; 1
</div><div class="line" data-line="4">
</div><div class="line" data-line="5">mov al, byte [pointer]
</div><div class="line" data-line="6">mov byte [array + rax], 2   ; array + 1
</div></code></pre>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">array</span>
</div><div class="line" data-line="2"><span style="color: #d19a66;">0x402004</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">array</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>       <span style="color: #d19a66;">0x00000201</span>
</div></code></pre>
<p><em>Yay!</em> What a wonderful day!</p>
<h3><a href="#hitting-the-array-limit" aria-hidden="true" class="anchor" id="hitting-the-array-limit"></a>Hitting the array limit</h3>
<p>And if we keep incrementing the pointer until we hit the array limit?</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">mov al, byte [pointer]
</div><div class="line" data-line="2">mov byte [array + rax], 1   ; array + 0
</div><div class="line" data-line="3">inc byte [pointer]
</div><div class="line" data-line="4">
</div><div class="line" data-line="5">mov al, byte [pointer]
</div><div class="line" data-line="6">mov byte [array + rax], 2   ; array + 1
</div><div class="line" data-line="7">inc byte [pointer]
</div><div class="line" data-line="8">
</div><div class="line" data-line="9">mov al, byte [pointer]
</div><div class="line" data-line="10">mov byte [array + rax], 3   ; array + 2
</div><div class="line" data-line="11">inc byte [pointer]
</div></code></pre>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Reading the first 4 hexabytes of the array, we have the representation</span>
</div><div class="line" data-line="2"><span style="color: #7f848e;"># of the full array with all spaces occupied, remembering that</span>
</div><div class="line" data-line="3"><span style="color: #7f848e;"># the last byte is the array terminator</span>
</div><div class="line" data-line="4"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">/4xb</span> <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">array</span>
</div><div class="line" data-line="5"><span style="color: #d19a66;">0x402004</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">array</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>       <span style="color: #d19a66;">0x01</span>    <span style="color: #d19a66;">0x02</span>    <span style="color: #d19a66;">0x03</span>    <span style="color: #d19a66;">0x00</span>
</div><div class="line" data-line="6">
</div><div class="line" data-line="7"><span style="color: #7f848e;"># The pointer is at the end of the array</span>
</div><div class="line" data-line="8"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">pointer</span>
</div><div class="line" data-line="9"><span style="color: #d19a66;">0x402000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">pointer</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>     <span style="color: #d19a66;">0x03</span>
</div></code></pre>
<p>Wonderful, and if we add one more element, should our program allow it?</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">mov al, byte [pointer]
</div><div class="line" data-line="2">mov byte [array + rax], 4   ; array + 3
</div><div class="line" data-line="3">inc byte [pointer]
</div></code></pre>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># We shouldn&#39;t allow another element to be added,</span>
</div><div class="line" data-line="2"><span style="color: #7f848e;"># since our array was already full</span>
</div><div class="line" data-line="3"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">/4xb</span> <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">array</span>
</div><div class="line" data-line="4"><span style="color: #d19a66;">0x402004</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">array</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>       <span style="color: #d19a66;">0x01</span>    <span style="color: #d19a66;">0x02</span>    <span style="color: #d19a66;">0x03</span>    <span style="color: #d19a66;">0x04</span>
</div><div class="line" data-line="5">
</div><div class="line" data-line="6"><span style="color: #7f848e;"># The pointer is beyond the array capacity (not good...)</span>
</div><div class="line" data-line="7"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">pointer</span>
</div><div class="line" data-line="8"><span style="color: #d19a66;">0x402000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">pointer</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>     <span style="color: #d19a66;">0x04</span>
</div></code></pre>
<p>Let’s use a conditional jump (I explain more about this in the <a href="https://leandronsp.com/articles/construindo-um-web-server-em-assembly-x86-parte-iv-um-assembly-modesto-oif">series</a>) to not allow the element to be added. With this, before appending to the array, we should check if the pointer is already at the end of the array:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">cmp byte [pointer], 3   ; check if array is full
</div><div class="line" data-line="2">je .exit                ; jump to .exit routine if flag is raised
</div></code></pre>
<p>Here’s the complete program:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">%define SYS_exit 60
</div><div class="line" data-line="4">%define EXIT_SUCCESS 0
</div><div class="line" data-line="5">
</div><div class="line" data-line="6">section .bss
</div><div class="line" data-line="7">array: resb 4 ; 3 bytes + 1 terminator byte
</div><div class="line" data-line="8">
</div><div class="line" data-line="9">section .data
</div><div class="line" data-line="10">pointer: db 0
</div><div class="line" data-line="11">
</div><div class="line" data-line="12">section .text
</div><div class="line" data-line="13">_start:
</div><div class="line" data-line="14">	cmp byte [pointer], 3   ; check if array is full
</div><div class="line" data-line="15">	je .exit
</div><div class="line" data-line="16">
</div><div class="line" data-line="17">	mov al, byte [pointer]
</div><div class="line" data-line="18">	mov byte [array + rax], 1   ; array + 0
</div><div class="line" data-line="19">	inc byte [pointer]
</div><div class="line" data-line="20">
</div><div class="line" data-line="21">	cmp byte [pointer], 3   ; check if array is full
</div><div class="line" data-line="22">	je .exit
</div><div class="line" data-line="23">
</div><div class="line" data-line="24">	mov al, byte [pointer]
</div><div class="line" data-line="25">	mov byte [array + rax], 2   ; array + 1
</div><div class="line" data-line="26">	inc byte [pointer]
</div><div class="line" data-line="27">
</div><div class="line" data-line="28">	cmp byte [pointer], 3   ; check if array is full
</div><div class="line" data-line="29">	je .exit
</div><div class="line" data-line="30">
</div><div class="line" data-line="31">	mov al, byte [pointer]
</div><div class="line" data-line="32">	mov byte [array + rax], 3   ; array + 2
</div><div class="line" data-line="33">	inc byte [pointer]
</div><div class="line" data-line="34">
</div><div class="line" data-line="35">	cmp byte [pointer], 3   ; check if array is full
</div><div class="line" data-line="36">	je .exit
</div><div class="line" data-line="37">
</div><div class="line" data-line="38">	; shouldn&#39;t allow adding the fourth element,
</div><div class="line" data-line="39">	; since the array supports up to 3 elements. this way,
</div><div class="line" data-line="40">	; we&#39;d be writing to the memory address of other
</div><div class="line" data-line="41">	; program data
</div><div class="line" data-line="42">	mov al, byte [pointer]
</div><div class="line" data-line="43">	mov byte [array + rax], 4   ; array + 3
</div><div class="line" data-line="44">	inc byte [pointer]
</div><div class="line" data-line="45">.exit:
</div><div class="line" data-line="46">	mov rdi, EXIT_SUCCESS
</div><div class="line" data-line="47">	mov rax, SYS_exit
</div><div class="line" data-line="48">	syscall
</div></code></pre>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">pointer</span>
</div><div class="line" data-line="2"><span style="color: #d19a66;">0x402000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">pointer</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>     <span style="color: #d19a66;">0x00000003</span>
</div><div class="line" data-line="3"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">array</span>
</div><div class="line" data-line="4"><span style="color: #d19a66;">0x402004</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">array</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>       <span style="color: #d19a66;">0x00030201</span>
</div></code></pre>
<p>Perfect, let’s now do a small refactoring in the code separating the append logic into a subroutine:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">%define SYS_exit 60
</div><div class="line" data-line="4">%define EXIT_SUCCESS 0
</div><div class="line" data-line="5">%define CAPACITY 3
</div><div class="line" data-line="6">
</div><div class="line" data-line="7">section .bss
</div><div class="line" data-line="8">array: resb CAPACITY + 1
</div><div class="line" data-line="9">
</div><div class="line" data-line="10">section .data
</div><div class="line" data-line="11">pointer: db 0
</div><div class="line" data-line="12">
</div><div class="line" data-line="13">section .text
</div><div class="line" data-line="14">_start:
</div><div class="line" data-line="15">	mov rdi, 1
</div><div class="line" data-line="16">	call .append
</div><div class="line" data-line="17">
</div><div class="line" data-line="18">	mov rdi, 2
</div><div class="line" data-line="19">	call .append
</div><div class="line" data-line="20">
</div><div class="line" data-line="21">	mov rdi, 3
</div><div class="line" data-line="22">	call .append
</div><div class="line" data-line="23">
</div><div class="line" data-line="24">	mov rdi, 4
</div><div class="line" data-line="25">	call .append
</div><div class="line" data-line="26">.exit:
</div><div class="line" data-line="27">	mov rdi, EXIT_SUCCESS
</div><div class="line" data-line="28">	mov rax, SYS_exit
</div><div class="line" data-line="29">	syscall
</div><div class="line" data-line="30">.append:
</div><div class="line" data-line="31">	cmp byte [pointer], CAPACITY ; check if array is full
</div><div class="line" data-line="32">	je .done
</div><div class="line" data-line="33">
</div><div class="line" data-line="34">	mov al, byte [pointer]
</div><div class="line" data-line="35">	mov byte [array + rax], dil
</div><div class="line" data-line="36">	inc byte [pointer]
</div><div class="line" data-line="37">.done:
</div><div class="line" data-line="38">	ret
</div></code></pre>
<blockquote>
<p>If you want to understand more about conditional jump, routines, call, ret and flags, I suggest reading my series which has been referenced several times in this article</p>
</blockquote>
<p>Running with gdb and…</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">array</span>
</div><div class="line" data-line="2"><span style="color: #d19a66;">0x402004</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">array</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>       <span style="color: #d19a66;">0x00030201</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">pointer</span>
</div><div class="line" data-line="5"><span style="color: #d19a66;">0x402000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">pointer</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>     <span style="color: #d19a66;">0x00000003</span>
</div></code></pre>
<p>A big <em>Yay!</em></p>
<p>However, there may be situations where we want our array to be <em>resized</em> to support more elements, that is, the array size would be dynamic.</p>
<p>How do we add more elements beyond the <em>initial capacity</em> without writing to other memory areas that don’t belong to the array?</p>
<hr />
<h2><a href="#heap-heap-hooray" aria-hidden="true" class="anchor" id="heap-heap-hooray"></a>Heap, heap, hooray!</h2>
<p>Before talking about the heap, let’s remember how the memory layout of a computer program works:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/s81vxvgfylw0wfcf6if7.png" alt="memory layout" /></p>
<ul>
<li>the layout is represented as an area in computer memory where we have the program’s lowest memory addresses toward the highest addresses at the top</li>
<li>at the lowest memory addresses, we have the <code>.text</code> section, where we’ve already seen that it refers to the program itself</li>
<li>then we have the <strong>data section</strong> which encompasses initialized data <code>.data</code> and the following section representing uninitialized data <code>.bss</code></li>
<li>at the highest addresses, we have the program’s <em>stack</em>, which stores metadata such as the program name, its arguments and any program information that has a fixed size fitting within the stack, as well as function calls and their respective arguments</li>
<li>the stack has a <em>stack</em> format and “grows downward”, that is, as we add elements to the stack, it grows toward lower addresses in memory</li>
</ul>
<p>In the “middle” of the layout, between the data section and the stack, we have a large area in memory that many end up associating as <em>heap</em>. In the heap, we can allocate data dynamically, unlike the static way we do in the data section.</p>
<p>To accommodate a dynamic-sized array that supports resizing, we have to allocate memory in this area.</p>
<blockquote>
<p>In this article, we’ll call this region in the middle of memory between the data section and the stack <strong>heap</strong></p>
</blockquote>
<h3><a href="#dynamic-memory-allocation-with-brk" aria-hidden="true" class="anchor" id="dynamic-memory-allocation-with-brk"></a>Dynamic memory allocation with brk</h3>
<p>One way to manipulate this memory area is through the <a href="https://man7.org/linux/man-pages/man2/brk.2.html">brk syscall</a>, which changes the <em>program break</em>, which is <strong>where the data section ends</strong>.</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/3c703vs0c7bl1eosh5i8.png" alt="program break" /></p>
<p>With <code>brk</code>, we can modify this <em>program break</em> to higher addresses, that is, allowing manipulation of memory areas that go beyond the program and data section.</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jh2x79f2nb1m1v4dcaxe.png" alt="program break visualized" /></p>
<p>The first thing we need to do is map the syscall and make the call that brings the current break address:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">%define SYS_brk 12
</div><div class="line" data-line="2">....
</div><div class="line" data-line="3">
</div><div class="line" data-line="4">section .text
</div><div class="line" data-line="5">_start:
</div><div class="line" data-line="6">; syscall to access the program break (0x403000), which is where
</div><div class="line" data-line="7">; the data section ends and the heap begins
</div><div class="line" data-line="8">mov rdi, 0
</div><div class="line" data-line="9">mov rax, SYS_brk
</div><div class="line" data-line="10">syscall
</div><div class="line" data-line="11">....
</div></code></pre>
<p>With gdb, let’s analyze the program state:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Breakpoint at brk syscall line</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">b</span> <span style="color: #d19a66;">18</span>
</div><div class="line" data-line="3"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">run</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #7f848e;"># The program start is in the .text section and begins at</span>
</div><div class="line" data-line="6"><span style="color: #7f848e;"># 0x401000</span>
</div><div class="line" data-line="7"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">_start</span>
</div><div class="line" data-line="8"><span style="color: #d19a66;">0x401000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">_start</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>      <span style="color: #61afef;">0x000000bf</span>
</div><div class="line" data-line="9">
</div><div class="line" data-line="10"><span style="color: #7f848e;"># The pointer is in the .data section a bit higher and starts at</span>
</div><div class="line" data-line="11"><span style="color: #7f848e;"># 0x402000</span>
</div><div class="line" data-line="12"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">pointer</span>
</div><div class="line" data-line="13"><span style="color: #d19a66;">0x402000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">pointer</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>     <span style="color: #d19a66;">0x00000000</span>
</div><div class="line" data-line="14">
</div><div class="line" data-line="15"><span style="color: #7f848e;"># The array is in the .bss section a bit higher and starts at</span>
</div><div class="line" data-line="16"><span style="color: #7f848e;"># 0x402004</span>
</div><div class="line" data-line="17"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">array</span>
</div><div class="line" data-line="18"><span style="color: #d19a66;">0x402004</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">array</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>       <span style="color: #d19a66;">0x00000000</span>
</div><div class="line" data-line="19">
</div><div class="line" data-line="20"><span style="color: #7f848e;"># Execute the brk syscall</span>
</div><div class="line" data-line="21"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">n</span>
</div><div class="line" data-line="22">
</div><div class="line" data-line="23"><span style="color: #7f848e;"># The brk syscall stores in RAX the program break memory address,</span>
</div><div class="line" data-line="24"><span style="color: #7f848e;"># in this case a bit higher at 0x403000</span>
</div><div class="line" data-line="25"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">rax</span>
</div><div class="line" data-line="26"><span style="color: #61afef;">rax</span>            <span style="color: #d19a66;">0x403000</span>            <span style="color: #d19a66;">4206592</span>
</div></code></pre>
<ul>
<li><code>0x401000</code>: <code>.text</code> section which is where the program begins</li>
<li><code>0x402000</code>: <code>.data</code> section where initialized data is</li>
<li><code>0x402004</code>: <code>.bss</code> section where uninitialized data is</li>
<li><code>0x403000</code>: program break, which is where the data section ends and our “heap” begins</li>
</ul>
<p>With this, from address <code>0x403000</code> onwards is where we’ll put our array elements, so the array address can use just one byte, which points to the address where the first element begins in the heap.</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/mkuui4ot8ta2ohpf05bx.png" alt="array in heap" /></p>
<p>In the syscall we made, if the argument in RDI is zero, it means brk will return the current program break, in this case <code>0x403000</code>. But we can make more brk syscalls with a different RDI argument (incremented), signaling that we’re changing the program break.</p>
<p>From now on, in the <code>.bss</code> data section, we no longer need to reserve 4 bytes for the array, so only 1 byte is needed which will represent the array’s memory address in the heap:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">%define SYS_brk 12
</div><div class="line" data-line="4">%define SYS_exit 60
</div><div class="line" data-line="5">%define EXIT_SUCCESS 0
</div><div class="line" data-line="6">%define CAPACITY 3
</div><div class="line" data-line="7">
</div><div class="line" data-line="8">; initially starts with 0x000000, but will later contain
</div><div class="line" data-line="9">; address 0x403000
</div><div class="line" data-line="10">section .bss
</div><div class="line" data-line="11">array: resb 1
</div><div class="line" data-line="12">
</div><div class="line" data-line="13">section .data
</div><div class="line" data-line="14">pointer: db 0
</div><div class="line" data-line="15">
</div><div class="line" data-line="16">section .text
</div><div class="line" data-line="17">_start:
</div><div class="line" data-line="18">	mov rdi, 0
</div><div class="line" data-line="19">	mov rax, SYS_brk
</div><div class="line" data-line="20">	syscall
</div><div class="line" data-line="21">
</div><div class="line" data-line="22">	mov rdi, rax
</div><div class="line" data-line="23">	add rdi, CAPACITY
</div><div class="line" data-line="24">	mov rax, SYS_brk
</div><div class="line" data-line="25">	syscall
</div><div class="line" data-line="26">
</div><div class="line" data-line="27">...
</div><div class="line" data-line="28">...
</div></code></pre>
<p>Analyzing with gdb:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Breakpoint at first syscall</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">b</span> <span style="color: #d19a66;">18</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">run</span>
</div><div class="line" data-line="5">
</div><div class="line" data-line="6"><span style="color: #7f848e;"># Execute the syscall line</span>
</div><div class="line" data-line="7"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">n</span>
</div><div class="line" data-line="8">
</div><div class="line" data-line="9"><span style="color: #7f848e;"># In RAX the syscall stores the program break address, in this case</span>
</div><div class="line" data-line="10"><span style="color: #7f848e;"># 0x403000</span>
</div><div class="line" data-line="11"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">rax</span>
</div><div class="line" data-line="12"><span style="color: #61afef;">rax</span>            <span style="color: #d19a66;">0x403000</span>            <span style="color: #d19a66;">4206592</span>
</div><div class="line" data-line="13">
</div><div class="line" data-line="14"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #d19a66;">0x403000</span>
</div><div class="line" data-line="15"><span style="color: #61afef;">0x403000:</span>       <span style="color: #e06c75;">Cannot</span> <span style="color: #e06c75;">access</span> <span style="color: #e06c75;">memory</span> <span style="color: #e06c75;">at</span> <span style="color: #e06c75;">address</span> <span style="color: #d19a66;">0x403000</span>
</div></code></pre>
<p>At this moment, this address is not yet accessible because we haven’t reserved new bytes in the heap. Let’s move forward with the next syscall:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">n</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">n</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #7f848e;"># Before executing the syscall, we verify that argument RDI will</span>
</div><div class="line" data-line="5"><span style="color: #7f848e;"># contain the desired address for the new program break, in this case with</span>
</div><div class="line" data-line="6"><span style="color: #7f848e;"># 3 bytes added, 0x403003</span>
</div><div class="line" data-line="7"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">rdi</span>
</div><div class="line" data-line="8"><span style="color: #61afef;">rdi</span>            <span style="color: #d19a66;">0x403003</span>            <span style="color: #d19a66;">4206595</span>
</div><div class="line" data-line="9">
</div><div class="line" data-line="10"><span style="color: #7f848e;"># Execute the syscall...</span>
</div><div class="line" data-line="11"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">n</span>
</div><div class="line" data-line="12"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">n</span>
</div><div class="line" data-line="13">
</div><div class="line" data-line="14"><span style="color: #7f848e;"># After executing the second syscall, we see that in RAX, the program break was changed to 0x403003</span>
</div><div class="line" data-line="15"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">rax</span>
</div><div class="line" data-line="16"><span style="color: #61afef;">rax</span>            <span style="color: #d19a66;">0x403003</span>            <span style="color: #d19a66;">4206595</span>
</div></code></pre>
<p>Now, we can access memory addresses between <code>0x403000</code> and <code>0x403003</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #d19a66;">0x403000</span>
</div><div class="line" data-line="2"><span style="color: #61afef;">0x403000:</span>       <span style="color: #d19a66;">0x00000000</span>
</div><div class="line" data-line="3"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #d19a66;">0x403001</span>
</div><div class="line" data-line="4"><span style="color: #61afef;">0x403001:</span>       <span style="color: #d19a66;">0x00000000</span>
</div><div class="line" data-line="5"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #d19a66;">0x403002</span>
</div><div class="line" data-line="6"><span style="color: #61afef;">0x403002:</span>       <span style="color: #d19a66;">0x00000000</span>
</div><div class="line" data-line="7"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #d19a66;">0x403003</span>
</div><div class="line" data-line="8"><span style="color: #61afef;">0x403003:</span>       <span style="color: #d19a66;">0x00000000</span>
</div></code></pre>
<p><em>Wow!</em> Now we have in the heap a reserved area especially for our dear array, how cool is that!</p>
<p>How are we going to manipulate the array in this memory region?</p>
<h3><a href="#pointers-pointers-everywhere" aria-hidden="true" class="anchor" id="pointers-pointers-everywhere"></a>Pointers, pointers everywhere</h3>
<p>After the first syscall, we should take the memory address <code>0x403000</code> which represents the first program break and store it in the array pointer that’s in <code>.bss</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">...
</div><div class="line" data-line="2">mov rdi, 0
</div><div class="line" data-line="3">mov rax, SYS_brk
</div><div class="line" data-line="4">syscall
</div><div class="line" data-line="5">mov [array], rax      ; &lt;---- breakpoint here
</div><div class="line" data-line="6">
</div><div class="line" data-line="7">mov rdi, rax
</div><div class="line" data-line="8">add rdi, CAPACITY
</div><div class="line" data-line="9">mov rax, SYS_brk
</div><div class="line" data-line="10">syscall
</div><div class="line" data-line="11">...
</div></code></pre>
<p>Let’s check with gdb the breakpoint at the line that changes the array pointer:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">b</span> <span style="color: #d19a66;">19</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">run</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">array</span>
</div><div class="line" data-line="5"><span style="color: #d19a66;">0x402004</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">array</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>       <span style="color: #d19a66;">0x00000000</span>
</div><div class="line" data-line="6">
</div><div class="line" data-line="7"><span style="color: #7f848e;"># Execute the line that changes the pointer</span>
</div><div class="line" data-line="8"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">n</span>
</div><div class="line" data-line="9">
</div><div class="line" data-line="10"><span style="color: #7f848e;"># Now the pointer points to address 0x403000,</span>
</div><div class="line" data-line="11"><span style="color: #7f848e;"># this is what we want</span>
</div><div class="line" data-line="12"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">array</span>
</div><div class="line" data-line="13"><span style="color: #d19a66;">0x402004</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">array</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>       <span style="color: #d19a66;">0x00403000</span>
</div></code></pre>
<p><em>Important to note</em> that <strong>array</strong> is at address <code>0x402004</code>, in the <code>.bss</code> section, so its value represents another memory address <code>0x403000</code> which is where the first array element should start in the heap.</p>
<p>Now, when we make the next syscall to allocate 3 bytes in the heap, the program break will be modified and we’ll be able to manipulate the array since the pointer already points to the correct address.</p>
<p>After the second syscall, we can no longer manipulate <code>array</code> by its value, because now the array value is no longer an actual element, but rather an address to another place in memory.</p>
<p>Here’s the program in its current version:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">%define SYS_brk 12
</div><div class="line" data-line="4">%define SYS_exit 60
</div><div class="line" data-line="5">%define EXIT_SUCCESS 0
</div><div class="line" data-line="6">%define CAPACITY 3
</div><div class="line" data-line="7">
</div><div class="line" data-line="8">section .bss
</div><div class="line" data-line="9">array: resb 1   ; 0x403000
</div><div class="line" data-line="10">
</div><div class="line" data-line="11">section .data
</div><div class="line" data-line="12">pointer: db 0
</div><div class="line" data-line="13">
</div><div class="line" data-line="14">section .text
</div><div class="line" data-line="15">_start:
</div><div class="line" data-line="16">	mov rdi, 0
</div><div class="line" data-line="17">	mov rax, SYS_brk
</div><div class="line" data-line="18">	syscall
</div><div class="line" data-line="19">	mov [array], rax
</div><div class="line" data-line="20">
</div><div class="line" data-line="21">	mov rdi, rax
</div><div class="line" data-line="22">	add rdi, CAPACITY
</div><div class="line" data-line="23">	mov rax, SYS_brk
</div><div class="line" data-line="24">	syscall
</div><div class="line" data-line="25">
</div><div class="line" data-line="26">	mov rbx, [array]
</div><div class="line" data-line="27">
</div><div class="line" data-line="28">	mov r8, 1
</div><div class="line" data-line="29">	call .append
</div><div class="line" data-line="30">
</div><div class="line" data-line="31">	mov r8, 2
</div><div class="line" data-line="32">	call .append
</div><div class="line" data-line="33">
</div><div class="line" data-line="34">	mov r8, 3
</div><div class="line" data-line="35">	call .append
</div><div class="line" data-line="36">
</div><div class="line" data-line="37">	mov r8, 4
</div><div class="line" data-line="38">	call .append
</div><div class="line" data-line="39">.exit:
</div><div class="line" data-line="40">	mov rdi, EXIT_SUCCESS
</div><div class="line" data-line="41">	mov rax, SYS_exit
</div><div class="line" data-line="42">	syscall
</div><div class="line" data-line="43">.append:
</div><div class="line" data-line="44">	cmp byte [pointer], CAPACITY ; check if array is full
</div><div class="line" data-line="45">	je .done
</div><div class="line" data-line="46">
</div><div class="line" data-line="47">	mov sil, byte [pointer]
</div><div class="line" data-line="48">	mov byte [rbx + rsi], r8b
</div><div class="line" data-line="49">	inc byte [pointer]
</div><div class="line" data-line="50">.done:
</div><div class="line" data-line="51">	ret
</div></code></pre>
<p>Explaining each block:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">mov rdi, 0
</div><div class="line" data-line="2">mov rax, SYS_brk
</div><div class="line" data-line="3">syscall
</div><div class="line" data-line="4">mov [array], rax
</div></code></pre>
<ul>
<li>fetches the current program break and stores the address in the <code>array</code> pointer</li>
</ul>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">mov rdi, rax
</div><div class="line" data-line="2">add rdi, CAPACITY
</div><div class="line" data-line="3">mov rax, SYS_brk
</div><div class="line" data-line="4">syscall
</div></code></pre>
<ul>
<li>modifies the current program break, incrementing 3 bytes which is the initial array capacity in the heap</li>
</ul>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">; assign to the register the memory address that the
</div><div class="line" data-line="2">; &quot;array&quot; pointer is pointing to
</div><div class="line" data-line="3">mov rbx, [array]
</div></code></pre>
<ul>
<li>stores the pointer’s memory address in register RBX. This is necessary because we don’t want to do arithmetic directly on the pointer in the <code>.bss</code> section, but rather through a register that allows it</li>
</ul>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">mov r8, 1
</div><div class="line" data-line="2">call .append
</div></code></pre>
<ul>
<li>since now RDI was used as argument in the brk syscall, it’s not convenient to use this register anymore to represent the element to be added to the array, so we switch to register R8</li>
</ul>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">.append:
</div><div class="line" data-line="2">	cmp byte [pointer], CAPACITY ; check if array is full
</div><div class="line" data-line="3">	je .done
</div><div class="line" data-line="4">
</div><div class="line" data-line="5">	mov sil, byte [pointer]
</div><div class="line" data-line="6">	mov byte [rbx + rsi], r8b    ; indirect-mode addressing
</div><div class="line" data-line="7">	inc byte [pointer]
</div><div class="line" data-line="8">.done:
</div><div class="line" data-line="9">	ret
</div></code></pre>
<p>Now the <code>.append</code> routine has been modified so that heap array manipulation is through register RBX. We also can’t use register RAX anymore to represent the pointer because the brk syscall also used it as return for the program break; in this case we switch to RSI (which has SIL as its lower 8-bit representation).</p>
<p>Running with gdb, we can verify that elements are being added at address <code>0x403000</code> which is in the heap, through the pointer that was stored in register RBX:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Array points to address 0x403000</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">array</span>
</div><div class="line" data-line="3"><span style="color: #d19a66;">0x402004</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">array</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>       <span style="color: #d19a66;">0x00403000</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #7f848e;"># At that address, we have the added elements. Yay!</span>
</div><div class="line" data-line="6"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">x</span> <span style="color: #d19a66;">0x403000</span>
</div><div class="line" data-line="7"><span style="color: #61afef;">0x403000:</span>       <span style="color: #d19a66;">0x00030201</span>
</div><div class="line" data-line="8">
</div><div class="line" data-line="9"><span style="color: #7f848e;"># And the &quot;index&quot; pointer correctly representing the end of the array in the heap</span>
</div><div class="line" data-line="10"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">pointer</span>
</div><div class="line" data-line="11"><span style="color: #d19a66;">0x402000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">pointer</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>     <span style="color: #d19a66;">0x00000003</span>
</div></code></pre>
<p>At this point, the program has the same behavior as the previous example with static array in <code>.bss</code>, not allowing adding more elements when the array reaches its limit.</p>
<p>Let’s change this by resizing the array and allowing new elements to be added.</p>
<h3><a href="#resize-with-brk" aria-hidden="true" class="anchor" id="resize-with-brk"></a>Resize with brk</h3>
<p>Next, we start the steps so that array resizing is done when <strong>it reaches capacity limit</strong>. We start by changing the <code>.append</code> routine:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">.append:
</div><div class="line" data-line="2">	cmp byte [pointer], CAPACITY ; check if array is full
</div><div class="line" data-line="3">	je .resize
</div><div class="line" data-line="4">
</div><div class="line" data-line="5">	mov sil, byte [pointer]
</div><div class="line" data-line="6">	mov byte [rbx + rsi], r8b
</div><div class="line" data-line="7">	inc byte [pointer]
</div><div class="line" data-line="8">.done:
</div><div class="line" data-line="9">	ret
</div><div class="line" data-line="10">.resize:
</div><div class="line" data-line="11">	...
</div></code></pre>
<p>Instead of jumping to <code>.done</code> when the array is full, we jump to another subroutine called <code>.resize</code>, which should make the brk syscall again, thus modifying the <strong>program break</strong> in a new memory area, obeying the initial array capacity:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">.append:
</div><div class="line" data-line="2">	cmp byte [pointer], CAPACITY ; check if array is full
</div><div class="line" data-line="3">	je .resize
</div><div class="line" data-line="4">
</div><div class="line" data-line="5">	mov sil, byte [pointer]
</div><div class="line" data-line="6">	mov byte [rbx + rsi], r8b
</div><div class="line" data-line="7">	inc byte [pointer]
</div><div class="line" data-line="8">.done:
</div><div class="line" data-line="9">	ret
</div><div class="line" data-line="10">.resize:
</div><div class="line" data-line="11">	mov rdi, 0
</div><div class="line" data-line="12">	mov rax, SYS_brk
</div><div class="line" data-line="13">	syscall
</div><div class="line" data-line="14">
</div><div class="line" data-line="15">	mov rdi, rax            ; RDI now represents the current break
</div><div class="line" data-line="16">	add rdi, CAPACITY       ; add 3 bytes, becoming 0x403006
</div><div class="line" data-line="17">	mov rax, SYS_brk
</div><div class="line" data-line="18">	syscall
</div><div class="line" data-line="19">	jmp .append
</div></code></pre>
<ul>
<li>the first resize syscall brings the current break, in this case we already know it’s <code>0x403003</code>, which was allocated at the beginning of the program for the array</li>
<li>the second resize syscall modifies the current break, thus allocating 3 more bytes in the heap</li>
<li>at the end of resize, instead of returning the function, we’ll go back to the beginning of <code>.append</code> and execute the necessary logic to add the element to the array</li>
</ul>
<p>This way, we can manipulate this new memory area to add more elements to the array, thus dynamically modifying its capacity.</p>
<p>If we run the program exactly like this, we’ll face a problem, because:</p>
<ul>
<li>every time resize is done, it jumps to the beginning of the routine</li>
<li>the array size (pointer) is checked against the initial capacity, which in this case is 3. Since the pointer reached value 3, it will enter resize again characterizing an infinite loop with infinite resize until memory runs out</li>
</ul>
<p>To solve this, we need to compare the pointer with the current capacity (modified), and therefore we’ll add a value in the <code>.data</code> section representing the current capacity:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">%define CAPACITY 3
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">section .data
</div><div class="line" data-line="4">pointer: db 0
</div><div class="line" data-line="5">currentCapacity: db CAPACITY ; starts with 3
</div></code></pre>
<p>In the <code>.append</code> routine, we’ll make the comparison with <code>currentCapacity</code>, which will be modified with each resize, instead of with <code>CAPACITY</code>, which will remain fixed with the initial value throughout the program.</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">.append:
</div><div class="line" data-line="2">	mov r9, [currentCapacity]
</div><div class="line" data-line="3">	cmp byte [pointer], r9b     ; check if array is full
</div><div class="line" data-line="4">	je .resize
</div><div class="line" data-line="5">...
</div></code></pre>
<p>And, after resizing before going back to <code>.append</code>, we’ll increment the initial capacity to the current capacity:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">.resize:
</div><div class="line" data-line="2">	mov rdi, 0
</div><div class="line" data-line="3">	mov rax, SYS_brk
</div><div class="line" data-line="4">	syscall
</div><div class="line" data-line="5">
</div><div class="line" data-line="6">	mov rdi, rax
</div><div class="line" data-line="7">	add rdi, CAPACITY
</div><div class="line" data-line="8">	mov rax, SYS_brk
</div><div class="line" data-line="9">	syscall
</div><div class="line" data-line="10">
</div><div class="line" data-line="11">	mov r10, currentCapacity
</div><div class="line" data-line="12">	add byte [r10], CAPACITY
</div><div class="line" data-line="13">	jmp .append
</div></code></pre>
<p>Running the program, we can see that element 4 was successfully added to the array after resizing:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #d19a66;">0x403000</span>
</div><div class="line" data-line="2"><span style="color: #61afef;">0x403000:</span>       <span style="color: #d19a66;">0x04030201</span>
</div></code></pre>
<p>And if we add more and more elements?</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">...
</div><div class="line" data-line="2">	mov r8, 4
</div><div class="line" data-line="3">	call .append
</div><div class="line" data-line="4">
</div><div class="line" data-line="5">	mov r8, 5
</div><div class="line" data-line="6">	call .append
</div><div class="line" data-line="7">
</div><div class="line" data-line="8">	mov r8, 6
</div><div class="line" data-line="9">	call .append
</div><div class="line" data-line="10">
</div><div class="line" data-line="11">	mov r8, 7
</div><div class="line" data-line="12">	call .append
</div><div class="line" data-line="13">...
</div></code></pre>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># We can see that currentCapacity is 9, meaning there were</span>
</div><div class="line" data-line="2"><span style="color: #7f848e;"># 2 resizes. Our array can now accommodate up to 9 elements,</span>
</div><div class="line" data-line="3"><span style="color: #7f848e;"># so when adding the tenth element, one more resize would be done.</span>
</div><div class="line" data-line="4"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">currentCapacity</span>
</div><div class="line" data-line="5"><span style="color: #d19a66;">0x402001</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">currentCapacity</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>     <span style="color: #d19a66;">0x09</span>
</div><div class="line" data-line="6">
</div><div class="line" data-line="7"><span style="color: #7f848e;"># Fetching the first 9 hexabytes at the array address in the heap</span>
</div><div class="line" data-line="8"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span> <span style="color: #61afef;">x/9xb</span>  <span style="color: #d19a66;">0x403000</span>
</div><div class="line" data-line="9"><span style="color: #61afef;">0x403000:</span>       <span style="color: #d19a66;">0x01</span>    <span style="color: #d19a66;">0x02</span>    <span style="color: #d19a66;">0x03</span>    <span style="color: #d19a66;">0x04</span>    <span style="color: #d19a66;">0x05</span>    <span style="color: #d19a66;">0x06</span>    <span style="color: #d19a66;">0x07</span>    <span style="color: #d19a66;">0x00</span>
</div><div class="line" data-line="10"><span style="color: #61afef;">0x403008:</span>       <span style="color: #d19a66;">0x00</span>
</div></code></pre>
<p><em>How cool is that?</em></p>
<hr />
<h2><a href="#the-final-program" aria-hidden="true" class="anchor" id="the-final-program"></a>The final program</h2>
<p>Here’s the final program, with an array of initial capacity of 3 elements in the heap that can be resized using the <code>brk</code> syscall, as more elements are added to the array:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">%define SYS_brk 12
</div><div class="line" data-line="4">%define SYS_exit 60
</div><div class="line" data-line="5">%define EXIT_SUCCESS 0
</div><div class="line" data-line="6">%define CAPACITY 3
</div><div class="line" data-line="7">
</div><div class="line" data-line="8">section .bss
</div><div class="line" data-line="9">array: resb 1
</div><div class="line" data-line="10">
</div><div class="line" data-line="11">section .data
</div><div class="line" data-line="12">pointer: db 0
</div><div class="line" data-line="13">currentCapacity: db CAPACITY ; initial capacity is 3
</div><div class="line" data-line="14">
</div><div class="line" data-line="15">section .text
</div><div class="line" data-line="16">_start:
</div><div class="line" data-line="17">	mov rdi, 0
</div><div class="line" data-line="18">	mov rax, SYS_brk
</div><div class="line" data-line="19">	syscall
</div><div class="line" data-line="20">	mov [array], rax
</div><div class="line" data-line="21">
</div><div class="line" data-line="22">	mov rdi, rax
</div><div class="line" data-line="23">	add rdi, CAPACITY
</div><div class="line" data-line="24">	mov rax, SYS_brk
</div><div class="line" data-line="25">	syscall
</div><div class="line" data-line="26">
</div><div class="line" data-line="27">	mov rbx, [array]
</div><div class="line" data-line="28">
</div><div class="line" data-line="29">	mov r8, 1
</div><div class="line" data-line="30">	call .append
</div><div class="line" data-line="31">
</div><div class="line" data-line="32">	mov r8, 2
</div><div class="line" data-line="33">	call .append
</div><div class="line" data-line="34">
</div><div class="line" data-line="35">	mov r8, 3
</div><div class="line" data-line="36">	call .append
</div><div class="line" data-line="37">
</div><div class="line" data-line="38">	mov r8, 4
</div><div class="line" data-line="39">	call .append
</div><div class="line" data-line="40">
</div><div class="line" data-line="41">	mov r8, 5
</div><div class="line" data-line="42">	call .append
</div><div class="line" data-line="43">
</div><div class="line" data-line="44">	mov r8, 6
</div><div class="line" data-line="45">	call .append
</div><div class="line" data-line="46">
</div><div class="line" data-line="47">	mov r8, 7
</div><div class="line" data-line="48">	call .append
</div><div class="line" data-line="49">.exit:
</div><div class="line" data-line="50">	mov rdi, EXIT_SUCCESS
</div><div class="line" data-line="51">	mov rax, SYS_exit
</div><div class="line" data-line="52">	syscall
</div><div class="line" data-line="53">.append:
</div><div class="line" data-line="54">	mov r9, [currentCapacity]
</div><div class="line" data-line="55">	cmp byte [pointer], r9b ; check if array is full
</div><div class="line" data-line="56">	je .resize
</div><div class="line" data-line="57">
</div><div class="line" data-line="58">	mov sil, byte [pointer]
</div><div class="line" data-line="59">	mov byte [rbx + rsi], r8b
</div><div class="line" data-line="60">	inc byte [pointer]
</div><div class="line" data-line="61">.done:
</div><div class="line" data-line="62">	ret
</div><div class="line" data-line="63">.resize:
</div><div class="line" data-line="64">	mov rdi, 0
</div><div class="line" data-line="65">	mov rax, SYS_brk
</div><div class="line" data-line="66">	syscall
</div><div class="line" data-line="67">
</div><div class="line" data-line="68">	mov rdi, rax
</div><div class="line" data-line="69">	add rdi, CAPACITY
</div><div class="line" data-line="70">	mov rax, SYS_brk
</div><div class="line" data-line="71">	syscall
</div><div class="line" data-line="72">
</div><div class="line" data-line="73">	mov r10, currentCapacity
</div><div class="line" data-line="74">	add byte [r10], CAPACITY
</div><div class="line" data-line="75">	jmp .append
</div></code></pre>
<hr />
<h2><a href="#conclusion" aria-hidden="true" class="anchor" id="conclusion"></a>Conclusion</h2>
<p>In this article, we showed the implementation of an array in x86 Assembly, covering important concepts like memory layout, register manipulation, and dynamic memory allocation with <code>brk</code>.</p>
<p>This article is the foundation for future articles about data structures, where I intend to write about implementing queues and later other data structures.</p>
<hr />
<h2><a href="#references" aria-hidden="true" class="anchor" id="references"></a>References</h2>
<ul>
<li><a href="https://man7.org/linux/man-pages/man2/brk.2.html">brk syscall</a></li>
<li><a href="https://leandronsp.com/articles/construindo-um-web-server-em-assembly-x86-parte-i-introducao-14p5">x86 Assembly series</a></li>
</ul>
      </div>

      <!-- Back to top -->
      <div class="mt-12 mb-8 text-center">
        <a href="#" onclick="event.preventDefault(); window.scrollTo({ top: 0, behavior: 'smooth' });" class="inline-flex items-center gap-2 text-xl font-medium transition-colors text-base-content/70 hover:text-primary cursor-pointer">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
          </svg>
          Back to top
        </a>
      </div>
    </article>

    <!-- Giscus Comments -->
    <div class="mt-16">
      <div class="border-t border-base-300 pt-8">
        <h2 class="text-2xl font-bold mb-6">Comments</h2>
        <script src="https://giscus.app/client.js"
                data-repo="leandronsp/leandronsp.com"
                data-repo-id="R_kgDOQGG-eQ"
                data-category="Announcements"
                data-category-id="DIC_kwDOQGG-ec4Cw4TN"
                data-mapping="pathname"
                data-strict="0"
                data-reactions-enabled="1"
                data-emit-metadata="0"
                data-input-position="bottom"
                data-theme="preferred_color_scheme"
                data-lang="en"
                crossorigin="anonymous"
                async>
        </script>
      </div>
    </div>

    <!-- Footer -->
    <footer class="mt-16 pt-8 pb-6 border-t border-base-300">
      <div class="text-center text-sm text-base-content/80">
        <p>
          Powered by
          <a
            href="https://github.com/leandronsp/curupira"
            target="_blank"
            rel="noopener noreferrer"
            class="font-semibold text-blue-600 hover:underline"
          >
            Curupira
          </a>
          | Open source blog platform built with Phoenix LiveView
        </p>
        <p class="mt-2 text-xs text-base-content/70">
          Licensed under
          <a
            href="https://github.com/leandronsp/curupira/blob/master/LICENSE"
            target="_blank"
            rel="noopener noreferrer"
            class="text-blue-600 hover:underline"
          >
            AGPL-3.0
          </a>
        </p>
      </div>
    </footer>
  </main>

  <script src="/static-theme.7c342999.js" defer></script>
  <script src="/static-filters.ff26a35d.js" defer></script>
  <script src="/static-search.f956387a.js" defer></script>
  <script src="/static-giscus.ff40d264.js" defer></script>

  <!-- Lazy load Google Analytics after page is fully interactive -->
  <script>
    (function() {
      function loadGTM() {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-0Y5RNLZMKN');

        var script = document.createElement('script');
        script.async = true;
        script.src = 'https://www.googletagmanager.com/gtag/js?id=G-0Y5RNLZMKN';
        document.head.appendChild(script);
      }

      // Load after page is idle, or after 5 seconds as fallback
      if ('requestIdleCallback' in window) {
        requestIdleCallback(loadGTM, { timeout: 5000 });
      } else {
        setTimeout(loadGTM, 5000);
      }
    })();
  </script>
</body>
</html>
