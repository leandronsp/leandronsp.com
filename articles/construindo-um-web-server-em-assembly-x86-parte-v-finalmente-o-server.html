<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Construindo um web server em Assembly x86, parte V, finalmente o server - Leandro Proen√ßa</title>
  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">

  <!-- Google Fonts - Nunito for name, Caveat for bio -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800&family=Caveat:wght@500;700&display=swap" rel="stylesheet">

  <!-- SEO Meta Tags -->
  <meta name="description" content="No [artigo anterior](https://leandronsp.com/articles/construindo-um-web-server-em-assembly-x86-parte-iv-um-assembly-modesto-oif), passamos pelos fundamentos de A">
  <meta name="author" content="Leandro Proen√ßa">
  <link rel="canonical" href="https://leandronsp.com/articles/construindo-um-web-server-em-assembly-x86-parte-v-finalmente-o-server.html">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://leandronsp.com/articles/construindo-um-web-server-em-assembly-x86-parte-v-finalmente-o-server.html">
  <meta property="og:title" content="Construindo um web server em Assembly x86, parte V, finalmente o server">
  <meta property="og:description" content="No [artigo anterior](https://leandronsp.com/articles/construindo-um-web-server-em-assembly-x86-parte-iv-um-assembly-modesto-oif), passamos pelos fundamentos de A">
  <meta property="og:site_name" content="Leandro Proen√ßa">
  <meta property="article:published_time" content="2024-05-25T00:14:20Z">
  <meta property="article:tag" content="braziliandevs">
      <meta property="article:tag" content="assembly">
      <meta property="article:tag" content="computerscience">

  <!-- JSON-LD Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "Construindo um web server em Assembly x86, parte V, finalmente o server",
    "datePublished": "2024-05-25T00:14:20Z",
    "author": {
      "@type": "Person",
      "name": "Leandro Proen√ßa"
    },
    "description": "No [artigo anterior](https://leandronsp.com/articles/construindo-um-web-server-em-assembly-x86-parte-iv-um-assembly-modesto-oif), passamos pelos fundamentos de A",
        "keywords": "braziliandevs, assembly, computerscience"
  }
  </script>

  <link rel="preload" href="/assets/css/app.css" as="style">
  <script>
    // Prevent FOUC (Flash of Unstyled Content) by setting theme before CSS loads
    (function() {
      const theme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <link rel="stylesheet" href="/assets/css/app.css">
  <style>
    /* Force scrollbar to always be visible to prevent layout shift */
    html {
      overflow-y: scroll;
    }

    /* Softer dark theme colors */
    [data-theme="dark"] {
      --base-100: #2a2f3a;
      --base-200: #232831;
      --base-300: #1e222a;
      --base-content: #e8eaed;
    }
    [data-theme="dark"] .article-card {
      background-color: transparent;
      border-color: #3d4454;
    }
    [data-theme="dark"] .article-card:hover {
      border-color: #4a5568;
    }
    /* Keep pinned article with background for prominence in dark theme - lighter pastel */
    [data-theme="dark"] .pinned-article {
      background-color: #3a4050 !important;
    }
    [data-theme="dark"] .prose {
      color: #e8eaed;
    }
    [data-theme="dark"] .prose h1,
    [data-theme="dark"] .prose h2,
    [data-theme="dark"] .prose h3,
    [data-theme="dark"] .prose h4 {
      color: #f0f2f5;
    }
    [data-theme="dark"] .prose a {
      color: #8fb4ff;
    }
    [data-theme="dark"] .prose code {
      background-color: #3d4454;
      color: #f0f2f5;
    }
    [data-theme="dark"] .prose pre {
      background-color: #1e222a;
      border: 1px solid #3d4454;
    }
    [data-theme="dark"] input {
      background-color: #2f3542;
      border-color: #3d4454;
      color: #e8eaed;
    }
    [data-theme="dark"] input::placeholder {
      color: #9ca3af;
    }
    /* Language switcher dark theme styling */
    [data-theme="dark"] .lang-switcher-bg {
      background-color: rgba(59, 130, 246, 0.15) !important;
      border-color: rgba(59, 130, 246, 0.3) !important;
    }
    /* Blog name styling */
    .blog-name {
      font-family: 'Nunito', sans-serif;
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    /* Intro text styling */
    .intro-text {
      font-family: 'Caveat', cursive;
      font-weight: 600;
      color: #6b7280; /* Darker pastel gray for light theme */
    }
    [data-theme="dark"] .intro-text {
      color: #d4d4d8; /* Lighter pastel gray for dark theme */
    }
    /* Article card styling */
    article {
      background-color: transparent;
      border: none;
      border-radius: 0.5rem;
      padding: 2rem;
    }
    [data-theme="dark"] article {
      background-color: transparent;
    }
    /* Article images styling - consistent sizing */
    .prose img {
      max-width: 800px;
      width: 100%;
      height: auto;
      display: block;
      margin-left: auto;
      margin-right: auto;
      border-radius: 0.5rem;
    }
  </style>
</head>
<body class="min-h-screen bg-base-100">
  <!-- Fixed Header -->
  <header class="sticky top-0 z-50 bg-base-100 border-b border-base-300 shadow-sm">
    <div class="container mx-auto px-4 sm:px-6 py-4 max-w-6xl">
      <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-2 lg:gap-4 mb-4">
        <!-- Left side: Name + Intro text -->
        <div class="flex flex-col lg:flex-row lg:items-center lg:gap-6 flex-1">
          <h1 class="blog-name text-2xl sm:text-3xl font-bold text-base-content flex-shrink-0">Leandro Proen√ßa</h1>
          <p class="intro-text text-xl lg:text-2xl leading-tight">
            Software Developer 15+ years programming and counting.<br>
            See my guides at
            <a href="https://web101.leandronsp.com" target="_blank" rel="noopener noreferrer" class="underline decoration-2 hover:opacity-80 transition-opacity cursor-pointer">web101</a>,
            <a href="https://concorrencia101.leandronsp.com" target="_blank" rel="noopener noreferrer" class="underline decoration-2 hover:opacity-80 transition-opacity cursor-pointer">concorrencia101</a>,
            <a href="https://aws101.leandronsp.com" target="_blank" rel="noopener noreferrer" class="underline decoration-2 hover:opacity-80 transition-opacity cursor-pointer">aws101</a>
          </p>
        </div>

        <!-- Right side: Social icons -->
        <div class="flex items-center gap-3 flex-shrink-0">
          <a href="https://linkedin.com/in/leandronsp" target="_blank" rel="noopener noreferrer" class="text-base-content/60 hover:text-primary transition-colors" title="LinkedIn">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
          </a>
          <a href="https://github.com/leandronsp" target="_blank" rel="noopener noreferrer" class="text-base-content/60 hover:text-primary transition-colors" title="GitHub">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/></svg>
          </a>
          <button id="theme-toggle" class="text-base-content/60 hover:text-primary transition-colors" title="Toggle theme">
            <svg xmlns="http://www.w3.org/2000/svg" class="sun-icon h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
            <svg xmlns="http://www.w3.org/2000/svg" class="moon-icon h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
          </button>
        </div>
      </div>

      <!-- Search Bar + Language Switcher -->
      <div class="flex gap-4 items-center">
        <!-- Search -->
        <div class="hidden md:block relative flex-1 max-w-2xl">
          <input
            type="text"
            id="search-input"
            placeholder="Search articles..."
            class="w-full h-12 pl-12 pr-4 text-base bg-base-200 border-2 border-base-300 rounded-full transition-all focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
            autocomplete="off"
          />
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-4 top-1/2 -translate-y-1/2 text-base-content/40" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>

          <!-- Search Results Dropdown -->
          <div id="search-results" class="hidden absolute top-full mt-2 w-full bg-base-100 border-2 border-base-300 rounded-2xl shadow-2xl max-h-[500px] overflow-y-auto z-50 p-3">
            <!-- Results will be inserted here by JavaScript -->
          </div>
        </div>

        <!-- Language Switcher -->
        <div class="lang-switcher-bg flex gap-0 bg-blue-50/80 border border-blue-100 rounded-full p-1 ml-auto shadow-sm">
          <button class="lang-filter-btn px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-primary text-white" data-lang="all" onclick="window.blogFilters.setLanguage('all')">All</button>
          <button class="lang-filter-btn px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-white/60 text-base-content" data-lang="pt" onclick="window.blogFilters.setLanguage('pt')">üáßüá∑ PT</button>
          <button class="lang-filter-btn px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-white/60 text-base-content" data-lang="en" onclick="window.blogFilters.setLanguage('en')">üá∫üá∏ EN</button>
        </div>
        <script>
          // Apply language state immediately (sync, no event listener)
          (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlLang = urlParams.get('lang');
            const savedLang = localStorage.getItem('blog-filter-lang') || 'all';
            const currentLang = urlLang || savedLang;

            const buttons = document.querySelectorAll('.lang-filter-btn');
            buttons.forEach(function(btn) {
              const lang = btn.getAttribute('data-lang');
              if (lang === currentLang) {
                btn.className = 'lang-filter-btn px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-primary text-white';
              } else {
                btn.className = 'lang-filter-btn px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-white/60 text-base-content';
              }
            });
          })();
        </script>
      </div>
    </div>

    <!-- Tags Navigation -->
    <div class="border-t border-base-300 bg-base-200/50">
      <div class="container mx-auto px-4 sm:px-6 max-w-6xl">
        <div class="py-3">
          <div class="flex flex-wrap gap-2 items-center">
            <div id="tags-pills" class="flex flex-wrap gap-2 items-center">
              <button class="tag-pill px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-primary text-white" data-tag="all" onclick="window.blogFilters.clearTag()">All</button>
              <button class="tag-pill px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-base-200 text-base-content" data-tag="ruby" onclick="window.blogFilters.setTag('ruby')">Ruby</button>
              <button class="tag-pill px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-base-200 text-base-content" data-tag="rust" onclick="window.blogFilters.setTag('rust')">Rust</button>
              <button class="tag-pill px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-base-200 text-base-content" data-tag="haskell" onclick="window.blogFilters.setTag('haskell')">Haskell</button>
              <button class="tag-pill px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-base-200 text-base-content" data-tag="assembly" onclick="window.blogFilters.setTag('assembly')">Assembly</button>
              <button class="tag-pill px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-base-200 text-base-content" data-tag="bash" onclick="window.blogFilters.setTag('bash')">Bash</button>
              <button class="tag-pill px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-base-200 text-base-content" data-tag="postgres" onclick="window.blogFilters.setTag('postgres')">Postgres</button>
              <button class="tag-pill px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-base-200 text-base-content" data-tag="kubernetes" onclick="window.blogFilters.setTag('kubernetes')">Kubernetes</button>
            </div>
          </div>
        </div>
      </div>
      <script>
        // Apply tag state and pinned visibility immediately (sync, no event listener)
        (function() {
          const urlParams = new URLSearchParams(window.location.search);
          const urlTag = urlParams.get('tag');
          const savedTag = localStorage.getItem('blog-filter-tag');
          const currentTag = urlTag || savedTag || null;

          // Update tag buttons
          const buttons = document.querySelectorAll('.tag-pill');
          buttons.forEach(function(btn) {
            const tag = btn.getAttribute('data-tag');
            const isActive = (tag === 'all' && !currentTag) || (tag === currentTag);
            if (isActive) {
              btn.className = 'tag-pill px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-primary text-white';
            } else {
              btn.className = 'tag-pill px-4 py-1.5 text-sm font-medium rounded-full transition-all whitespace-nowrap cursor-pointer bg-transparent hover:bg-base-200 text-base-content';
            }
          });
        })();
      </script>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto px-4 sm:px-6 py-8 max-w-6xl">
    <article class="bg-base-100">
      <!-- Back link -->
      <a href="/" onclick="event.preventDefault(); history.back();" class="inline-flex items-center gap-2 text-lg font-medium transition-colors text-base-content/70 hover:text-primary cursor-pointer mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back
      </a>

      <h1 class="text-5xl font-bold leading-tight mb-6">Construindo um web server em Assembly x86, parte V, finalmente o server</h1>

      <div class="flex flex-wrap items-center gap-3 mb-8 text-base text-base-content/85">
        <div class="flex items-center gap-1.5">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
          <span>Published 25 May 2024</span>
        </div>

        <div class="flex items-center gap-1.5">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
  </svg>
  <div class="flex gap-2 flex-wrap">
    <span class="inline-flex items-center px-3 py-1 text-sm border border-base-content/25 rounded-full">braziliandevs</span><span class="inline-flex items-center px-3 py-1 text-sm border border-base-content/25 rounded-full">assembly</span><span class="inline-flex items-center px-3 py-1 text-sm border border-base-content/25 rounded-full">computerscience</span>
  </div>
</div>

      </div>

      <div class="prose prose-lg max-w-none">
        <p>No <a href="https://leandronsp.com/articles/construindo-um-web-server-em-assembly-x86-parte-iv-um-assembly-modesto-oif">artigo anterior</a>, passamos pelos fundamentos de Assembly, onde foi poss√≠vel entender alguns conceitos b√°sicos tais como tipos de registradores, <strong>stack</strong>, loops, FLAGS etc, tudo sendo feito com debugging via <em>GDB</em>.</p>
<p>Agora, vamos de fato construir um web server muito simples que devolve um HTML com a frase ‚ÄúHello, World‚Äù. A meta √© chegarmos nisto:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/6745f6h98cph2u50aa8x.png" alt="hello world" /></p>
<p>O processo para chegarmos a este objetivo consiste em cobrir fundamentos de Web, passando por sockets, TCP e HTTP, enquanto vamos explorando conceitos pr√°ticos em Assembly x86.</p>
<hr />
<h2><a href="#agenda" aria-hidden="true" class="anchor" id="agenda"></a>Agenda</h2>
<ul>
<li><a href="#arquitetura-web">Arquitetura Web</a>
<ul>
<li><a href="#clienteservidor">Cliente-servidor</a></li>
<li><a href="#modelo-osi">Modelo OSI</a></li>
<li><a href="#sockets-e-tcp">Sockets e TCP</a></li>
<li><a href="#http">HTTP</a></li>
</ul>
</li>
<li><a href="#como-funciona-um-servidor-web">Como funciona um servidor web</a>
<ul>
<li><a href="#4-syscalls-para-o-resgate">4 syscalls para o resgate</a></li>
</ul>
</li>
<li><a href="#um-server-modesto-em-assembly">Um server modesto em Assembly</a>
<ul>
<li><a href="#criando-o-socket">Criando o socket</a></li>
<li><a href="#fazendo-bind-no-socket">Fazendo bind no socket</a></li>
<li><a href="#preparando-para-receber-conex%C3%B5es">Preparando para receber conex√µes</a></li>
<li><a href="#chegou-o-momento-de-aceitar-clientes">Chegou o momento de aceitar clientes</a></li>
<li><a href="#resposta-do-servidor-e-fechamento-da-conex%C3%A3o">Resposta do servidor e fechamento da conex√£o</a></li>
<li><a href="#mas-o-servidor-deve-ficar-em-loop-n%C3%A3o">Mas o servidor deve ficar em loop, n√£o?</a></li>
</ul>
</li>
<li><a href="#conclus%C3%A3o">Conclus√£o</a></li>
<li><a href="#refer%C3%AAncias">Refer√™ncias</a></li>
</ul>
<hr />
<h2><a href="#arquitetura-web" aria-hidden="true" class="anchor" id="arquitetura-web"></a>Arquitetura Web</h2>
<p>Para criar um servidor web, precisamos manipular <em>mensagens HTTP</em>, que s√£o transportadas via camada de transporte TCP/IP atrav√©s de uma rede.</p>
<p>Estas mensagens s√£o enviadas entre diferentes dispositivos conectados a uma rede, que pode ser privada (local) ou p√∫blica. Regularmente, comunica√ß√£o HTTP √© feita entre 2 dispositivos, sendo um deles o <em>cliente</em> e outro o <em>servidor</em>.</p>
<p>Vamos brevemente falar de cada um destes conceitos.</p>
<h3><a href="#cliente-servidor" aria-hidden="true" class="anchor" id="cliente-servidor"></a>Cliente-servidor</h3>
<p>Numa arquitetura cliente-servidor, temos 2 dispositivos conectados a uma rede de computadores:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/z9io56i8xzadm9cqvepe.png" alt="cliente servidor" /></p>
<p>Para um servidor web, √© necess√°rio que o cliente realize uma <strong>conex√£o</strong> com o servidor, em seguida fa√ßa uma <strong>requisi√ß√£o</strong>, pelo que o servidor deve devolver uma <strong>resposta</strong> e, por √∫ltimo, <strong>fechar a conex√£o</strong>.</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/maxau6kx9t18u6r049r0.png" alt="connect request response" /></p>
<p>Mas como esta mensagem deve ser enviada? Quem garante a entrega? E caso ocorra falha de sinal na camada f√≠sica (cabeamento de rede), como assegurar que cada ‚Äúpacote‚Äù da mensagem seja entregue em ordem?</p>
<p>√â pra isto que foi criado o <strong>modelo de comunica√ß√£o OSI</strong>.</p>
<h3><a href="#modelo-osi" aria-hidden="true" class="anchor" id="modelo-osi"></a>Modelo OSI</h3>
<p>OSI √© um modelo de refer√™ncia para comunica√ß√£o entre diferentes dispositivos atrav√©s de diferentes redes, que estabelece um conjunto de camadas que vai desde a camada f√≠sica at√© a camada de formato de mensagens.</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/sdfapddkf7j5uzojvgzg.png" alt="modelo OSI" /></p>
<ul>
<li><strong>Camada f√≠sica</strong>: respons√°vel pelo tr√°fego de informa√ß√µes atrav√©s de meios f√≠sicos, tais como bluetooth, frequ√™ncia de r√°dio, cabos etc</li>
<li><strong>Camada de enlace de rede</strong>: respons√°vel pela decodifica√ß√£o e codifica√ß√£o de mensagens em frames, do meio f√≠sico para o meio digital e vice-versa</li>
<li><strong>Camada de rede</strong>: √© aqui que definimos protocolos de rede, tais como o <em>protocolo de internet</em>, tamb√©m conhecido como <strong>IP</strong> (Internet Protocol)</li>
</ul>
<blockquote>
<p>Na web, os dados trafegam geralmente atrav√©s de uma rede de computadores p√∫blica, global e descentralizada, neste caso a Internet</p>
</blockquote>
<ul>
<li><strong>Camada de transporte</strong>: camada respons√°vel por caracter√≠sticas de entrega, tais como definir crit√©rios de confiabilidade e ordem dos pacotes de mensagens. Por exemplo, nesta camada temos o <em>protocolo de  controle de transmiss√£o</em>, ou <strong>TCP</strong></li>
<li><strong>Camada de sess√£o e apresenta√ß√£o</strong>: aqui v√£o crit√©rios de informa√ß√µes que podem ser vinculadas a uma determinada conex√£o entre diferentes dispositivos, bem como o formato de apresenta√ß√£o das informa√ß√µes na rede</li>
<li><strong>Camada de aplica√ß√£o</strong>: nesta camada, temos a defini√ß√£o do formato de mensagens em um n√≠vel mais ‚Äúaplicacional‚Äù, como por exemplo protocolo HTTP (Hypertext Transfer Protocol), FTP, SSH entre outros</li>
</ul>
<p>Entretanto fica aqui uma quest√£o: como que todo esse modelo de comunica√ß√£o em rede se converte em algo pr√°tico num programa dentro de um sistema operacional?</p>
<p>Chegou o momento de falar sobre <em>sockets</em> e TCP.</p>
<h3><a href="#sockets-e-tcp" aria-hidden="true" class="anchor" id="sockets-e-tcp"></a>Sockets e TCP</h3>
<p>Num computador, todos os programas s√£o encapsulados dentro de uma estrutura chamada <em>processo</em>, como vimos em artigos anteriores.</p>
<p>Quando falamos em cliente na aquitetura cliente-servidor, estamos falando de um processo rodando dentro de um computador, e o mesmo vale para o servidor, onde cada processo tem seu pr√≥prio identificador, ou <em>PID</em>:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7q9yi7cdbs42p0352s24.png" alt="pids" /></p>
<p>Sabendo que processos s√£o isolados, foram definidas diferentes formas de comunica√ß√£o entre processos (tamb√©m conhecido como IPC, ou <em>inter process communication</em>), tais como pipes, arquivos do filesystem, descritores de arquivos e UNIX sockets.</p>
<blockquote>
<p>Estamos baseando a saga em sistema ‚ÄúUNIX-like‚Äù, mais especificamente GNU/Linux</p>
</blockquote>
<p>Ou seja, temos ci√™ncia que √© poss√≠vel fazer 2 processos <em>dentro de um mesmo computador</em> se comunicarem atrav√©s de UNIX sockets. Mas como fazer dois processos em computadores distintos se comunicarem?</p>
<p>Entramos ent√£o em <strong>Berkeley Sockets</strong>, que define uma API comum de comunica√ß√£o utilizando sockets, onde diferentes sockets podem estar no mesmo computador, ou em uma mesma rede local, ou at√© mesmo em redes diferentes dentro da <em>Internet</em>.</p>
<p>√â aqui que temos a introdu√ß√£o ao TCP, que √© um protocolo de comunica√ß√£o via sockets. Portanto, para fazer um cliente se comunicar com um servidor, √© preciso estabelecer <em>endpoints de comunica√ß√£o</em>, que s√£o basicamente <strong>sockets</strong>, e neste caso para a web, vamos utilizar <em>sockets TCP</em>.</p>
<p>Estes sockets s√£o abertos tanto do lado do cliente, quanto no servidor. No servidor, estes sockets s√£o mapeados em descritores de arquivos, que representam um n√∫mero especial e reservado, tamb√©m chamado de <strong>porta de comunica√ß√£o</strong>:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/j1x249n2k8ajhgvj2fsq.png" alt="sockets e tcp" /></p>
<blockquote>
<p>Ok Leandro, consegui entender o conceito de sockets e TCP. Mas qual deveria ser o formato da mensagem na web?</p>
</blockquote>
<p>Com voc√™s, o <em>HTTP</em>.</p>
<h3><a href="#http" aria-hidden="true" class="anchor" id="http"></a>HTTP</h3>
<p>HTTP √© um protocolo de formato de mensagem que faz parte da camada de aplica√ß√£o.</p>
<p>Com HTTP, a mensagem √© definida seguindo padr√µes de hipertexto, que s√£o basicamente documentos que podem ter liga√ß√µes com outros documentos em sites diferentes.</p>
<p>Na web, o padr√£o segue um formato de <em>headline</em>, que cont√©m o tipo de pedido, seguido de quebra de linhas com <em>cabe√ßalhos</em> de metadados e por fim, opcionalmente e dependendo do tipo de pedido, um <em>corpo</em> com a mensagem principal contendo majoritariamente HTML, CSS e Javascript.</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/7d0w16gxgauxlw4bnwe6.png" alt="tcp &amp; http" /></p>
<p>At√© agora, passamos por conceitos que formam a web. Como nosso exemplo de web server √© bastante simples, estes fundamentos j√° s√£o o suficiente para entrarmos na pr√≥xima se√ß√£o, que √© de fato escrever o web server em Assembly x86.</p>
<hr />
<h2><a href="#como-funciona-um-servidor-web" aria-hidden="true" class="anchor" id="como-funciona-um-servidor-web"></a>Como funciona um servidor web</h2>
<p>Conforme vimos na se√ß√£o anterior, arquitetura web passa por manipula√ß√£o de sockets TCP.</p>
<p>Tal manipula√ß√£o √© feita via <em>chamadas de sistema</em> (syscalls) no sistema operacional, portanto, para darmos in√≠cio ao servidor, vamos entender como devem ser criados os sockets a n√≠vel do OS.</p>
<h3><a href="#4-syscalls-para-o-resgate" aria-hidden="true" class="anchor" id="4-syscalls-para-o-resgate"></a>4 syscalls para o resgate</h3>
<p>Resumidamente temos que fazer 4 syscalls para termos um server operante, que s√£o:</p>
<p><strong>socket</strong><br />
A syscall <em>socket</em> √© respons√°vel por criar um endpoint de comunica√ß√£o de rede e retornar um descritor de arquivo (fd) relativo ao endpoint criado.</p>
<p>Na libc, <em>socket</em> √© referenciada pelo n√∫mero 41 e tem a seguinte assinatura:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-c" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #e5c07b;">int</span> <span style="color: #61afef;">socket</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">int</span> <span style="color: #e06c75;">domain</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">int</span> <span style="color: #e06c75;">type</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">int</span> <span style="color: #e06c75;">protocol</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span>
</div></code></pre>
<blockquote>
<p>Lembrando que estamos utilizando arquitetura x86_64, ou x64</p>
</blockquote>
<p><strong>bind</strong><br />
<em>bind</em> atribui nome e porta ao socket previamente criado. Esta syscall na libc responde pelo n√∫mero 49 e tem a assinatura a seguir:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-c" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #e5c07b;">int</span> <span style="color: #61afef;">bind</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">int</span> <span style="color: #e06c75;">sockfd</span><span style="color: #abb2bf;">,</span> <span style="color: #c678dd;">const</span> <span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">sockaddr</span> <span style="color: #e06c75;"><span style="color: #56b6c2;">*</span><span style="color: #e06c75;">addr</span></span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">socklen_t</span> <span style="color: #e06c75;">addrlen</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span>
</div></code></pre>
<p><strong>listen</strong><br />
A syscall <em>listen</em> marca o socket criado (precisa ser do tipo stream, no caso TCP) para aceitar conex√µes. √â conhecida pelo n√∫mero 50 e tem a seguinte assinatura em C:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-c" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #e5c07b;">int</span> <span style="color: #61afef;">listen</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">int</span> <span style="color: #e06c75;">sockfd</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">int</span> <span style="color: #e06c75;">backlog</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span>
</div></code></pre>
<p><strong>accept</strong><br />
A syscall <em>accept</em> admite uma conex√£o de um cliente no socket e cria um <em>novo socket de conex√£o espec√≠fico</em> para aquele cliente. Esta syscall, a princ√≠pio, bloqueia o programa e s√≥ continua a execu√ß√£o quando uma nova conex√£o com novo cliente √© estabelecida.</p>
<p>√â referenciada pelo n√∫mero 288 e tem a seguinte assintaura:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-c" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #e5c07b;">int</span> <span style="color: #61afef;">accept</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">int</span> <span style="color: #e06c75;">sockfd</span><span style="color: #abb2bf;">,</span> <span style="color: #c678dd;">struct</span> <span style="color: #56b6c2;">*</span><span style="color: #e5c07b;">addr</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">int</span> <span style="color: #e06c75;">addrlen</span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">int</span> <span style="color: #e06c75;">flags</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span>
</div></code></pre>
<p>Em resumo, tudo o que precisamos para criar um web server, independente do programa, linguagem de programa√ß√£o ou tecnologia, √© de chamar estas 4 syscalls.</p>
<blockquote>
<p>N√£o se engane, o teu servidor Express, Rails, Django ou NGINX, faz estas chamadas de sistema por baixo dos panos: <em>socket, bind, listen e accept</em></p>
</blockquote>
<p>Sem mais delongas, vamos ver como tudo isto se aplica naquilo que importa para esta saga: <strong>assembly</strong>.</p>
<hr />
<h2><a href="#um-server-modesto-em-assembly" aria-hidden="true" class="anchor" id="um-server-modesto-em-assembly"></a>Um server modesto em Assembly</h2>
<p>Montar as syscalls para o web server em Assembly n√£o √© t√£o dif√≠cil quanto parece. Para come√ßar, vamos fazer a primeira syscall, que √© a <em>socket</em>.</p>
<h3><a href="#criando-o-socket" aria-hidden="true" class="anchor" id="criando-o-socket"></a>Criando o socket</h3>
<p>Como de costume, vamos montar as instru√ß√µes de acordo com o <a href="https://man7.org/linux/man-pages/man2/socket.2.html">manual</a> e <a href="https://x64.syscall.sh/">tabela de syscalls</a>.</p>
<blockquote>
<p>J√° vimos na se√ß√£o anterior quais s√£o os n√∫meros das syscalls e suas respectivas assinaturas na libc</p>
</blockquote>
<p>Iniciamos definindo as constantes, apenas as necess√°rias para a syscall <em>socket</em>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">; syscalls constants
</div><div class="line" data-line="4">%define SYS_socket 41
</div><div class="line" data-line="5">
</div><div class="line" data-line="6">; other constants
</div><div class="line" data-line="7">%define AF_INET 2
</div><div class="line" data-line="8">%define SOCK_STREAM 1
</div><div class="line" data-line="9">%define SOCK_PROTOCOL 0
</div></code></pre>
<p>Ap√≥s isto, vamos reservar 1 byte com a diretiva <code>resb 1</code> que significa ‚Äúreservar 1 byte‚Äù. Este byte ser√° utilizado para armazenar o n√∫mero do descritor de arquivo que referencia o <em>socket</em> que vai ser criado.</p>
<p>Como <strong>n√£o queremos inicializar</strong> o valor deste byte, n√£o vamos colocar na se√ß√£o <code>.data</code> como temos utilizado at√© o momento na saga, mas sim na se√ß√£o <code>.bss</code>.</p>
<ul>
<li>Na se√ß√£o <code>.data</code>, ficam apenas dados inicializados</li>
<li>Na se√ß√£o <code>.bss</code>, ficam os dados n√£o-inicializados</li>
</ul>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">section .bss
</div><div class="line" data-line="2">sockfd: resb 1
</div></code></pre>
<p>Vamos relembrar o layout de mem√≥ria:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/3wznvwyjq68cs1ln7aj3.png" alt="layout de mem√≥ria" /></p>
<p>Como vemos na imagem, a se√ß√£o <code>.bss</code> vem a seguir a se√ß√£o <code>.data</code>, ou seja, fica em endere√ßos de mem√≥ria mais altos que a se√ß√£o <code>.data</code>.</p>
<p>Agora, vamos montar os registradores seguindo a conven√ß√£o de chamada e a ordem dos par√¢metros da fun√ß√£o <em>socket</em> na libc:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">section .text
</div><div class="line" data-line="2">_start:
</div><div class="line" data-line="3">.socket:
</div><div class="line" data-line="4">	; int socket(int domain, int type, int protocol)
</div><div class="line" data-line="5">	mov rdi, AF_INET
</div><div class="line" data-line="6">	mov rsi, SOCK_STREAM
</div><div class="line" data-line="7">	mov rdx, SOCK_PROTOCOL
</div><div class="line" data-line="8">	mov rax, SYS_socket
</div><div class="line" data-line="9">	syscall
</div><div class="line" data-line="10">	mov [sockfd], rax 
</div><div class="line" data-line="11">.exit:
</div><div class="line" data-line="12">	mov rdi, 0
</div><div class="line" data-line="13">	mov rax, 60
</div><div class="line" data-line="14">	syscall
</div></code></pre>
<ul>
<li><strong>domain</strong>: representa o dom√≠nio de comunica√ß√£o. No caso queremos usar AF_INET, que significa IPv4, e tem o valor 2 conforme especificado no <a href="https://github.com/bminor/glibc/blob/8f58e412b1e26d2c7e65c13a0ce758fbaf18d83f/bits/socket.h#L78">glibc</a></li>
<li><strong>type</strong>: representa o tipo de comunica√ß√£o, que no caso vamos usar SOCK_STREAM que √© sequencial, confi√°vel, duplex e baseado em conex√£o. O valor <a href="https://github.com/bminor/glibc/blob/8f58e412b1e26d2c7e65c13a0ce758fbaf18d83f/bits/socket.h#L42">conforme glibc</a> √© 1</li>
<li><strong>protocol</strong>: esta op√ß√£o √© usada no caso da utiliza√ß√£o de um protocolo em espec√≠fico. Neste caso, vamos deixar o valor como 0 que √© o default para AF_INET e SOCK_STREAM, <em>indicando que se trata de um socket TCP</em></li>
</ul>
<blockquote>
<p>Lembrando que existem sockets da fam√≠lia UNIX que n√£o funcionam na camada de rede IP. √â poss√≠vel combinar socket UNIX com SOCK_STREAM, mas neste caso estamos combinando a fam√≠lia AF_INET (IPv4) com o tipo SOCK_STREAM (segmento de bytes, duplex), e esta combina√ß√£o faz este socket ser TCP. Para mais detalhes sobre sockets, sugiro a leitura de um artigo que escrevi sobre <a href="https://leandronsp.com/articles/building-a-web-server-in-bash-part-i-sockets-2n8b">UNIX Sockets</a></p>
</blockquote>
<p>Vamos confirmar com GDB?</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Breakpoint na linha &lt;syscall&gt;</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #e5c07b;">break</span> <span style="color: #d19a66;">22</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">run</span>
</div><div class="line" data-line="5">
</div><div class="line" data-line="6"><span style="color: #7f848e;"># Confirmando que os registradores est√£o com os valores corretos</span>
</div><div class="line" data-line="7"><span style="color: #7f848e;"># antes da execu√ß√£o da syscall...</span>
</div><div class="line" data-line="8"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">rdi</span> <span style="color: #e06c75;">rsi</span> <span style="color: #e06c75;">rdx</span> <span style="color: #e06c75;">rax</span>
</div><div class="line" data-line="9"><span style="color: #61afef;">rdi</span>            <span style="color: #d19a66;">0x2</span>                 <span style="color: #d19a66;">2</span>
</div><div class="line" data-line="10"><span style="color: #61afef;">rsi</span>            <span style="color: #d19a66;">0x1</span>                 <span style="color: #d19a66;">1</span>
</div><div class="line" data-line="11"><span style="color: #61afef;">rdx</span>            <span style="color: #d19a66;">0x0</span>                 <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="12"><span style="color: #61afef;">rax</span>            <span style="color: #d19a66;">0x29</span>                <span style="color: #d19a66;">41</span>
</div><div class="line" data-line="13">
</div><div class="line" data-line="14"><span style="color: #7f848e;"># Confirmando que `sockfd` continua com o valor zerado</span>
</div><div class="line" data-line="15"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">sockfd</span>
</div><div class="line" data-line="16"><span style="color: #d19a66;">0x402000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">sockfd</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>      <span style="color: #d19a66;">0x00000000</span>
</div><div class="line" data-line="17">
</div><div class="line" data-line="18"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> next
</div></code></pre>
<p>Ap√≥s a execu√ß√£o da syscall, podemos ver que o <em>retorno da fun√ß√£o</em>, que representa o descritor de arquivo conforme documenta√ß√£o, est√° armazenado no registrador RAX (de acordo com a conven√ß√£o de chamada):</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">(gdb) i r rax
</div><div class="line" data-line="2">rax            0x3                 3
</div><div class="line" data-line="3">
</div><div class="line" data-line="4">(gdb) next
</div><div class="line" data-line="5">
</div><div class="line" data-line="6">(gdb) x &amp;sockfd
</div><div class="line" data-line="7">0x402000 &lt;sockfd&gt;:      0x00000003
</div></code></pre>
<p>Ou seja, ap√≥s a syscall, temos em <code>sockfd</code> o n√∫mero do socket que acabou de ser criado.</p>
<p>Executando com <em>strace</em>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">strace</span> <span style="color: #e06c75;">./live</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #61afef;">execve</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;./live&quot;</span><span style="color: #98c379;">,</span> <span style="color: #e06c75;">[</span><span style="color: #98c379;">&quot;./live&quot;</span><span style="color: #e06c75;">]</span><span style="color: #e06c75;">,</span> <span style="color: #e06c75;">0x7ffca20187e0</span> <span style="color: #e06c75;">/*</span> <span style="color: #d19a66;">24</span> <span style="color: #e06c75;">vars</span> <span style="color: #e06c75;">*/</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="4"><span style="color: #61afef;">socket</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">AF_INET,</span> <span style="color: #e06c75;">SOCK_STREAM,</span> <span style="color: #e06c75;">IPPROTO_IP</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">3</span>
</div><div class="line" data-line="5"><span style="color: #e5c07b;">exit</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">0</span><span style="color: #c678dd;">)</span>                                 <span style="color: #56b6c2;">=</span> ?
</div><div class="line" data-line="6">+++ <span style="color: #61afef;">exited</span> <span style="color: #e06c75;">with</span> <span style="color: #d19a66;">0</span> <span style="color: #e06c75;">+++</span>
</div></code></pre>
<p>Sem erros, <em>yay!</em></p>
<p>Vamos para a pr√≥xima syscall.</p>
<h3><a href="#fazendo-bind-no-socket" aria-hidden="true" class="anchor" id="fazendo-bind-no-socket"></a>Fazendo bind no socket</h3>
<p>Agora, √© o momento de atribuir um endere√ßo e uma porta como endpoint de comunica√ß√£o para este socket. √â para isto que serve a syscall <em>bind</em>.</p>
<p>Analisando a fun√ß√£o:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-c" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">;</span> <span style="color: #e5c07b;">int</span> <span style="color: #61afef;">bind</span><span style="color: #c678dd;">(</span><span style="color: #e5c07b;">int</span> <span style="color: #e06c75;">sockfd</span><span style="color: #abb2bf;">,</span> <span style="color: #c678dd;">const</span> <span style="color: #c678dd;">struct</span> <span style="color: #e5c07b;">sockaddr</span> <span style="color: #e06c75;"><span style="color: #56b6c2;">*</span><span style="color: #e06c75;">addr</span></span><span style="color: #abb2bf;">,</span> <span style="color: #e5c07b;">socklen_t</span> <span style="color: #e06c75;">addrlen</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;"></span>
</div></code></pre>
<p>Podemos ver que um dos argumentos √© um <em>ponteiro</em> para uma struct na mem√≥ria. Vamos entender melhor cada argumento.</p>
<p><strong>sockfd</strong><br />
Em sockfd vai o inteiro que representa o descritor do socket criado</p>
<p>*<em>sockaddr <strong>addr</strong></em><br />
Representa o ponteiro para o endere√ßo de mem√≥ria que cont√©m uma estrutura de dados que, de acordo com <a href="https://www.gta.ufrj.br/ensino/eel878/sockets/sockaddr_inman.html">este guia</a>, contempla: <em>family, port, ip_address, sin_zero</em>, onde sin_zero √© apenas padding de preenchimento de bytes.</p>
<p>Para arquitetura x64, esta estrutura deve conter 16 bytes no total, onde:</p>
<ul>
<li>
<p>2 bytes s√£o para a <em>fam√≠lia</em> de protocolo</p>
</li>
<li>
<p>2 bytes para a <em>porta</em></p>
</li>
<li>
<p>4 bytes para o <em>endere√ßo de IP</em></p>
</li>
<li>
<p>8 bytes de padding para o <em>sin_zero</em>, ou seja, preencher os 8 bytes restantes com ZERO</p>
</li>
</ul>
<p><strong>addrlen</strong>: tamanho do sockaddr, e j√° sabemos que s√£o 16 bytes</p>
<p>Uma vez entendidos os par√¢metros da fun√ß√£o, vamos montar a chamada.</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">%define SYS_bind 49
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">; Data types in asm
</div><div class="line" data-line="4">; (db) byte =&gt; 1 byte
</div><div class="line" data-line="5">; (dw) word =&gt; 2 bytes
</div><div class="line" data-line="6">; (dd) doubleword =&gt; 4 bytes
</div><div class="line" data-line="7">; (dq) quadword =&gt; 8 bytes
</div><div class="line" data-line="8">
</div><div class="line" data-line="9">section .data
</div><div class="line" data-line="10">sockaddr: 
</div><div class="line" data-line="11">	family: dw AF_INET   ; 2 bytes
</div><div class="line" data-line="12">	port: dw 0x0BB8      ; 2 bytes (representa a porta 3000)
</div><div class="line" data-line="13">	ip_address: dd 0     ; 4 bytes
</div><div class="line" data-line="14">	sin_zero: dq 0       ; 8 bytes
</div><div class="line" data-line="15">
</div><div class="line" data-line="16">.bind:
</div><div class="line" data-line="17">	; int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen)
</div><div class="line" data-line="18">	mov rdi, [sockfd]
</div><div class="line" data-line="19">	mov rsi, sockaddr
</div><div class="line" data-line="20">	mov rdx, 16
</div><div class="line" data-line="21">	mov rax, SYS_bind
</div><div class="line" data-line="22">	syscall
</div></code></pre>
<p>Ao validar com GDB, podemos ver que o <code>sockaddr</code> est√° armazenando a estrutura necess√°ria para ser enviada no par√¢metro <code>sockaddr *addr</code> da syscall:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Breakpoint na syscall de bind</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #e5c07b;">break</span> <span style="color: #d19a66;">38</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">run</span>
</div><div class="line" data-line="5">
</div><div class="line" data-line="6"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">sockaddr</span>
</div><div class="line" data-line="7"><span style="color: #d19a66;">0x402000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">family</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>      <span style="color: #61afef;">0xb80b0002</span>
</div></code></pre>
<p>Se buscarmos os 2 primeiros bytes, confirmamos que √© o valor 2 (repare que est√° invertido pois √© o padr√£o little-endian da aquitetura x86_64:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #e06c75;">/2xb</span> <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">sockaddr</span>
</div><div class="line" data-line="2"><span style="color: #d19a66;">0x402000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">family</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>      <span style="color: #d19a66;">0x02</span>    <span style="color: #d19a66;">0x00</span>
</div></code></pre>
<p>Quanto √† porta, queremos que o server responda no n√∫mero 3000. Portanto, verificamos que os pr√≥ximos 2 bytes representam a porta:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Em hexadecimal, 3000 equivale a 0x0BB8, mas por causa do formato</span>
</div><div class="line" data-line="2"><span style="color: #7f848e;"># little-endian da arquitetura x86_64, estamos visualizando 0xB80B</span>
</div><div class="line" data-line="3"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #61afef;">/2xb</span> <span style="color: #c678dd;">(</span><span style="color: #61afef;">void*</span><span style="color: #c678dd;">)</span> <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">sockaddr+2</span>
</div><div class="line" data-line="4"><span style="color: #d19a66;">0x402002</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">port</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>        <span style="color: #61afef;">0xb8</span>    <span style="color: #61afef;">0x0b</span>
</div></code></pre>
<p>Queremos tamb√©m que o servidor responda no endere√ßo de IP <code>0.0.0.0</code>, ent√£o os pr√≥ximos 4 bytes estar√£o todos a zero:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #61afef;">/4xb</span> <span style="color: #c678dd;">(</span><span style="color: #61afef;">void*</span><span style="color: #c678dd;">)</span> <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">sockaddr+4</span>
</div><div class="line" data-line="2"><span style="color: #d19a66;">0x402004</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">ip_address</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>  <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>
</div></code></pre>
<p>E, por fim, os 8 bytes restantes representando <em>sin_zero</em>, todos preenchidos com zero:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #61afef;">/8xb</span> <span style="color: #c678dd;">(</span><span style="color: #61afef;">void*</span><span style="color: #c678dd;">)</span> <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">sockaddr+8</span>
</div><div class="line" data-line="2"><span style="color: #d19a66;">0x402008</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">sin_zero</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>    <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>    <span style="color: #d19a66;">0x00</span>
</div></code></pre>
<p>Vamos executar com <em>strace</em>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">strace</span> <span style="color: #e06c75;">./live</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #61afef;">execve</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;./live&quot;</span><span style="color: #98c379;">,</span> <span style="color: #e06c75;">[</span><span style="color: #98c379;">&quot;./live&quot;</span><span style="color: #e06c75;">]</span><span style="color: #e06c75;">,</span> <span style="color: #e06c75;">0x7ffd51ed4650</span> <span style="color: #e06c75;">/*</span> <span style="color: #d19a66;">24</span> <span style="color: #e06c75;">vars</span> <span style="color: #e06c75;">*/</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="4"><span style="color: #61afef;">socket</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">AF_INET,</span> <span style="color: #e06c75;">SOCK_STREAM,</span> <span style="color: #e06c75;">IPPROTO_IP</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">3</span>
</div><div class="line" data-line="5"><span style="color: #e5c07b;">bind</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">3,</span> <span style="color: #e06c75;">&lbrace;</span><span style="color: #e06c75;">sa_family=AF_INET,</span> <span style="color: #e06c75;">sin_port=htons</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">47115</span><span style="color: #c678dd;">)</span>, sin_addr=inet_addr<span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;0.0.0.0&quot;</span><span style="color: #c678dd;">)</span>&rbrace;, <span style="color: #d19a66;">16</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="6"><span style="color: #e5c07b;">exit</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">0</span><span style="color: #c678dd;">)</span>                                 <span style="color: #56b6c2;">=</span> ?
</div><div class="line" data-line="7">+++ <span style="color: #61afef;">exited</span> <span style="color: #e06c75;">with</span> <span style="color: #d19a66;">0</span> <span style="color: #e06c75;">+++</span>
</div></code></pre>
<p>Ouch! Apesar da fun√ß√£o <em>bind</em> ter retornado 0 indicando que n√£o houve erros, temos um pequeno problema. Repare que a <em>porta</em> n√£o est√° sendo mapeada para o n√∫mero <strong>3000</strong>, e sim para <strong>47115</strong>, conforme vemos em <em>htons(47115)</em>.</p>
<p><strong>Entendendo a implica√ß√£o de endianess na syscall bind</strong><br />
<code>htons</code> √© uma fun√ß√£o de rede utilizada para converter a ordem dos bytes do programa antes de serem utilizados na rede. Como a internet utiliza big-endian, esta fun√ß√£o converte a ordem utilizada na arquitetura (no caso da x86_64, little-endian) para o formato big-endian da rede.</p>
<p>Entretanto <em>htons(47115)</em> n√£o √© o valor que queremos. O que precisamos √© que o mapeamendo seja <em>htons(3000)</em>. Por qu√™ isto est√° acontecendo?</p>
<p>O valor que colocamos em hexadecimal representando <em>3000</em> √© <em>0x0BB8</em>, mas se prestarmos aten√ß√£o no GBD, o valor de fato armazenado est√° com os bytes invertidos para little-endian, que √© <em>0xB80B</em>. Ocorre que <code>0xB80B</code> em decimal √© <strong>47115</strong>!!!!!! A√≠ que est√° o problema!</p>
<p>Precisamos ent√£o inverter os bytes no programa, e assim sendo o valor que ser√° passado para a fun√ß√£o htons fica corrigido.</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">....
</div><div class="line" data-line="2">section .data
</div><div class="line" data-line="3">sockaddr: 
</div><div class="line" data-line="4">	family: dw AF_INET   ; 2 bytes
</div><div class="line" data-line="5">	port: dw 0xB80B      ; 2 bytes (aqui invertemos os bytes)
</div><div class="line" data-line="6">	ip_address: dd 0     ; 4 bytes
</div><div class="line" data-line="7">	sin_zero: dq 0       ; 8 bytes
</div><div class="line" data-line="8">....
</div></code></pre>
<p>E analisando novamente com GDB:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Agora sim, apesar de estar invertido, √© exatamente este valor que</span>
</div><div class="line" data-line="2"><span style="color: #7f848e;"># queremos que seja passado para htons: 0x0BB8 em decimal √© 3000</span>
</div><div class="line" data-line="3"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> x <span style="color: #61afef;">/2xb</span> <span style="color: #c678dd;">(</span><span style="color: #61afef;">void*</span><span style="color: #c678dd;">)</span> <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">sockaddr+2</span>
</div><div class="line" data-line="4"><span style="color: #d19a66;">0x402002</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">port</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>        <span style="color: #61afef;">0x0b</span>    <span style="color: #61afef;">0xb8</span>
</div></code></pre>
<p>Executando novamente com <em>strace</em>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">strace</span> <span style="color: #e06c75;">./live</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #61afef;">execve</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;./live&quot;</span><span style="color: #98c379;">,</span> <span style="color: #e06c75;">[</span><span style="color: #98c379;">&quot;./live&quot;</span><span style="color: #e06c75;">]</span><span style="color: #e06c75;">,</span> <span style="color: #e06c75;">0x7ffd51ed4650</span> <span style="color: #e06c75;">/*</span> <span style="color: #d19a66;">24</span> <span style="color: #e06c75;">vars</span> <span style="color: #e06c75;">*/</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="4"><span style="color: #61afef;">socket</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">AF_INET,</span> <span style="color: #e06c75;">SOCK_STREAM,</span> <span style="color: #e06c75;">IPPROTO_IP</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">3</span>
</div><div class="line" data-line="5"><span style="color: #e5c07b;">bind</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">3,</span> <span style="color: #e06c75;">&lbrace;</span><span style="color: #e06c75;">sa_family=AF_INET,</span> <span style="color: #e06c75;">sin_port=htons</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">3000</span><span style="color: #c678dd;">)</span>, sin_addr=inet_addr<span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;0.0.0.0&quot;</span><span style="color: #c678dd;">)</span>&rbrace;, <span style="color: #d19a66;">16</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="6"><span style="color: #e5c07b;">exit</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">0</span><span style="color: #c678dd;">)</span>                                 <span style="color: #56b6c2;">=</span> ?
</div><div class="line" data-line="7">+++ <span style="color: #61afef;">exited</span> <span style="color: #e06c75;">with</span> <span style="color: #d19a66;">0</span> <span style="color: #e06c75;">+++</span>
</div></code></pre>
<p><em>Superb!</em> Podemos ver que a syscall <em>bind</em> foi executada com os par√¢metros corretamente, inclusive o <code>htons(3000)</code>, ent√£o retornando <em>0</em>, que indica que n√£o houve qualquer erro.</p>
<h3><a href="#preparando-para-receber-conex√µes" aria-hidden="true" class="anchor" id="preparando-para-receber-conex√µes"></a>Preparando para receber conex√µes</h3>
<p>Pr√≥ximo passo consiste em preparar o socket para receber conex√µes, que basicamente √© chamar a fun√ß√£o <code>listen</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">%define SYS_listen 50
</div><div class="line" data-line="2">%define BACKLOG 2
</div><div class="line" data-line="3">
</div><div class="line" data-line="4">.listen:
</div><div class="line" data-line="5">	; int listen(int sockfd, int backlog)
</div><div class="line" data-line="6">	mov rdi, [sockfd]
</div><div class="line" data-line="7">	mov rsi, BACKLOG
</div><div class="line" data-line="8">	mov rax, SYS_listen
</div><div class="line" data-line="9">	syscall
</div></code></pre>
<p>Onde <em>BACKLOG</em> significa a quantidade de conex√µes ‚Äúpendentes‚Äù no socket. Executamos com <em>strace</em> e:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">strace</span> <span style="color: #e06c75;">./live</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #61afef;">execve</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;./live&quot;</span><span style="color: #98c379;">,</span> <span style="color: #e06c75;">[</span><span style="color: #98c379;">&quot;./live&quot;</span><span style="color: #e06c75;">]</span><span style="color: #e06c75;">,</span> <span style="color: #e06c75;">0x7ffe6b4eea30</span> <span style="color: #e06c75;">/*</span> <span style="color: #d19a66;">24</span> <span style="color: #e06c75;">vars</span> <span style="color: #e06c75;">*/</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="4"><span style="color: #61afef;">socket</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">AF_INET,</span> <span style="color: #e06c75;">SOCK_STREAM,</span> <span style="color: #e06c75;">IPPROTO_IP</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">3</span>
</div><div class="line" data-line="5"><span style="color: #e5c07b;">bind</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">3,</span> <span style="color: #e06c75;">&lbrace;</span><span style="color: #e06c75;">sa_family=AF_INET,</span> <span style="color: #e06c75;">sin_port=htons</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">3000</span><span style="color: #c678dd;">)</span>, sin_addr=inet_addr<span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;0.0.0.0&quot;</span><span style="color: #c678dd;">)</span>&rbrace;, <span style="color: #d19a66;">16</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="6"><span style="color: #61afef;">listen</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">3,</span> <span style="color: #d19a66;">2</span><span style="color: #c678dd;">)</span>                            <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="7"><span style="color: #e5c07b;">exit</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">0</span><span style="color: #c678dd;">)</span>                                 <span style="color: #56b6c2;">=</span> ?
</div><div class="line" data-line="8">+++ <span style="color: #61afef;">exited</span> <span style="color: #e06c75;">with</span> <span style="color: #d19a66;">0</span> <span style="color: #e06c75;">+++</span>
</div></code></pre>
<p><em>Que noite maravilhosa!</em> Listen funcionou lindamente, afinal, √© uma fun√ß√£o muito simples. Agora, hora de aceitar conex√µes de clientes no socket.</p>
<h3><a href="#chegou-o-momento-de-aceitar-clientes" aria-hidden="true" class="anchor" id="chegou-o-momento-de-aceitar-clientes"></a>Chegou o momento de aceitar clientes</h3>
<p>O grande momento chegou. Vamos montar as instru√ß√µes da syscall <em>accept</em>, que de acordo com a fun√ß√£o em libc, recebe um socket como primeiro argumento e os demais s√£o opcionais.</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">%define SYS_accept 288
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">.accept:
</div><div class="line" data-line="4">	; int accept(int sockfd, struct *addr, int addrlen, int flags)
</div><div class="line" data-line="5">	mov rdi, [sockfd]
</div><div class="line" data-line="6">	mov rsi, 0              ; n√£o precisa estabelecer um addr
</div><div class="line" data-line="7">	mov rdx, 0              ; n√£o precisa do tamanho uma vez que n√£o h√° addr
</div><div class="line" data-line="8">	mov r10, 0
</div><div class="line" data-line="9">	mov rax, SYS_accept
</div><div class="line" data-line="10">	syscall
</div></code></pre>
<p>Se executarmos com GDB, podemos ver que o resultado da syscall fica bloqueado at√© que uma conex√£o seja feita:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># Breakpoint na syscall de socket</span>
</div><div class="line" data-line="2"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #e5c07b;">break</span> <span style="color: #d19a66;">55</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">run</span>
</div><div class="line" data-line="5"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">next</span>
</div></code></pre>
<p>O programa est√° parado na syscall de socket, aguardando resposta do <strong>kernel</strong>. Para que o kernel responda e o programa continue a execu√ß√£o, √© preciso realizar um pedido usando um HTTP client, e neste caso vamos usar o <em>curl</em>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">curl</span> <span style="color: #e06c75;">localhost:3000</span>
</div></code></pre>
<p>Repare que o programa continuou a execu√ß√£o. Vamos ver a resposta que est√° em RAX:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">i</span> <span style="color: #e06c75;">r</span> <span style="color: #e06c75;">rax</span>
</div><div class="line" data-line="2"><span style="color: #61afef;">rax</span>            <span style="color: #d19a66;">0x4</span>                 <span style="color: #d19a66;">4</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #7f848e;"># Um n√∫mero diferente do sockfd, que √© o socket criado pelo server</span>
</div><div class="line" data-line="5"><span style="color: #c678dd;">(</span><span style="color: #61afef;">gdb</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">x</span> <span style="color: #abb2bf;">&amp;</span><span style="color: #61afef;">sockfd</span>
</div><div class="line" data-line="6"><span style="color: #d19a66;">0x402010</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">sockfd</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>      <span style="color: #d19a66;">0x00000003</span>
</div><div class="line" data-line="7">
</div></code></pre>
<p>Podemos ver que √© um n√∫mero diferente (RAX cont√©m 4 e sockfd cont√©m 3). De acordo com a documenta√ß√£o, este √© o n√∫mero do descritor que representa um novo socket criado para comunica√ß√£o entre <em>um cliente espec√≠fico e o servidor</em>.</p>
<p>Vamos mover o valor de RAX para R8, apenas para preservar o socket, uma vez que RAX ser√° usado novamente por outras syscalls de accept:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">mov r8, rax             ; client socket
</div></code></pre>
<h3><a href="#resposta-do-servidor-e-fechamento-da-conex√£o" aria-hidden="true" class="anchor" id="resposta-do-servidor-e-fechamento-da-conex√£o"></a>Resposta do servidor e fechamento da conex√£o</h3>
<p>Uma outra coisa importante a se fazer √© <strong>fechar a conex√£o</strong> com este socket do cliente depois de ter processado e respondido a requisi√ß√£o.</p>
<p>Vamos implementar a subrotina <code>.write</code>, que escreve a resposta na conex√£o (socket) do cliente:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">%define SYS_write 1
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">%define CR 0xD
</div><div class="line" data-line="4">%define LF 0xA
</div><div class="line" data-line="5">
</div><div class="line" data-line="6">section .data
</div><div class="line" data-line="7">response: 
</div><div class="line" data-line="8">	headline: db &quot;HTTP/1.1 200 OK&quot;, CR, LF
</div><div class="line" data-line="9">	content_type: db &quot;Content-Type: text/html&quot;, CR, LF
</div><div class="line" data-line="10">	content_length: db &quot;Content-Length: 22&quot;, CR, LF
</div><div class="line" data-line="11">	crlf: db CR, LF
</div><div class="line" data-line="12">	body: db &quot;&lt;h1&gt;Hello, World!&lt;/h1&gt;&quot;
</div><div class="line" data-line="13">responseLen: equ $ - response
</div><div class="line" data-line="14">
</div><div class="line" data-line="15">section .text
</div><div class="line" data-line="16">...
</div><div class="line" data-line="17">.write:
</div><div class="line" data-line="18">	; int write(int fd, buffer *bf, int bfLen)
</div><div class="line" data-line="19">	mov rdi, r8
</div><div class="line" data-line="20">	mov rsi, response
</div><div class="line" data-line="21">	mov rdx, responseLen
</div><div class="line" data-line="22">	mov rax, SYS_write
</div><div class="line" data-line="23">	syscall
</div><div class="line" data-line="24">	ret
</div></code></pre>
<p>No exemplo acima, assumimos que a string de resposta HTTP aponta para uma estrutura na mem√≥ria, definida em <code>.data</code>.</p>
<blockquote>
<p>Aten√ß√£o para CR (carriage return), LF (line feed) que s√£o constantes que representam <code>\r\n </code> que s√£o separadores de linhas definidos pelo protocolo HTTP</p>
</blockquote>
<p>Agora, definir a subrotina <code>.close</code>, que fecha a conex√£o com o cliente:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">%define SYS_close 3
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">section .text
</div><div class="line" data-line="4">...
</div><div class="line" data-line="5">.close:
</div><div class="line" data-line="6">	; int close(int fd)
</div><div class="line" data-line="7">	mov rdi, r8
</div><div class="line" data-line="8">	mov rax, SYS_close
</div><div class="line" data-line="9">	syscall
</div><div class="line" data-line="10">	ret
</div></code></pre>
<p>Ligando tudo no <em>accept</em>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">section .text
</div><div class="line" data-line="2">....
</div><div class="line" data-line="3">.accept:
</div><div class="line" data-line="4">	; int accept(int sockfd, struct *addr, int addrlen, int flags)
</div><div class="line" data-line="5">	mov rdi, [sockfd]
</div><div class="line" data-line="6">	mov rsi, 0              ; n√£o precisa estabelecer um addr
</div><div class="line" data-line="7">	mov rdx, 0              ; n√£o precisa do tamanho uma vez que n√£o h√° addr
</div><div class="line" data-line="8">	mov r10, 0
</div><div class="line" data-line="9">	mov rax, SYS_accept
</div><div class="line" data-line="10">	syscall
</div><div class="line" data-line="11">	mov r8, rax             ; client socket
</div><div class="line" data-line="12">	call .write             ; escreve no socket
</div><div class="line" data-line="13">	call .close             ; fecha o socket
</div><div class="line" data-line="14">	jmp .exit               ; termina o programa
</div></code></pre>
<p>E agora, vamos executar o programa com <em>strace</em>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">strace</span> <span style="color: #e06c75;">./live</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #61afef;">execve</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;./live&quot;</span><span style="color: #98c379;">,</span> <span style="color: #e06c75;">[</span><span style="color: #98c379;">&quot;./live&quot;</span><span style="color: #e06c75;">]</span><span style="color: #e06c75;">,</span> <span style="color: #e06c75;">0x7ffd811567c0</span> <span style="color: #e06c75;">/*</span> <span style="color: #d19a66;">24</span> <span style="color: #e06c75;">vars</span> <span style="color: #e06c75;">*/</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="4"><span style="color: #61afef;">socket</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">AF_INET,</span> <span style="color: #e06c75;">SOCK_STREAM,</span> <span style="color: #e06c75;">IPPROTO_IP</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">3</span>
</div><div class="line" data-line="5"><span style="color: #e5c07b;">bind</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">3,</span> <span style="color: #e06c75;">&lbrace;</span><span style="color: #e06c75;">sa_family=AF_INET,</span> <span style="color: #e06c75;">sin_port=htons</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">3000</span><span style="color: #c678dd;">)</span>, sin_addr=inet_addr<span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;0.0.0.0&quot;</span><span style="color: #c678dd;">)</span>&rbrace;, <span style="color: #d19a66;">16</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="6"><span style="color: #61afef;">listen</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">3,</span> <span style="color: #d19a66;">2</span><span style="color: #c678dd;">)</span>                            <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="7"><span style="color: #61afef;">accept4</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">3,</span> <span style="color: #e06c75;">NULL,</span> <span style="color: #e06c75;">NULL,</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="8"><span style="color: #c678dd;"></span>
</div></code></pre>
<ul>
<li>primeiro foi feita a syscall <em>socket</em></li>
<li>a seguir foi feito o <em>bind</em></li>
<li>depois o <em>listen</em></li>
<li>e por fim, o <em>accept</em> ficou bloqueado a espera de uma requisi√ß√£o</li>
</ul>
<p>Em outra janela, vamos fazer a requisi√ß√£o:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">curl</span> <span style="color: #e06c75;">localhost:3000</span>
</div><div class="line" data-line="2"><span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">h1</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">Hello,</span> <span style="color: #61afef;">World!</span><span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">/h1</span><span style="color: #56b6c2;">&gt;</span>
</div></code></pre>
<p>E no servidor, a sa√≠da do strace no final ficou assim:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #61afef;">write</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">4,</span> <span style="color: #98c379;">&quot;HTTP/1.1 200 OK\r\nContent-Type: t&quot;</span><span style="color: #e06c75;">...,</span> <span style="color: #d19a66;">86</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">86</span>
</div><div class="line" data-line="2"><span style="color: #61afef;">close</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">4</span><span style="color: #c678dd;">)</span>                                <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="3"><span style="color: #e5c07b;">exit</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">0</span><span style="color: #c678dd;">)</span>                                 <span style="color: #56b6c2;">=</span> ?
</div><div class="line" data-line="4">+++ <span style="color: #61afef;">exited</span> <span style="color: #e06c75;">with</span> <span style="color: #d19a66;">0</span> <span style="color: #e06c75;">+++</span>
</div></code></pre>
<p>Escreveu a resposta com <code>write</code>, fechou a conex√£o com <code>close</code>, e depois terminou o programa com <code>exit</code>.</p>
<p><em>Como n√£o ficar feliz?</em></p>
<h3><a href="#mas-o-servidor-deve-ficar-em-loop-n√£o" aria-hidden="true" class="anchor" id="mas-o-servidor-deve-ficar-em-loop-n√£o"></a>Mas o servidor deve ficar em loop, n√£o?</h3>
<p>Sim, o servidor deve ficar em loop, portanto ao inv√©s de fazer o <code>jmp .exit</code>, fazemos <code>jmp .accept</code> na √∫ltima linha da procedure:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">...
</div><div class="line" data-line="2">.accept:
</div><div class="line" data-line="3">	; int accept(int sockfd, struct *addr, int addrlen, int flags)
</div><div class="line" data-line="4">	mov rdi, [sockfd]
</div><div class="line" data-line="5">	mov rsi, 0              ; n√£o precisa estabelecer um addr
</div><div class="line" data-line="6">	mov rdx, 0              ; n√£o precisa do tamanho uma vez que n√£o h√° addr
</div><div class="line" data-line="7">	mov r10, 0
</div><div class="line" data-line="8">	mov rax, SYS_accept
</div><div class="line" data-line="9">	syscall
</div><div class="line" data-line="10">	mov r8, rax             ; client socket
</div><div class="line" data-line="11">	call .write
</div><div class="line" data-line="12">	call .close
</div><div class="line" data-line="13">	jmp .accept             ; &lt;-- MUDAN√áA AQUI, mant√©m o server em loop infinito
</div></code></pre>
<p>Assim, o server nunca termina, e quando uma conex√£o com um cliente √© fechada, voltamos no in√≠cio do loop e ficamos a espera de nova conex√£o na syscall <em>accept</em>.</p>
<p>C√≥digo final do server:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">global _start
</div><div class="line" data-line="2">
</div><div class="line" data-line="3">%define SYS_socket 41
</div><div class="line" data-line="4">%define SYS_bind 49
</div><div class="line" data-line="5">%define SYS_listen 50
</div><div class="line" data-line="6">%define SYS_accept 288
</div><div class="line" data-line="7">%define SYS_write 1
</div><div class="line" data-line="8">%define SYS_close 3
</div><div class="line" data-line="9">
</div><div class="line" data-line="10">%define AF_INET 2
</div><div class="line" data-line="11">%define SOCK_STREAM 1
</div><div class="line" data-line="12">%define SOCK_PROTOCOL 0
</div><div class="line" data-line="13">%define BACKLOG 2
</div><div class="line" data-line="14">%define CR 0xD
</div><div class="line" data-line="15">%define LF 0xA
</div><div class="line" data-line="16">
</div><div class="line" data-line="17">; Data types in asm
</div><div class="line" data-line="18">; byte =&gt; 1 byte
</div><div class="line" data-line="19">; word =&gt; 2 bytes
</div><div class="line" data-line="20">; doubleword =&gt; 4 bytes
</div><div class="line" data-line="21">; quadword =&gt; 8 bytes
</div><div class="line" data-line="22">
</div><div class="line" data-line="23">section .data
</div><div class="line" data-line="24">sockaddr: 
</div><div class="line" data-line="25">	family: dw AF_INET   ; 2 bytes
</div><div class="line" data-line="26">	port: dw 0xB80B      ; 2 bytes (47115 big endian becomes 3000 little endian)
</div><div class="line" data-line="27">	ip_address: dd 0     ; 4 bytes
</div><div class="line" data-line="28">	sin_zero: dq 0       ; 8 bytes
</div><div class="line" data-line="29">sockaddrLen: equ $ - sockaddr
</div><div class="line" data-line="30">response: 
</div><div class="line" data-line="31">	headline: db &quot;HTTP/1.1 200 OK&quot;, CR, LF
</div><div class="line" data-line="32">	content_type: db &quot;Content-Type: text/html&quot;, CR, LF
</div><div class="line" data-line="33">	content_length: db &quot;Content-Length: 22&quot;, CR, LF
</div><div class="line" data-line="34">	crlf: db CR, LF
</div><div class="line" data-line="35">	body: db &quot;&lt;h1&gt;Hello, World!&lt;/h1&gt;&quot;
</div><div class="line" data-line="36">responseLen: equ $ - response
</div><div class="line" data-line="37">
</div><div class="line" data-line="38">section .bss
</div><div class="line" data-line="39">sockfd: resb 1
</div><div class="line" data-line="40">
</div><div class="line" data-line="41">section .text
</div><div class="line" data-line="42">_start:
</div><div class="line" data-line="43">.socket:
</div><div class="line" data-line="44">	; int socket(int domain, int type, int protocol)
</div><div class="line" data-line="45">	mov rdi, AF_INET
</div><div class="line" data-line="46">	mov rsi, SOCK_STREAM
</div><div class="line" data-line="47">	mov rdx, SOCK_PROTOCOL
</div><div class="line" data-line="48">	mov rax, SYS_socket
</div><div class="line" data-line="49">	syscall
</div><div class="line" data-line="50">	mov [sockfd], rax 
</div><div class="line" data-line="51">.bind:
</div><div class="line" data-line="52">	; int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen)
</div><div class="line" data-line="53">	mov rdi, [sockfd]
</div><div class="line" data-line="54">	mov rsi, sockaddr
</div><div class="line" data-line="55">	mov rdx, sockaddrLen
</div><div class="line" data-line="56">	mov rax, SYS_bind
</div><div class="line" data-line="57">	syscall
</div><div class="line" data-line="58">.listen:
</div><div class="line" data-line="59">	; int listen(int sockfd, int backlog)
</div><div class="line" data-line="60">	mov rdi, [sockfd]
</div><div class="line" data-line="61">	mov rsi, BACKLOG
</div><div class="line" data-line="62">	mov rax, SYS_listen
</div><div class="line" data-line="63">	syscall
</div><div class="line" data-line="64">.accept:
</div><div class="line" data-line="65">	; int accept(int sockfd, struct *addr, int addrlen, int flags)
</div><div class="line" data-line="66">	mov rdi, [sockfd]
</div><div class="line" data-line="67">	mov rsi, 0              ; n√£o precisa estabelecer um addr
</div><div class="line" data-line="68">	mov rdx, 0              ; n√£o precisa do tamanho uma vez que n√£o h√° addr
</div><div class="line" data-line="69">	mov r10, 0
</div><div class="line" data-line="70">	mov rax, SYS_accept
</div><div class="line" data-line="71">	syscall
</div><div class="line" data-line="72">	mov r8, rax             ; client socket
</div><div class="line" data-line="73">	call .write
</div><div class="line" data-line="74">	call .close
</div><div class="line" data-line="75">	jmp .accept
</div><div class="line" data-line="76">.write:
</div><div class="line" data-line="77">	; int write(int fd, buffer *bf, int bfLen)
</div><div class="line" data-line="78">	mov rdi, r8
</div><div class="line" data-line="79">	mov rsi, response
</div><div class="line" data-line="80">	mov rdx, responseLen
</div><div class="line" data-line="81">	mov rax, SYS_write
</div><div class="line" data-line="82">	syscall
</div><div class="line" data-line="83">	ret
</div><div class="line" data-line="84">.close:
</div><div class="line" data-line="85">	; int close(int fd)
</div><div class="line" data-line="86">	mov rdi, r8
</div><div class="line" data-line="87">	mov rax, SYS_close
</div><div class="line" data-line="88">	syscall
</div><div class="line" data-line="89">	ret
</div></code></pre>
<p>Executando tudo com <em>strace</em> e temos:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">strace</span> <span style="color: #e06c75;">./live</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #61afef;">execve</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;./live&quot;</span><span style="color: #98c379;">,</span> <span style="color: #e06c75;">[</span><span style="color: #98c379;">&quot;./live&quot;</span><span style="color: #e06c75;">]</span><span style="color: #e06c75;">,</span> <span style="color: #e06c75;">0x7fff9fde7840</span> <span style="color: #e06c75;">/*</span> <span style="color: #d19a66;">24</span> <span style="color: #e06c75;">vars</span> <span style="color: #e06c75;">*/</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="4"><span style="color: #61afef;">socket</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">AF_INET,</span> <span style="color: #e06c75;">SOCK_STREAM,</span> <span style="color: #e06c75;">IPPROTO_IP</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">3</span>
</div><div class="line" data-line="5"><span style="color: #e5c07b;">bind</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">3,</span> <span style="color: #e06c75;">&lbrace;</span><span style="color: #e06c75;">sa_family=AF_INET,</span> <span style="color: #e06c75;">sin_port=htons</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">3000</span><span style="color: #c678dd;">)</span>, sin_addr=inet_addr<span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;0.0.0.0&quot;</span><span style="color: #c678dd;">)</span>&rbrace;, <span style="color: #d19a66;">16</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="6"><span style="color: #61afef;">listen</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">3,</span> <span style="color: #d19a66;">2</span><span style="color: #c678dd;">)</span>                            <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="7"><span style="color: #61afef;">accept4</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">3,</span> <span style="color: #e06c75;">NULL,</span> <span style="color: #e06c75;">NULL,</span> <span style="color: #d19a66;">0</span><span style="color: #c678dd;">)</span>               <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">4</span>
</div><div class="line" data-line="8"><span style="color: #61afef;">write</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">4,</span> <span style="color: #98c379;">&quot;HTTP/1.1 200 OK\r\nContent-Type: t&quot;</span><span style="color: #e06c75;">...,</span> <span style="color: #d19a66;">86</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">86</span>
</div><div class="line" data-line="9"><span style="color: #61afef;">close</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">4</span><span style="color: #c678dd;">)</span>                                <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="10"><span style="color: #61afef;">accept4</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">3,</span> <span style="color: #e06c75;">NULL,</span> <span style="color: #e06c75;">NULL,</span> <span style="color: #d19a66;">0</span><span style="color: #c678dd;">)</span>               <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">4</span>
</div><div class="line" data-line="11"><span style="color: #61afef;">write</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">4,</span> <span style="color: #98c379;">&quot;HTTP/1.1 200 OK\r\nContent-Type: t&quot;</span><span style="color: #e06c75;">...,</span> <span style="color: #d19a66;">86</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">86</span>
</div><div class="line" data-line="12"><span style="color: #61afef;">close</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">4</span><span style="color: #c678dd;">)</span>                                <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="13"><span style="color: #61afef;">accept4</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">3,</span> <span style="color: #e06c75;">NULL,</span> <span style="color: #e06c75;">NULL,</span> <span style="color: #d19a66;">0</span><span style="color: #c678dd;">)</span>               <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">4</span>
</div><div class="line" data-line="14"><span style="color: #61afef;">write</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">4,</span> <span style="color: #98c379;">&quot;HTTP/1.1 200 OK\r\nContent-Type: t&quot;</span><span style="color: #e06c75;">...,</span> <span style="color: #d19a66;">86</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">86</span>
</div><div class="line" data-line="15"><span style="color: #61afef;">close</span><span style="color: #c678dd;">(</span><span style="color: #d19a66;">4</span><span style="color: #c678dd;">)</span>                                <span style="color: #56b6c2;">=</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="16"><span style="color: #61afef;">accept4</span><span style="color: #c678dd;">(</span><span style="color: #61afef;">3,</span> <span style="color: #e06c75;">NULL,</span> <span style="color: #e06c75;">NULL,</span> <span style="color: #d19a66;">0</span>
</div><div class="line" data-line="17"><span style="color: #c678dd;"></span>
</div></code></pre>
<p>No lado do cliente:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">curl</span> <span style="color: #e06c75;">localhost:3000</span>
</div><div class="line" data-line="2"><span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">h1</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">Hello,</span> <span style="color: #61afef;">World!</span><span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">/h1</span><span style="color: #56b6c2;">&gt;</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">curl</span> <span style="color: #61afef;">localhost:3000</span>
</div><div class="line" data-line="5"><span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">h1</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">Hello,</span> <span style="color: #61afef;">World!</span><span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">/h1</span><span style="color: #56b6c2;">&gt;</span>
</div><div class="line" data-line="6">
</div><div class="line" data-line="7"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">curl</span> <span style="color: #61afef;">localhost:3000</span>
</div><div class="line" data-line="8"><span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">h1</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">Hello,</span> <span style="color: #61afef;">World!</span><span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">/h1</span><span style="color: #56b6c2;">&gt;</span>
</div></code></pre>
<h3><a href="#com-voc√™s-o-web-browser" aria-hidden="true" class="anchor" id="com-voc√™s-o-web-browser"></a>Com voc√™s, o web browser</h3>
<p>Esta saga n√£o teria nenhuma gra√ßa se n√£o fosse pra ser executada em um <em>web browser</em>, afinal estamos falando de um <strong>web server</strong>, n√£o?</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/qm4v5vqi8jw5578sajjy.png" alt="final hello world" /></p>
<hr />
<h2><a href="#conclus√£o" aria-hidden="true" class="anchor" id="conclus√£o"></a>Conclus√£o</h2>
<p>Incrivelmente chegamos no final da constru√ß√£o de um modesto web server. Aqui aprendemos conceitos sobre sockets, TCP e HTTP, com uma pitada leve de HTML.</p>
<blockquote>
<p>Fala a√≠, quem n√£o j√° conhecia a tag H1 do HTML? kk</p>
</blockquote>
<p>Para al√©m de termos visto sobre as syscalls de rede <em>socket, bind, listen e accept</em> em Assembly.</p>
<p>Ainda n√£o chegamos ao fim da saga, pelo que no pr√≥ximo artigo iremos abordar a cria√ß√£o de <strong>threads</strong> e aprender sobre aloca√ß√£o din√¢mica de mem√≥ria para as threads.</p>
<p>Stay tuned!</p>
<p><em>Agradecimentos a <a href="https://x.com/rodrigogbranco">Rodrigo Gon√ßalves de Branco</a> por ter revisado este artigo com o devido rigor</em></p>
<hr />
<h2><a href="#refer√™ncias" aria-hidden="true" class="anchor" id="refer√™ncias"></a>Refer√™ncias</h2>
<sub>
Building a web server in Bash
https://leandronsp.com/articles/tekton-ci-part-i-a-gentle-introduction-ilj
OSI Model
https://en.wikipedia.org/wiki/OSI_model
TCP
https://en.wikipedia.org/wiki/Transmission_Control_Protocol
Berkeley Sockets
https://en.wikipedia.org/wiki/Berkeley_sockets
HTTP
https://en.wikipedia.org/wiki/HTTP
struct sockaddr_in
https://www.gta.ufrj.br/ensino/eel878/sockets/sockaddr_inman.html
</sub>
      </div>

      <!-- Back to top -->
      <div class="mt-12 mb-8 text-center">
        <a href="#" onclick="event.preventDefault(); window.scrollTo({ top: 0, behavior: 'smooth' });" class="inline-flex items-center gap-2 text-xl font-medium transition-colors text-base-content/70 hover:text-primary cursor-pointer">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
          </svg>
          Back to top
        </a>
      </div>
    </article>

    <!-- Giscus Comments -->
    <div class="mt-16">
      <div class="border-t border-base-300 pt-8">
        <h2 class="text-2xl font-bold mb-6">Comments</h2>
        <script src="https://giscus.app/client.js"
                data-repo="leandronsp/leandronsp.com"
                data-repo-id="R_kgDOQGG-eQ"
                data-category="Announcements"
                data-category-id="DIC_kwDOQGG-ec4Cw4TN"
                data-mapping="pathname"
                data-strict="0"
                data-reactions-enabled="1"
                data-emit-metadata="0"
                data-input-position="bottom"
                data-theme="preferred_color_scheme"
                data-lang="en"
                crossorigin="anonymous"
                async>
        </script>
      </div>
    </div>

    <!-- Footer -->
    <footer class="mt-16 pt-8 pb-6 border-t border-base-300">
      <div class="text-center text-sm text-base-content/80">
        <p>
          Powered by
          <a
            href="https://github.com/leandronsp/curupira"
            target="_blank"
            rel="noopener noreferrer"
            class="font-semibold text-blue-600 hover:underline"
          >
            Curupira
          </a>
          | Open source blog platform built with Phoenix LiveView
        </p>
        <p class="mt-2 text-xs text-base-content/70">
          Licensed under
          <a
            href="https://github.com/leandronsp/curupira/blob/master/LICENSE"
            target="_blank"
            rel="noopener noreferrer"
            class="text-blue-600 hover:underline"
          >
            AGPL-3.0
          </a>
        </p>
      </div>
    </footer>
  </main>

  <script src="/static-theme.js" defer></script>
  <script src="/static-filters.js" defer></script>
  <script src="/static-search.js" defer></script>
  <script src="/static-giscus.js" defer></script>

  <!-- Lazy load Google Analytics after page is interactive -->
  <script>
    (function() {
      function loadGTM() {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-0Y5RNLZMKN');

        var script = document.createElement('script');
        script.async = true;
        script.src = 'https://www.googletagmanager.com/gtag/js?id=G-0Y5RNLZMKN';
        document.head.appendChild(script);
      }

      // Load after page is idle, or after 2 seconds as fallback
      if ('requestIdleCallback' in window) {
        requestIdleCallback(loadGTM, { timeout: 2000 });
      } else {
        setTimeout(loadGTM, 2000);
      }
    })();
  </script>
</body>
</html>
