<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compiladores, trampolim, deque e thread pool - Leandro Proen√ßa</title>
  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">

  <!-- SEO Meta Tags -->
  <meta name="description" content="Faz alguns dias que n√£o escrevo. Minha rotina mudou um pouco e tamb√©m tenho focado em estudar algumas coisas que eu n√£o tinha tanto dom√≠nio. Entretanto tenho alg">
  <meta name="author" content="Leandro Proen√ßa">
  <link rel="canonical" href="https://leandronsp.com/articles/compiladores-trampolim-deque-e-thread-pool-dd1.html">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://leandronsp.com/articles/compiladores-trampolim-deque-e-thread-pool-dd1.html">
  <meta property="og:title" content="Compiladores, trampolim, deque e thread pool">
  <meta property="og:description" content="Faz alguns dias que n√£o escrevo. Minha rotina mudou um pouco e tamb√©m tenho focado em estudar algumas coisas que eu n√£o tinha tanto dom√≠nio. Entretanto tenho alg">
  <meta property="og:site_name" content="Leandro Proen√ßa">
  <meta property="article:published_time" content="2023-10-17T06:08:01Z">
  <meta property="article:tag" content="ruby">
      <meta property="article:tag" content="webdev">

  <!-- JSON-LD Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "Compiladores, trampolim, deque e thread pool",
    "datePublished": "2023-10-17T06:08:01Z",
    "author": {
      "@type": "Person",
      "name": "Leandro Proen√ßa"
    },
    "description": "Faz alguns dias que n√£o escrevo. Minha rotina mudou um pouco e tamb√©m tenho focado em estudar algumas coisas que eu n√£o tinha tanto dom√≠nio. Entretanto tenho alg",
        "keywords": "ruby, webdev"
  }
  </script>

  <link rel="preload" href="/assets/css/app.cf141171.css" as="style">
  <script>
    // Prevent FOUC (Flash of Unstyled Content) by setting theme before CSS loads
    (function() {
      const theme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <link rel="stylesheet" href="/assets/css/app.cf141171.css">
  <style>
    /* Force scrollbar to always be visible to prevent layout shift */
    html {
      overflow-y: scroll;
    }

    /* Softer dark theme colors */
    [data-theme="dark"] {
      --base-100: #2a2f3a;
      --base-200: #232831;
      --base-300: #1e222a;
      --base-content: #e8eaed;
    }
    [data-theme="dark"] .article-card {
      background-color: transparent;
    }
    /* Keep pinned article with background for prominence in dark theme - lighter pastel */
    [data-theme="dark"] .pinned-article {
      background-color: #3a4050 !important;
    }
    [data-theme="dark"] .prose {
      color: #e8eaed;
    }
    [data-theme="dark"] .prose h1,
    [data-theme="dark"] .prose h2,
    [data-theme="dark"] .prose h3,
    [data-theme="dark"] .prose h4 {
      color: #f0f2f5;
    }
    [data-theme="dark"] .prose a {
      color: #8fb4ff;
    }
    [data-theme="dark"] .prose code {
      background-color: #3d4454;
      color: #f0f2f5;
    }
    [data-theme="dark"] .prose pre {
      background-color: #1e222a;
      border: 1px solid #3d4454;
    }
    [data-theme="dark"] input {
      background-color: #2f3542;
      border-color: #3d4454;
      color: #e8eaed;
    }
    [data-theme="dark"] input::placeholder {
      color: #9ca3af;
    }
    /* Language switcher dark theme styling */
    [data-theme="dark"] .lang-switcher-bg {
      background-color: rgba(59, 130, 246, 0.15) !important;
      border-color: rgba(59, 130, 246, 0.3) !important;
    }
    /* Blog name styling - system font first, Google Font loads async */
    .blog-name {
      font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    /* Intro text styling - system font first, Google Font loads async */
    .intro-text {
      font-family: 'Caveat', 'Bradley Hand', 'Comic Sans MS', cursive;
      font-weight: 600;
      color: #6b7280; /* Darker pastel gray for light theme */
    }
    [data-theme="dark"] .intro-text {
      color: #d4d4d8; /* Lighter pastel gray for dark theme */
    }
    /* Article card styling */
    article {
      background-color: transparent;
      border: none;
      border-radius: 0.5rem;
      padding: 2rem;
    }
    [data-theme="dark"] article {
      background-color: transparent;
    }
    /* Article images styling - consistent sizing */
    .prose img {
      max-width: 800px;
      width: 100%;
      height: auto;
      display: block;
      margin-left: auto;
      margin-right: auto;
      border-radius: 0.5rem;
    }
  </style>
</head>
<body class="min-h-screen bg-base-100">
  <!-- Fixed Header - Article page: focus on reading -->
  <header class="sticky top-0 z-50 bg-base-100 border-b border-base-300 shadow-sm">
    <div class="container mx-auto px-4 sm:px-6 py-4 max-w-6xl">
      <!-- Same structure as homepage, no search/language/tags -->
      <div class="flex flex-col gap-2">
        <!-- Name + Social Icons + Guide Links (icons hidden on small) -->
        <div class="flex items-center gap-3">
          <a href="/" class="blog-name text-2xl sm:text-3xl font-bold text-base-content flex-shrink-0 no-underline cursor-pointer hover:opacity-80 transition-opacity">Leandro Proen√ßa</a>
          <div class="hidden md:flex items-center gap-2">
            <a href="https://linkedin.com/in/leandronsp" target="_blank" rel="noopener noreferrer" class="text-base-content/60 hover:text-primary transition-colors" title="LinkedIn">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
            </a>
            <a href="https://github.com/leandronsp" target="_blank" rel="noopener noreferrer" class="text-base-content/60 hover:text-primary transition-colors" title="GitHub">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"/></svg>
            </a>
            <button id="theme-toggle" class="text-base-content/60 hover:text-primary transition-colors" title="Toggle theme">
              <svg xmlns="http://www.w3.org/2000/svg" class="sun-icon h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
              <svg xmlns="http://www.w3.org/2000/svg" class="moon-icon h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>
          </div>
          <!-- Guide Links (medium and up) -->
          <div class="hidden md:flex items-center gap-3 ml-4">
            <a href="https://concorrencia101.leandronsp.com" target="_blank" rel="noopener noreferrer" class="flex items-center gap-1 text-sm font-medium text-base-content/70 hover:text-primary transition-colors" title="Concorr√™ncia 101">
              <span>Concorr√™ncia 101</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </a>
            <a href="https://web101.leandronsp.com" target="_blank" rel="noopener noreferrer" class="flex items-center gap-1 text-sm font-medium text-base-content/70 hover:text-primary transition-colors" title="Web 101">
              <span>Web 101</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </a>
            <a href="https://aws101.leandronsp.com" target="_blank" rel="noopener noreferrer" class="flex items-center gap-1 text-sm font-medium text-base-content/70 hover:text-primary transition-colors" title="AWS 101">
              <span>AWS 101</span>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </a>
          </div>
        </div>

        <!-- Bio -->
        <p class="intro-text text-xl sm:text-2xl leading-tight">
          Software Developer 15+ years working for companies worldwide
        </p>
      </div>

    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto max-w-6xl">
    <article class="bg-base-100">
      <!-- Back link -->
      <a href="/" onclick="event.preventDefault(); history.back();" class="inline-flex items-center gap-2 text-lg font-medium transition-colors text-base-content/70 hover:text-primary cursor-pointer mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back
      </a>

      <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold leading-tight mb-6">Compiladores, trampolim, deque e thread pool</h1>

      <div class="flex flex-wrap items-center gap-3 mb-8 text-base text-base-content/85">
        <div class="flex items-center gap-1.5">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
          <span>Published 17 Oct 2023</span>
        </div>

        <div class="flex items-center gap-1.5">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
  </svg>
  <div class="flex gap-2 flex-wrap">
    <span class="inline-flex items-center px-3 py-1 text-sm border border-base-content/25 rounded-full">ruby</span><span class="inline-flex items-center px-3 py-1 text-sm border border-base-content/25 rounded-full">webdev</span>
  </div>
</div>

      </div>

      <div class="prose prose-lg max-w-none">
        <p>Faz alguns dias que n√£o escrevo. Minha rotina mudou um pouco e tamb√©m tenho focado em estudar algumas coisas que eu n√£o tinha tanto dom√≠nio. Entretanto tenho algumas coisas pra compartilhar.</p>
<p>Vamos a isso.</p>
<hr />
<h2><a href="#rinha-de-compiladores" aria-hidden="true" class="anchor" id="rinha-de-compiladores"></a>Rinha de compiladores</h2>
<p>Em Setembro de 2023 aconteceu na tal #bolhaDev uma <a href="https://github.com/aripiprazole/rinha-de-compiler">outra competi√ß√£o</a> em formato de rinha, mas desta vez o desafio era a <strong>constru√ß√£o de um compilador/interpretador</strong> que fosse capaz de rodar um programa escrito em uma linguagem especificada para a rinha, chamada - guess what -, <em>rinha</em>.</p>
<p>A competi√ß√£o foi criada por duas meninas fant√°sticas e que entendem muito desse mundo de compiladores: a <a href="https://twitter.com/algebraic_sofia">Sofia</a> e a <a href="https://twitter.com/algebraic_gabi">Gabi</a>. Ambas tinham o intuito de despertar mais o interesse das pessoas nesse tema de compiladores, o que foi atingido com sucesso: <em>190 projetos</em> foram submetidos em diversas linguagens de programa√ß√£o. Teve at√© projetos <a href="https://github.com/jeffque/rinha-compiler">submetidos</a> em <a href="https://github.com/tiagosh/garbash">Bash</a> (desta vez n√£o fui eu, risos).</p>
<p>Inicialmente eu s√≥ tinha interesse em acompanhar esta rinha de perto sem submeter, apenas pra aprender mais com essa galera que manja bastante. Eu j√° tinha feito algumas coisas bastante b√°sicas sobre compiladores na faculdade h√° muito tempo atr√°s.</p>
<p>Mas ap√≥s ver a live do brabo <a href="https://www.youtube.com/watch?v=FbCdhicY3sk">Navarro</a>, que trouxe uma did√°tica excelente com sua vers√£o em Rust, decidi entrar tamb√©m com o intuito de aprender mais e praticar algumas t√©cnicas.</p>
<p>Escolhi Ruby porque eu queria testar um neg√≥cio. E disto saiu o <a href="https://github.com/leandronsp/patropi">patropi</a>.</p>
<p>Okay, mas o que era pra ser feito de fato? Vamos voltar duas casas e entender primeiro <strong>o que raios √© um compilador ou interpretador</strong>.</p>
<h3><a href="#-arquitetura-de-cpu-e-c√≥digo-de-m√°quina" aria-hidden="true" class="anchor" id="-arquitetura-de-cpu-e-c√≥digo-de-m√°quina"></a>üëâüèΩ Arquitetura de CPU e c√≥digo de m√°quina</h3>
<p>Para que uma CPU possa processar informa√ß√µes, √© necess√°rio organiz√°-la em um conjunto coeso de instru√ß√µes. A este conjunto organizado de instru√ß√µes para uma determinada CPU chamamos de <strong>arquitetura da CPU</strong>.</p>
<p>Existem diversos tipos de arquiteturas de CPU dispon√≠veis, e cada CPU traz um conjunto espec√≠fico de instru√ß√µes. Exemplos de arquiteturas: x86, x86-64 (64-bits), ARM (baseada em RISC), MIPS, SPARC, PowerPC dentre outros.</p>
<p>As instru√ß√µes da CPU s√£o mapeadas para componentes da arquitetura chamados <em>registradores</em>. Para manipularmos esses registradores, precisamos utilizar um conjunto de ‚Äúc√≥digos‚Äù que s√£o pr√©-definidos pelo fabricante da arquitetura da CPU. Estes c√≥digos s√£o chamados de <strong>opcodes</strong>, ou c√≥digo de m√°quina, ou instru√ß√µes de m√°quina.</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">0000000000401000 
</div><div class="line" data-line="2">  401000:       48 c7 c0 01 00 00 00    
</div><div class="line" data-line="3">  401007:       48 c7 c7 01 00 00 00    
</div><div class="line" data-line="4">  40100e:       48 c7 c6 00 20 40 00    
</div><div class="line" data-line="5">  401015:       48 c7 c2 0e 00 00 00    
</div><div class="line" data-line="6">  40101c:       0f 05                   
</div><div class="line" data-line="7">  40101e:       48 c7 c0 3c 00 00 00    
</div><div class="line" data-line="8">  401025:       48 31 ff                
</div><div class="line" data-line="9">  401028:       0f 05                   
</div></code></pre>
<p>Escrever programas em c√≥digo de m√°quina pode ser bastante desafiador, por isso alguns sistemas operacionais e bibliotecas trazem consigo um programa que auxilia na ‚Äúmontagem‚Äù desse c√≥digo de m√°quina, possibilitando assim escrever programas em uma linguagem mnem√¥nica com base em letras, n√∫meros e s√≠mbolos, sendo mais f√°cil de memorizar do que os opcodes.</p>
<p>A estes montadores chamamos de <strong>assemblers</strong>.</p>
<h3><a href="#-assemblers" aria-hidden="true" class="anchor" id="-assemblers"></a>üëâüèΩ Assemblers</h3>
<p>Com um assembler, podemos escrever c√≥digo de montagem (assembly), que √© convertido para c√≥digo de m√°quina.</p>
<p>Exemplo de um simples programa escrito em assembly x86_64 que imprime <code>Hello, World!</code> no standard output:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-plaintext" translate="no" tabindex="0"><div class="line" data-line="1">.section .data
</div><div class="line" data-line="2">hello:
</div><div class="line" data-line="3">    .ascii &quot;Hello, World!\n&quot;
</div><div class="line" data-line="4">
</div><div class="line" data-line="5">.section .text
</div><div class="line" data-line="6">.global _start
</div><div class="line" data-line="7">
</div><div class="line" data-line="8">_start:
</div><div class="line" data-line="9">    # write our string to stdout
</div><div class="line" data-line="10">    movq $1, %rax         # syscall number for sys_write
</div><div class="line" data-line="11">    movq $1, %rdi         # file descriptor 1 is stdout
</div><div class="line" data-line="12">    movq $hello, %rsi     # pointer to the hello string
</div><div class="line" data-line="13">    movq $14, %rdx        # length of the hello string plus newline character
</div><div class="line" data-line="14">    syscall               # invoke the kernel
</div><div class="line" data-line="15">
</div><div class="line" data-line="16">    # exit
</div><div class="line" data-line="17">    movq $60, %rax        # syscall number for sys_exit
</div><div class="line" data-line="18">    xorq %rdi, %rdi       # exit code 0
</div><div class="line" data-line="19">    syscall               # invoke the kernel
</div></code></pre>
<p>Ap√≥s executar o programa com o assembler <code>as</code> que vem acompanhado no GNU/Linux seguido do linker <code>ld</code>, temos o bin√°rio com o c√≥digo de m√°quina.</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">as</span> <span style="color: #e06c75;">-o</span> <span style="color: #e06c75;">hello.o</span> <span style="color: #e06c75;">hello.s</span> 
</div><div class="line" data-line="2"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">ld</span> <span style="color: #e06c75;">-o</span> <span style="color: #e06c75;">hello</span> <span style="color: #e06c75;">hello.o</span>
</div><div class="line" data-line="3">$ <span style="color: #61afef;">./hello</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #61afef;">Hello,</span> <span style="color: #e06c75;">World!</span>
</div></code></pre>
<p>Uma forma de fazer o ‚Äúdisassembly‚Äù do bin√°rio e ver o assembly equivalente, √© com o utilit√°rio <code>objdump</code>, onde podemos ver as instru√ß√µes de m√°quina (opcodes) mapeadas para cada instru√ß√£o assembly contida no nosso c√≥digo fonte:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">objdump</span> <span style="color: #e06c75;">-d</span> <span style="color: #e06c75;">hello</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #61afef;">hello:</span>     <span style="color: #e06c75;">file</span> <span style="color: #e06c75;">format</span> <span style="color: #e06c75;">elf64-x86-64</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5">
</div><div class="line" data-line="6"><span style="color: #61afef;">Disassembly</span> <span style="color: #e06c75;">of</span> <span style="color: #e06c75;">section</span> <span style="color: #e06c75;">.text:</span>
</div><div class="line" data-line="7">
</div><div class="line" data-line="8"><span style="color: #d19a66;">0000000000401000</span> <span style="color: #56b6c2;">&lt;</span><span style="color: #61afef;">_start</span><span style="color: #56b6c2;">&gt;</span><span style="color: #61afef;">:</span>
</div><div class="line" data-line="9">  <span style="color: #61afef;">401000:</span>       <span style="color: #d19a66;">48</span> <span style="color: #e06c75;">c7</span> <span style="color: #e06c75;">c0</span> <span style="color: #d19a66;">01</span> <span style="color: #d19a66;">00</span> <span style="color: #d19a66;">00</span> <span style="color: #d19a66;">00</span>    <span style="color: #e06c75;">mov</span>    <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">0x1</span><span style="color: #e06c75;">,%rax</span>
</div><div class="line" data-line="10">  <span style="color: #61afef;">401007:</span>       <span style="color: #d19a66;">48</span> <span style="color: #e06c75;">c7</span> <span style="color: #e06c75;">c7</span> <span style="color: #d19a66;">01</span> <span style="color: #d19a66;">00</span> <span style="color: #d19a66;">00</span> <span style="color: #d19a66;">00</span>    <span style="color: #e06c75;">mov</span>    <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">0x1</span><span style="color: #e06c75;">,%rdi</span>
</div><div class="line" data-line="11">  <span style="color: #61afef;">40100e:</span>       <span style="color: #d19a66;">48</span> <span style="color: #e06c75;">c7</span> <span style="color: #e06c75;">c6</span> <span style="color: #d19a66;">00</span> <span style="color: #d19a66;">20</span> <span style="color: #d19a66;">40</span> <span style="color: #d19a66;">00</span>    <span style="color: #e06c75;">mov</span>    <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">0x402000</span><span style="color: #e06c75;">,%rsi</span>
</div><div class="line" data-line="12">  <span style="color: #61afef;">401015:</span>       <span style="color: #d19a66;">48</span> <span style="color: #e06c75;">c7</span> <span style="color: #e06c75;">c2</span> <span style="color: #e06c75;">0e</span> <span style="color: #d19a66;">00</span> <span style="color: #d19a66;">00</span> <span style="color: #d19a66;">00</span>    <span style="color: #e06c75;">mov</span>    <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">0xe</span><span style="color: #e06c75;">,%rdx</span>
</div><div class="line" data-line="13">  <span style="color: #61afef;">40101c:</span>       <span style="color: #e06c75;">0f</span> <span style="color: #d19a66;">05</span>                   <span style="color: #e06c75;">syscall</span>
</div><div class="line" data-line="14">  <span style="color: #61afef;">40101e:</span>       <span style="color: #d19a66;">48</span> <span style="color: #e06c75;">c7</span> <span style="color: #e06c75;">c0</span> <span style="color: #e06c75;">3c</span> <span style="color: #d19a66;">00</span> <span style="color: #d19a66;">00</span> <span style="color: #d19a66;">00</span>    <span style="color: #e06c75;">mov</span>    <span style="color: #abb2bf;">$</span><span style="color: #e06c75;">0x3c</span><span style="color: #e06c75;">,%rax</span>
</div><div class="line" data-line="15">  <span style="color: #61afef;">401025:</span>       <span style="color: #d19a66;">48</span> <span style="color: #d19a66;">31</span> <span style="color: #e06c75;">ff</span>                <span style="color: #e06c75;">xor</span>    <span style="color: #e06c75;">%rdi,%rdi</span>
</div><div class="line" data-line="16">  <span style="color: #61afef;">401028:</span>       <span style="color: #e06c75;">0f</span> <span style="color: #d19a66;">05</span>                   <span style="color: #e06c75;">syscall</span>
</div></code></pre>
<p><em>Espetacular, n√£o?</em></p>
<h3><a href="#-t√°-mas-e-os-compiladores" aria-hidden="true" class="anchor" id="-t√°-mas-e-os-compiladores"></a>üëâüèΩ T√°, mas e os compiladores?</h3>
<p>Os compiladores entram justamente na categoria de programas de mais alto n√≠vel que convertem para o assembly da arquitetura em quest√£o ou diretamente para c√≥digo de m√°quina.</p>
<p>Por exemplo, este simples programa escrito em C:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-c" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">#include</span> <span style="color: #98c379;">&lt;stdio.h&gt;</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #e5c07b;">int</span> <span style="color: #61afef;">main</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="4">    <span style="color: #61afef;">printf</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;Hello, World!<span style="color: #56b6c2;">\n</span>&quot;</span><span style="color: #c678dd;">)</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="5">    <span style="color: #c678dd;">return</span> <span style="color: #d19a66;">0</span><span style="color: #abb2bf;">;</span>
</div><div class="line" data-line="6"><span style="color: #c678dd;">&rbrace;</span>
</div></code></pre>
<p>Pode ser compilado para c√≥digo de m√°quina utilizando o compilador <code>gcc</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">gcc</span> <span style="color: #e06c75;">-o</span> <span style="color: #e06c75;">hello</span> <span style="color: #e06c75;">hello.c</span> 
</div><div class="line" data-line="2">$ <span style="color: #61afef;">./hello</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #61afef;">Hello,</span> <span style="color: #e06c75;">World!</span>
</div></code></pre>
<blockquote>
<p>√â muito comum tamb√©m compiladores converterem para uma representa√ß√£o intermedi√°ria (IR) antes de gerar o c√≥digo de m√°quina, como √© o caso do pr√≥prio gcc, LLVM, dentre outros.</p>
</blockquote>
<h3><a href="#-e-os-interpretadores" aria-hidden="true" class="anchor" id="-e-os-interpretadores"></a>üëâüèΩ E os interpretadores?</h3>
<p>A distin√ß√£o e similaridade entre compiladores e interpretadores n√£o √© um senso bastante comum, embora algumas pessoas entendam que interpretador √© um tipo de compilador.</p>
<p>Indo pelo sentido pr√°tico, podemos dizer que o compilador <em>compila</em> para instru√ß√£o de m√°quina. Enquanto que o interpretador vai lendo linha por linha do c√≥digo fonte e executando.</p>
<p>Interpretadores modernos possuem um processo interno de compila√ß√£o em tempo real, chamado <strong>just-in-time</strong>, ou <em>JIT</em>, o que pode inclusive caracterizar interpretadores tamb√©m no rol de compiladores.</p>
<p>Independente da defini√ß√£o correta ou n√£o de compiladores/interpretadores, uma coisa que devemos ter em mente √© que est√£o acontecendo diversas transforma√ß√µes em camadas at√© chegar ao c√≥digo de m√°quina.</p>
<p>Nesse processo de transforma√ß√£o, acontecem an√°lises e otimiza√ß√µes que v√£o afetar drasticamente a performance do programa.</p>
<h3><a href="#-frontend-vs-backend" aria-hidden="true" class="anchor" id="-frontend-vs-backend"></a>üëâüèΩ Frontend vs Backend</h3>
<p>Voc√™ pensava que a briga front vs back existia apenas na web, pois n√£o? No mundo dos compiladores tamb√©m!</p>
<blockquote>
<p>To brincando, gente. N√£o tem briga nenhuma n√£o</p>
</blockquote>
<p><strong>Frontend</strong> √© a etapa que faz a leitura do c√≥digo fonte e gera uma √°rvore sint√°tica. Esta √°rvore, como o pr√≥prio nome diz, segue uma estrutura de dados muito comum na computa√ß√£o, o que permite a an√°lise de programas seguindo o conjunto de regras definido na gram√°tica.</p>
<p>Basicamente, o frontend faz a an√°lise l√©xica (gerando tokens v√°lidos da especifica√ß√£o), e em seguida a an√°lise sint√°tica (parsing dos tokens), gerando a √°rvore sint√°tica abstrata, ou <strong>AST</strong>.</p>
<p>Com a AST, o frontend pode ainda realizar an√°lise sem√¢ntica e at√© mesmo gerar um c√≥digo intermedi√°rio (IR), se for o caso.</p>
<p>J√° no <strong>Backend</strong> consiste na etapa de, a partir de uma AST ou IR, aplicar otimiza√ß√µes, an√°lise est√°tica (tamb√©m chamada de <em>ahead-of-time compilation</em>, ou <strong>AOT</strong>), compila√ß√£o em tempo de execu√ß√£o (JIT) e por fim a gera√ß√£o de assembly ou c√≥digo de m√°quina.</p>
<p>Resumindo, ent√£o, alguns tipos de assemblers e compiladores:</p>
<ol>
<li>Assemblers</li>
</ol>
<ul>
<li>NASM</li>
<li>GNU as</li>
</ul>
<ol start="2">
<li>Frontend</li>
</ol>
<ul>
<li>Clang (para LLVM)</li>
<li>GCC</li>
<li>javac</li>
</ul>
<ol start="3">
<li>Backend</li>
</ol>
<ul>
<li>LLC/LLI (para LLVM)</li>
<li>GCC</li>
<li>JVM</li>
</ul>
<h3><a href="#-okay-mas-e-a-rinha" aria-hidden="true" class="anchor" id="-okay-mas-e-a-rinha"></a>üëâüèΩ Okay mas e a rinha</h3>
<p>Na rinha, foi disponibilizado um frontend para a especifica√ß√£o da linguagem, em formato de <a href="https://crates.io/crates/rinha">Rust crate</a>.</p>
<p>Bastando ter o Rust instalado, adicionamos a crate e, atrav√©s do comando <code>rinha</code>, temos uma representa√ß√£o JSON da AST:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #7f848e;"># examples/hello.rinha</span>
</div><div class="line" data-line="2"><span style="color: #61afef;">print</span><span style="color: #c678dd;">(</span><span style="color: #98c379;">&quot;Hello, world&quot;</span><span style="color: #c678dd;">)</span>
</div><div class="line" data-line="3">
</div><div class="line" data-line="4"><span style="color: #7f848e;"># run frontend</span>
</div><div class="line" data-line="5"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">rinha</span> <span style="color: #e06c75;">-p</span> <span style="color: #e06c75;">examples/hello.rinha</span>
</div><div class="line" data-line="6">
</div><div class="line" data-line="7"><span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="8">  <span style="color: #98c379;">&quot;name&quot;</span><span style="color: #98c379;">:</span> <span style="color: #98c379;">&quot;examples/hello.rinha&quot;</span><span style="color: #e06c75;">,</span>
</div><div class="line" data-line="9">  <span style="color: #98c379;">&quot;expression&quot;</span><span style="color: #98c379;">:</span> <span style="color: #e06c75;">&lbrace;</span>
</div><div class="line" data-line="10">    <span style="color: #98c379;">&quot;kind&quot;</span><span style="color: #98c379;">:</span> <span style="color: #98c379;">&quot;Print&quot;</span><span style="color: #e06c75;">,</span>
</div><div class="line" data-line="11">    <span style="color: #98c379;">&quot;value&quot;</span><span style="color: #98c379;">:</span> <span style="color: #e06c75;">&lbrace;</span>
</div><div class="line" data-line="12">      <span style="color: #98c379;">&quot;kind&quot;</span><span style="color: #98c379;">:</span> <span style="color: #98c379;">&quot;Str&quot;</span><span style="color: #e06c75;">,</span>
</div><div class="line" data-line="13">      <span style="color: #98c379;">&quot;value&quot;</span><span style="color: #98c379;">:</span> <span style="color: #98c379;">&quot;Hello, world&quot;</span><span style="color: #e06c75;">,</span>
</div><div class="line" data-line="14">      <span style="color: #98c379;">&quot;location&quot;</span><span style="color: #98c379;">:</span> <span style="color: #e06c75;">&lbrace;</span>
</div><div class="line" data-line="15">        <span style="color: #98c379;">&quot;start&quot;</span><span style="color: #98c379;">:</span> <span style="color: #e06c75;">6,</span>
</div><div class="line" data-line="16">        <span style="color: #98c379;">&quot;end&quot;</span><span style="color: #98c379;">:</span> <span style="color: #e06c75;">20,</span>
</div><div class="line" data-line="17">        <span style="color: #98c379;">&quot;filename&quot;</span><span style="color: #98c379;">:</span> <span style="color: #98c379;">&quot;examples/hello.rinha&quot;</span>
</div><div class="line" data-line="18">      <span style="color: #c678dd;">&rbrace;</span>
</div><div class="line" data-line="19"><span style="color: #61afef;">...........</span>
</div></code></pre>
<p>O desafio? Escrever um compilador/interpretador para este AST. <em>Simples assim.</em></p>
<hr />
<h2><a href="#patropi-e-o-trampolim" aria-hidden="true" class="anchor" id="patropi-e-o-trampolim"></a>Patropi e o trampolim</h2>
<p>Minha submiss√£o escrita em Ruby foi batizada de <strong>Patropi</strong> (<em>idk either</em>). Optei por fazer um interpretador no formato <em>tree-walking interpreter</em>, que basicamente vai caminhando por cada n√≥ da AST e executando.</p>
<p>Como n√£o sou especialista em compiladores e otimiza√ß√µes, pra mim foi o caminho mais sensato naquele momento.</p>
<p>Um exemplo de c√≥digo muito simples em Ruby, para interpretar o simples <code>print(&quot;Hello world&quot;)</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-ruby" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">def</span> <span style="color: #61afef;">evaluate</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">term</span><span style="color: #c678dd;">)</span>
</div><div class="line" data-line="2">  <span style="color: #c678dd;">case</span> <span style="color: #e06c75;">term</span>
</div><div class="line" data-line="3">  <span style="color: #c678dd;">in</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">kind</span><span style="color: #56b6c2;">:</span> <span style="color: #98c379;">&#39;</span><span style="color: #98c379;">Str</span><span style="color: #98c379;">&#39;</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">value</span><span style="color: #56b6c2;">:</span> <span style="color: #e06c75;">value</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #abb2bf;">;</span> <span style="color: #e06c75;">value</span><span style="color: #abb2bf;">.</span><span style="color: #61afef;">to_s</span>
</div><div class="line" data-line="4">  <span style="color: #c678dd;">in</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #e06c75;">kind</span><span style="color: #56b6c2;">:</span> <span style="color: #98c379;">&#39;</span><span style="color: #98c379;">Print</span><span style="color: #98c379;">&#39;</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">value</span><span style="color: #56b6c2;">:</span> <span style="color: #e06c75;">next_term</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #abb2bf;">;</span> <span style="color: #61afef;">puts</span> <span style="color: #61afef;">evaluate</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">next_term</span><span style="color: #c678dd;">)</span>
</div><div class="line" data-line="5">  <span style="color: #c678dd;">else</span> <span style="color: #c678dd;">raise</span> <span style="color: #98c379;">&quot;</span><span style="color: #98c379;">Unknown term: </span><span style="color: #abb2bf;">#&lbrace;</span><span style="color: #e06c75;">term</span><span style="color: #abb2bf;">&rbrace;</span><span style="color: #98c379;">&quot;</span>
</div><div class="line" data-line="6">  <span style="color: #c678dd;">end</span>
</div><div class="line" data-line="7"><span style="color: #c678dd;">end</span>
</div></code></pre>
<p>Note que o m√©todo <code>evaluate</code> √© nosso ponto focal. Ele recebe um termo (n√≥ da AST) e tenta buscar por um match espec√≠fico. Caso d√™ match com uma <code>String</code> literal, retorna o valor. Mas se der match com um n√≥ <code>Print</code>, chama o <code>evaluate</code> recursivamente.</p>
<h3><a href="#-recurs√£o" aria-hidden="true" class="anchor" id="-recurs√£o"></a>üëâüèΩ Recurs√£o</h3>
<p><strong>Recurs√£o</strong> √© o caminho mais intuitivo para manipular uma √°rvore na computa√ß√£o. Quase todo compilador √© feito inicialmente de forma recursiva na manipula√ß√£o da √°rvore justamente porque √© intuitivo.</p>
<blockquote>
<p>Enquanto h√° n√≥ para percorrer, vou chamar minha fun√ß√£o novamente, at√© chegar no fim do galho</p>
</blockquote>
<p>N√£o vou entrar muito nos detalhes dos trade-offs da recurs√£o, mas se quiser se aprofundar nisto, sugiro a leitura do artigo que escrevi sobre <a href="https://leandronsp.com/articles/entendendo-fundamentos-de-recursao-2ap4">fundamentos de recurs√£o</a>.</p>
<p>Com isto em mente, e sabendo que o pessoal na rinha iria executar alguns programas que exigem muito da mem√≥ria stack, decidi experimentar uma estrat√©gia n√£o muito ortodoxa e que funciona como alternativa √† recurs√£o quando otimiza√ß√µes de recurs√£o de cauda n√£o s√£o poss√≠veis ou s√£o muito limitadas.</p>
<p>A esta estrat√©gia (que tamb√©m explico com detalhes no artigo apontado), chamamos de <strong>Trampoline</strong>, ou <em>trampolim</em>.</p>
<h3><a href="#-trampolim-para-o-resgate" aria-hidden="true" class="anchor" id="-trampolim-para-o-resgate"></a>üëâüèΩ Trampolim para o resgate</h3>
<p>Basicamente, ao inv√©s de chamar a fun√ß√£o recursivamente, eu devolvo uma estrutura chamada ‚Äúcontinuation‚Äù, passando o controle para um loop fora da fun√ß√£o.</p>
<p>Este loop imperativo toma a decis√£o de executar uma closure com o valor passado na continuation ou se vai para o pr√≥ximo n√≥ da √°rvore. A cada itera√ß√£o do loop, por n√£o haver chamada recursiva, n√£o h√° ac√∫mulo na stack frame, portanto diminui drasticamente a chance de acontecer <strong>stack buffer overflow</strong>, ou seja, praticamente n√£o h√° chance de estouro de pilha.</p>
<p>Aqui segue uma imagem com a arquitetura do <a href="https://github.com/leandronsp/patropi">Patropi</a>:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/jsbup3brs6qdax53p4sy.png" alt="arquitetura do patropi" /></p>
<blockquote>
<p>Para mais detalhes de c√≥digo, basta seguir o link do <a href="https://github.com/leandronsp/patropi">reposit√≥rio no Github</a></p>
</blockquote>
<h3><a href="#-and-the-oscar-goes-to" aria-hidden="true" class="anchor" id="-and-the-oscar-goes-to"></a>üëâüèΩ And the Oscar goes to‚Ä¶</h3>
<p>O <a href="https://github.com/aripiprazole/rinha-de-compiler/blob/main/TESTS.md">ranking oficial</a> est√° divulgado no reposit√≥rio da rinha, e em primeiro lugar ficou uma solu√ß√£o escrita em Golang de tree-walking interpreter. Achei incr√≠vel, here we ‚ÄúGo‚Äù again :P</p>
<p>Minha solu√ß√£o em Ruby, o Patropi, das 190 submiss√µes, ficou entre as 68 que rodaram, amargando a 65¬™ posi√ß√£o.</p>
<p>Apesar de ter sido divertido implementar o trampolim, Patropi n√£o soube lidar muito bem com Tuplas e falhou em diversos testes‚Ä¶</p>
<hr />
<h2><a href="#fila-duplamente-terminada-em-go" aria-hidden="true" class="anchor" id="fila-duplamente-terminada-em-go"></a>Fila duplamente terminada em Go</h2>
<p>Neste intervalo de estudos, aproveitei tamb√©m para contribuir para um projeto de <a href="https://github.com/kelvins/algorithms-and-data-structures">algoritmos e estruturas de dados</a> no Github. A ideia do reposit√≥rio √© muito boa, basicamente ali tem dezenas de algoritmos que podem ser implementados por qualquer pessoa em diversas linguagens. Basta contribuir :)</p>
<p>Aproveitei a deixa para submeter <a href="https://github.com/kelvins/algorithms-and-data-structures/pulls?q=is%3Apr+author%3Aleandronsp+is%3Aclosed">alguns algoritmos e estruturas de dados</a> em Rust, Go e Ruby. Mas queria destacar uma fila duplamente terminada (double-ended queue, ou <strong>deque</strong>) que <a href="https://github.com/kelvins/algorithms-and-data-structures/pull/211">fiz em Go</a>.</p>
<p><strong>Deque</strong> √© uma estrutura de dados de fila que permite adicionar ou remover elementos em qualquer um dos lados.</p>
<p>Por exemplo, uma pilha permite adicionar e remover em apenas um lado (LIFO). Em uma fila, adicionamos a um lado e removemos do outro (FIFO).</p>
<p>A versatilidade da deque permite na m√©dia um acesso em tempo constante em ambos os lados (in√≠cio da fila ou fim), tanto para adi√ß√£o (push) ou remo√ß√£o (pop).</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/cutdsqnv54nvvvehskxo.png" alt="deque" /></p>
<p>Um caso pr√°tico de deque seria no hist√≥rico de um navegador web, por exemplo. Como o armazenamento no navegador √© limitado, o hist√≥rico precisa ter um limite de tamanho. Portanto adicionar e remover em ambas extremidades com o mesmo custo passa a ser uma vantagem neste cen√°rio.</p>
<p>Em Go, poder√≠amos implementar em baby-steps da seguinte forma. Primeiro, definimos a type struct que ter√° um slice de inteiros:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-go" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">package</span> <span style="color: #e5c07b;">main</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #c678dd;">import</span> <span style="color: #98c379;">&quot;fmt&quot;</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #c678dd;">type</span> <span style="color: #e5c07b;">Deque</span> <span style="color: #c678dd;">struct</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="6">	<span style="color: #e06c75;">Store</span> <span style="color: #c678dd;">[</span><span style="color: #c678dd;">]</span><span style="color: #e5c07b;">int</span>
</div><div class="line" data-line="7"><span style="color: #c678dd;">&rbrace;</span>
</div></code></pre>
<p>Agora, temos que implementar as opera√ß√µes do lado direito, <code>Rpush</code> e <code>RPop</code>:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-go" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">func</span> <span style="color: #c678dd;">(</span><span style="color: #e06c75;">deque</span> <span style="color: #56b6c2;">*</span><span style="color: #e5c07b;">Deque</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">RPush</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">element</span> <span style="color: #e5c07b;">int</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="2">	<span style="color: #e06c75;">deque</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">Store</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">append</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">deque</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">Store</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">element</span><span style="color: #c678dd;">)</span>
</div><div class="line" data-line="3"><span style="color: #c678dd;">&rbrace;</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #c678dd;">func</span> <span style="color: #c678dd;">(</span><span style="color: #e06c75;">deque</span> <span style="color: #56b6c2;">*</span><span style="color: #e5c07b;">Deque</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">RPop</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">*</span><span style="color: #e5c07b;">int</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="6">	<span style="color: #c678dd;">if</span> <span style="color: #e5c07b;">len</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">deque</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">Store</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">==</span> <span style="color: #d19a66;">0</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="7">		<span style="color: #c678dd;">return</span> <span style="color: #c678dd;">nil</span>
</div><div class="line" data-line="8">	<span style="color: #c678dd;">&rbrace;</span>
</div><div class="line" data-line="9">
</div><div class="line" data-line="10">	<span style="color: #e06c75;">element</span> <span style="color: #56b6c2;">:=</span> <span style="color: #e06c75;">deque</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">Store</span><span style="color: #c678dd;">[</span><span style="color: #e5c07b;">len</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">deque</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">Store</span><span style="color: #c678dd;">)</span><span style="color: #56b6c2;">-</span><span style="color: #d19a66;">1</span><span style="color: #c678dd;">]</span>
</div><div class="line" data-line="11">	<span style="color: #e06c75;">deque</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">Store</span> <span style="color: #56b6c2;">=</span> <span style="color: #e06c75;">deque</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">Store</span><span style="color: #c678dd;">[</span><span style="color: #abb2bf;">:</span><span style="color: #e5c07b;">len</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">deque</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">Store</span><span style="color: #c678dd;">)</span><span style="color: #56b6c2;">-</span><span style="color: #d19a66;">1</span><span style="color: #c678dd;">]</span>
</div><div class="line" data-line="12">
</div><div class="line" data-line="13">	<span style="color: #c678dd;">return</span> <span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">element</span>
</div><div class="line" data-line="14"><span style="color: #c678dd;">&rbrace;</span>
</div></code></pre>
<ul>
<li>RPush: utiliza o built-in <code>append</code> no lado direito, que √© uma opera√ß√£o constante</li>
<li>RPop: manipula o slice, trabalhando apenas com os √≠ndices</li>
</ul>
<p>Para terminar, fazer o mesmo do lado esquerdo:</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-go" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">func</span> <span style="color: #c678dd;">(</span><span style="color: #e06c75;">deque</span> <span style="color: #56b6c2;">*</span><span style="color: #e5c07b;">Deque</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">LPush</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">element</span> <span style="color: #e5c07b;">int</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="2">	<span style="color: #e06c75;">deque</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">Store</span> <span style="color: #56b6c2;">=</span> <span style="color: #e5c07b;">append</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">[</span><span style="color: #c678dd;">]</span><span style="color: #e5c07b;">int</span><span style="color: #c678dd;">&lbrace;</span><span style="color: #e06c75;">element</span><span style="color: #c678dd;">&rbrace;</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">deque</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">Store</span><span style="color: #56b6c2;">...</span><span style="color: #c678dd;">)</span>
</div><div class="line" data-line="3"><span style="color: #c678dd;">&rbrace;</span>
</div><div class="line" data-line="4">
</div><div class="line" data-line="5"><span style="color: #c678dd;">func</span> <span style="color: #c678dd;">(</span><span style="color: #e06c75;">deque</span> <span style="color: #56b6c2;">*</span><span style="color: #e5c07b;">Deque</span><span style="color: #c678dd;">)</span> <span style="color: #61afef;">LPop</span><span style="color: #c678dd;">(</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">*</span><span style="color: #e5c07b;">int</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="6">	<span style="color: #c678dd;">if</span> <span style="color: #e5c07b;">len</span><span style="color: #c678dd;">(</span><span style="color: #e06c75;">deque</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">Store</span><span style="color: #c678dd;">)</span> <span style="color: #56b6c2;">==</span> <span style="color: #d19a66;">0</span> <span style="color: #c678dd;">&lbrace;</span>
</div><div class="line" data-line="7">		<span style="color: #c678dd;">return</span> <span style="color: #c678dd;">nil</span>
</div><div class="line" data-line="8">	<span style="color: #c678dd;">&rbrace;</span>
</div><div class="line" data-line="9">
</div><div class="line" data-line="10">	<span style="color: #e06c75;">element</span> <span style="color: #56b6c2;">:=</span> <span style="color: #e06c75;">deque</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">Store</span><span style="color: #c678dd;">[</span><span style="color: #d19a66;">0</span><span style="color: #c678dd;">]</span>
</div><div class="line" data-line="11">	<span style="color: #e06c75;">deque</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">Store</span> <span style="color: #56b6c2;">=</span> <span style="color: #e06c75;">deque</span><span style="color: #abb2bf;">.</span><span style="color: #e06c75;">Store</span><span style="color: #c678dd;">[</span><span style="color: #d19a66;">1</span><span style="color: #abb2bf;">:</span><span style="color: #c678dd;">]</span>
</div><div class="line" data-line="12">
</div><div class="line" data-line="13">	<span style="color: #c678dd;">return</span> <span style="color: #56b6c2;">&amp;</span><span style="color: #e06c75;">element</span>
</div><div class="line" data-line="14"><span style="color: #c678dd;">&rbrace;</span>
</div></code></pre>
<p>No lado esquerdo, as opera√ß√µes passam a ter um custo linear, mas na m√©dia, por ser uma fila duplamente terminada, esse custo √© amortizado caindo pra constante.</p>
<hr />
<h2><a href="#thread-pool-no-adelnor" aria-hidden="true" class="anchor" id="thread-pool-no-adelnor"></a>Thread pool no Adelnor</h2>
<p>Pra finalizar, meu projetinho xod√≥ do momento, o <a href="https://github.com/leandronsp/adelnor">leandronsp/adelnor</a>, precisava de uns ajustes importantes. Cada request HTTP era servido dentro da thread principal, n√£o havia qualquer tipo de concorr√™ncia, e portanto o server n√£o conseguia entregar muitos requests.</p>
<p>Resolvi implementar uma thread pool modesta <a href="https://github.com/leandronsp/adelnor/pull/1">submetendo este PR</a>, em live na Twitch e tamb√©m no <a href="https://www.youtube.com/watch?v=a8Ccxt0UGqA">Youtube</a>.</p>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-bash" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #abb2bf;">$</span> <span style="color: #e06c75;">gem</span> <span style="color: #e06c75;">install</span> <span style="color: #e06c75;">adelnor</span>
</div></code></pre>
<pre class="athl" style="color: #abb2bf; background-color: #282c34;"><code class="language-ruby" translate="no" tabindex="0"><div class="line" data-line="1"><span style="color: #c678dd;">require</span> <span style="color: #98c379;">&#39;</span><span style="color: #98c379;">adelnor</span><span style="color: #98c379;">&#39;</span>
</div><div class="line" data-line="2">
</div><div class="line" data-line="3"><span style="color: #e06c75;">app</span> <span style="color: #56b6c2;">=</span> <span style="color: #56b6c2;">-&gt;</span> <span style="color: #c678dd;">(</span><span style="color: #e06c75;">env</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">do</span>
</div><div class="line" data-line="4">  <span style="color: #c678dd;">[</span><span style="color: #d19a66;">200</span><span style="color: #abb2bf;">,</span> <span style="color: #c678dd;">&lbrace;</span> <span style="color: #98c379;">&#39;</span><span style="color: #98c379;">Content-Type</span><span style="color: #98c379;">&#39;</span> <span style="color: #56b6c2;">=&gt;</span> <span style="color: #98c379;">&#39;</span><span style="color: #98c379;">text/html</span><span style="color: #98c379;">&#39;</span> <span style="color: #c678dd;">&rbrace;</span><span style="color: #abb2bf;">,</span> <span style="color: #98c379;">&#39;</span><span style="color: #98c379;">Hello world!</span><span style="color: #98c379;">&#39;</span><span style="color: #c678dd;">]</span>
</div><div class="line" data-line="5"><span style="color: #c678dd;">end</span>
</div><div class="line" data-line="6">
</div><div class="line" data-line="7"><span style="color: #e5c07b;">Adelnor</span><span style="color: #abb2bf;">::</span><span style="color: #e5c07b;">Server</span><span style="color: #abb2bf;">.</span><span style="color: #61afef;">run</span> <span style="color: #e06c75;">app</span><span style="color: #abb2bf;">,</span> <span style="color: #d19a66;">3000</span><span style="color: #abb2bf;">,</span> <span style="color: #e06c75;">thread_pool</span><span style="color: #abb2bf;">:</span> <span style="color: #d19a66;">5</span>
</div></code></pre>
<p>Foi um processo interessante. Ap√≥s subir o server com uma pool de 5 threads, a app conseguiu entregar 4x mais requests do que na vers√£o single-threaded.</p>
<p>E caso queira aprender mais sobre threads em Ruby, recomendo muito <a href="https://workingwithruby.com/wwrt/intro">este guia</a>.</p>
<hr />
<h2><a href="#conclus√£o" aria-hidden="true" class="anchor" id="conclus√£o"></a>Conclus√£o</h2>
<p>√â isto que tive experimentando ultimamente. No momento, estou fazendo algumas melhorias no Adelnor, nomeadamente implementar modelo de atores com Ractors, mas vou entrar em detalhes disto num blogpost √† parte.</p>
<hr />
<h2><a href="#refer√™ncias" aria-hidden="true" class="anchor" id="refer√™ncias"></a>Refer√™ncias</h2>
<p><a href="https://computersciencewiki.org/index.php/Architecture_of_the_central_processing_unit_(CPU)">CPU architecture</a><br />
<a href="http://sparksandflames.com/files/x86InstructionChart.html">x86 instructions chart</a><br />
<a href="https://craftinginterpreters.com/">Crafting Interpreters</a><br />
<a href="https://github.com/aripiprazole/rinha-de-compiler">Rinha de compiladores</a><br />
<a href="https://github.com/reu/rinha-compiladores">reu/rinha-compiladores</a><br />
<a href="https://github.com/leandronsp/patropi">leandronsp/patropi</a><br />
<a href="https://leandronsp.com/articles/entendendo-fundamentos-de-recursao-2ap4">Fundamentos de Recurs√£o</a><br />
<a href="https://en.wikipedia.org/wiki/Double-ended_queue">Double-ended queue</a><br />
<a href="https://workingwithruby.com/">workingwithruby.com</a><br />
<a href="https://github.com/leandronsp/adelnor">leandronsp/adelnor</a></p>
      </div>

      <!-- Back to top -->
      <div class="mt-12 mb-8 text-center">
        <a href="#" onclick="event.preventDefault(); window.scrollTo({ top: 0, behavior: 'smooth' });" class="inline-flex items-center gap-2 text-xl font-medium transition-colors text-base-content/70 hover:text-primary cursor-pointer">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
          </svg>
          Back to top
        </a>
      </div>
    </article>

    <!-- Giscus Comments -->
    <div class="mt-16">
      <div class="border-t border-base-300 pt-8">
        <h2 class="text-2xl font-bold mb-6">Comments</h2>
        <script src="https://giscus.app/client.js"
                data-repo="leandronsp/leandronsp.com"
                data-repo-id="R_kgDOQGG-eQ"
                data-category="Announcements"
                data-category-id="DIC_kwDOQGG-ec4Cw4TN"
                data-mapping="pathname"
                data-strict="0"
                data-reactions-enabled="1"
                data-emit-metadata="0"
                data-input-position="bottom"
                data-theme="preferred_color_scheme"
                data-lang="en"
                crossorigin="anonymous"
                async>
        </script>
      </div>
    </div>

    <!-- Footer -->
    <footer class="mt-16 pt-8 pb-6 border-t border-base-300">
      <div class="text-center text-sm text-base-content/80">
        <p>
          Powered by
          <a
            href="https://github.com/leandronsp/curupira"
            target="_blank"
            rel="noopener noreferrer"
            class="font-semibold text-blue-600 hover:underline"
          >
            Curupira
          </a>
          | Open source blog platform built with Phoenix LiveView
        </p>
        <p class="mt-2 text-xs text-base-content/70">
          Licensed under
          <a
            href="https://github.com/leandronsp/curupira/blob/master/LICENSE"
            target="_blank"
            rel="noopener noreferrer"
            class="text-blue-600 hover:underline"
          >
            AGPL-3.0
          </a>
        </p>
      </div>
    </footer>
  </main>

  <script src="/static-theme.7c342999.js" defer></script>
  <script src="/static-filters.ff26a35d.js" defer></script>
  <script src="/static-search.f956387a.js" defer></script>
  <script src="/static-giscus.ff40d264.js" defer></script>

  <!-- Lazy load Google Analytics after page is fully interactive -->
  <script>
    (function() {
      function loadGTM() {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-0Y5RNLZMKN');

        var script = document.createElement('script');
        script.async = true;
        script.src = 'https://www.googletagmanager.com/gtag/js?id=G-0Y5RNLZMKN';
        document.head.appendChild(script);
      }

      // Load after page is idle, or after 5 seconds as fallback
      if ('requestIdleCallback' in window) {
        requestIdleCallback(loadGTM, { timeout: 5000 });
      } else {
        setTimeout(loadGTM, 5000);
      }
    })();
  </script>
</body>
</html>
